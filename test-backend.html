<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åç«¯è¿æ¥æµ‹è¯• - GameBox</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 14px;
    }

    .test-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
    }

    .test-section h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-loading {
      background: #fbbf24;
      color: #92400e;
    }

    .status-success {
      background: #34d399;
      color: #065f46;
    }

    .status-error {
      background: #f87171;
      color: #991b1b;
    }

    .test-item {
      padding: 15px;
      margin-bottom: 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #f9fafb;
    }

    .test-item-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 8px;
      color: #374151;
    }

    .test-item-result {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.6;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
    }

    .test-item-result.success {
      color: #059669;
    }

    .test-item-result.error {
      color: #dc2626;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
    }

    .btn-secondary {
      background: #6b7280;
      color: white;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #f3f4f6;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .config-info {
      background: #eff6ff;
      border-left: 4px solid #3b82f6;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }

    .config-info strong {
      color: #1e40af;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ§ª GameBox åç«¯è¿æ¥æµ‹è¯•</h1>
      <p>æ£€æµ‹ Supabase æ•°æ®åº“è¿æ¥çŠ¶æ€å’ŒåŠŸèƒ½å¯ç”¨æ€§</p>
    </div>

    <!-- é…ç½®çŠ¶æ€ -->
    <div class="test-section">
      <h2>
        ğŸ“ é…ç½®çŠ¶æ€
        <span class="status-badge status-loading" id="configStatus">æ£€æµ‹ä¸­...</span>
      </h2>
      <div class="test-item">
        <div class="test-item-title">Supabase é…ç½®</div>
        <div class="test-item-result" id="configResult">æ­£åœ¨æ£€æµ‹...</div>
      </div>
      <div class="test-item">
        <div class="test-item-title">é‚®ä»¶æœåŠ¡é…ç½®</div>
        <div class="test-item-result" id="emailConfigResult">æ­£åœ¨æ£€æµ‹...</div>
      </div>
    </div>

    <!-- æ•°æ®åº“è¿æ¥æµ‹è¯• -->
    <div class="test-section">
      <h2>
        ğŸ—„ï¸ æ•°æ®åº“è¿æ¥æµ‹è¯•
        <span class="status-badge status-loading" id="dbStatus">æœªæµ‹è¯•</span>
      </h2>
      <div class="test-item">
        <div class="test-item-title">è¿æ¥çŠ¶æ€</div>
        <div class="test-item-result" id="dbConnectionResult">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æµ‹è¯•</div>
      </div>
      <div class="test-item">
        <div class="test-item-title">è¡¨ç»“æ„æ£€æŸ¥</div>
        <div class="test-item-result" id="dbTablesResult">ç­‰å¾…æµ‹è¯•...</div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="testDatabaseConnection()">æµ‹è¯•æ•°æ®åº“è¿æ¥</button>
      </div>
    </div>

    <!-- ç¤¾åŒºåŠŸèƒ½æµ‹è¯• -->
    <div class="test-section">
      <h2>
        ğŸ’¬ ç¤¾åŒºåŠŸèƒ½æµ‹è¯•
        <span class="status-badge status-loading" id="communityStatus">æœªæµ‹è¯•</span>
      </h2>
      <div class="test-item">
        <div class="test-item-title">è·å–å¸–å­åˆ—è¡¨</div>
        <div class="test-item-result" id="getPostsResult">ç­‰å¾…æµ‹è¯•...</div>
      </div>
      <div class="test-item">
        <div class="test-item-title">åˆ›å»ºæµ‹è¯•å¸–å­</div>
        <div class="test-item-result" id="createPostResult">ç­‰å¾…æµ‹è¯•...</div>
      </div>
      <div class="test-item">
        <div class="test-item-title">ç¤¾åŒºç»Ÿè®¡</div>
        <div class="test-item-result" id="statsResult">ç­‰å¾…æµ‹è¯•...</div>
      </div>
      <div class="actions">
        <button class="btn btn-primary" onclick="testCommunityFunctions()">æµ‹è¯•ç¤¾åŒºåŠŸèƒ½</button>
        <button class="btn btn-secondary" onclick="window.location.href='community.html'">è®¿é—®ç¤¾åŒº</button>
      </div>
    </div>

    <!-- é‚®ä»¶æœåŠ¡æµ‹è¯• -->
    <div class="test-section">
      <h2>
        ğŸ“§ é‚®ä»¶æœåŠ¡æµ‹è¯•
        <span class="status-badge status-loading" id="emailStatus">æœªæµ‹è¯•</span>
      </h2>
      <div class="test-item">
        <div class="test-item-title">å‘é€æµ‹è¯•é‚®ä»¶</div>
        <div class="test-item-result" id="emailResult">è¾“å…¥ä½ çš„é‚®ç®±åœ°å€æµ‹è¯•</div>
        <div style="margin-top: 10px;">
          <input type="email" id="testEmail" placeholder="your@email.com" style="padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; margin-right: 10px; width: 250px;">
          <button class="btn btn-primary" onclick="testEmailService()">å‘é€æµ‹è¯•é‚®ä»¶</button>
        </div>
      </div>
    </div>

    <!-- è¯Šæ–­ä¿¡æ¯ -->
    <div class="test-section">
      <h2>ğŸ” è¯Šæ–­ä¿¡æ¯</h2>
      <div class="config-info">
        <strong>æç¤º</strong>: å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ï¼š<br>
        1. Supabase é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆsupabase-config.jsï¼‰<br>
        2. æ•°æ®åº“è¡¨æ˜¯å¦å·²åˆ›å»ºï¼ˆæ‰§è¡Œ supabase-init.sqlï¼‰<br>
        3. RLS ç­–ç•¥æ˜¯å¦å·²å¯ç”¨<br>
        4. æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯ä¿¡æ¯
      </div>
      <div class="actions">
        <button class="btn btn-secondary" onclick="openConsole()">æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°</button>
        <button class="btn btn-secondary" onclick="window.location.reload()">åˆ·æ–°é¡µé¢</button>
      </div>
    </div>
  </div>

  <!-- åŠ è½½ä¾èµ– -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="community-data-service.js"></script>

  <script>
    // åˆå§‹åŒ–æ£€æµ‹
    window.addEventListener('DOMContentLoaded', async () => {
      await checkConfiguration();
    });

    // æ£€æŸ¥é…ç½®
    async function checkConfiguration() {
      const configStatus = document.getElementById('configStatus');
      const configResult = document.getElementById('configResult');
      const emailConfigResult = document.getElementById('emailConfigResult');

      // æ£€æŸ¥ Supabase é…ç½®
      const isSupabaseEnabled = typeof SUPABASE_CONFIG !== 'undefined' && SUPABASE_CONFIG.enabled;
      const hasValidUrl = isSupabaseEnabled && SUPABASE_CONFIG.url && !SUPABASE_CONFIG.url.includes('xxxxx');
      const hasValidKey = isSupabaseEnabled && SUPABASE_CONFIG.anonKey && SUPABASE_CONFIG.anonKey.length > 50;

      if (isSupabaseEnabled && hasValidUrl && hasValidKey) {
        configStatus.textContent = 'âœ… å·²é…ç½®';
        configStatus.className = 'status-badge status-success';
        configResult.className = 'test-item-result success';
        configResult.textContent = `âœ… Supabase å·²å¯ç”¨
URL: ${SUPABASE_CONFIG.url}
Key: ${SUPABASE_CONFIG.anonKey.substring(0, 20)}...`;
      } else {
        configStatus.textContent = 'âš ï¸ æœªé…ç½®';
        configStatus.className = 'status-badge status-error';
        configResult.className = 'test-item-result error';
        configResult.textContent = `âŒ Supabase æœªæ­£ç¡®é…ç½®
è¯·æ£€æŸ¥ supabase-config.js æ–‡ä»¶
- enabled: ${isSupabaseEnabled ? 'âœ…' : 'âŒ'}
- url: ${hasValidUrl ? 'âœ…' : 'âŒ'}
- anonKey: ${hasValidKey ? 'âœ…' : 'âŒ'}`;
      }

      // æ£€æŸ¥é‚®ä»¶æœåŠ¡é…ç½®
      const isEmailEnabled = typeof EMAIL_SERVICE_CONFIG !== 'undefined' && EMAIL_SERVICE_CONFIG.emailjs?.enabled;
      if (isEmailEnabled) {
        emailConfigResult.className = 'test-item-result success';
        emailConfigResult.textContent = `âœ… EmailJS å·²é…ç½®
Service ID: ${EMAIL_SERVICE_CONFIG.emailjs.serviceId}
Template ID: ${EMAIL_SERVICE_CONFIG.emailjs.templateId}`;
      } else {
        emailConfigResult.className = 'test-item-result';
        emailConfigResult.textContent = 'âš ï¸ EmailJS æœªé…ç½®ï¼ˆé‚®ä»¶åŠŸèƒ½å°†ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ï¼‰';
      }
    }

    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    async function testDatabaseConnection() {
      const dbStatus = document.getElementById('dbStatus');
      const dbConnectionResult = document.getElementById('dbConnectionResult');
      const dbTablesResult = document.getElementById('dbTablesResult');

      dbStatus.textContent = 'æµ‹è¯•ä¸­...';
      dbStatus.className = 'status-badge status-loading';
      dbConnectionResult.textContent = 'æ­£åœ¨è¿æ¥æ•°æ®åº“...';

      try {
        // æ£€æŸ¥æ˜¯å¦å¯ç”¨ Supabase
        if (!window.communityDataService?.isSupabaseEnabled()) {
          throw new Error('Supabase æœªå¯ç”¨ï¼Œè¯·æ£€æŸ¥é…ç½®');
        }

        // æµ‹è¯•è¿æ¥
        const stats = await window.communityDataService.getCommunityStats();
        
        dbStatus.textContent = 'âœ… è¿æ¥æˆåŠŸ';
        dbStatus.className = 'status-badge status-success';
        dbConnectionResult.className = 'test-item-result success';
        dbConnectionResult.textContent = `âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼
ç»Ÿè®¡æ•°æ®: ${JSON.stringify(stats, null, 2)}`;

        // æ£€æŸ¥è¡¨
        dbTablesResult.className = 'test-item-result success';
        dbTablesResult.textContent = 'âœ… æ•°æ®åº“è¡¨ç»“æ„æ­£å¸¸\nå·²éªŒè¯: community_posts, community_stats ç­‰è¡¨';

      } catch (error) {
        dbStatus.textContent = 'âŒ è¿æ¥å¤±è´¥';
        dbStatus.className = 'status-badge status-error';
        dbConnectionResult.className = 'test-item-result error';
        dbConnectionResult.textContent = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
        dbTablesResult.className = 'test-item-result error';
        dbTablesResult.textContent = 'è¯·ç¡®ä¿å·²æ‰§è¡Œ supabase-init.sql åˆ›å»ºæ•°æ®åº“è¡¨';
      }
    }

    // æµ‹è¯•ç¤¾åŒºåŠŸèƒ½
    async function testCommunityFunctions() {
      const communityStatus = document.getElementById('communityStatus');
      const getPostsResult = document.getElementById('getPostsResult');
      const createPostResult = document.getElementById('createPostResult');
      const statsResult = document.getElementById('statsResult');

      communityStatus.textContent = 'æµ‹è¯•ä¸­...';
      communityStatus.className = 'status-badge status-loading';

      try {
        // æµ‹è¯•è·å–å¸–å­
        getPostsResult.textContent = 'æ­£åœ¨è·å–å¸–å­åˆ—è¡¨...';
        const posts = await window.communityDataService.getAllPosts();
        getPostsResult.className = 'test-item-result success';
        getPostsResult.textContent = `âœ… æˆåŠŸè·å– ${posts.length} æ¡å¸–å­\næœ€æ–°å¸–å­: ${posts[0]?.title || 'æš‚æ— '}`;

        // æµ‹è¯•åˆ›å»ºå¸–å­
        createPostResult.textContent = 'æ­£åœ¨åˆ›å»ºæµ‹è¯•å¸–å­...';
        const testPost = await window.communityDataService.createPost({
          title: `æµ‹è¯•å¸–å­ - ${new Date().toLocaleString()}`,
          content: 'è¿™æ˜¯ä¸€æ¡ç”±åç«¯æµ‹è¯•é¡µé¢åˆ›å»ºçš„æµ‹è¯•å¸–å­',
          author: 'æµ‹è¯•æœºå™¨äºº',
          avatar: 'ğŸ¤–',
          game: 'ç³»ç»Ÿæµ‹è¯•',
          board: 'general'
        });
        
        if (testPost.success) {
          createPostResult.className = 'test-item-result success';
          createPostResult.textContent = `âœ… æµ‹è¯•å¸–å­åˆ›å»ºæˆåŠŸï¼\nID: ${testPost.post.id}`;
        } else {
          throw new Error('åˆ›å»ºå¸–å­å¤±è´¥');
        }

        // æµ‹è¯•ç»Ÿè®¡
        statsResult.textContent = 'æ­£åœ¨è·å–ç»Ÿè®¡æ•°æ®...';
        const stats = await window.communityDataService.getCommunityStats();
        statsResult.className = 'test-item-result success';
        statsResult.textContent = `âœ… ç»Ÿè®¡æ•°æ®è·å–æˆåŠŸ
æ€»å¸–å­: ${stats.totalPosts}
æ€»æˆå‘˜: ${stats.totalMembers}
æ€»å›å¤: ${stats.totalReplies}
åœ¨çº¿äººæ•°: ${stats.onlineUsers}`;

        communityStatus.textContent = 'âœ… æµ‹è¯•é€šè¿‡';
        communityStatus.className = 'status-badge status-success';

      } catch (error) {
        communityStatus.textContent = 'âŒ æµ‹è¯•å¤±è´¥';
        communityStatus.className = 'status-badge status-error';
        getPostsResult.className = 'test-item-result error';
        getPostsResult.textContent = `âŒ é”™è¯¯: ${error.message}`;
      }
    }

    // æµ‹è¯•é‚®ä»¶æœåŠ¡
    async function testEmailService() {
      const emailStatus = document.getElementById('emailStatus');
      const emailResult = document.getElementById('emailResult');
      const testEmail = document.getElementById('testEmail').value;

      if (!testEmail || !testEmail.includes('@')) {
        emailResult.className = 'test-item-result error';
        emailResult.textContent = 'âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€';
        return;
      }

      emailStatus.textContent = 'å‘é€ä¸­...';
      emailStatus.className = 'status-badge status-loading';
      emailResult.textContent = 'æ­£åœ¨å‘é€æµ‹è¯•é‚®ä»¶...';

      try {
        const result = await GameBoxAuth.sendEmailOTP(testEmail);
        
        if (result.success) {
          emailStatus.textContent = 'âœ… å‘é€æˆåŠŸ';
          emailStatus.className = 'status-badge status-success';
          emailResult.className = 'test-item-result success';
          emailResult.textContent = `âœ… é‚®ä»¶å·²å‘é€åˆ° ${testEmail}\n${result.demoCode ? `æ¼”ç¤ºæ¨¡å¼éªŒè¯ç : ${result.demoCode}` : 'è¯·æ£€æŸ¥æ”¶ä»¶ç®±ï¼ˆåŒ…æ‹¬åƒåœ¾é‚®ä»¶ï¼‰'}`;
        } else {
          throw new Error(result.error || 'å‘é€å¤±è´¥');
        }
      } catch (error) {
        emailStatus.textContent = 'âŒ å‘é€å¤±è´¥';
        emailStatus.className = 'status-badge status-error';
        emailResult.className = 'test-item-result error';
        emailResult.textContent = `âŒ å‘é€å¤±è´¥: ${error.message}`;
      }
    }

    // æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
    function openConsole() {
      alert('è¯·æŒ‰ F12 é”®æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†æ—¥å¿—');
    }
  </script>
</body>
</html>
