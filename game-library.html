<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æ¸¸æˆåº“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
  <link rel="stylesheet" href="cyberpunk-styles.css" />
</head>
<body data-current-page="library" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>

      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æ¸¸æˆåº“</div>
        <div class="page-intro">
          é€šè¿‡åç§°ã€ç±»å‹ã€å¹³å°å’Œä»·æ ¼åŒºé—´æ¥ç­›é€‰ä½ æ„Ÿå…´è¶£çš„æ¸¸æˆï¼ˆç¤ºä¾‹æ•°æ®ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>ç­›é€‰æ¡ä»¶</span>
          </div>
        </header>

        <div class="form">
          <div class="form-row">
            <label for="libSearch">æŒ‰åç§°æœç´¢</label>
            <input type="text" id="libSearch" placeholder="è¾“å…¥æ¸¸æˆåï¼Œå¦‚ï¼šè‰¾å°”ç™»æ³•ç¯" />
          </div>

          <div class="form-row">
            <label for="libType">ç±»å‹</label>
            <select id="libType">
              <option value="all">å…¨éƒ¨ç±»å‹</option>
              <option value="action">åŠ¨ä½œ / ACT</option>
              <option value="rpg">è§’è‰²æ‰®æ¼” / RPG</option>
              <option value="strategy">ç­–ç•¥ / SLG</option>
              <option value="indie">ç‹¬ç«‹ / Indie</option>
              <option value="multiplayer">å¤šäººè”æœº</option>
              <option value="casual">ä¼‘é—² / è½»åº¦</option>
              <option value="card">å¡ç‰Œ</option>
            </select>
          </div>

          <div class="form-row">
            <label>å¹³å°ï¼ˆå¯å¤šé€‰ï¼‰</label>
            <div id="libPlatforms" style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;">
              <label><input type="checkbox" name="libPlatform" value="steam" checked /> Steam</label>
              <label><input type="checkbox" name="libPlatform" value="pc" checked /> PCï¼ˆå…¶ä»–å¹³å°ï¼‰</label>
              <label><input type="checkbox" name="libPlatform" value="ps" /> PlayStation</label>
              <label><input type="checkbox" name="libPlatform" value="switch" /> Switch</label>
              <label><input type="checkbox" name="libPlatform" value="mobile" /> æ‰‹æœº</label>
            </div>
          </div>

          <div class="form-row">
            <label for="libPrice">ä»·æ ¼åŒºé—´</label>
            <select id="libPrice">
              <option value="all">å…¨éƒ¨</option>
              <option value="free">å…è´¹ / F2P</option>
              <option value="low">100 å…ƒä»¥ä¸‹</option>
              <option value="high">100 å…ƒä»¥ä¸Š</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>ç­›é€‰ç»“æœ</span>
          </div>
          <div class="chip" id="libResultCount">å…± 0 æ¬¾</div>
        </header>
        <ol id="libList" class="ranking-list"></ol>
        <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
        <div id="loadMoreContainer" style="text-align: center; padding: 20px; display: none;">
          <button id="loadMoreBtn" class="btn-secondary" style="padding: 12px 30px;">ğŸ”½ åŠ è½½æ›´å¤šæ¸¸æˆ</button>
        </div>
        <div id="loadingIndicator" style="text-align: center; padding: 20px; display: none; color: var(--text-muted);">
          â³ åŠ è½½ä¸­...
        </div>
        <div id="noMoreGames" style="text-align: center; padding: 20px; display: none; color: var(--text-muted);">
          âœ… å·²åŠ è½½å…¨éƒ¨æ¸¸æˆ
        </div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">å°æç¤º</div>
        <div class="sidebar-item">
          <span class="label">å¯ä¸é¦–é¡µåˆ†ç±»è”åŠ¨</span>
          <span class="value">æ”¯æŒ</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®æ¥æº</span>
          <span class="value">FreeToGame API</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ¸¸æˆæ€»æ•°</span>
          <span class="value" id="totalGamesCount">åŠ è½½ä¸­...</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<!-- ğŸ® 5000æ¬¾çœŸå®Steamæ¸¸æˆæ•°æ®åº“ -->
<script src="real-5000-games-database.js"></script>
<script src="mega-game-database-real.js"></script>
<script>
  initCommon();

  // åˆ†é¡µå’Œç­›é€‰çŠ¶æ€
  let allGamesData = [];
  let filteredGames = [];
  let currentPage = 0;
  const PAGE_SIZE = 20;
  let isDataLoaded = false;

  const libSearch = document.getElementById("libSearch");
  const libType = document.getElementById("libType");
  const libPrice = document.getElementById("libPrice");
  const libPlatformsEl = document.getElementById('libPlatforms');
  const libPlatforms = libPlatformsEl.querySelectorAll('input[name="libPlatform"]');
  const totalGamesCountEl = document.getElementById('totalGamesCount');
  const libList = document.getElementById("libList");
  const libCount = document.getElementById("libResultCount");

  // åŠ è½½æ‰€æœ‰æ¸¸æˆæ•°æ®
  async function loadAllGames() {
    try {
      libList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®...</div>';
      
      allGamesData = await window.megaGameDB.getAllGames();
      isDataLoaded = true;
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allGamesData.length} æ¬¾æ¸¸æˆ`);
      
      // æ›´æ–°ä¾§è¾¹æ æ¸¸æˆæ€»æ•°
      if (totalGamesCountEl) {
        totalGamesCountEl.textContent = `${allGamesData.length} æ¬¾`;
      }
      applyFiltersAndRender();
    } catch (error) {
      console.error("âŒ åŠ è½½å¤±è´¥:", error);
      libList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--danger);">âŒ æ¸¸æˆæ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>';
    }
  }

  // è·å–é€‰ä¸­çš„å¹³å°
  function getSelectedPlatforms() {
    const checked = Array.from(libPlatforms).filter(cb => cb.checked).map(cb => cb.value);
    return checked.length > 0 ? checked : null;
  }

  // åº”ç”¨ç­›é€‰æ¡ä»¶
  function applyFiltersAndRender() {
    if (!isDataLoaded) {
      libList.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½...</div>';
      return;
    }

    const nameKw = libSearch.value.trim().toLowerCase();
    const typeVal = libType.value;
    const priceVal = libPrice.value;
    const platformsVal = getSelectedPlatforms();

    // ç­›é€‰æ¸¸æˆ
    filteredGames = allGamesData.filter(game => {
      // åç§°æœç´¢
      if (nameKw && !game.name.toLowerCase().includes(nameKw) && 
          !game.short_description.toLowerCase().includes(nameKw)) {
        return false;
      }

      // ç±»å‹ç­›é€‰
      if (typeVal !== "all" && !game.genre.toLowerCase().includes(typeVal.toLowerCase())) {
        return false;
      }

      // ä»·æ ¼ç­›é€‰
      if (priceVal === "free" && game.price !== 0) return false;
      if (priceVal === "paid" && game.price === 0) return false;
      if (priceVal === "low" && game.price >= 100) return false; // 100å…ƒä»¥ä¸‹
      if (priceVal === "high" && game.price < 100) return false; // 100å…ƒä»¥ä¸Š

      // å¹³å°ç­›é€‰
      if (platformsVal) {
        const gamePlatforms = game.platform.toLowerCase();
        const matchesPlatform = platformsVal.some(p => {
          const platform = p.toLowerCase();
          // Steam å’Œ PC è§†ä¸ºç›¸åŒ
          if (platform === 'steam' || platform === 'pc') {
            return gamePlatforms.includes('pc') || gamePlatforms.includes('steam');
          }
          // PSç³»åˆ—
          if (platform === 'ps') {
            return gamePlatforms.includes('ps4') || gamePlatforms.includes('ps5') || gamePlatforms.includes('playstation');
          }
          // Xboxç³»åˆ—
          if (platform === 'xbox') {
            return gamePlatforms.includes('xbox');
          }
          // å…¶ä»–å¹³å°ç›´æ¥åŒ¹é…
          return gamePlatforms.includes(platform);
        });
        if (!matchesPlatform) return false;
      }

      return true;
    });

    // æ’åºï¼šé«˜è¯„åˆ†ä¼˜å…ˆ
    filteredGames.sort((a, b) => b.rating - a.rating);

    // é‡ç½®åˆ—è¡¨
    currentPage = 0;
    libList.innerHTML = "";
    libCount.textContent = `å…± ${filteredGames.length} æ¬¾`;

    if (filteredGames.length === 0) {
      libList.innerHTML = '<li style="text-align: center; padding: 40px; color: var(--text-muted); list-style: none;">ğŸ” æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆ</li>';
      return;
    }

    // åŠ è½½ç¬¬ä¸€é¡µ
    loadMoreGames();
  }

  // åŠ è½½æ›´å¤šæ¸¸æˆ
  async function loadMoreGames() {
    const start = currentPage * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageGames = filteredGames.slice(start, end);

    if (pageGames.length === 0) return;

    // ä½¿ç”¨æ’è¡Œæ¦œæ ·å¼æ¸²æŸ“æ¸¸æˆåˆ—è¡¨
    pageGames.forEach((game, index) => {
      const globalIdx = start + index;
      const li = document.createElement("li");
      li.className = "ranking-item";
      li.style.cursor = "pointer";

      // å°é¢å›¾
      const coverHtml = game.thumbnail
        ? `<img src="${game.thumbnail}" alt="${game.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);\\'>ğŸ®</div>'" />`
        : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ®</div>';

      // æ’åæ ·å¼
      const rankClass = globalIdx === 0 ? "ranking-pos--top1" : "";
      const medalIcon = globalIdx === 0 ? "ğŸ¥‡" : globalIdx === 1 ? "ğŸ¥ˆ" : globalIdx === 2 ? "ğŸ¥‰" : "";

      // ç±»åˆ«æ ‡ç­¾
      const categoryTag = game.genre.split(' ')[0]; // å–ç¬¬ä¸€ä¸ªç±»åˆ«
      const categoryColor = game.rating >= 9.0 ? '#00ff00' : game.rating >= 8.0 ? '#00ccff' : '#ffaa00';

      li.innerHTML = `
        <div class="ranking-pos ${rankClass}">${medalIcon}${globalIdx + 1}</div>
        <div class="ranking-game">
          <div class="ranking-cover">${coverHtml}</div>
          <div class="ranking-info">
            <div class="ranking-name">${game.name}</div>
            <div class="ranking-meta">${game.genre.toUpperCase()} Â· ${game.platform.split(',')[0].trim().toUpperCase()}</div>
          </div>
        </div>
        <div class="ranking-score">
          <span class="value" style="color: ${categoryColor};">${game.rating.toFixed(1)}</span>
          <div><span class="tag" style="border-color: ${categoryColor}; color: ${categoryColor};">${categoryTag.toUpperCase()}</span></div>
        </div>
      `;

      // æ‚¬åœæ•ˆæœ
      li.addEventListener("mouseenter", () => {
        li.style.backgroundColor = "rgba(56, 189, 248, 0.05)";
        li.style.transition = "all 0.3s ease";
      });

      li.addEventListener("mouseleave", () => {
        li.style.backgroundColor = "";
      });

      // ç‚¹å‡»è·³è½¬
      li.addEventListener("click", () => {
        const url = new URL("game-detail.html", window.location.href);
        url.searchParams.set("id", game.id);
        url.searchParams.set("name", game.name);
        window.location.href = url.toString();
      });

      libList.appendChild(li);
    });

    currentPage++;
    
    // æ›´æ–°åŠ è½½çŠ¶æ€
    updateLoadingState();
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦ç»§ç»­åŠ è½½ï¼ˆå¦‚æœé¡µé¢æ²¡å¡«æ»¡ï¼‰
    setTimeout(() => {
      const scrollHeight = Math.max(
        document.body.scrollHeight,
        document.documentElement.scrollHeight
      );
      const clientHeight = window.innerHeight || document.documentElement.clientHeight;
      const loadedCount = currentPage * PAGE_SIZE;
      const totalCount = filteredGames.length;
      
      console.log(`ğŸ“¦ åŠ è½½çŠ¶æ€: ${loadedCount}/${totalCount}, é¡µé¢é«˜åº¦: ${scrollHeight}, è§†å£: ${clientHeight}`);
      
      if (scrollHeight <= clientHeight + 200 && loadedCount < totalCount) {
        loadMoreGames();
      }
    }, 100);
  }

  // åŠ è½½æ›´å¤šæŒ‰é’®å’ŒæŒ‡ç¤ºå™¨
  const loadMoreContainer = document.getElementById('loadMoreContainer');
  const loadMoreBtn = document.getElementById('loadMoreBtn');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const noMoreGames = document.getElementById('noMoreGames');

  // æ›´æ–°åŠ è½½çŠ¶æ€UI
  function updateLoadingState() {
    const hasMore = currentPage * PAGE_SIZE < filteredGames.length;
    loadMoreContainer.style.display = hasMore ? 'block' : 'none';
    noMoreGames.style.display = hasMore ? 'none' : (filteredGames.length > 0 ? 'block' : 'none');
    loadingIndicator.style.display = 'none';
  }

  // æ— é™æ»šåŠ¨ - ç›‘å¬çª—å£æ»šåŠ¨
  let isLoading = false;
  let scrollTimeout = null;
  
  function checkAndLoadMore() {
    if (isLoading) return;
    if (!filteredGames || filteredGames.length === 0) return;
    
    const scrollTop = window.scrollY || window.pageYOffset || document.documentElement.scrollTop;
    const scrollHeight = Math.max(
      document.body.scrollHeight,
      document.documentElement.scrollHeight,
      document.body.offsetHeight,
      document.documentElement.offsetHeight
    );
    const clientHeight = window.innerHeight || document.documentElement.clientHeight;

    // è®¡ç®—å½“å‰å·²åŠ è½½çš„æ•°é‡
    const loadedCount = currentPage * PAGE_SIZE;
    const totalCount = filteredGames.length;
    
    // å½“è·ç¦»åº•éƒ¨å°äº1200pxæ—¶åŠ è½½æ›´å¤šï¼ˆå¢åŠ è§¦å‘è·ç¦»ï¼‰
    const distanceFromBottom = scrollHeight - scrollTop - clientHeight;
    
    if (distanceFromBottom < 1200 && loadedCount < totalCount) {
      isLoading = true;
      loadingIndicator.style.display = 'block';
      loadMoreContainer.style.display = 'none';
      
      console.log(`ğŸ“œ æ— é™æ»šåŠ¨è§¦å‘: å·²åŠ è½½ ${loadedCount}/${totalCount}, è·åº•éƒ¨ ${Math.round(distanceFromBottom)}px`);
      
      setTimeout(() => {
        loadMoreGames();
        updateLoadingState();
        isLoading = false;
        
        // å†æ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦ç»§ç»­åŠ è½½ï¼ˆå¿«é€Ÿæ»šåŠ¨æ—¶ï¼‰
        setTimeout(checkAndLoadMore, 50);
      }, 80);
    }
  }

  // ä½¿ç”¨å¤šç§äº‹ä»¶ç›‘å¬ç¡®ä¿æ»šåŠ¨æ£€æµ‹
  window.addEventListener("scroll", () => {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(checkAndLoadMore, 50);
  }, { passive: true });
  
  // å…¼å®¹æ€§ï¼šåŒæ—¶ç›‘å¬documentæ»šåŠ¨
  document.addEventListener("scroll", () => {
    if (scrollTimeout) clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(checkAndLoadMore, 50);
  }, { passive: true });
  
  // åˆå§‹æ£€æµ‹ï¼ˆé¡µé¢åŠ è½½åï¼‰
  setTimeout(checkAndLoadMore, 200);
  
  // åŠ è½½æ›´å¤šæŒ‰é’®ç‚¹å‡»äº‹ä»¶
  loadMoreBtn.addEventListener('click', () => {
    if (currentPage * PAGE_SIZE < filteredGames.length) {
      loadingIndicator.style.display = 'block';
      loadMoreContainer.style.display = 'none';
      
      setTimeout(() => {
        loadMoreGames();
        updateLoadingState();
      }, 100);
    }
  });

  // ç›‘å¬ç­›é€‰æ¡ä»¶å˜åŒ–
  libSearch.addEventListener("input", applyFiltersAndRender);
  libType.addEventListener("change", applyFiltersAndRender);
  libPrice.addEventListener("change", applyFiltersAndRender);
  libPlatforms.forEach(cb => cb.addEventListener("change", applyFiltersAndRender));

  // åˆå§‹åŠ è½½
  loadAllGames();
</script>
</body>
</html>
