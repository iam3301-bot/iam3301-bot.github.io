<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æ¸¸æˆåº“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
  <link rel="stylesheet" href="cyberpunk-styles.css" />
  <style>
    /* ===== æ»šåŠ¨åˆ—è¡¨æ ·å¼ ===== */
    .lib-scroll-container {
      max-height: 550px;
      overflow-y: auto;
      padding-right: 4px;
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 255, 136, 0.6) rgba(0, 0, 0, 0.3);
    }
    
    .lib-scroll-container::-webkit-scrollbar { width: 6px; }
    .lib-scroll-container::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.3); border-radius: 3px; }
    .lib-scroll-container::-webkit-scrollbar-thumb {
      border-radius: 3px;
      background: linear-gradient(180deg, rgba(0, 255, 136, 0.8), rgba(0, 200, 100, 0.9));
      box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
    }
    .lib-scroll-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(0, 255, 136, 1), rgba(0, 255, 200, 1));
    }

    /* ===== ç­›é€‰åŒºåŸŸæ ·å¼ ===== */
    .filter-section {
      background: rgba(0, 20, 10, 0.6);
      border: 1px solid rgba(0, 255, 136, 0.15);
      border-radius: 8px;
      padding: 14px;
      margin-bottom: 12px;
    }
    
    .filter-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0, 255, 136, 0.1);
    }
    
    .filter-title {
      font-size: 13px;
      font-weight: 600;
      color: #00ff88;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .filter-actions {
      display: flex;
      gap: 8px;
    }
    
    .filter-btn {
      padding: 4px 10px;
      font-size: 11px;
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid rgba(0, 255, 136, 0.3);
      border-radius: 4px;
      color: #00ff88;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-btn:hover {
      background: rgba(0, 255, 136, 0.2);
      border-color: rgba(0, 255, 136, 0.6);
    }
    
    .filter-btn.active {
      background: rgba(0, 255, 136, 0.3);
      border-color: #00ff88;
    }

    /* ===== ç­›é€‰ç½‘æ ¼ ===== */
    .filter-grid {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 10px;
    }
    
    @media (max-width: 900px) {
      .filter-grid { grid-template-columns: 1fr 1fr; }
    }
    
    @media (max-width: 600px) {
      .filter-grid { grid-template-columns: 1fr; }
    }
    
    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .filter-item.full-width {
      grid-column: 1 / -1;
    }
    
    .filter-label {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .filter-input,
    .filter-select {
      padding: 8px 10px;
      font-size: 12px;
      border-radius: 4px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 255, 136, 0.2);
      color: #fff;
      transition: all 0.2s;
    }
    
    .filter-input:focus,
    .filter-select:focus {
      outline: none;
      border-color: rgba(0, 255, 136, 0.6);
      box-shadow: 0 0 8px rgba(0, 255, 136, 0.2);
    }
    
    .filter-input::placeholder {
      color: rgba(255, 255, 255, 0.3);
    }

    /* ===== è¯„åˆ†æ»‘å—å¢å¼º ===== */
    .rating-control {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 255, 136, 0.2);
      border-radius: 4px;
    }
    
    .rating-slider {
      flex: 1;
      -webkit-appearance: none;
      height: 6px;
      background: linear-gradient(to right, rgba(255,100,100,0.5) 0%, rgba(255,200,50,0.5) 50%, rgba(0,255,136,0.5) 100%);
      border-radius: 3px;
      cursor: pointer;
    }
    
    .rating-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 18px;
      height: 18px;
      background: radial-gradient(circle, #00ff88 0%, #00cc66 100%);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.6), 0 2px 4px rgba(0,0,0,0.3);
      transition: transform 0.2s;
    }
    
    .rating-slider::-webkit-slider-thumb:hover {
      transform: scale(1.15);
    }
    
    .rating-display {
      min-width: 50px;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 4px;
      background: rgba(0, 255, 136, 0.15);
    }
    
    .rating-display.low { color: #ff6b6b; background: rgba(255, 100, 100, 0.15); }
    .rating-display.medium { color: #ffc107; background: rgba(255, 200, 50, 0.15); }
    .rating-display.high { color: #00ff88; background: rgba(0, 255, 136, 0.15); }

    /* ===== å¹³å°é€‰æ‹©å¢å¼º ===== */
    .platform-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    .platform-chip {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 5px 10px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.6);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }
    
    .platform-chip:hover {
      border-color: rgba(0, 255, 136, 0.4);
      color: rgba(255, 255, 255, 0.8);
    }
    
    .platform-chip.selected {
      background: rgba(0, 255, 136, 0.2);
      border-color: rgba(0, 255, 136, 0.6);
      color: #00ff88;
    }
    
    .platform-chip input {
      display: none;
    }
    
    .platform-icon {
      font-size: 12px;
    }

    /* ===== å½“å‰ç­›é€‰æ ‡ç­¾ ===== */
    .active-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 8px 0;
      min-height: 32px;
    }
    
    .filter-tag {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: rgba(0, 255, 136, 0.15);
      border: 1px solid rgba(0, 255, 136, 0.3);
      border-radius: 12px;
      font-size: 11px;
      color: #00ff88;
      animation: tagAppear 0.2s ease;
    }
    
    @keyframes tagAppear {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
    
    .filter-tag-remove {
      cursor: pointer;
      opacity: 0.7;
      font-size: 12px;
      transition: opacity 0.2s;
    }
    
    .filter-tag-remove:hover {
      opacity: 1;
    }
    
    .no-filters {
      font-size: 11px;
      color: rgba(255, 255, 255, 0.3);
      font-style: italic;
    }

    /* ===== æ’åºæ ‡ç­¾å¢å¼º ===== */
    .sort-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(0, 255, 136, 0.1);
    }
    
    .sort-tabs {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    
    .sort-tab {
      padding: 5px 10px;
      font-size: 11px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .sort-tab:hover {
      border-color: rgba(0, 255, 136, 0.3);
      color: rgba(255, 255, 255, 0.8);
    }
    
    .sort-tab.is-active {
      background: rgba(0, 255, 136, 0.15);
      border-color: rgba(0, 255, 136, 0.5);
      color: #00ff88;
    }
    
    .view-toggle {
      display: flex;
      gap: 4px;
    }
    
    .view-btn {
      padding: 5px 8px;
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      font-size: 12px;
      transition: all 0.2s;
    }
    
    .view-btn:hover, .view-btn.active {
      border-color: rgba(0, 255, 136, 0.5);
      color: #00ff88;
    }

    /* ===== æ¸¸æˆå¡ç‰‡å¢å¼º ===== */
    .game-card-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .ranking-item:hover .game-card-actions {
      opacity: 1;
    }
    
    .game-action-btn {
      padding: 4px 8px;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(0, 255, 136, 0.3);
      border-radius: 4px;
      color: #00ff88;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .game-action-btn:hover {
      background: rgba(0, 255, 136, 0.2);
      border-color: #00ff88;
    }
    
    .game-action-btn.favorited {
      background: rgba(255, 61, 148, 0.2);
      border-color: rgba(255, 61, 148, 0.6);
      color: #ff3d94;
    }

    /* ===== ç»Ÿè®¡ä¿¡æ¯ ===== */
    .stats-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      font-size: 11px;
      color: rgba(255, 255, 255, 0.5);
    }
    
    .stats-count {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .stats-highlight {
      color: #00ff88;
      font-weight: 600;
    }
    
    .stats-progress {
      width: 100px;
      height: 4px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    
    .stats-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00ff88, #00ccff);
      transition: width 0.3s;
    }

    /* ===== æ”¶è—åˆ—è¡¨ ===== */
    .favorites-panel {
      background: rgba(255, 61, 148, 0.05);
      border: 1px solid rgba(255, 61, 148, 0.2);
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 12px;
      display: none;
    }
    
    .favorites-panel.show {
      display: block;
      animation: slideDown 0.3s ease;
    }
    
    @keyframes slideDown {
      from { opacity: 0; max-height: 0; }
      to { opacity: 1; max-height: 200px; }
    }
    
    .favorites-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .favorites-title {
      font-size: 12px;
      color: #ff3d94;
      font-weight: 600;
    }
    
    .favorites-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      max-height: 80px;
      overflow-y: auto;
    }
    
    .favorite-item {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: rgba(255, 61, 148, 0.1);
      border: 1px solid rgba(255, 61, 148, 0.3);
      border-radius: 4px;
      font-size: 10px;
      color: #ff3d94;
    }
    
    .favorite-remove {
      cursor: pointer;
      opacity: 0.7;
    }
    
    .favorite-remove:hover {
      opacity: 1;
    }
  </style>
</head>
<body data-current-page="library" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">æ’è¡Œæ¦œ <span class="badge">HOT</span></a>
      </nav>

      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ..." />
          <span class="header-search-icon">ğŸ”</span>
        </div>
      </div>
    </div>
  </header>

  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>

  <main class="main">
    <section>
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="card" style="padding: 12px 16px;">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div>
            <div class="page-title" style="font-size: 18px; margin-bottom: 2px;">ğŸ® æ¸¸æˆåº“</div>
            <div style="font-size: 11px; color: rgba(255,255,255,0.5);">ä» 5000+ æ¬¾çœŸå® Steam æ¸¸æˆä¸­å‘ç°ä½ çš„æœ€çˆ±</div>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="filter-btn" id="toggleFavorites" title="æŸ¥çœ‹æ”¶è—">â¤ï¸ æ”¶è— (<span id="favCount">0</span>)</button>
            <button class="filter-btn" id="exportResults" title="å¯¼å‡ºç»“æœ">ğŸ“¥ å¯¼å‡º</button>
          </div>
        </div>
      </div>

      <!-- æ”¶è—é¢æ¿ -->
      <div class="favorites-panel" id="favoritesPanel">
        <div class="favorites-header">
          <span class="favorites-title">â¤ï¸ æˆ‘çš„æ”¶è—</span>
          <button class="filter-btn" onclick="clearFavorites()" style="font-size: 10px; padding: 2px 6px;">æ¸…ç©º</button>
        </div>
        <div class="favorites-list" id="favoritesList">
          <span class="no-filters">æš‚æ— æ”¶è—æ¸¸æˆ</span>
        </div>
      </div>

      <!-- ç­›é€‰æ¡ä»¶ -->
      <div class="card filter-section">
        <div class="filter-header">
          <span class="filter-title">ğŸ”§ ç­›é€‰æ¡ä»¶</span>
          <div class="filter-actions">
            <button class="filter-btn" id="collapseFilters">æ”¶èµ· â–²</button>
            <button class="filter-btn" id="resetFilters">é‡ç½®å…¨éƒ¨</button>
          </div>
        </div>
        
        <div id="filterContent">
          <div class="filter-grid">
            <!-- æœç´¢æ¡† -->
            <div class="filter-item">
              <span class="filter-label">ğŸ” æ¸¸æˆåç§°</span>
              <input type="text" class="filter-input" id="libSearch" placeholder="è¾“å…¥å…³é”®è¯æœç´¢..." />
            </div>
            
            <!-- æ¸¸æˆç±»å‹ -->
            <div class="filter-item">
              <span class="filter-label">ğŸ® æ¸¸æˆç±»å‹</span>
              <select class="filter-select" id="libType">
                <option value="all">å…¨éƒ¨ç±»å‹</option>
                <option value="action">ğŸ¯ åŠ¨ä½œ Action</option>
                <option value="rpg">âš”ï¸ è§’è‰²æ‰®æ¼” RPG</option>
                <option value="shooter">ğŸ”« å°„å‡» Shooter</option>
                <option value="strategy">ğŸ§  ç­–ç•¥ Strategy</option>
                <option value="adventure">ğŸ—ºï¸ å†’é™© Adventure</option>
                <option value="simulation">ğŸ—ï¸ æ¨¡æ‹Ÿ Simulation</option>
                <option value="puzzle">ğŸ§© è§£è°œ Puzzle</option>
                <option value="platformer">ğŸƒ å¹³å° Platformer</option>
                <option value="survival">ğŸ•ï¸ ç”Ÿå­˜ Survival</option>
                <option value="horror">ğŸ‘» ææ€– Horror</option>
                <option value="racing">ğŸï¸ èµ›è½¦ Racing</option>
                <option value="sports">âš½ ä½“è‚² Sports</option>
                <option value="indie">ğŸ¨ ç‹¬ç«‹ Indie</option>
              </select>
            </div>
            
            <!-- ä»·æ ¼åŒºé—´ -->
            <div class="filter-item">
              <span class="filter-label">ğŸ’° ä»·æ ¼åŒºé—´</span>
              <select class="filter-select" id="libPrice">
                <option value="all">å…¨éƒ¨ä»·æ ¼</option>
                <option value="free">ğŸ†“ å…è´¹æ¸¸æˆ</option>
                <option value="under50">ğŸ’µ Â¥50 ä»¥ä¸‹</option>
                <option value="under100">ğŸ’µ Â¥100 ä»¥ä¸‹</option>
                <option value="under200">ğŸ’µ Â¥200 ä»¥ä¸‹</option>
                <option value="over200">ğŸ’ Â¥200 ä»¥ä¸Š</option>
              </select>
            </div>
          </div>
          
          <!-- ç¬¬äºŒè¡Œç­›é€‰ -->
          <div class="filter-grid" style="margin-top: 10px;">
            <!-- è¯„åˆ†æ»‘å— -->
            <div class="filter-item">
              <span class="filter-label">â­ æœ€ä½è¯„åˆ†</span>
              <div class="rating-control">
                <input type="range" class="rating-slider" id="libRating" min="0" max="10" step="0.5" value="0" />
                <span class="rating-display high" id="ratingValue">0.0+</span>
              </div>
            </div>
            
            <!-- å‘è¡Œå¹´ä»½ -->
            <div class="filter-item">
              <span class="filter-label">ğŸ“… å‘è¡Œå¹´ä»½</span>
              <select class="filter-select" id="libYear">
                <option value="all">å…¨éƒ¨å¹´ä»½</option>
                <option value="2023">2023 å¹´æ–°ä½œ</option>
                <option value="2022">2022 å¹´</option>
                <option value="2021">2021 å¹´</option>
                <option value="2019">2019-2020</option>
                <option value="classic">ç»å…¸æ¸¸æˆ (2018å‰)</option>
              </select>
            </div>
            
            <!-- è¯„ä»·ç­‰çº§ -->
            <div class="filter-item">
              <span class="filter-label">ğŸ“Š è¯„ä»·ç­‰çº§</span>
              <select class="filter-select" id="libReviewLevel">
                <option value="all">å…¨éƒ¨è¯„ä»·</option>
                <option value="overwhelmingly">å¥½è¯„å¦‚æ½® (95%+)</option>
                <option value="very">ç‰¹åˆ«å¥½è¯„ (85%+)</option>
                <option value="mostly">å¤šåŠå¥½è¯„ (70%+)</option>
              </select>
            </div>
          </div>
          
          <!-- å¹³å°é€‰æ‹© -->
          <div style="margin-top: 10px;">
            <span class="filter-label" style="margin-bottom: 6px; display: block;">ğŸ–¥ï¸ æ¸¸æˆå¹³å°</span>
            <div class="platform-grid" id="libPlatforms">
              <label class="platform-chip selected">
                <input type="checkbox" name="libPlatform" value="steam" checked />
                <span class="platform-icon">ğŸ®</span> Steam
              </label>
              <label class="platform-chip selected">
                <input type="checkbox" name="libPlatform" value="pc" checked />
                <span class="platform-icon">ğŸ’»</span> PC
              </label>
              <label class="platform-chip">
                <input type="checkbox" name="libPlatform" value="ps" />
                <span class="platform-icon">ğŸ®</span> PlayStation
              </label>
              <label class="platform-chip">
                <input type="checkbox" name="libPlatform" value="xbox" />
                <span class="platform-icon">ğŸ®</span> Xbox
              </label>
              <label class="platform-chip">
                <input type="checkbox" name="libPlatform" value="switch" />
                <span class="platform-icon">ğŸ•¹ï¸</span> Switch
              </label>
              <label class="platform-chip">
                <input type="checkbox" name="libPlatform" value="mobile" />
                <span class="platform-icon">ğŸ“±</span> ç§»åŠ¨ç«¯
              </label>
            </div>
          </div>
        </div>
        
        <!-- å½“å‰ç­›é€‰æ¡ä»¶æ ‡ç­¾ -->
        <div class="active-filters" id="activeFilters">
          <span class="no-filters">æš‚æ— ç­›é€‰æ¡ä»¶</span>
        </div>
      </div>

      <!-- ç­›é€‰ç»“æœ -->
      <div class="card">
        <!-- æ’åºå’Œè§†å›¾ -->
        <div class="sort-bar">
          <div class="sort-tabs" id="sortTabs">
            <button class="sort-tab is-active" data-sort="rating">â­ è¯„åˆ†</button>
            <button class="sort-tab" data-sort="name">ğŸ”¤ åç§°</button>
            <button class="sort-tab" data-sort="year">ğŸ“… æœ€æ–°</button>
            <button class="sort-tab" data-sort="price-low">ğŸ’° ä½ä»·</button>
            <button class="sort-tab" data-sort="price-high">ğŸ’ é«˜ä»·</button>
            <button class="sort-tab" data-sort="random">ğŸ² éšæœº</button>
          </div>
          <div class="view-toggle">
            <button class="view-btn active" id="viewList" title="åˆ—è¡¨è§†å›¾">ğŸ“‹</button>
            <button class="view-btn" id="viewGrid" title="ç½‘æ ¼è§†å›¾">ğŸ“±</button>
          </div>
        </div>
        
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-bar">
          <div class="stats-count">
            <span>æ‰¾åˆ° <span class="stats-highlight" id="libResultCount">0</span> æ¬¾æ¸¸æˆ</span>
            <span>Â·</span>
            <span>å·²åŠ è½½ <span id="loadedCount">0</span>/<span id="totalCount">0</span></span>
          </div>
          <div class="stats-progress">
            <div class="stats-progress-bar" id="loadProgress" style="width: 0%"></div>
          </div>
        </div>
        
        <!-- æ¸¸æˆåˆ—è¡¨ -->
        <ol id="libList" class="ranking-list lib-scroll-container"></ol>
        
        <!-- åº•éƒ¨æç¤º -->
        <div style="text-align: center; padding: 8px; font-size: 11px; color: rgba(255,255,255,0.4);">
          ğŸ’¡ æç¤ºï¼šæ»šåŠ¨åŠ è½½æ›´å¤š Â· ç‚¹å‡»æ¸¸æˆæŸ¥çœ‹è¯¦æƒ… Â· â¤ï¸ æ”¶è—å–œæ¬¢çš„æ¸¸æˆ
        </div>
      </div>
    </section>

    <aside>
      <!-- æ•°æ®ç»Ÿè®¡ -->
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ“Š æ•°æ®ç»Ÿè®¡</div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®æ¥æº</span>
          <span class="value" style="color: #00ff88;">Steam</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ¸¸æˆæ€»æ•°</span>
          <span class="value" id="totalGamesCount">åŠ è½½ä¸­...</span>
        </div>
        <div class="sidebar-item">
          <span class="label">ç­›é€‰åŒ¹é…</span>
          <span class="value" id="matchedCount">-</span>
        </div>
      </div>
      
      <!-- å¿«æ·ç­›é€‰ -->
      <div class="sidebar-card">
        <div class="sidebar-title">âš¡ å¿«æ·ç­›é€‰</div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('free')">
          <span class="label">ğŸ†“ å…è´¹æ¸¸æˆ</span>
          <span class="value" id="freeCount">-</span>
        </div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('top')">
          <span class="label">â­ ç¥ä½œ (9.5+)</span>
          <span class="value" id="topCount">-</span>
        </div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('new')">
          <span class="label">ğŸ†• 2023æ–°ä½œ</span>
          <span class="value" id="newCount">-</span>
        </div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('action')">
          <span class="label">ğŸ¯ åŠ¨ä½œæ¸¸æˆ</span>
          <span class="value" id="actionCount">-</span>
        </div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('rpg')">
          <span class="label">âš”ï¸ RPG</span>
          <span class="value" id="rpgCount">-</span>
        </div>
      </div>
      
      <!-- çƒ­é—¨æ ‡ç­¾ -->
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ·ï¸ çƒ­é—¨æ ‡ç­¾</div>
        <div style="display: flex; flex-wrap: wrap; gap: 4px;">
          <span class="filter-tag" style="cursor: pointer;" onclick="searchTag('indie')">ç‹¬ç«‹</span>
          <span class="filter-tag" style="cursor: pointer;" onclick="searchTag('multiplayer')">å¤šäºº</span>
          <span class="filter-tag" style="cursor: pointer;" onclick="searchTag('singleplayer')">å•äºº</span>
          <span class="filter-tag" style="cursor: pointer;" onclick="searchTag('openworld')">å¼€æ”¾ä¸–ç•Œ</span>
          <span class="filter-tag" style="cursor: pointer;" onclick="searchTag('story')">å‰§æƒ…</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="real-5000-games-database.js"></script>
<script src="mega-game-database-real.js"></script>
<script>
  initCommon();

  // çŠ¶æ€å˜é‡
  let allGamesData = [];
  let filteredGames = [];
  let favorites = JSON.parse(localStorage.getItem('gameFavorites') || '[]');
  let currentPage = 0;
  const PAGE_SIZE = 20;
  let isDataLoaded = false;
  let isLoading = false;
  let currentSort = 'rating';
  let filterCollapsed = false;

  // DOM å…ƒç´ 
  const libSearch = document.getElementById("libSearch");
  const libType = document.getElementById("libType");
  const libPrice = document.getElementById("libPrice");
  const libYear = document.getElementById("libYear");
  const libRating = document.getElementById("libRating");
  const ratingValue = document.getElementById("ratingValue");
  const libReviewLevel = document.getElementById("libReviewLevel");
  const libPlatformsEl = document.getElementById('libPlatforms');
  const libPlatforms = libPlatformsEl.querySelectorAll('input[name="libPlatform"]');
  const totalGamesCountEl = document.getElementById('totalGamesCount');
  const libList = document.getElementById("libList");
  const libCount = document.getElementById("libResultCount");
  const loadedCountEl = document.getElementById("loadedCount");
  const totalCountEl = document.getElementById("totalCount");
  const sortTabs = document.getElementById("sortTabs");
  const resetFiltersBtn = document.getElementById("resetFilters");
  const activeFiltersEl = document.getElementById("activeFilters");
  const loadProgressEl = document.getElementById("loadProgress");
  const matchedCountEl = document.getElementById("matchedCount");
  const favCountEl = document.getElementById("favCount");
  const favoritesPanelEl = document.getElementById("favoritesPanel");
  const favoritesListEl = document.getElementById("favoritesList");

  // åˆå§‹åŒ–æ”¶è—
  updateFavoritesUI();

  // è¯„åˆ†æ»‘å—å¢å¼º
  libRating.addEventListener("input", () => {
    const val = parseFloat(libRating.value);
    ratingValue.textContent = val > 0 ? `${val.toFixed(1)}+` : "0.0+";
    ratingValue.className = 'rating-display ' + (val >= 8 ? 'high' : val >= 5 ? 'medium' : 'low');
  });

  // å¹³å°é€‰æ‹©å¢å¼º
  libPlatforms.forEach(cb => {
    cb.addEventListener('change', function() {
      this.closest('.platform-chip').classList.toggle('selected', this.checked);
      applyFiltersAndRender();
    });
  });

  // æŠ˜å ç­›é€‰
  document.getElementById('collapseFilters').addEventListener('click', function() {
    filterCollapsed = !filterCollapsed;
    document.getElementById('filterContent').style.display = filterCollapsed ? 'none' : 'block';
    this.textContent = filterCollapsed ? 'å±•å¼€ â–¼' : 'æ”¶èµ· â–²';
  });

  // æ”¶è—é¢æ¿
  document.getElementById('toggleFavorites').addEventListener('click', () => {
    favoritesPanelEl.classList.toggle('show');
  });

  // å¯¼å‡ºç»“æœ
  document.getElementById('exportResults').addEventListener('click', () => {
    if (filteredGames.length === 0) {
      alert('æ²¡æœ‰å¯å¯¼å‡ºçš„ç»“æœ');
      return;
    }
    const data = filteredGames.slice(0, 100).map(g => ({
      name: g.name,
      rating: g.rating,
      genre: g.genre,
      price: g.price,
      year: g.year
    }));
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'game-library-export.json';
    a.click();
  });

  // åŠ è½½æ¸¸æˆæ•°æ®
  async function loadAllGames() {
    try {
      libList.innerHTML = '<li style="text-align: center; padding: 60px; color: var(--text-muted); list-style: none;">ğŸ® æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®...</li>';
      
      allGamesData = await window.megaGameDB.getAllGames();
      isDataLoaded = true;
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allGamesData.length} æ¬¾æ¸¸æˆ`);
      
      if (totalGamesCountEl) {
        totalGamesCountEl.textContent = `${allGamesData.length}`;
      }
      
      updateQuickStats();
      applyFiltersAndRender();
    } catch (error) {
      console.error("âŒ åŠ è½½å¤±è´¥:", error);
      libList.innerHTML = '<li style="text-align: center; padding: 60px; color: var(--danger); list-style: none;">âŒ æ¸¸æˆæ•°æ®åŠ è½½å¤±è´¥</li>';
    }
  }

  // æ›´æ–°å¿«æ·ç»Ÿè®¡
  function updateQuickStats() {
    document.getElementById('freeCount').textContent = allGamesData.filter(g => !g.price || g.price === 0).length;
    document.getElementById('topCount').textContent = allGamesData.filter(g => g.rating >= 9.5).length;
    document.getElementById('newCount').textContent = allGamesData.filter(g => g.year >= 2023).length;
    document.getElementById('actionCount').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('action')).length;
    document.getElementById('rpgCount').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('rpg')).length;
  }

  // è·å–é€‰ä¸­å¹³å°
  function getSelectedPlatforms() {
    const checked = Array.from(libPlatforms).filter(cb => cb.checked).map(cb => cb.value);
    return checked.length > 0 ? checked : null;
  }

  // æ›´æ–°ç­›é€‰æ ‡ç­¾
  function updateActiveFilters() {
    const tags = [];
    
    if (libSearch.value.trim()) {
      tags.push({ type: 'search', label: `æœç´¢: ${libSearch.value}`, clear: () => { libSearch.value = ''; } });
    }
    if (libType.value !== 'all') {
      tags.push({ type: 'type', label: libType.options[libType.selectedIndex].text, clear: () => { libType.value = 'all'; } });
    }
    if (libPrice.value !== 'all') {
      tags.push({ type: 'price', label: libPrice.options[libPrice.selectedIndex].text, clear: () => { libPrice.value = 'all'; } });
    }
    if (parseFloat(libRating.value) > 0) {
      tags.push({ type: 'rating', label: `è¯„åˆ† â‰¥${libRating.value}`, clear: () => { libRating.value = '0'; ratingValue.textContent = '0.0+'; } });
    }
    if (libYear.value !== 'all') {
      tags.push({ type: 'year', label: libYear.options[libYear.selectedIndex].text, clear: () => { libYear.value = 'all'; } });
    }
    if (libReviewLevel.value !== 'all') {
      tags.push({ type: 'review', label: libReviewLevel.options[libReviewLevel.selectedIndex].text, clear: () => { libReviewLevel.value = 'all'; } });
    }
    
    if (tags.length === 0) {
      activeFiltersEl.innerHTML = '<span class="no-filters">æš‚æ— ç­›é€‰æ¡ä»¶</span>';
    } else {
      activeFiltersEl.innerHTML = tags.map((tag, i) => 
        `<span class="filter-tag">${tag.label} <span class="filter-tag-remove" data-idx="${i}">Ã—</span></span>`
      ).join('');
      
      activeFiltersEl.querySelectorAll('.filter-tag-remove').forEach((btn, i) => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          tags[i].clear();
          applyFiltersAndRender();
        });
      });
    }
  }

  // åº”ç”¨ç­›é€‰
  function applyFiltersAndRender() {
    if (!isDataLoaded) return;

    const nameKw = libSearch.value.trim().toLowerCase();
    const typeVal = libType.value;
    const priceVal = libPrice.value;
    const yearVal = libYear.value;
    const minRating = parseFloat(libRating.value);
    const reviewLevel = libReviewLevel.value;
    const platformsVal = getSelectedPlatforms();

    filteredGames = allGamesData.filter(game => {
      // åç§°æœç´¢
      if (nameKw && !game.name.toLowerCase().includes(nameKw)) return false;

      // ç±»å‹ç­›é€‰
      if (typeVal !== "all") {
        const gameGenre = (game.genre || '').toLowerCase();
        if (!gameGenre.includes(typeVal.toLowerCase())) return false;
      }

      // ä»·æ ¼ç­›é€‰
      const price = game.price || 0;
      if (priceVal === "free" && price > 0) return false;
      if (priceVal === "under50" && price >= 50) return false;
      if (priceVal === "under100" && price >= 100) return false;
      if (priceVal === "under200" && price >= 200) return false;
      if (priceVal === "over200" && price < 200) return false;

      // å¹´ä»½ç­›é€‰
      if (yearVal !== "all") {
        const gameYear = game.year || 2020;
        if (yearVal === "classic" && gameYear > 2018) return false;
        else if (yearVal === "2019" && (gameYear < 2019 || gameYear > 2020)) return false;
        else if (yearVal !== "classic" && yearVal !== "2019" && gameYear != parseInt(yearVal)) return false;
      }

      // è¯„åˆ†ç­›é€‰
      if (minRating > 0 && (game.rating || 0) < minRating) return false;

      // è¯„ä»·ç­‰çº§
      if (reviewLevel !== "all") {
        const rating = game.rating || 0;
        if (reviewLevel === "overwhelmingly" && rating < 9.5) return false;
        if (reviewLevel === "very" && rating < 8.5) return false;
        if (reviewLevel === "mostly" && rating < 7.0) return false;
      }

      // å¹³å°ç­›é€‰
      if (platformsVal) {
        const gamePlatforms = (game.platform || '').toLowerCase();
        const match = platformsVal.some(p => {
          if (p === 'steam' || p === 'pc') return gamePlatforms.includes('pc') || gamePlatforms.includes('steam');
          if (p === 'ps') return gamePlatforms.includes('ps') || gamePlatforms.includes('playstation');
          return gamePlatforms.includes(p);
        });
        if (!match) return false;
      }

      return true;
    });

    sortGames();
    updateActiveFilters();
    
    currentPage = 0;
    libList.innerHTML = "";
    libCount.textContent = filteredGames.length;
    totalCountEl.textContent = filteredGames.length;
    matchedCountEl.textContent = filteredGames.length;

    if (filteredGames.length === 0) {
      libList.innerHTML = '<li style="text-align: center; padding: 60px; color: var(--text-muted); list-style: none;">ğŸ” æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆ</li>';
      loadedCountEl.textContent = "0";
      loadProgressEl.style.width = "0%";
      return;
    }

    loadMoreGames();
  }

  // æ’åº
  function sortGames() {
    switch (currentSort) {
      case 'rating': filteredGames.sort((a, b) => (b.rating || 0) - (a.rating || 0)); break;
      case 'name': filteredGames.sort((a, b) => a.name.localeCompare(b.name)); break;
      case 'year': filteredGames.sort((a, b) => (b.year || 2020) - (a.year || 2020)); break;
      case 'price-low': filteredGames.sort((a, b) => (a.price || 0) - (b.price || 0)); break;
      case 'price-high': filteredGames.sort((a, b) => (b.price || 0) - (a.price || 0)); break;
      case 'random': filteredGames.sort(() => Math.random() - 0.5); break;
    }
  }

  // åŠ è½½æ›´å¤š
  function loadMoreGames() {
    if (isLoading) return;
    
    const start = currentPage * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageGames = filteredGames.slice(start, end);

    if (pageGames.length === 0) return;
    
    isLoading = true;

    pageGames.forEach((game, index) => {
      const globalIdx = start + index;
      const li = document.createElement("li");
      li.className = "ranking-item";
      li.style.cursor = "pointer";
      
      const isFav = favorites.includes(game.id);
      const rating = game.rating || 0;
      const categoryColor = rating >= 9.0 ? '#00ff00' : rating >= 8.0 ? '#00ccff' : '#ffaa00';

      const coverHtml = game.thumbnail
        ? `<img src="${game.thumbnail}" alt="${game.name}" style="width:100%;height:100%;object-fit:cover;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 font-size=%2240%22>ğŸ®</text></svg>'" />`
        : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:20px;background:#333;">ğŸ®</div>';

      const medalIcon = globalIdx === 0 ? "ğŸ¥‡" : globalIdx === 1 ? "ğŸ¥ˆ" : globalIdx === 2 ? "ğŸ¥‰" : "";

      li.innerHTML = `
        <div class="ranking-pos ${globalIdx < 3 ? 'ranking-pos--top1' : ''}">${medalIcon}${globalIdx + 1}</div>
        <div class="ranking-game">
          <div class="ranking-cover">${coverHtml}</div>
          <div class="ranking-info">
            <div class="ranking-name">${game.name}</div>
            <div class="ranking-meta">${(game.genre || 'Game').toUpperCase()} Â· ${game.year || '?'} Â· Â¥${game.price || 0}</div>
          </div>
        </div>
        <div class="ranking-score" style="display:flex;align-items:center;gap:8px;">
          <div>
            <span class="value" style="color:${categoryColor};">${rating.toFixed(1)}</span>
            <div><span class="tag" style="border-color:${categoryColor};color:${categoryColor};">${(game.category || 'GAME').substring(0,6).toUpperCase()}</span></div>
          </div>
          <div class="game-card-actions">
            <button class="game-action-btn ${isFav ? 'favorited' : ''}" onclick="event.stopPropagation();toggleFavorite(${game.id},'${game.name.replace(/'/g, "\\'")}')">
              ${isFav ? 'â¤ï¸' : 'ğŸ¤'}
            </button>
          </div>
        </div>
      `;

      li.addEventListener("click", () => {
        window.location.href = `game-detail.html?id=${game.id}&name=${encodeURIComponent(game.name)}`;
      });

      libList.appendChild(li);
    });

    currentPage++;
    const loaded = Math.min(currentPage * PAGE_SIZE, filteredGames.length);
    loadedCountEl.textContent = loaded;
    loadProgressEl.style.width = `${(loaded / filteredGames.length) * 100}%`;
    isLoading = false;
  }

  // æ”¶è—åŠŸèƒ½
  window.toggleFavorite = function(id, name) {
    const idx = favorites.indexOf(id);
    if (idx === -1) {
      favorites.push(id);
    } else {
      favorites.splice(idx, 1);
    }
    localStorage.setItem('gameFavorites', JSON.stringify(favorites));
    updateFavoritesUI();
    
    // æ›´æ–°å½“å‰åˆ—è¡¨ä¸­çš„æŒ‰é’®
    const btn = event.target;
    btn.classList.toggle('favorited');
    btn.textContent = favorites.includes(id) ? 'â¤ï¸' : 'ğŸ¤';
  };

  window.clearFavorites = function() {
    if (confirm('ç¡®å®šæ¸…ç©ºæ‰€æœ‰æ”¶è—å—ï¼Ÿ')) {
      favorites = [];
      localStorage.setItem('gameFavorites', JSON.stringify(favorites));
      updateFavoritesUI();
      applyFiltersAndRender();
    }
  };

  function updateFavoritesUI() {
    favCountEl.textContent = favorites.length;
    
    if (favorites.length === 0) {
      favoritesListEl.innerHTML = '<span class="no-filters">æš‚æ— æ”¶è—æ¸¸æˆ</span>';
    } else {
      const favGames = allGamesData.filter(g => favorites.includes(g.id));
      favoritesListEl.innerHTML = favGames.map(g => 
        `<span class="favorite-item">${g.name.substring(0,15)}${g.name.length > 15 ? '...' : ''} <span class="favorite-remove" onclick="toggleFavorite(${g.id},'')">Ã—</span></span>`
      ).join('');
    }
  }

  // å¿«æ·ç­›é€‰
  window.quickFilter = function(type) {
    resetFilters();
    setTimeout(() => {
      if (type === 'free') libPrice.value = 'free';
      else if (type === 'top') { libRating.value = '9.5'; ratingValue.textContent = '9.5+'; }
      else if (type === 'new') libYear.value = '2023';
      else if (type === 'action') libType.value = 'action';
      else if (type === 'rpg') libType.value = 'rpg';
      applyFiltersAndRender();
    }, 50);
  };

  window.searchTag = function(tag) {
    libSearch.value = tag;
    applyFiltersAndRender();
  };

  function resetFilters() {
    libSearch.value = "";
    libType.value = "all";
    libPrice.value = "all";
    libYear.value = "all";
    libRating.value = "0";
    ratingValue.textContent = "0.0+";
    libReviewLevel.value = "all";
    libPlatforms.forEach(cb => {
      cb.checked = cb.value === 'steam' || cb.value === 'pc';
      cb.closest('.platform-chip').classList.toggle('selected', cb.checked);
    });
  }

  // äº‹ä»¶ç›‘å¬
  libList.addEventListener("scroll", () => {
    if (isLoading) return;
    if (libList.scrollHeight - libList.scrollTop - libList.clientHeight < 200) {
      if (currentPage * PAGE_SIZE < filteredGames.length) loadMoreGames();
    }
  });

  sortTabs.addEventListener("click", (e) => {
    if (e.target.classList.contains("sort-tab")) {
      sortTabs.querySelectorAll(".sort-tab").forEach(t => t.classList.remove("is-active"));
      e.target.classList.add("is-active");
      currentSort = e.target.dataset.sort;
      applyFiltersAndRender();
    }
  });

  resetFiltersBtn.addEventListener("click", () => {
    resetFilters();
    applyFiltersAndRender();
  });

  // è¾“å…¥ç›‘å¬
  libSearch.addEventListener("input", debounce(applyFiltersAndRender, 300));
  libType.addEventListener("change", applyFiltersAndRender);
  libPrice.addEventListener("change", applyFiltersAndRender);
  libYear.addEventListener("change", applyFiltersAndRender);
  libRating.addEventListener("change", applyFiltersAndRender);
  libReviewLevel.addEventListener("change", applyFiltersAndRender);

  function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  // åˆå§‹åŠ è½½
  loadAllGames();
</script>
</body>
</html>
