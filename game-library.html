<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æ¸¸æˆåº“</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
  <link rel="stylesheet" href="cyberpunk-styles.css" />
  <style>
    /* æ¸¸æˆåº“ä¸“ç”¨æ»šåŠ¨åˆ—è¡¨æ ·å¼ */
    .lib-scroll-container {
      max-height: 600px;
      overflow-y: auto;
      padding-right: 4px;
      /* Firefox */
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 255, 136, 0.6) rgba(0, 0, 0, 0.3);
    }
    
    /* Chrome / Edge / Safari */
    .lib-scroll-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .lib-scroll-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
      margin: 4px;
    }
    
    .lib-scroll-container::-webkit-scrollbar-thumb {
      border-radius: 999px;
      background: linear-gradient(
        180deg,
        rgba(0, 255, 136, 0.8),
        rgba(0, 200, 100, 0.9)
      );
      border: 2px solid rgba(0, 0, 0, 0.5);
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }
    
    .lib-scroll-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(
        180deg,
        rgba(0, 255, 136, 1),
        rgba(0, 255, 200, 1)
      );
      box-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
    }

    /* ç­›é€‰åŒºåŸŸæ ·å¼ä¼˜åŒ– */
    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }
    
    .filter-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .filter-item label {
      font-size: 12px;
      color: var(--text-soft);
      font-weight: 500;
    }
    
    .filter-item input,
    .filter-item select {
      padding: 8px 12px;
      font-size: 13px;
      border-radius: 6px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(0, 255, 136, 0.3);
      color: var(--text-main);
      transition: all 0.3s ease;
    }
    
    .filter-item input:focus,
    .filter-item select:focus {
      outline: none;
      border-color: rgba(0, 255, 136, 0.8);
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.3);
    }
    
    .platform-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    .platform-checkboxes label {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 255, 136, 0.2);
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .platform-checkboxes label:hover {
      border-color: rgba(0, 255, 136, 0.5);
      background: rgba(0, 255, 136, 0.1);
    }
    
    .platform-checkboxes input:checked + span {
      color: #00ff88;
    }
    
    /* æ’åºæŒ‰é’®ç»„ */
    .sort-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .sort-tab {
      padding: 6px 14px;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(0, 255, 136, 0.2);
      border-radius: 4px;
      color: var(--text-soft);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .sort-tab:hover {
      border-color: rgba(0, 255, 136, 0.5);
      color: var(--text-main);
    }
    
    .sort-tab.is-active {
      background: rgba(0, 255, 136, 0.2);
      border-color: rgba(0, 255, 136, 0.8);
      color: #00ff88;
    }
    
    /* åŠ è½½æç¤º */
    .lib-hint {
      text-align: center;
      padding: 10px;
      font-size: 12px;
      color: var(--text-soft);
      border-top: 1px solid rgba(0, 255, 136, 0.1);
      margin-top: 10px;
    }
    
    /* è¯„åˆ†èŒƒå›´æ»‘å— */
    .rating-slider {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .rating-slider input[type="range"] {
      flex: 1;
      height: 4px;
      background: rgba(0, 255, 136, 0.3);
      border-radius: 2px;
      -webkit-appearance: none;
    }
    
    .rating-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      background: #00ff88;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
    }
    
    .rating-value {
      min-width: 40px;
      text-align: center;
      color: #00ff88;
      font-weight: bold;
    }
  </style>
</head>
<body data-current-page="library" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>

      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æ¸¸æˆåº“</div>
        <div class="page-intro">
          ä» 5000+ æ¬¾çœŸå® Steam æ¸¸æˆä¸­ï¼Œé€šè¿‡å¤šç§ç­›é€‰æ¡ä»¶æ‰¾åˆ°ä½ æ„Ÿå…´è¶£çš„æ¸¸æˆã€‚
        </div>
      </div>

      <!-- ç­›é€‰æ¡ä»¶å¡ç‰‡ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>ç­›é€‰æ¡ä»¶</span>
          </div>
          <button id="resetFilters" class="btn-secondary" style="padding: 4px 12px; font-size: 11px;">é‡ç½®ç­›é€‰</button>
        </header>

        <div class="filter-grid">
          <!-- æœç´¢æ¡† -->
          <div class="filter-item" style="grid-column: span 2;">
            <label for="libSearch">ğŸ” æŒ‰åç§°æœç´¢</label>
            <input type="text" id="libSearch" placeholder="è¾“å…¥æ¸¸æˆåï¼Œå¦‚ï¼šPortal 2ã€Counter-Strike" />
          </div>
          
          <!-- æ¸¸æˆç±»å‹ -->
          <div class="filter-item">
            <label for="libType">ğŸ® æ¸¸æˆç±»å‹</label>
            <select id="libType">
              <option value="all">å…¨éƒ¨ç±»å‹</option>
              <option value="action">åŠ¨ä½œ / Action</option>
              <option value="rpg">è§’è‰²æ‰®æ¼” / RPG</option>
              <option value="shooter">å°„å‡» / Shooter</option>
              <option value="strategy">ç­–ç•¥ / Strategy</option>
              <option value="adventure">å†’é™© / Adventure</option>
              <option value="simulation">æ¨¡æ‹Ÿ / Simulation</option>
              <option value="puzzle">è§£è°œ / Puzzle</option>
              <option value="platformer">å¹³å° / Platformer</option>
              <option value="survival">ç”Ÿå­˜ / Survival</option>
              <option value="horror">ææ€– / Horror</option>
              <option value="racing">èµ›è½¦ / Racing</option>
              <option value="sports">ä½“è‚² / Sports</option>
              <option value="indie">ç‹¬ç«‹ / Indie</option>
            </select>
          </div>

          <!-- ä»·æ ¼åŒºé—´ -->
          <div class="filter-item">
            <label for="libPrice">ğŸ’° ä»·æ ¼åŒºé—´</label>
            <select id="libPrice">
              <option value="all">å…¨éƒ¨ä»·æ ¼</option>
              <option value="free">å…è´¹ / F2P</option>
              <option value="under50">50 å…ƒä»¥ä¸‹</option>
              <option value="under100">100 å…ƒä»¥ä¸‹</option>
              <option value="under200">200 å…ƒä»¥ä¸‹</option>
              <option value="over200">200 å…ƒä»¥ä¸Š</option>
            </select>
          </div>
          
          <!-- æœ€ä½è¯„åˆ† -->
          <div class="filter-item">
            <label>â­ æœ€ä½è¯„åˆ†</label>
            <div class="rating-slider">
              <input type="range" id="libRating" min="0" max="10" step="0.5" value="0" />
              <span class="rating-value" id="ratingValue">0.0</span>
            </div>
          </div>
          
          <!-- å‘è¡Œå¹´ä»½ -->
          <div class="filter-item">
            <label for="libYear">ğŸ“… å‘è¡Œå¹´ä»½</label>
            <select id="libYear">
              <option value="all">å…¨éƒ¨å¹´ä»½</option>
              <option value="2023">2023 å¹´</option>
              <option value="2022">2022 å¹´</option>
              <option value="2021">2021 å¹´</option>
              <option value="2020">2020 å¹´åŠæ›´æ—©</option>
            </select>
          </div>
        </div>
        
        <!-- å¹³å°ç­›é€‰ -->
        <div style="margin-top: 12px;">
          <label style="font-size: 12px; color: var(--text-soft); display: block; margin-bottom: 8px;">ğŸ–¥ï¸ å¹³å°ï¼ˆå¯å¤šé€‰ï¼‰</label>
          <div class="platform-checkboxes" id="libPlatforms">
            <label><input type="checkbox" name="libPlatform" value="steam" checked /><span>Steam</span></label>
            <label><input type="checkbox" name="libPlatform" value="pc" checked /><span>PC</span></label>
            <label><input type="checkbox" name="libPlatform" value="ps" /><span>PlayStation</span></label>
            <label><input type="checkbox" name="libPlatform" value="xbox" /><span>Xbox</span></label>
            <label><input type="checkbox" name="libPlatform" value="switch" /><span>Switch</span></label>
            <label><input type="checkbox" name="libPlatform" value="mobile" /><span>ç§»åŠ¨ç«¯</span></label>
          </div>
        </div>
      </div>

      <!-- ç­›é€‰ç»“æœå¡ç‰‡ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>ç­›é€‰ç»“æœ</span>
          </div>
          <div class="chip" id="libResultCount">å…± 0 æ¬¾</div>
        </header>
        
        <!-- æ’åºé€‰é¡¹ -->
        <div class="sort-tabs" id="sortTabs">
          <button class="sort-tab is-active" data-sort="rating">è¯„åˆ†æœ€é«˜</button>
          <button class="sort-tab" data-sort="name">åç§° A-Z</button>
          <button class="sort-tab" data-sort="year">æœ€æ–°å‘å¸ƒ</button>
          <button class="sort-tab" data-sort="price-low">ä»·æ ¼æœ€ä½</button>
          <button class="sort-tab" data-sort="price-high">ä»·æ ¼æœ€é«˜</button>
        </div>
        
        <!-- æ»šåŠ¨åˆ—è¡¨å®¹å™¨ -->
        <ol id="libList" class="ranking-list lib-scroll-container"></ol>
        
        <!-- åŠ è½½æç¤º -->
        <div class="lib-hint" id="libHint">
          å·²åŠ è½½ <span id="loadedCount">0</span> / <span id="totalCount">0</span> æ¬¾ Â· æ»šåŠ¨åŠ è½½æ›´å¤š
        </div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ“Š æ•°æ®ç»Ÿè®¡</div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®æ¥æº</span>
          <span class="value">Steam API</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ¸¸æˆæ€»æ•°</span>
          <span class="value" id="totalGamesCount">åŠ è½½ä¸­...</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®æ›´æ–°</span>
          <span class="value">å®æ—¶</span>
        </div>
      </div>
      
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ¯ å¿«æ·ç­›é€‰</div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('free')">
          <span class="label">ğŸ†“ å…è´¹æ¸¸æˆ</span>
          <span class="value">â†’</span>
        </div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('top')">
          <span class="label">â­ é«˜è¯„åˆ† (9+)</span>
          <span class="value">â†’</span>
        </div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('action')">
          <span class="label">ğŸ® åŠ¨ä½œæ¸¸æˆ</span>
          <span class="value">â†’</span>
        </div>
        <div class="sidebar-item" style="cursor: pointer;" onclick="quickFilter('rpg')">
          <span class="label">âš”ï¸ RPGæ¸¸æˆ</span>
          <span class="value">â†’</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<!-- ğŸ® 5000æ¬¾çœŸå®Steamæ¸¸æˆæ•°æ®åº“ -->
<script src="real-5000-games-database.js"></script>
<script src="mega-game-database-real.js"></script>
<script>
  initCommon();

  // çŠ¶æ€å˜é‡
  let allGamesData = [];
  let filteredGames = [];
  let currentPage = 0;
  const PAGE_SIZE = 20;
  let isDataLoaded = false;
  let isLoading = false;
  let currentSort = 'rating';

  // DOM å…ƒç´ 
  const libSearch = document.getElementById("libSearch");
  const libType = document.getElementById("libType");
  const libPrice = document.getElementById("libPrice");
  const libYear = document.getElementById("libYear");
  const libRating = document.getElementById("libRating");
  const ratingValue = document.getElementById("ratingValue");
  const libPlatformsEl = document.getElementById('libPlatforms');
  const libPlatforms = libPlatformsEl.querySelectorAll('input[name="libPlatform"]');
  const totalGamesCountEl = document.getElementById('totalGamesCount');
  const libList = document.getElementById("libList");
  const libCount = document.getElementById("libResultCount");
  const loadedCountEl = document.getElementById("loadedCount");
  const totalCountEl = document.getElementById("totalCount");
  const sortTabs = document.getElementById("sortTabs");
  const resetFiltersBtn = document.getElementById("resetFilters");

  // è¯„åˆ†æ»‘å—æ›´æ–°
  libRating.addEventListener("input", () => {
    ratingValue.textContent = parseFloat(libRating.value).toFixed(1);
  });

  // åŠ è½½æ‰€æœ‰æ¸¸æˆæ•°æ®
  async function loadAllGames() {
    try {
      libList.innerHTML = '<li style="text-align: center; padding: 60px; color: var(--text-muted); list-style: none;">ğŸ® æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®...</li>';
      
      allGamesData = await window.megaGameDB.getAllGames();
      isDataLoaded = true;
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allGamesData.length} æ¬¾æ¸¸æˆ`);
      
      if (totalGamesCountEl) {
        totalGamesCountEl.textContent = `${allGamesData.length} æ¬¾`;
      }
      applyFiltersAndRender();
    } catch (error) {
      console.error("âŒ åŠ è½½å¤±è´¥:", error);
      libList.innerHTML = '<li style="text-align: center; padding: 60px; color: var(--danger); list-style: none;">âŒ æ¸¸æˆæ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</li>';
    }
  }

  // è·å–é€‰ä¸­çš„å¹³å°
  function getSelectedPlatforms() {
    const checked = Array.from(libPlatforms).filter(cb => cb.checked).map(cb => cb.value);
    return checked.length > 0 ? checked : null;
  }

  // åº”ç”¨ç­›é€‰æ¡ä»¶
  function applyFiltersAndRender() {
    if (!isDataLoaded) return;

    const nameKw = libSearch.value.trim().toLowerCase();
    const typeVal = libType.value;
    const priceVal = libPrice.value;
    const yearVal = libYear.value;
    const minRating = parseFloat(libRating.value);
    const platformsVal = getSelectedPlatforms();

    // ç­›é€‰æ¸¸æˆ
    filteredGames = allGamesData.filter(game => {
      // åç§°æœç´¢
      if (nameKw && !game.name.toLowerCase().includes(nameKw) && 
          !(game.short_description && game.short_description.toLowerCase().includes(nameKw))) {
        return false;
      }

      // ç±»å‹ç­›é€‰
      if (typeVal !== "all") {
        const gameGenre = (game.genre || '').toLowerCase();
        const gameCategory = (game.category || '').toLowerCase();
        if (!gameGenre.includes(typeVal.toLowerCase()) && !gameCategory.includes(typeVal.toLowerCase())) {
          return false;
        }
      }

      // ä»·æ ¼ç­›é€‰
      const price = game.price || 0;
      if (priceVal === "free" && price > 0) return false;
      if (priceVal === "under50" && price >= 50) return false;
      if (priceVal === "under100" && price >= 100) return false;
      if (priceVal === "under200" && price >= 200) return false;
      if (priceVal === "over200" && price < 200) return false;

      // å¹´ä»½ç­›é€‰
      if (yearVal !== "all") {
        const gameYear = game.year || 2020;
        if (yearVal === "2020" && gameYear > 2020) return false;
        else if (yearVal !== "2020" && gameYear != parseInt(yearVal)) return false;
      }

      // è¯„åˆ†ç­›é€‰
      if (minRating > 0 && (game.rating || 0) < minRating) return false;

      // å¹³å°ç­›é€‰
      if (platformsVal) {
        const gamePlatforms = (game.platform || '').toLowerCase();
        const matchesPlatform = platformsVal.some(p => {
          const platform = p.toLowerCase();
          if (platform === 'steam' || platform === 'pc') {
            return gamePlatforms.includes('pc') || gamePlatforms.includes('steam') || gamePlatforms.includes('windows');
          }
          if (platform === 'ps') {
            return gamePlatforms.includes('ps') || gamePlatforms.includes('playstation');
          }
          if (platform === 'xbox') {
            return gamePlatforms.includes('xbox');
          }
          return gamePlatforms.includes(platform);
        });
        if (!matchesPlatform) return false;
      }

      return true;
    });

    // æ’åº
    sortGames();

    // é‡ç½®åˆ—è¡¨
    currentPage = 0;
    libList.innerHTML = "";
    libCount.textContent = `å…± ${filteredGames.length} æ¬¾`;
    totalCountEl.textContent = filteredGames.length;

    if (filteredGames.length === 0) {
      libList.innerHTML = '<li style="text-align: center; padding: 60px; color: var(--text-muted); list-style: none;">ğŸ” æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆï¼Œè¯·è°ƒæ•´ç­›é€‰æ¡ä»¶</li>';
      loadedCountEl.textContent = "0";
      return;
    }

    // åŠ è½½ç¬¬ä¸€æ‰¹
    loadMoreGames();
  }

  // æ’åºæ¸¸æˆ
  function sortGames() {
    switch (currentSort) {
      case 'rating':
        filteredGames.sort((a, b) => (b.rating || 0) - (a.rating || 0));
        break;
      case 'name':
        filteredGames.sort((a, b) => a.name.localeCompare(b.name));
        break;
      case 'year':
        filteredGames.sort((a, b) => (b.year || 2020) - (a.year || 2020));
        break;
      case 'price-low':
        filteredGames.sort((a, b) => (a.price || 0) - (b.price || 0));
        break;
      case 'price-high':
        filteredGames.sort((a, b) => (b.price || 0) - (a.price || 0));
        break;
    }
  }

  // åŠ è½½æ›´å¤šæ¸¸æˆ
  function loadMoreGames() {
    if (isLoading) return;
    
    const start = currentPage * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageGames = filteredGames.slice(start, end);

    if (pageGames.length === 0) return;
    
    isLoading = true;

    pageGames.forEach((game, index) => {
      const globalIdx = start + index;
      const li = document.createElement("li");
      li.className = "ranking-item";
      li.style.cursor = "pointer";

      const coverHtml = game.thumbnail
        ? `<img src="${game.thumbnail}" alt="${game.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);\\'>ğŸ®</div>'" />`
        : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ®</div>';

      const rankClass = globalIdx === 0 ? "ranking-pos--top1" : "";
      const medalIcon = globalIdx === 0 ? "ğŸ¥‡" : globalIdx === 1 ? "ğŸ¥ˆ" : globalIdx === 2 ? "ğŸ¥‰" : "";
      
      const rating = game.rating || 0;
      const categoryColor = rating >= 9.0 ? '#00ff00' : rating >= 8.0 ? '#00ccff' : '#ffaa00';
      const categoryTag = (game.category || game.genre || 'Game').split(' ')[0];

      li.innerHTML = `
        <div class="ranking-pos ${rankClass}">${medalIcon}${globalIdx + 1}</div>
        <div class="ranking-game">
          <div class="ranking-cover">${coverHtml}</div>
          <div class="ranking-info">
            <div class="ranking-name">${game.name}</div>
            <div class="ranking-meta">${(game.genre || 'Game').toUpperCase()} Â· ${(game.platform || 'PC').split(',')[0].trim().toUpperCase()}</div>
          </div>
        </div>
        <div class="ranking-score">
          <span class="value" style="color: ${categoryColor};">${rating.toFixed(1)}</span>
          <div><span class="tag" style="border-color: ${categoryColor}; color: ${categoryColor};">${categoryTag.toUpperCase()}</span></div>
        </div>
      `;

      li.addEventListener("mouseenter", () => {
        li.style.backgroundColor = "rgba(0, 255, 136, 0.05)";
        li.style.transition = "all 0.3s ease";
      });

      li.addEventListener("mouseleave", () => {
        li.style.backgroundColor = "";
      });

      li.addEventListener("click", () => {
        const url = new URL("game-detail.html", window.location.href);
        url.searchParams.set("id", game.id);
        url.searchParams.set("name", game.name);
        window.location.href = url.toString();
      });

      libList.appendChild(li);
    });

    currentPage++;
    loadedCountEl.textContent = Math.min(currentPage * PAGE_SIZE, filteredGames.length);
    isLoading = false;
  }

  // ç›‘å¬åˆ—è¡¨æ»šåŠ¨ï¼ˆå†…ç½®æ»šåŠ¨æ¡ï¼‰
  libList.addEventListener("scroll", () => {
    if (isLoading) return;
    
    const scrollTop = libList.scrollTop;
    const scrollHeight = libList.scrollHeight;
    const clientHeight = libList.clientHeight;
    
    // å½“æ»šåŠ¨åˆ°è·åº•éƒ¨ 200px æ—¶åŠ è½½æ›´å¤š
    if (scrollHeight - scrollTop - clientHeight < 200) {
      if (currentPage * PAGE_SIZE < filteredGames.length) {
        loadMoreGames();
      }
    }
  });

  // æ’åºåˆ‡æ¢
  sortTabs.addEventListener("click", (e) => {
    if (e.target.classList.contains("sort-tab")) {
      sortTabs.querySelectorAll(".sort-tab").forEach(t => t.classList.remove("is-active"));
      e.target.classList.add("is-active");
      currentSort = e.target.dataset.sort;
      applyFiltersAndRender();
    }
  });

  // é‡ç½®ç­›é€‰
  resetFiltersBtn.addEventListener("click", () => {
    libSearch.value = "";
    libType.value = "all";
    libPrice.value = "all";
    libYear.value = "all";
    libRating.value = "0";
    ratingValue.textContent = "0.0";
    libPlatforms.forEach(cb => {
      cb.checked = cb.value === 'steam' || cb.value === 'pc';
    });
    applyFiltersAndRender();
  });

  // å¿«æ·ç­›é€‰
  window.quickFilter = function(type) {
    resetFiltersBtn.click();
    setTimeout(() => {
      if (type === 'free') {
        libPrice.value = 'free';
      } else if (type === 'top') {
        libRating.value = '9';
        ratingValue.textContent = '9.0';
      } else if (type === 'action') {
        libType.value = 'action';
      } else if (type === 'rpg') {
        libType.value = 'rpg';
      }
      applyFiltersAndRender();
    }, 100);
  };

  // ç›‘å¬ç­›é€‰æ¡ä»¶å˜åŒ–
  libSearch.addEventListener("input", debounce(applyFiltersAndRender, 300));
  libType.addEventListener("change", applyFiltersAndRender);
  libPrice.addEventListener("change", applyFiltersAndRender);
  libYear.addEventListener("change", applyFiltersAndRender);
  libRating.addEventListener("change", applyFiltersAndRender);
  libPlatforms.forEach(cb => cb.addEventListener("change", applyFiltersAndRender));

  // é˜²æŠ–å‡½æ•°
  function debounce(fn, delay) {
    let timer = null;
    return function(...args) {
      if (timer) clearTimeout(timer);
      timer = setTimeout(() => fn.apply(this, args), delay);
    };
  }

  // åˆå§‹åŠ è½½
  loadAllGames();
</script>
</body>
</html>
