<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>å¸–å­è¯¦æƒ… - GameBox æ¸¸ç›’</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
  <style>
    .post-detail {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 1px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .post-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--cyber-yellow);
      margin-bottom: 16px;
    }
    
    .post-meta {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .post-content {
      line-height: 1.8;
      color: var(--text-main);
      margin-bottom: 24px;
      font-size: 15px;
    }
    
    .post-actions {
      display: flex;
      gap: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 211, 0, 0.2);
    }
    
    .action-btn {
      padding: 8px 20px;
      background: rgba(85, 234, 212, 0.1);
      border: 1px solid rgba(85, 234, 212, 0.3);
      border-radius: 6px;
      color: var(--cyber-cyan);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .action-btn:hover {
      background: rgba(85, 234, 212, 0.2);
      box-shadow: 0 0 15px rgba(85, 234, 212, 0.3);
    }
    
    .comments-section {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 1px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      padding: 24px;
    }
    
    .comment-form {
      margin-bottom: 24px;
    }
    
    .comment-form textarea {
      width: 100%;
      padding: 12px;
      background: rgba(0, 0, 0, 0.5);
      border: 2px solid rgba(85, 234, 212, 0.3);
      border-radius: 6px;
      color: var(--text-main);
      font-size: 14px;
      line-height: 1.6;
      min-height: 100px;
      resize: vertical;
    }
    
    .comment-form textarea:focus {
      outline: none;
      border-color: var(--cyber-cyan);
      box-shadow: 0 0 15px rgba(85, 234, 212, 0.3);
    }
    
    .comment-item {
      padding: 16px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      margin-bottom: 12px;
      border-left: 3px solid var(--cyber-cyan);
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .comment-content {
      color: var(--text-main);
      line-height: 1.6;
    }
    
    .submit-btn {
      padding: 10px 24px;
      background: linear-gradient(135deg, rgba(85, 234, 212, 0.3), rgba(0, 255, 159, 0.3));
      color: var(--cyber-cyan);
      border: 2px solid var(--cyber-cyan);
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .submit-btn:hover {
      background: linear-gradient(135deg, rgba(85, 234, 212, 0.5), rgba(0, 255, 159, 0.5));
      box-shadow: 0 0 20px rgba(85, 234, 212, 0.4);
      transform: translateY(-2px);
    }
  </style>
</head>
<body data-current-page="community">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="community.html" data-page="community" class="nav-link">è¿”å›ç¤¾åŒº</a>
      </nav>
    </div>
  </header>
  
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>

  <main class="main">
    <section>
      <div class="card">
        <a href="community.html" style="color: var(--cyber-cyan); text-decoration: none; display: inline-block; margin-bottom: 16px;">
          â† è¿”å›ç¤¾åŒº
        </a>
      </div>

      <!-- å¸–å­è¯¦æƒ… -->
      <div id="postDetail" class="post-detail">
        <div style="text-align: center; padding: 40px; color: var(--text-muted);">
          åŠ è½½ä¸­...
        </div>
      </div>

      <!-- è¯„è®ºåŒº -->
      <div class="comments-section">
        <h3 style="color: var(--cyber-yellow); margin-bottom: 20px; font-family: 'Orbitron', sans-serif;">
          ğŸ’¬ è¯„è®ºåŒº (<span id="commentCount">0</span>)
        </h3>
        
        <div class="comment-form">
          <textarea id="commentInput" placeholder="å‘è¡¨ä½ çš„è¯„è®º...ï¼ˆè‡³å°‘5ä¸ªå­—ç¬¦ï¼‰"></textarea>
          <div style="margin-top: 12px; display: flex; justify-content: flex-end;">
            <button class="submit-btn" onclick="submitComment()">ğŸš€ å‘è¡¨è¯„è®º</button>
          </div>
        </div>
        
        <div id="commentsList">
          <div style="text-align: center; padding: 20px; color: var(--text-muted);">
            æš‚æ— è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘å§ï¼
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>

<script>
  initCommon();

  const SUPABASE_URL = 'https://gybgiqyyltckgxbdtzwu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5YmdpcXl5bHRja2d4YmR0end1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTA2MDksImV4cCI6MjA4MDM4NjYwOX0.WWF_rPUyIVOFDccLXm06Npf6J3fJoA_bbFoVJeZQzrA';

  let supabaseClient = null;
  let postId = null;
  
  function getUserId() {
    let userId = localStorage.getItem('gamebox_user_id');
    if (!userId) {
      userId = 'user-' + Date.now() + '-' + Math.random().toString(36).substring(2, 9);
      localStorage.setItem('gamebox_user_id', userId);
    }
    return userId;
  }
  
  const userId = getUserId();

  function loadSupabaseSDK() {
    return new Promise((resolve, reject) => {
      if (typeof supabase !== 'undefined') {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  async function init() {
    const params = new URLSearchParams(window.location.search);
    postId = params.get('id');
    
    if (!postId) {
      document.getElementById('postDetail').innerHTML = 
        '<div style="text-align:center;padding:40px;color:#ff4444;">âŒ å¸–å­ä¸å­˜åœ¨</div>';
      return;
    }

    try {
      await loadSupabaseSDK();
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      
      await loadPost();
      await loadComments();
      subscribeToComments();
      
    } catch (e) {
      console.error('åˆå§‹åŒ–å¤±è´¥:', e);
    }
  }

  async function loadPost() {
    try {
      const { data, error } = await supabaseClient
        .from('community_posts')
        .select('*')
        .eq('id', postId)
        .single();
      
      if (error) throw error;
      
      if (!data) {
        document.getElementById('postDetail').innerHTML = 
          '<div style="text-align:center;padding:40px;color:#ff4444;">âŒ å¸–å­ä¸å­˜åœ¨</div>';
        return;
      }
      
      // å¢åŠ æµè§ˆæ•°
      await supabaseClient
        .from('community_posts')
        .update({ views: (data.views || 0) + 1 })
        .eq('id', postId);
      
      const formatTime = (timestamp) => {
        const time = new Date(timestamp);
        return time.toLocaleString('zh-CN');
      };
      
      document.getElementById('postDetail').innerHTML = `
        <div class="post-title">${data.title}</div>
        <div class="post-meta">
          <span>ğŸ‘¤ ${data.author}</span>
          <span>ğŸ® ${data.game}</span>
          <span>ğŸ•’ ${formatTime(data.created_at)}</span>
          <span>ğŸ‘ï¸ ${(data.views || 0) + 1} æµè§ˆ</span>
        </div>
        <div class="post-content">${data.content.replace(/\n/g, '<br>')}</div>
        <div class="post-actions">
          <button class="action-btn" onclick="likePost()">
            ğŸ‘ ç‚¹èµ (<span id="likeCount">${data.likes || 0}</span>)
          </button>
          <button class="action-btn">
            ğŸ’¬ è¯„è®º (<span id="replyCount">${data.replies || 0}</span>)
          </button>
        </div>
      `;
      
    } catch (e) {
      console.error('åŠ è½½å¸–å­å¤±è´¥:', e);
      document.getElementById('postDetail').innerHTML = 
        '<div style="text-align:center;padding:40px;color:#ff4444;">âŒ åŠ è½½å¤±è´¥: ' + e.message + '</div>';
    }
  }

  async function loadComments() {
    try {
      const { data, error } = await supabaseClient
        .from('community_comments')
        .select('*')
        .eq('post_id', postId)
        .order('created_at', { ascending: true });
      
      if (error) throw error;
      
      const commentsList = document.getElementById('commentsList');
      const commentCount = document.getElementById('commentCount');
      
      commentCount.textContent = data.length;
      
      if (data.length === 0) {
        commentsList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">æš‚æ— è¯„è®ºï¼Œæ¥æŠ¢æ²™å‘å§ï¼</div>';
        return;
      }
      
      const formatTime = (timestamp) => {
        const now = new Date();
        const time = new Date(timestamp);
        const diff = Math.floor((now - time) / 1000);
        
        if (diff < 60) return 'åˆšåˆš';
        if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
        if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
        return time.toLocaleDateString();
      };
      
      commentsList.innerHTML = data.map(comment => `
        <div class="comment-item">
          <div class="comment-header">
            <span>ğŸ‘¤ ${comment.author}</span>
            <span>ğŸ•’ ${formatTime(comment.created_at)}</span>
          </div>
          <div class="comment-content">${comment.content}</div>
        </div>
      `).join('');
      
    } catch (e) {
      console.error('åŠ è½½è¯„è®ºå¤±è´¥:', e);
    }
  }

  async function submitComment() {
    const input = document.getElementById('commentInput');
    const content = input.value.trim();
    
    if (!content || content.length < 5) {
      alert('è¯„è®ºå†…å®¹è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦');
      return;
    }
    
    try {
      const { error } = await supabaseClient
        .from('community_comments')
        .insert({
          post_id: postId,
          author: 'è®¿å®¢' + Math.floor(Math.random() * 10000),
          content: content,
          created_at: new Date().toISOString()
        });
      
      if (error) throw error;
      
      // æ›´æ–°å¸–å­çš„å›å¤æ•°
      const { data: post } = await supabaseClient
        .from('community_posts')
        .select('replies')
        .eq('id', postId)
        .single();
      
      await supabaseClient
        .from('community_posts')
        .update({ replies: (post.replies || 0) + 1 })
        .eq('id', postId);
      
      input.value = '';
      alert('âœ… è¯„è®ºå‘è¡¨æˆåŠŸï¼');
      
    } catch (e) {
      console.error('å‘è¡¨è¯„è®ºå¤±è´¥:', e);
      alert('âŒ å‘è¡¨å¤±è´¥: ' + e.message);
    }
  }

  async function likePost() {
    try {
      const { data } = await supabaseClient
        .from('community_posts')
        .select('likes')
        .eq('id', postId)
        .single();
      
      await supabaseClient
        .from('community_posts')
        .update({ likes: (data.likes || 0) + 1 })
        .eq('id', postId);
      
      document.getElementById('likeCount').textContent = (data.likes || 0) + 1;
      
    } catch (e) {
      console.error('ç‚¹èµå¤±è´¥:', e);
    }
  }

  function subscribeToComments() {
    try {
      supabaseClient
        .channel('post-comments-' + postId)
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'community_comments',
          filter: 'post_id=eq.' + postId
        }, () => {
          loadComments();
        })
        .subscribe();
    } catch (e) {
      console.error('è®¢é˜…è¯„è®ºå¤±è´¥:', e);
    }
  }

  init();
</script>
</body>
</html>
