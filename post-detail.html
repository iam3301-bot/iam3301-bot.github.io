<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>å¸–å­è¯¦æƒ… - GameBox ç¤¾åŒº</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
  <style>
    /* å¸–å­è¯¦æƒ…é¡µä¸“å±æ ·å¼ */
    .post-detail-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      padding-top: 20px; /* æ— å¯¼èˆªæ ï¼Œç›´æ¥ä»é¡¶éƒ¨å¼€å§‹ */
    }
    
    /* è¿”å›æŒ‰é’® */
    .back-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 18px;
      background: rgba(0, 0, 0, 0.6);
      border: 2px solid rgba(255, 211, 0, 0.4);
      border-radius: 8px;
      color: var(--cyber-yellow);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      margin-bottom: 16px;
    }
    
    .back-btn:hover {
      border-color: var(--cyber-yellow);
      box-shadow: 0 0 15px rgba(255, 211, 0, 0.3);
      transform: translateX(-5px);
    }
    
    /* å¸–å­å†…å®¹å¡ç‰‡ */
    .post-content-card {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 2px solid rgba(255, 211, 0, 0.3);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 4px 20px rgba(255, 211, 0, 0.1);
    }
    
    .post-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(255, 211, 0, 0.2);
      gap: 15px;
    }
    
    .post-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 26px;
      font-weight: 700;
      color: var(--cyber-yellow);
      margin: 0;
      flex: 1;
      line-height: 1.3;
    }
    
    .post-badges {
      display: flex;
      gap: 10px;
    }
    
    .post-badge {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .badge-pinned {
      background: linear-gradient(135deg, #ff3d94 0%, #d946ef 100%);
      color: white;
    }
    
    .badge-board {
      background: rgba(255, 211, 0, 0.2);
      color: var(--cyber-yellow);
      border: 1px solid var(--cyber-yellow);
    }
    
    .post-meta {
      display: flex;
      align-items: center;
      gap: 20px;
      color: var(--text-muted);
      font-size: 13px;
      margin-bottom: 20px;
    }
    
    .post-meta-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .post-body {
      color: var(--text-primary);
      font-size: 16px;
      line-height: 1.8;
      margin-bottom: 30px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .post-actions {
      display: flex;
      gap: 15px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 211, 0, 0.2);
    }
    
    .action-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .action-btn:hover {
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
      box-shadow: 0 0 15px rgba(255, 211, 0, 0.2);
    }
    
    .action-btn.active {
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
      background: rgba(255, 211, 0, 0.1);
    }
    
    /* è¯„è®ºåŒº */
    .comments-section {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 2px solid rgba(255, 211, 0, 0.3);
      border-radius: 12px;
      padding: 30px;
    }
    
    .comments-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(255, 211, 0, 0.2);
    }
    
    .comments-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      font-weight: 600;
      color: var(--cyber-yellow);
    }
    
    .comments-count {
      color: var(--text-muted);
      font-size: 14px;
    }
    
    /* å‘è¡¨è¯„è®ºè¡¨å• */
    .comment-form {
      margin-bottom: 30px;
    }
    
    .comment-input {
      width: 100%;
      min-height: 100px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Rajdhani', sans-serif;
      resize: vertical;
      transition: all 0.3s ease;
    }
    
    .comment-input:focus {
      outline: none;
      border-color: var(--cyber-yellow);
      box-shadow: 0 0 15px rgba(255, 211, 0, 0.2);
    }
    
    .comment-input::placeholder {
      color: var(--text-muted);
    }
    
    .comment-submit-btn {
      margin-top: 10px;
      padding: 12px 30px;
      background: linear-gradient(135deg, var(--cyber-yellow) 0%, #ff3d94 100%);
      border: none;
      border-radius: 8px;
      color: #000;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Orbitron', sans-serif;
    }
    
    .comment-submit-btn:hover {
      box-shadow: 0 0 20px rgba(255, 211, 0, 0.5);
      transform: translateY(-2px);
    }
    
    .comment-submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* è¯„è®ºåˆ—è¡¨ */
    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .comment-item {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 211, 0, 0.2);
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s ease;
    }
    
    .comment-item:hover {
      border-color: rgba(255, 211, 0, 0.4);
      background: rgba(0, 0, 0, 0.4);
    }
    
    .comment-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .comment-author {
      font-weight: 600;
      color: var(--cyber-yellow);
      font-size: 14px;
    }
    
    .comment-time {
      color: var(--text-muted);
      font-size: 12px;
    }
    
    .comment-content {
      color: var(--text-primary);
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .no-comments {
      text-align: center;
      color: var(--text-muted);
      padding: 40px;
      font-size: 14px;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--cyber-yellow);
      min-height: 200px;
    }
    
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 211, 0, 0.2);
      border-top-color: var(--cyber-yellow);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* é”™è¯¯æç¤º */
    .error-message {
      background: rgba(255, 0, 0, 0.1);
      border: 2px solid rgba(255, 0, 0, 0.5);
      border-radius: 8px;
      padding: 20px;
      color: #ff6b6b;
      text-align: center;
      margin: 20px 0;
    }
  </style>
</head>
<body>
  <!-- Matrix èƒŒæ™¯ -->
  <canvas id="matrix"></canvas>

  <!-- ç²’å­èƒŒæ™¯ -->
  <div id="particles-js"></div>

  <!-- ç§»é™¤å¯¼èˆªæ ï¼Œä¿æŒç®€æ´ -->

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="post-detail-container">
    <!-- è¿”å›æŒ‰é’® -->
    <a href="community.html" class="back-btn">
      <span>â†</span>
      <span>è¿”å›ç¤¾åŒº</span>
    </a>

    <!-- åŠ è½½ä¸­ -->
    <div id="loading-container" class="loading">
      <div class="loading-spinner"></div>
      <p>åŠ è½½å¸–å­è¯¦æƒ…ä¸­...</p>
    </div>

    <!-- é”™è¯¯æç¤º -->
    <div id="error-container" style="display: none;"></div>

    <!-- å¸–å­å†…å®¹ -->
    <div id="post-content" style="display: none;"></div>

    <!-- è¯„è®ºåŒº -->
    <div id="comments-section" class="comments-section" style="display: none;">
      <div class="comments-header">
        <h2 class="comments-title">ğŸ’¬ è¯„è®ºåŒº</h2>
        <span class="comments-count" id="comments-count">0 æ¡è¯„è®º</span>
      </div>

      <!-- å‘è¡¨è¯„è®º -->
      <div class="comment-form">
        <textarea 
          id="comment-input" 
          class="comment-input" 
          placeholder="å‘è¡¨ä½ çš„çœ‹æ³•...ï¼ˆæœ€å°‘ 5 ä¸ªå­—ç¬¦ï¼‰"
          maxlength="2000"
        ></textarea>
        <button id="submit-comment-btn" class="comment-submit-btn">
          ğŸš€ å‘è¡¨è¯„è®º
        </button>
      </div>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <div id="comments-list" class="comments-list"></div>
    </div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Common Scripts -->
  <script src="common.js"></script>
  <script src="cyber-effects.js"></script>

  <script>
    // åˆå§‹åŒ–é€šç”¨åŠŸèƒ½
    if (typeof initCommon === 'function') {
      initCommon();
    }
  </script>

  <script>
    // ========== Supabase é…ç½® ==========
    const SUPABASE_URL = 'https://gybgiqyyltckgxbdtzwu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5YmdpcXl5bHRja2d4YmR0end1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTA2MDksImV4cCI6MjA4MDM4NjYwOX0.WWF_rPUyIVOFDccLXm06Npf6J3fJoA_bbFoVJeZQzrA';
    
    let supabaseClient = null;
    let currentPost = null;
    let currentUser = null;
    let commentsSubscription = null;

    // ========== åˆå§‹åŒ– ==========
    async function init() {
      console.log('ğŸš€ åˆå§‹åŒ–å¸–å­è¯¦æƒ…é¡µ...');
      
      // åˆ›å»º Supabase å®¢æˆ·ç«¯
      try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('âœ… Supabase å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
      } catch (error) {
        console.error('âŒ Supabase å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥:', error);
        showError('æ•°æ®åº“è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        return;
      }

      // è·å–å½“å‰ç”¨æˆ·
      currentUser = getCurrentUser();
      console.log('ğŸ”· å½“å‰ç”¨æˆ·:', currentUser);

      // è·å– URL å‚æ•°ä¸­çš„å¸–å­ ID
      const urlParams = new URLSearchParams(window.location.search);
      const postId = urlParams.get('id');

      if (!postId) {
        showError('æœªæ‰¾åˆ°å¸–å­ ID');
        return;
      }

      // åŠ è½½å¸–å­å†…å®¹
      await loadPost(postId);

      // åŠ è½½è¯„è®º
      await loadComments(postId);

      // è®¢é˜…è¯„è®ºæ›´æ–°ï¼ˆRealtimeï¼‰
      subscribeToComments(postId);

      // ç»‘å®šäº‹ä»¶
      bindEvents(postId);
    }

    // ========== è·å–å½“å‰ç”¨æˆ· ==========
    function getCurrentUser() {
      let userId = localStorage.getItem('gamebox_user_id');
      let username = localStorage.getItem('gamebox_username');

      if (!userId) {
        userId = 'user-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        username = 'è®¿å®¢' + Math.floor(Math.random() * 10000);
        localStorage.setItem('gamebox_user_id', userId);
        localStorage.setItem('gamebox_username', username);
      }

      return { id: userId, name: username };
    }

    // ========== åŠ è½½å¸–å­ ==========
    async function loadPost(postId) {
      try {
        console.log('ğŸ“¥ åŠ è½½å¸–å­:', postId);

        const { data, error } = await supabaseClient
          .from('community_posts')
          .select('*')
          .eq('id', postId)
          .single();

        if (error) {
          console.error('âŒ åŠ è½½å¸–å­å¤±è´¥:', error);
          showError('åŠ è½½å¸–å­å¤±è´¥ï¼š' + error.message);
          return;
        }

        if (!data) {
          showError('å¸–å­ä¸å­˜åœ¨');
          return;
        }

        currentPost = data;
        console.log('âœ… å¸–å­åŠ è½½æˆåŠŸ:', currentPost);

        // å¢åŠ æµè§ˆæ•°
        await incrementViews(postId);

        // æ¸²æŸ“å¸–å­
        renderPost(currentPost);

        // éšè—åŠ è½½æç¤º
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('post-content').style.display = 'block';
        document.getElementById('comments-section').style.display = 'block';

      } catch (error) {
        console.error('âŒ åŠ è½½å¸–å­å¼‚å¸¸:', error);
        showError('åŠ è½½å¸–å­æ—¶å‘ç”Ÿé”™è¯¯');
      }
    }

    // ========== å¢åŠ æµè§ˆæ•° ==========
    async function incrementViews(postId) {
      try {
        const { error } = await supabaseClient
          .from('community_posts')
          .update({ views: (currentPost.views || 0) + 1 })
          .eq('id', postId);

        if (error) {
          console.error('âŒ æ›´æ–°æµè§ˆæ•°å¤±è´¥:', error);
        } else {
          console.log('âœ… æµè§ˆæ•° +1');
        }
      } catch (error) {
        console.error('âŒ æ›´æ–°æµè§ˆæ•°å¼‚å¸¸:', error);
      }
    }

    // ========== æ¸²æŸ“å¸–å­ ==========
    function renderPost(post) {
      const postContentHTML = `
        <div class="post-content-card">
          <div class="post-header">
            <h1 class="post-title">${escapeHtml(post.title)}</h1>
            <div class="post-badges">
              ${post.pinned ? '<span class="post-badge badge-pinned">ğŸ“Œ ç½®é¡¶</span>' : ''}
              <span class="post-badge badge-board">${getBoardName(post.board)}</span>
            </div>
          </div>

          <div class="post-meta">
            <span class="post-meta-item">
              <span>ğŸ‘¤</span>
              <span>${escapeHtml(post.author)}</span>
            </span>
            <span class="post-meta-item">
              <span>ğŸ®</span>
              <span>${escapeHtml(post.game || 'æœªåˆ†ç±»')}</span>
            </span>
            <span class="post-meta-item">
              <span>ğŸ“…</span>
              <span>${formatDate(post.created_at)}</span>
            </span>
            <span class="post-meta-item">
              <span>ğŸ‘ï¸</span>
              <span>${post.views || 0} æµè§ˆ</span>
            </span>
          </div>

          <div class="post-body">${escapeHtml(post.content)}</div>

          <div class="post-actions">
            <button class="action-btn like-btn" id="like-btn" data-post-id="${post.id}">
              <span>ğŸ‘</span>
              <span id="like-count">${post.likes || 0}</span>
            </button>
            <button class="action-btn">
              <span>ğŸ’¬</span>
              <span id="reply-count">${post.replies || 0}</span>
            </button>
            <button class="action-btn">
              <span>ğŸ”—</span>
              <span>åˆ†äº«</span>
            </button>
          </div>
        </div>
      `;

      document.getElementById('post-content').innerHTML = postContentHTML;
    }

    // ========== åŠ è½½è¯„è®º ==========
    async function loadComments(postId) {
      try {
        console.log('ğŸ“¥ åŠ è½½è¯„è®º:', postId);

        const { data, error } = await supabaseClient
          .from('community_comments')
          .select('*')
          .eq('post_id', postId)
          .order('created_at', { ascending: false });

        if (error) {
          console.error('âŒ åŠ è½½è¯„è®ºå¤±è´¥:', error);
          // å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºæç¤º
          if (error.code === '42P01') {
            document.getElementById('comments-list').innerHTML = `
              <div class="no-comments">
                <p>è¯„è®ºåŠŸèƒ½å°šæœªå¼€å¯</p>
                <p style="margin-top: 10px; font-size: 12px;">ç®¡ç†å‘˜éœ€è¦å…ˆåˆ›å»ºè¯„è®ºè¡¨</p>
              </div>
            `;
            document.getElementById('submit-comment-btn').disabled = true;
          }
          return;
        }

        console.log('âœ… è¯„è®ºåŠ è½½æˆåŠŸ:', data?.length || 0, 'æ¡');
        renderComments(data || []);

      } catch (error) {
        console.error('âŒ åŠ è½½è¯„è®ºå¼‚å¸¸:', error);
      }
    }

    // ========== æ¸²æŸ“è¯„è®º ==========
    function renderComments(comments) {
      const commentsCount = comments.length;
      document.getElementById('comments-count').textContent = `${commentsCount} æ¡è¯„è®º`;

      if (commentsCount === 0) {
        document.getElementById('comments-list').innerHTML = `
          <div class="no-comments">
            <p>æš‚æ— è¯„è®ºï¼Œå¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§ï¼</p>
          </div>
        `;
        return;
      }

      const commentsHTML = comments.map(comment => `
        <div class="comment-item" data-id="${comment.id}">
          <div class="comment-header">
            <span class="comment-author">${escapeHtml(comment.author)}</span>
            <span class="comment-time">${formatDate(comment.created_at)}</span>
          </div>
          <div class="comment-content">${escapeHtml(comment.content)}</div>
        </div>
      `).join('');

      document.getElementById('comments-list').innerHTML = commentsHTML;
    }

    // ========== è®¢é˜…è¯„è®ºæ›´æ–°ï¼ˆRealtimeï¼‰==========
    function subscribeToComments(postId) {
      try {
        console.log('ğŸ”” è®¢é˜…è¯„è®º Realtime æ›´æ–°:', postId);

        commentsSubscription = supabaseClient
          .channel('comments-' + postId)
          .on(
            'postgres_changes',
            {
              event: '*',
              schema: 'public',
              table: 'community_comments',
              filter: `post_id=eq.${postId}`
            },
            (payload) => {
              console.log('ğŸ”” æ”¶åˆ°è¯„è®ºæ›´æ–°:', payload);
              
              if (payload.eventType === 'INSERT') {
                // æ–°è¯„è®º
                loadComments(postId);
                
                // æ›´æ–°å¸–å­å›å¤æ•°
                if (currentPost) {
                  currentPost.replies = (currentPost.replies || 0) + 1;
                  document.getElementById('reply-count').textContent = currentPost.replies;
                  
                  // åŒæ­¥åˆ°æ•°æ®åº“
                  supabaseClient
                    .from('community_posts')
                    .update({ replies: currentPost.replies })
                    .eq('id', postId)
                    .then(() => console.log('âœ… å›å¤æ•°å·²æ›´æ–°'));
                }
              } else if (payload.eventType === 'DELETE') {
                // åˆ é™¤è¯„è®º
                loadComments(postId);
              }
            }
          )
          .subscribe();

        console.log('âœ… Realtime è®¢é˜…æˆåŠŸ');
      } catch (error) {
        console.error('âŒ Realtime è®¢é˜…å¤±è´¥:', error);
      }
    }

    // ========== å‘è¡¨è¯„è®º ==========
    async function submitComment(postId) {
      const input = document.getElementById('comment-input');
      const content = input.value.trim();

      if (content.length < 5) {
        alert('è¯„è®ºå†…å®¹è‡³å°‘ 5 ä¸ªå­—ç¬¦');
        return;
      }

      const submitBtn = document.getElementById('submit-comment-btn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'å‘è¡¨ä¸­...';

      try {
        console.log('ğŸ“¤ å‘è¡¨è¯„è®º:', content);

        // ç”Ÿæˆå”¯ä¸€çš„è¯„è®º ID
        const commentId = 'comment-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

        const { data, error } = await supabaseClient
          .from('community_comments')
          .insert([
            {
              id: commentId,
              post_id: postId,
              author: currentUser.name,
              content: content
            }
          ])
          .select()
          .single();

        if (error) {
          console.error('âŒ å‘è¡¨è¯„è®ºå¤±è´¥:', error);
          alert('å‘è¡¨è¯„è®ºå¤±è´¥ï¼š' + error.message);
          return;
        }

        console.log('âœ… è¯„è®ºå‘è¡¨æˆåŠŸ:', data);
        
        // æ¸…ç©ºè¾“å…¥æ¡†
        input.value = '';
        
        // æ˜¾ç¤ºæˆåŠŸæç¤º
        alert('âœ… è¯„è®ºå‘è¡¨æˆåŠŸï¼');

      } catch (error) {
        console.error('âŒ å‘è¡¨è¯„è®ºå¼‚å¸¸:', error);
        alert('å‘è¡¨è¯„è®ºæ—¶å‘ç”Ÿé”™è¯¯');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸš€ å‘è¡¨è¯„è®º';
      }
    }

    // ========== ç‚¹èµ ==========
    async function likePost(postId) {
      try {
        console.log('ğŸ‘ ç‚¹èµå¸–å­:', postId);

        const newLikes = (currentPost.likes || 0) + 1;

        const { error } = await supabaseClient
          .from('community_posts')
          .update({ likes: newLikes })
          .eq('id', postId);

        if (error) {
          console.error('âŒ ç‚¹èµå¤±è´¥:', error);
          return;
        }

        console.log('âœ… ç‚¹èµæˆåŠŸ');
        currentPost.likes = newLikes;
        document.getElementById('like-count').textContent = newLikes;
        
        // æ·»åŠ å·²ç‚¹èµæ ·å¼
        document.getElementById('like-btn').classList.add('active');
        
        // ä¿å­˜ç‚¹èµçŠ¶æ€ï¼ˆé˜²æ­¢é‡å¤ç‚¹èµï¼‰
        localStorage.setItem(`liked_${postId}`, 'true');

      } catch (error) {
        console.error('âŒ ç‚¹èµå¼‚å¸¸:', error);
      }
    }

    // ========== ç»‘å®šäº‹ä»¶ ==========
    function bindEvents(postId) {
      // å‘è¡¨è¯„è®ºæŒ‰é’®
      document.getElementById('submit-comment-btn').addEventListener('click', () => {
        submitComment(postId);
      });

      // å›è½¦å‘è¡¨è¯„è®ºï¼ˆCtrl + Enterï¼‰
      document.getElementById('comment-input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) {
          submitComment(postId);
        }
      });

      // ç‚¹èµæŒ‰é’®ï¼ˆä½¿ç”¨äº‹ä»¶å§”æ‰˜ï¼‰
      document.getElementById('post-content').addEventListener('click', (e) => {
        const likeBtn = e.target.closest('.like-btn');
        if (likeBtn) {
          const postId = likeBtn.dataset.postId;
          const hasLiked = localStorage.getItem(`liked_${postId}`);
          
          if (!hasLiked) {
            likePost(postId);
          } else {
            alert('æ‚¨å·²ç»ç‚¹èµè¿‡äº†ï¼');
          }
        }
      });
    }

    // ========== å·¥å…·å‡½æ•° ==========
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const diff = now - date;
      
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);
      
      if (minutes < 1) return 'åˆšåˆš';
      if (minutes < 60) return `${minutes} åˆ†é’Ÿå‰`;
      if (hours < 24) return `${hours} å°æ—¶å‰`;
      if (days < 7) return `${days} å¤©å‰`;
      
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
    }

    function getBoardName(boardKey) {
      const boards = {
        'general': 'ç»¼åˆè®¨è®º',
        'guides': 'æ”»ç•¥å¿ƒå¾—',
        'showcase': 'ä½œå“å±•ç¤º',
        'questions': 'é—®é¢˜æ±‚åŠ©',
        'events': 'æ´»åŠ¨å…¬å‘Š'
      };
      return boards[boardKey] || boardKey;
    }

    function showError(message) {
      document.getElementById('loading-container').style.display = 'none';
      const errorContainer = document.getElementById('error-container');
      errorContainer.innerHTML = `
        <div class="error-message">
          <h3>âš ï¸ é”™è¯¯</h3>
          <p>${message}</p>
          <button class="back-btn" onclick="window.location.href='community.html'" style="margin-top: 15px;">
            è¿”å›ç¤¾åŒº
          </button>
        </div>
      `;
      errorContainer.style.display = 'block';
    }

    // ========== é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ– ==========
    window.addEventListener('DOMContentLoaded', init);

    // ========== é¡µé¢å¸è½½æ—¶æ¸…ç†è®¢é˜… ==========
    window.addEventListener('beforeunload', () => {
      if (commentsSubscription) {
        commentsSubscription.unsubscribe();
        console.log('ğŸ”• å·²å–æ¶ˆ Realtime è®¢é˜…');
      }
    });
  </script>

  <!-- Matrix å’Œç²’å­æ•ˆæœè„šæœ¬ -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    // Matrix èƒŒæ™¯
    const canvas = document.getElementById('matrix');
    const ctx = canvas.getContext('2d');

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const matrix = "ABCDEFGHIJKLMNOPQRSTUVWXYZ123456789@#$%^&*()*&^%";
    const font_size = 10;
    const columns = canvas.width/font_size;

    const drops = [];
    for(let x = 0; x < columns; x++)
      drops[x] = 1;

    function draw() {
      ctx.fillStyle = 'rgba(0, 0, 0, 0.04)';
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = 'rgba(255, 211, 0, 0.3)';
      ctx.font = font_size + 'px monospace';

      for(let i = 0; i < drops.length; i++) {
        const text = matrix.charAt(Math.floor(Math.random() * matrix.length));
        ctx.fillText(text, i*font_size, drops[i]*font_size);

        if(drops[i]*font_size > canvas.height && Math.random() > 0.975)
          drops[i] = 0;

        drops[i]++;
      }
    }

    setInterval(draw, 35);

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    });

    // ç²’å­æ•ˆæœ
    if (typeof particlesJS !== 'undefined') {
      particlesJS('particles-js', {
        particles: {
          number: { value: 80, density: { enable: true, value_area: 800 } },
          color: { value: '#ffd300' },
          shape: { type: 'circle' },
          opacity: { value: 0.5, random: false },
          size: { value: 3, random: true },
          line_linked: { enable: true, distance: 150, color: '#ffd300', opacity: 0.4, width: 1 },
          move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
        },
        interactivity: {
          detect_on: 'canvas',
          events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
          modes: { grab: { distance: 400, line_linked: { opacity: 1 } }, bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 }, repulse: { distance: 200, duration: 0.4 }, push: { particles_nb: 4 }, remove: { particles_nb: 2 } }
        },
        retina_detect: true
      });
    }
  </script>
</body>
</html>
