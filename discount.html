<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æŠ˜æ‰£ä¸å²ä½</title>
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="discount" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æŠ˜æ‰£ä¸å²ä½</div>
        <div class="page-intro">
          å±•ç¤ºç¤ºä¾‹æ¸¸æˆçš„æŠ˜æ‰£ä¿¡æ¯ï¼Œå¯æŒ‰æŠ˜æ‰£åŠ›åº¦è¿‡æ»¤ï¼Œå¹¶å¯åªçœ‹â€œå²ä½â€ä»·æ ¼ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>ç­›é€‰æ¡ä»¶</span>
          </div>
        </header>
        <div class="form">
          <div class="form-row">
            <label for="discSearch">æŒ‰åç§°æœç´¢</label>
            <input id="discSearch" type="text" placeholder="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹ 2077" />
          </div>
          <div class="form-row">
            <label for="discFilter">æŠ˜æ‰£åŠ›åº¦</label>
            <select id="discFilter">
              <option value="all">å…¨éƒ¨æŠ˜æ‰£</option>
              <option value="20">â‰¥ 20%</option>
              <option value="50">â‰¥ 50%</option>
              <option value="70">â‰¥ 70%</option>
            </select>
          </div>
          <div class="form-row">
            <label>
              <input type="checkbox" id="discLowOnly" />
              åªçœ‹å²ä½
            </label>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>å½“å‰æŠ˜æ‰£</span>
          </div>
          <div class="chip" id="discCount">å…± 0 æ¬¾</div>
        </header>
        <div id="discList" class="game-list" style="max-height: 600px; overflow-y: auto;"></div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">è¯´æ˜</div>
        <div class="sidebar-item">
          <span class="label">â€œå²ä½â€</span><span class="value">ç¤ºä¾‹å±æ€§</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®</span><span class="value">å‰ç«¯å‡æ•°æ®</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="game-api.js"></script>
<script>
  initCommon();

  // æ•°æ®æºï¼šä» ranking.json + FreeToGame API æ··åˆåŠ è½½
  let allDiscountData = [];
  let isDataLoaded = false;
  let currentPage = 0;
  const PAGE_SIZE = 15;
  let currentFilteredList = [];

  const discSearch = document.getElementById("discSearch");
  const discPercent = document.getElementById("discPercent");
  const discHistLow = document.getElementById("discHistLow");
  const discList = document.getElementById("discList");
  const discCount = document.getElementById("discCount");

  // åŠ è½½æ‰€æœ‰æŠ˜æ‰£æ•°æ®
  async function loadAllData() {
    try {
      discList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½æŠ˜æ‰£æ•°æ®...</div>';

      // 1. åŠ è½½ ranking.json ä¸­çš„æŠ˜æ‰£æ•°æ®
      const rankRes = await fetch("ranking.json");
      if (!rankRes.ok) throw new Error("HTTP çŠ¶æ€ç  " + rankRes.status);
      const rankData = await rankRes.json();
      
      const rankDiscounts = (rankData.discount || []).map((game, index) => {
        const basePrice = 100 + Math.floor(Math.random() * 400);
        const discountPercent = 20 + Math.floor(Math.random() * 60);
        const currentPrice = (basePrice * (100 - discountPercent) / 100).toFixed(2);
        const isHistLow = (index % 3 === 0);
        
        return {
          ...game,
          basePrice: basePrice,
          currentPrice: parseFloat(currentPrice),
          discountPercent: discountPercent,
          isHistLow: isHistLow,
          source: "ranking"
        };
      });

      // 2. åŠ è½½ FreeToGame API æ•°æ®ï¼ˆå…è´¹æ¸¸æˆä½œä¸º"100%æŠ˜æ‰£"ï¼‰
      const apiGames = await window.gameAPI.getAllGames();
      const apiDiscounts = apiGames.slice(0, 200).map((game, index) => {
        const basePrice = 50 + Math.floor(Math.random() * 200);
        const discountPercent = 30 + Math.floor(Math.random() * 65);
        const currentPrice = discountPercent === 100 ? 0 : (basePrice * (100 - discountPercent) / 100).toFixed(2);
        const isHistLow = (index % 4 === 0);
        
        return {
          id: game.id,
          name: game.title,
          platform: game.platform === "PC (Windows)" ? "Windows" : game.platform,
          cover: game.thumbnail,
          score: Math.random() * 2 + 7,
          tag: game.genre,
          basePrice: basePrice,
          currentPrice: parseFloat(currentPrice),
          discountPercent: discountPercent,
          isHistLow: isHistLow,
          source: "api"
        };
      });

      // 3. åˆå¹¶æ•°æ®
      allDiscountData = [...rankDiscounts, ...apiDiscounts];
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allDiscountData.length} æ¬¾æŠ˜æ‰£æ¸¸æˆ`);
      isDataLoaded = true;
      applyFiltersAndRender();
    } catch (err) {
      console.error("åŠ è½½æŠ˜æ‰£æ•°æ®å¤±è´¥:", err);
      discList.innerHTML = `
        <div style="text-align: center; color: var(--danger); padding: 20px;">
          âŒ æŠ˜æ‰£æ•°æ®åŠ è½½å¤±è´¥<br>
          <span style="font-size: 11px; opacity: 0.8;">é”™è¯¯: ${err.message}</span>
        </div>
      `;
    }
  }

  // åº”ç”¨ç­›é€‰æ¡ä»¶å¹¶æ¸²æŸ“
  function applyFiltersAndRender() {
    if (!isDataLoaded) {
      discList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½æŠ˜æ‰£æ•°æ®...</div>';
      return;
    }

    const kw = discSearch.value.trim().toLowerCase();
    const minPercent = parseInt(discPercent.value) || 0;
    const onlyHistLow = discHistLow.checked;

    currentFilteredList = allDiscountData.filter(item => {
      if (kw && !item.name.toLowerCase().includes(kw)) return false;
      if (item.discountPercent < minPercent) return false;
      if (onlyHistLow && !item.isHistLow) return false;
      return true;
    });

    // æŒ‰æŠ˜æ‰£åŠ›åº¦é™åºæ’åº
    currentFilteredList.sort((a, b) => b.discountPercent - a.discountPercent);

    // é‡ç½®åˆ†é¡µå¹¶æ¸²æŸ“
    currentPage = 0;
    discList.innerHTML = "";
    discCount.textContent = `å…± ${currentFilteredList.length} æ¬¾`;

    if (!currentFilteredList.length) {
      discList.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:20px;text-align:center;">ğŸ” æš‚æ— ç¬¦åˆæ¡ä»¶çš„æŠ˜æ‰£æ¸¸æˆã€‚</div>';
      return;
    }

    loadMoreItems();
  }

  // åŠ è½½æ›´å¤šé¡¹ç›®
  function loadMoreItems() {
    const startIdx = currentPage * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageItems = currentFilteredList.slice(startIdx, endIdx);
    
    if (!pageItems.length) return;

    pageItems.forEach((item) => {
      const gameCard = document.createElement("div");
      gameCard.className = "game-card";
      gameCard.style.cursor = "pointer";

      const coverHtml = item.cover 
        ? `<img src="${item.cover}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:40px;\\'>ğŸ®</div>'" />` 
        : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 40px;">ğŸ®</div>';

      const histLowBadge = item.isHistLow ? '<div class="badge" style="background:var(--danger);margin-left:4px;">å²ä½</div>' : '';

      gameCard.innerHTML = `
        <div class="game-cover">${coverHtml}</div>
        <div class="game-title">${item.name || "æœªçŸ¥æ¸¸æˆ"}</div>
        <div class="game-meta">
          ${item.tag || item.genre || "æ¸¸æˆ"} Â· ${item.platform || "PC"}
        </div>
        <div class="game-price" style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;">
          <div>
            <span class="badge" style="background:var(--accent);">-${item.discountPercent}%</span>
            ${histLowBadge}
          </div>
          <div style="text-align:right;">
            <div style="text-decoration:line-through;font-size:11px;opacity:0.6;">Â¥${item.basePrice}</div>
            <div style="color:var(--accent);font-weight:700;font-size:16px;">Â¥${item.currentPrice}</div>
          </div>
        </div>
      `;

      gameCard.addEventListener("mouseenter", () => {
        gameCard.style.transform = "translateY(-4px)";
        gameCard.style.boxShadow = "0 8px 24px rgba(56, 189, 248, 0.3)";
        gameCard.style.transition = "all 0.3s ease";
      });

      gameCard.addEventListener("mouseleave", () => {
        gameCard.style.transform = "translateY(0)";
        gameCard.style.boxShadow = "";
      });

      gameCard.addEventListener("click", () => {
        const url = new URL("game-detail.html", window.location.href);
        if (item.id) url.searchParams.set("id", item.id);
        url.searchParams.set("name", item.name);
        window.location.href = url.toString();
      });

      discList.appendChild(gameCard);
    });

    currentPage++;
  }

  // æ— é™æ»šåŠ¨ç›‘å¬
  discList.addEventListener("scroll", () => {
    const scrollTop = discList.scrollTop;
    const scrollHeight = discList.scrollHeight;
    const clientHeight = discList.clientHeight;
    
    // è·ç¦»åº•éƒ¨ 100px æ—¶åŠ è½½æ›´å¤š
    if (scrollHeight - scrollTop - clientHeight < 100) {
      loadMoreItems();
    }
  });

  // ç›‘å¬ç­›é€‰æ¡ä»¶å˜åŒ–
  discSearch.addEventListener("input", applyFiltersAndRender);
  discPercent.addEventListener("change", applyFiltersAndRender);
  discHistLow.addEventListener("change", applyFiltersAndRender);

  // åˆå§‹åŠ è½½
  loadAllData();
</script>
</body>
</html>
