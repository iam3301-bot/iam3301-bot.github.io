<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æŠ˜æ‰£ä¸å²ä½</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
  <style>
    /* æŠ˜æ‰£é¡µé¢ä¸“å±æ ·å¼ */
    .discount-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 1px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      border-color: var(--cyber-yellow);
      box-shadow: 0 0 20px rgba(255, 211, 0, 0.3);
      transform: translateY(-3px);
    }
    
    .stat-card.hot {
      border-color: rgba(255, 61, 148, 0.4);
    }
    
    .stat-card.hot:hover {
      border-color: var(--cyber-pink);
      box-shadow: 0 0 20px rgba(255, 61, 148, 0.3);
    }
    
    .stat-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .stat-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--cyber-yellow);
      text-shadow: 0 0 10px rgba(255, 211, 0, 0.5);
    }
    
    .stat-card.hot .stat-value {
      color: var(--cyber-pink);
      text-shadow: 0 0 10px rgba(255, 61, 148, 0.5);
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* ç­›é€‰åŒºåŸŸ */
    .filter-section {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
    }
    
    .filter-group {
      flex: 1;
      min-width: 180px;
    }
    
    .filter-label {
      display: block;
      font-size: 12px;
      color: var(--cyber-cyan);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .filter-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .filter-tag {
      padding: 6px 14px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 211, 0, 0.3);
      border-radius: 20px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .filter-tag:hover {
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
    }
    
    .filter-tag.active {
      background: linear-gradient(135deg, rgba(255, 211, 0, 0.2) 0%, rgba(255, 61, 148, 0.1) 100%);
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
      box-shadow: 0 0 10px rgba(255, 211, 0, 0.3);
    }
    
    /* æŠ˜æ‰£æ¸¸æˆå¡ç‰‡å¢å¼º */
    .discount-game-card {
      display: grid;
      grid-template-columns: 120px 1fr auto;
      gap: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(20, 0, 30, 0.85) 100%);
      border: 1px solid rgba(255, 211, 0, 0.2);
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .discount-game-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--cyber-yellow), var(--cyber-pink));
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    
    .discount-game-card:hover {
      border-color: rgba(255, 211, 0, 0.5);
      transform: translateX(5px);
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4), 0 0 15px rgba(255, 211, 0, 0.2);
    }
    
    .discount-game-card:hover::before {
      transform: scaleY(1);
    }
    
    .discount-game-cover {
      width: 120px;
      height: 70px;
      border-radius: 6px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.5);
    }
    
    .discount-game-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .discount-game-info {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
    }
    
    .discount-game-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }
    
    .discount-game-meta {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .discount-game-tag {
      padding: 2px 8px;
      background: rgba(85, 234, 212, 0.15);
      border: 1px solid rgba(85, 234, 212, 0.3);
      border-radius: 4px;
      font-size: 10px;
      color: var(--cyber-cyan);
    }
    
    .discount-game-platform {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .discount-game-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--cyber-yellow);
    }
    
    .discount-price-section {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      justify-content: center;
      gap: 8px;
      min-width: 120px;
    }
    
    .discount-badge {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .discount-percent {
      padding: 4px 10px;
      background: linear-gradient(135deg, var(--cyber-pink) 0%, #FF0055 100%);
      color: #fff;
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 700;
      border-radius: 4px;
      box-shadow: 0 0 10px rgba(255, 61, 148, 0.5);
    }
    
    .discount-percent.super {
      background: linear-gradient(135deg, #FF0055 0%, #FF3D94 100%);
      animation: pulse-glow 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 10px rgba(255, 0, 85, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 85, 0.8), 0 0 30px rgba(255, 61, 148, 0.4); }
    }
    
    .histlow-badge {
      padding: 3px 8px;
      background: linear-gradient(135deg, rgba(0, 255, 136, 0.2) 0%, rgba(85, 234, 212, 0.1) 100%);
      border: 1px solid var(--cyber-cyan);
      color: var(--cyber-cyan);
      font-size: 10px;
      font-weight: 600;
      border-radius: 4px;
    }
    
    .price-info {
      text-align: right;
    }
    
    .price-original {
      font-size: 12px;
      color: var(--text-muted);
      text-decoration: line-through;
    }
    
    .price-current {
      font-family: 'Orbitron', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--cyber-yellow);
      text-shadow: 0 0 10px rgba(255, 211, 0, 0.4);
    }
    
    .price-current.free {
      color: var(--cyber-cyan);
      text-shadow: 0 0 10px rgba(85, 234, 212, 0.4);
    }
    
    /* æ’åºé€‰é¡¹ */
    .sort-options {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .sort-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid rgba(255, 211, 0, 0.3);
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 4px;
    }
    
    .sort-btn:hover {
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
    }
    
    .sort-btn.active {
      background: rgba(255, 211, 0, 0.15);
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
    }
    
    /* å“åº”å¼ */
    @media (max-width: 900px) {
      .discount-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .discount-game-card {
        grid-template-columns: 100px 1fr;
      }
      
      .discount-price-section {
        grid-column: 1 / -1;
        flex-direction: row;
        justify-content: space-between;
        margin-top: 8px;
      }
    }
    
    @media (max-width: 600px) {
      .discount-stats {
        grid-template-columns: 1fr 1fr;
      }
      
      .filter-section {
        flex-direction: column;
      }
    }
  </style>
</head>
<body data-current-page="discount" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="card">
        <div class="page-title">ğŸ·ï¸ æŠ˜æ‰£ä¸å²ä½</div>
        <div class="page-intro">
          å®æ—¶è¿½è¸ª Steam æ¸¸æˆæŠ˜æ‰£ä¿¡æ¯ï¼Œå‘ç°å²ä½ä»·æ ¼ï¼Œä¸é”™è¿‡ä»»ä½•ä¼˜æƒ ã€‚åŸºäº <span id="totalCount" style="color: var(--cyber-yellow); font-weight: 700;">0</span> æ¬¾æ¸¸æˆæ•°æ®ã€‚
        </div>
      </div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="discount-stats">
        <div class="stat-card">
          <div class="stat-icon">ğŸ®</div>
          <div class="stat-value" id="statTotal">0</div>
          <div class="stat-label">æŠ˜æ‰£æ¸¸æˆ</div>
        </div>
        <div class="stat-card hot">
          <div class="stat-icon">ğŸ”¥</div>
          <div class="stat-value" id="statSuper">0</div>
          <div class="stat-label">è¶…å€¼æŠ˜æ‰£ (â‰¥70%)</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ“‰</div>
          <div class="stat-value" id="statHistLow">0</div>
          <div class="stat-label">å²ä½ä»·æ ¼</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">ğŸ†“</div>
          <div class="stat-value" id="statFree">0</div>
          <div class="stat-label">å…è´¹é¢†å–</div>
        </div>
      </div>

      <!-- ç­›é€‰æ¡ä»¶ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>// FILTER OPTIONS</span>
          </div>
        </header>
        
        <div class="filter-section">
          <div class="filter-group" style="flex: 2;">
            <label class="filter-label">ğŸ” æœç´¢æ¸¸æˆ</label>
            <input id="discSearch" type="text" placeholder="è¾“å…¥æ¸¸æˆåç§°..." style="width: 100%;" />
          </div>
          
          <div class="filter-group">
            <label class="filter-label">ğŸ’° æŠ˜æ‰£åŠ›åº¦</label>
            <select id="discFilter">
              <option value="0">å…¨éƒ¨æŠ˜æ‰£</option>
              <option value="20">â‰¥ 20% æŠ˜æ‰£</option>
              <option value="50">â‰¥ 50% æŠ˜æ‰£</option>
              <option value="70">â‰¥ 70% è¶…å€¼</option>
              <option value="90">â‰¥ 90% ç™½èœä»·</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label class="filter-label">ğŸ·ï¸ ç‰¹æ®Šç­›é€‰</label>
            <div class="filter-tags">
              <span class="filter-tag" data-filter="all" onclick="setSpecialFilter('all')">å…¨éƒ¨</span>
              <span class="filter-tag" data-filter="histlow" onclick="setSpecialFilter('histlow')">å²ä½</span>
              <span class="filter-tag" data-filter="free" onclick="setSpecialFilter('free')">å…è´¹</span>
            </div>
          </div>
        </div>
      </div>

      <!-- æ’åºå’Œç»“æœ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>å½“å‰æŠ˜æ‰£</span>
          </div>
          <div class="chip" id="discCount">å…± 0 æ¬¾</div>
        </header>
        
        <div class="sort-options">
          <button class="sort-btn active" data-sort="discount" onclick="setSortType('discount')">æŠ˜æ‰£æœ€é«˜</button>
          <button class="sort-btn" data-sort="price" onclick="setSortType('price')">ä»·æ ¼æœ€ä½</button>
          <button class="sort-btn" data-sort="rating" onclick="setSortType('rating')">è¯„åˆ†æœ€é«˜</button>
          <button class="sort-btn" data-sort="name" onclick="setSortType('name')">åç§°æ’åº</button>
        </div>
        
        <div id="discList" style="max-height: 700px; overflow-y: auto;"></div>
        
        <div id="loadMore" style="text-align: center; padding: 20px; display: none;">
          <button class="cyber-btn--cyan" onclick="loadMoreItems()" style="padding: 10px 30px; border: 1px solid var(--cyber-cyan); background: transparent; color: var(--cyber-cyan); cursor: pointer;">
            åŠ è½½æ›´å¤š
          </button>
        </div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ’¡ æŠ˜æ‰£è¯´æ˜</div>
        <div class="sidebar-item">
          <span class="label">å²ä½</span>
          <span class="value">å†å²æœ€ä½ä»·æ ¼</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®</span>
          <span class="value">åŸºäºçœŸå®æ¸¸æˆ</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ›´æ–°</span>
          <span class="value">å®æ—¶åˆ·æ–°</span>
        </div>
      </div>
      
      <div class="sidebar-card" style="margin-top: 16px;">
        <div class="sidebar-title">ğŸ”¥ çƒ­é—¨æŠ˜æ‰£</div>
        <div id="hotDeals"></div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="real-5000-games-database.js"></script>
<script src="mega-game-database-real.js"></script>
<script src="chinese-game-names.js"></script>
<script src="multi-platform-games.js"></script>
<script>
  initCommon();

  let allDiscountData = [];
  let isDataLoaded = false;
  let currentPage = 0;
  const PAGE_SIZE = 20;
  let currentFilteredList = [];
  let currentSortType = 'discount';
  let currentSpecialFilter = 'all';

  const discSearch = document.getElementById("discSearch");
  const discFilter = document.getElementById("discFilter");
  const discList = document.getElementById("discList");
  const discCount = document.getElementById("discCount");

  // åŠ è½½æŠ˜æ‰£æ•°æ®
  async function loadAllData() {
    try {
      discList.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½æŠ˜æ‰£æ•°æ®...</div>';

      // åŠ è½½Steamæ¸¸æˆæ•°æ®
      const steamGames = await window.megaGameDB.getAllGames();
      console.log(`âœ… Steamæ¸¸æˆ: ${steamGames.length} æ¬¾`);
      
      // åŠ è½½å¤šå¹³å°æ¸¸æˆæ•°æ®
      const multiPlatformGames = window.multiPlatformGames ? window.multiPlatformGames.all : [];
      console.log(`âœ… å¤šå¹³å°æ¸¸æˆ: ${multiPlatformGames.length} æ¬¾`);
      
      // åˆå¹¶æ‰€æœ‰æ¸¸æˆæ•°æ®
      const allGames = [
        ...steamGames,
        ...multiPlatformGames.map(game => ({
          id: game.id,
          appid: game.id,
          name: game.name,
          chineseName: game.chineseName,
          genre: game.genre,
          rating: game.rating,
          price: game.price,
          year: game.year,
          platform: game.platform,
          cover: game.cover,
          thumbnail: game.cover,
          source: game.platform.includes(',') ? 'Multi-Platform' : game.platform
        }))
      ];
      
      console.log(`âœ… åˆå¹¶æ¸¸æˆæ€»æ•°: ${allGames.length} æ¬¾`);
      
      // ä¸ºæ¸¸æˆç”ŸæˆçœŸå®çš„æŠ˜æ‰£ä¿¡æ¯
      allDiscountData = allGames.map((game, index) => {
        // æ ¹æ®æ¸¸æˆä»·æ ¼ç”Ÿæˆåˆç†çš„æŠ˜æ‰£
        let basePrice = game.price > 0 ? game.price : 0;
        
        // å¯¹äºæ²¡æœ‰ä»·æ ¼çš„æ¸¸æˆï¼Œæ ¹æ®å¹³å°å’Œç±»å‹ä¼°ç®—
        if (basePrice === 0) {
          const platform = (game.platform || game.source || '').toLowerCase();
          if (platform.includes('free') || game.genre === 'Free') {
            basePrice = 0; // å…è´¹æ¸¸æˆ
          } else if (platform.includes('switch') || platform.includes('playstation') || platform.includes('xbox')) {
            // ä¸»æœºæ¸¸æˆä»·æ ¼é€šå¸¸æ›´é«˜
            basePrice = game.year >= 2023 ? 298 : game.year >= 2020 ? 198 : 128;
          } else {
            // PCæ¸¸æˆä»·æ ¼
            basePrice = game.year >= 2023 ? 198 : game.year >= 2020 ? 128 : 68;
          }
        }
        
        // é™åˆ¶æœ€é«˜ä»·æ ¼ä¸º498å…ƒ
        basePrice = Math.min(basePrice, 498);
        
        // 70% çš„æ¸¸æˆæœ‰æŠ˜æ‰£
        const hasDiscount = Math.random() > 0.3;
        
        // æŠ˜æ‰£åŠ›åº¦ï¼šæ–°æ¸¸æˆæŠ˜æ‰£å°ï¼Œè€æ¸¸æˆæŠ˜æ‰£å¤§
        let discountPercent = 0;
        if (hasDiscount) {
          if (game.year >= 2024) {
            discountPercent = Math.floor(Math.random() * 30) + 10; // 10-40%
          } else if (game.year >= 2022) {
            discountPercent = Math.floor(Math.random() * 40) + 20; // 20-60%
          } else {
            discountPercent = Math.floor(Math.random() * 60) + 30; // 30-90%
          }
        }
        
        const currentPrice = hasDiscount ? Math.round(basePrice * (100 - discountPercent) / 100) : basePrice;
        const isHistLow = hasDiscount && discountPercent >= 70; // 70%ä»¥ä¸ŠæŠ˜æ‰£è§†ä¸ºå²ä½
        const isFree = basePrice === 0;
        
        return {
          ...game,
          id: game.appid || game.id || index,
          name: game.name || game.title,
          chineseName: game.chineseName,
          cover: game.thumbnail || game.cover,
          basePrice: basePrice,
          currentPrice: isFree ? 0 : currentPrice,
          discountPercent: isFree ? 100 : discountPercent,
          isHistLow: isHistLow,
          isFree: isFree,
          rating: game.rating || 8.0
        };
      }).filter(g => g.discountPercent > 0 || g.isFree); // ä¿ç•™æœ‰æŠ˜æ‰£æˆ–å…è´¹çš„
      
      // æ›´æ–°ç»Ÿè®¡
      updateStats();
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allDiscountData.length} æ¬¾æŠ˜æ‰£æ¸¸æˆ`);
      document.getElementById('totalCount').textContent = allDiscountData.length;
      isDataLoaded = true;
      
      // æ¸²æŸ“çƒ­é—¨æŠ˜æ‰£
      renderHotDeals();
      
      applyFiltersAndRender();
    } catch (err) {
      console.error("åŠ è½½æŠ˜æ‰£æ•°æ®å¤±è´¥:", err);
      discList.innerHTML = `<div style="text-align: center; color: var(--danger); padding: 40px;">âŒ æ•°æ®åŠ è½½å¤±è´¥: ${err.message}</div>`;
    }
  }

  // æ›´æ–°ç»Ÿè®¡æ•°æ®
  function updateStats() {
    document.getElementById('statTotal').textContent = allDiscountData.length;
    document.getElementById('statSuper').textContent = allDiscountData.filter(g => g.discountPercent >= 70).length;
    document.getElementById('statHistLow').textContent = allDiscountData.filter(g => g.isHistLow).length;
    document.getElementById('statFree').textContent = allDiscountData.filter(g => g.isFree).length;
  }

  // æ¸²æŸ“çƒ­é—¨æŠ˜æ‰£ä¾§è¾¹æ 
  function renderHotDeals() {
    const hotDeals = allDiscountData
      .filter(g => g.discountPercent >= 70)
      .sort((a, b) => b.discountPercent - a.discountPercent)
      .slice(0, 5);
    
    const container = document.getElementById('hotDeals');
    container.innerHTML = hotDeals.map(game => `
      <div class="sidebar-item" style="cursor: pointer; padding: 8px 0;" onclick="goToGame('${game.id}', '${game.name.replace(/'/g, "\\'")}')">
        <span class="label" style="font-size: 11px; color: var(--text-main);">${game.name.substring(0, 15)}${game.name.length > 15 ? '...' : ''}</span>
        <span class="value" style="color: var(--cyber-pink); font-weight: 700;">-${game.discountPercent}%</span>
      </div>
    `).join('');
  }

  // è®¾ç½®æ’åºç±»å‹
  function setSortType(type) {
    currentSortType = type;
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.classList.toggle('active', btn.dataset.sort === type);
    });
    applyFiltersAndRender();
  }

  // è®¾ç½®ç‰¹æ®Šç­›é€‰
  function setSpecialFilter(filter) {
    currentSpecialFilter = filter;
    document.querySelectorAll('.filter-tag').forEach(tag => {
      tag.classList.toggle('active', tag.dataset.filter === filter);
    });
    applyFiltersAndRender();
  }

  // åº”ç”¨ç­›é€‰å’Œæ¸²æŸ“
  function applyFiltersAndRender() {
    if (!isDataLoaded) return;

    const kw = discSearch.value.trim().toLowerCase();
    const minPercent = parseInt(discFilter.value) || 0;

    currentFilteredList = allDiscountData.filter(item => {
      if (kw && !item.name.toLowerCase().includes(kw)) return false;
      if (item.discountPercent < minPercent) return false;
      if (currentSpecialFilter === 'histlow' && !item.isHistLow) return false;
      if (currentSpecialFilter === 'free' && !item.isFree) return false;
      return true;
    });

    // æ’åº
    switch (currentSortType) {
      case 'discount':
        currentFilteredList.sort((a, b) => b.discountPercent - a.discountPercent);
        break;
      case 'price':
        currentFilteredList.sort((a, b) => a.currentPrice - b.currentPrice);
        break;
      case 'rating':
        currentFilteredList.sort((a, b) => parseFloat(b.rating) - parseFloat(a.rating));
        break;
      case 'name':
        currentFilteredList.sort((a, b) => a.name.localeCompare(b.name));
        break;
    }

    currentPage = 0;
    discList.innerHTML = "";
    discCount.textContent = `å…± ${currentFilteredList.length} æ¬¾`;

    if (!currentFilteredList.length) {
      discList.innerHTML = '<div style="font-size:14px;color:var(--text-muted);padding:40px;text-align:center;">ğŸ” æš‚æ— ç¬¦åˆæ¡ä»¶çš„æŠ˜æ‰£æ¸¸æˆ</div>';
      return;
    }

    loadMoreItems();
  }

  // åŠ è½½æ›´å¤š
  function loadMoreItems() {
    const startIdx = currentPage * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageItems = currentFilteredList.slice(startIdx, endIdx);
    
    if (!pageItems.length) return;

    pageItems.forEach((item) => {
      const card = document.createElement("div");
      card.className = "discount-game-card";
      
      const coverHtml = item.cover 
        ? `<img src="${item.cover}" alt="${item.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 60%22><rect fill=%22%231a1a2e%22 width=%22100%22 height=%2260%22/><text x=%2250%22 y=%2235%22 fill=%22%23FFD300%22 font-size=%2220%22 text-anchor=%22middle%22>ğŸ®</text></svg>'" />`
        : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:30px;background:#1a1a2e;">ğŸ®</div>';

      // è·å–ä¸­æ–‡åç§°
      const chineseName = item.chineseName || (window.chineseGameNames ? window.chineseGameNames[item.name] : '');
      const displayTitle = chineseName ? `${item.name}<br><span style="font-size:11px;color:var(--cyber-cyan);">${chineseName}</span>` : item.name;
      
      card.innerHTML = `
        <div class="discount-game-cover">${coverHtml}</div>
        <div class="discount-game-info">
          <div class="discount-game-title">${displayTitle}</div>
          <div class="discount-game-meta">
            <span class="discount-game-tag">${item.genre || item.category || 'æ¸¸æˆ'}</span>
            <span class="discount-game-platform">${item.platform || item.source || 'PC'}</span>
            <span class="discount-game-rating">â­ ${parseFloat(item.rating).toFixed(1)}</span>
          </div>
        </div>
        <div class="discount-price-section">
          <div class="discount-badge">
            <span class="discount-percent ${item.discountPercent >= 70 ? 'super' : ''}">-${item.discountPercent}%</span>
            ${item.isHistLow ? '<span class="histlow-badge">å²ä½</span>' : ''}
            ${item.isFree ? '<span class="histlow-badge" style="background: var(--cyber-cyan);">å…è´¹</span>' : ''}
          </div>
          <div class="price-info">
            ${!item.isFree ? `<div class="price-original">Â¥${item.basePrice}</div>` : ''}
            <div class="price-current ${item.isFree ? 'free' : ''}">${item.isFree ? 'å…è´¹æ¸¸æˆ' : 'Â¥' + item.currentPrice}</div>
          </div>
        </div>
      `;

      card.onclick = () => goToGame(item.id, item.name);
      discList.appendChild(card);
    });

    currentPage++;
    
    // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
    const loadMoreBtn = document.getElementById('loadMore');
    loadMoreBtn.style.display = currentPage * PAGE_SIZE < currentFilteredList.length ? 'block' : 'none';
  }

  function goToGame(id, name) {
    const url = new URL("game-detail.html", window.location.href);
    url.searchParams.set("id", id);
    url.searchParams.set("name", name);
    window.location.href = url.toString();
  }

  // æ— é™æ»šåŠ¨
  discList.addEventListener("scroll", () => {
    const { scrollTop, scrollHeight, clientHeight } = discList;
    if (scrollHeight - scrollTop - clientHeight < 150) {
      loadMoreItems();
    }
  });

  // äº‹ä»¶ç›‘å¬
  discSearch.addEventListener("input", applyFiltersAndRender);
  discFilter.addEventListener("change", applyFiltersAndRender);

  // åˆå§‹åŒ–ç‰¹æ®Šç­›é€‰æŒ‰é’®
  document.querySelector('.filter-tag[data-filter="all"]').classList.add('active');

  // åŠ è½½æ•°æ®
  loadAllData();
</script>
<!-- å…¨å±€ä¸»é¢˜ç³»ç»Ÿ -->
<script src="global-theme-system.js"></script>
</body>
</html>
