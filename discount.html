<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æŠ˜æ‰£ä¸å²ä½</title>
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="discount" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æŠ˜æ‰£ä¸å²ä½</div>
        <div class="page-intro">
          å±•ç¤ºç¤ºä¾‹æ¸¸æˆçš„æŠ˜æ‰£ä¿¡æ¯ï¼Œå¯æŒ‰æŠ˜æ‰£åŠ›åº¦è¿‡æ»¤ï¼Œå¹¶å¯åªçœ‹â€œå²ä½â€ä»·æ ¼ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>ç­›é€‰æ¡ä»¶</span>
          </div>
        </header>
        <div class="form">
          <div class="form-row">
            <label for="discSearch">æŒ‰åç§°æœç´¢</label>
            <input id="discSearch" type="text" placeholder="ä¾‹å¦‚ï¼šèµ›åšæœ‹å…‹ 2077" />
          </div>
          <div class="form-row">
            <label for="discFilter">æŠ˜æ‰£åŠ›åº¦</label>
            <select id="discFilter">
              <option value="all">å…¨éƒ¨æŠ˜æ‰£</option>
              <option value="20">â‰¥ 20%</option>
              <option value="50">â‰¥ 50%</option>
              <option value="70">â‰¥ 70%</option>
            </select>
          </div>
          <div class="form-row">
            <label>
              <input type="checkbox" id="discLowOnly" />
              åªçœ‹å²ä½
            </label>
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>å½“å‰æŠ˜æ‰£</span>
          </div>
          <div class="chip" id="discCount">å…± 0 æ¬¾</div>
        </header>
        <div id="discList" class="game-list"></div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">è¯´æ˜</div>
        <div class="sidebar-item">
          <span class="label">â€œå²ä½â€</span><span class="value">ç¤ºä¾‹å±æ€§</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®</span><span class="value">å‰ç«¯å‡æ•°æ®</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script>
  initCommon();

  // ä» ranking.json åŠ è½½çœŸå®æŠ˜æ‰£æ•°æ®
  let discountData = [];
  let isDataLoaded = false;

  // åŠ è½½æŠ˜æ‰£æ•°æ®
  function loadDiscountData() {
    fetch("ranking.json")
      .then((res) => {
        if (!res.ok) throw new Error("HTTP çŠ¶æ€ç  " + res.status);
        return res.json();
      })
      .then((data) => {
        // ä½¿ç”¨ discount åˆ†ç±»çš„æ•°æ®ï¼Œå¹¶æ¨¡æ‹ŸæŠ˜æ‰£ä¿¡æ¯
        discountData = (data.discount || []).map((game, index) => {
          // æ¨¡æ‹ŸåŸä»·å’ŒæŠ˜æ‰£ï¼ˆåŸºäºè¯„åˆ†ï¼‰
          const basePrice = Math.floor(game.score * 30); // åŸºç¡€ä»·æ ¼
          const discountPercent = 30 + Math.floor(Math.random() * 50); // 30-80% æŠ˜æ‰£
          const nowPrice = Math.floor(basePrice * (100 - discountPercent) / 100);
          
          return {
            id: game.id,
            name: game.name,
            platform: game.platform || "PC",
            oldPrice: basePrice,
            nowPrice: nowPrice,
            low: index % 3 === 0, // æ¯3ä¸ªæ¸¸æˆæ ‡è®°ä¸ºå²ä½
            cover: game.cover,
            score: game.score
          };
        });
        
        isDataLoaded = true;
        renderDiscount();
      })
      .catch((err) => {
        console.error("åŠ è½½æŠ˜æ‰£æ•°æ®å¤±è´¥:", err);
        discList.innerHTML = `
          <div style="font-size:12px;color:var(--danger);padding:20px;text-align:center;">
            âŒ æŠ˜æ‰£æ•°æ®åŠ è½½å¤±è´¥<br>
            <span style="font-size: 11px; opacity: 0.8;">é”™è¯¯: ${err.message}</span><br>
            <button onclick="loadDiscountData()" style="margin-top: 10px;" class="btn btn-inline">é‡è¯•</button>
          </div>
        `;
      });
  }

  function calcOff(item) {
    return Math.round((1 - item.nowPrice / item.oldPrice) * 100);
  }

  const discSearch = document.getElementById("discSearch");
  const discFilter = document.getElementById("discFilter");
  const discLowOnly = document.getElementById("discLowOnly");
  const discList = document.getElementById("discList");
  const discCount = document.getElementById("discCount");

  function renderDiscount() {
    if (!isDataLoaded) {
      discList.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:20px;text-align:center;">ğŸ’° æ­£åœ¨åŠ è½½æŠ˜æ‰£æ•°æ®...</div>';
      discCount.textContent = `å…± 0 æ¬¾`;
      return;
    }

    const kw = discSearch.value.trim().toLowerCase();
    const off = discFilter.value; // all / 20 / 50 / 70
    const lowOnly = discLowOnly.checked;

    let list = discountData.filter((item) => {
      if (kw) {
        const text = (item.name + " " + item.platform).toLowerCase();
        if (!text.includes(kw)) return false;
      }
      const offVal = calcOff(item);
      if (off !== "all" && offVal < Number(off)) return false;
      if (lowOnly && !item.low) return false;
      return true;
    });

    // æŒ‰æŠ˜æ‰£åŠ›åº¦ä»é«˜åˆ°ä½
    list.sort((a, b) => calcOff(b) - calcOff(a));

    discList.innerHTML = "";
    discCount.textContent = `å…± ${list.length} æ¬¾`;

    if (!list.length) {
      discList.innerHTML =
        '<div style="font-size:12px;color:var(--text-muted);padding:20px;text-align:center;">ğŸ’° å½“å‰æ¡ä»¶ä¸‹æ²¡æœ‰æŠ˜æ‰£æ¸¸æˆã€‚</div>';
      return;
    }

    list.forEach((item) => {
      const offVal = calcOff(item);
      const div = document.createElement("div");
      div.className = "game-card";
      div.style.cursor = "pointer";
      
      // è®¡ç®—çœä¸‹çš„é’±
      const saved = item.oldPrice - item.nowPrice;
      
      // ä½¿ç”¨çœŸå®å°é¢å›¾æˆ–é»˜è®¤å›¾æ ‡
      const coverHtml = item.cover 
        ? `<img src="${item.cover}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\\'display:flex;align-items:center;justify-content:center;height:100%;font-size:32px;\\'>ğŸ®</div>';" />`
        : '<div style="display: flex; align-items: center; justify-content: center; font-size: 32px; height: 100%;">ğŸ®</div>';
      
      div.innerHTML = `
        <div class="game-cover" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(249, 115, 22, 0.2)), #0b1020;">${coverHtml}</div>
        <div class="game-info">
          <div class="game-name">${item.name}</div>
          <div class="game-meta">ğŸ“ ${item.platform}</div>
          <div class="game-footer">
            <span class="tag" style="text-decoration: line-through; opacity: 0.6;">åŸä»· Â¥${item.oldPrice}</span>
            <span class="tag tag--accent" style="font-size: 14px; font-weight: bold;">ç°ä»· Â¥${item.nowPrice}</span>
            <span class="tag tag--danger" style="font-weight: bold;">-${offVal}%</span>
            ${item.low ? '<span class="tag" style="background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; font-weight: bold;">ğŸ”¥ å²ä½</span>' : ""}
          </div>
          <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
            ğŸ’° çœ Â¥${saved} ${item.low ? "Â· å†å²æœ€ä½ä»·ï¼Œå»ºè®®å…¥æ‰‹ï¼" : ""}
          </div>
        </div>
      `;
      
      // æ·»åŠ æ‚¬åœæ•ˆæœ
      div.addEventListener("mouseenter", () => {
        div.style.transform = "translateY(-2px)";
        div.style.boxShadow = "0 4px 12px rgba(239, 68, 68, 0.3)";
        div.style.transition = "all 0.3s ease";
      });
      
      div.addEventListener("mouseleave", () => {
        div.style.transform = "translateY(0)";
        div.style.boxShadow = "";
      });
      
      div.addEventListener("click", () => {
        // è·³è½¬åˆ°æ¸¸æˆè¯¦æƒ…é¡µ
        const url = new URL("game-detail.html", window.location.href);
        if (item.id) {
          url.searchParams.set("id", item.id);
        }
        url.searchParams.set("name", item.name);
        window.location.href = url.toString();
      });
      discList.appendChild(div);
    });
  }

  discSearch.addEventListener("input", renderDiscount);
  discFilter.addEventListener("change", renderDiscount);
  discLowOnly.addEventListener("change", renderDiscount);
  
  // åŠ è½½çœŸå®æŠ˜æ‰£æ•°æ®
  loadDiscountData();
</script>
</body>
</html>
