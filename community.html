<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>GameBox æ¸¸ç›’ - ç¤¾åŒº</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
  <style>
    /* ç¤¾åŒºé¡µé¢ä¸“å±æ ·å¼ */
    .community-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .community-stat {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 1px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .community-stat:hover {
      border-color: var(--cyber-yellow);
      box-shadow: 0 0 20px rgba(255, 211, 0, 0.3);
    }
    
    .community-stat .icon {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .community-stat .value {
      font-family: 'Orbitron', sans-serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--cyber-yellow);
    }
    
    .community-stat .label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* æ¿å—é€‰æ‹©å™¨ */
    .board-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    
    .board-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .board-btn:hover {
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
    }
    
    .board-btn.active {
      background: linear-gradient(135deg, rgba(255, 211, 0, 0.15) 0%, rgba(255, 61, 148, 0.1) 100%);
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
      box-shadow: 0 0 15px rgba(255, 211, 0, 0.3);
    }
    
    .board-btn .board-icon {
      font-size: 18px;
    }
    
    .board-btn .board-count {
      background: rgba(255, 211, 0, 0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    
    /* å¸–å­å¡ç‰‡ */
    .post-card {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(20, 0, 30, 0.85) 100%);
      border: 1px solid rgba(255, 211, 0, 0.2);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .post-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--cyber-yellow), var(--cyber-pink));
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    
    .post-card:hover {
      border-color: rgba(255, 211, 0, 0.5);
      transform: translateX(5px);
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
    }
    
    .post-card:hover::before {
      transform: scaleY(1);
    }
    
    .post-card.pinned {
      border-color: rgba(255, 61, 148, 0.4);
      background: linear-gradient(135deg, rgba(255, 61, 148, 0.1) 0%, rgba(20, 0, 30, 0.9) 100%);
    }
    
    .post-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    
    .post-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cyber-yellow), var(--cyber-pink));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .post-info {
      flex: 1;
    }
    
    .post-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .post-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .post-badge.hot {
      background: linear-gradient(135deg, #FF0055, #FF3D94);
      color: #fff;
    }
    
    .post-badge.pinned {
      background: linear-gradient(135deg, var(--cyber-yellow), #FFC700);
      color: #000;
    }
    
    .post-badge.new {
      background: linear-gradient(135deg, var(--cyber-cyan), #00FF9F);
      color: #000;
    }
    
    .post-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .post-content {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .post-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .post-tags {
      display: flex;
      gap: 8px;
    }
    
    .post-tag {
      padding: 3px 10px;
      background: rgba(85, 234, 212, 0.15);
      border: 1px solid rgba(85, 234, 212, 0.3);
      border-radius: 4px;
      font-size: 11px;
      color: var(--cyber-cyan);
    }
    
    .post-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .post-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* å‘å¸–æŒ‰é’® */
    .create-post-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(255, 211, 0, 0.2) 0%, rgba(255, 61, 148, 0.15) 100%);
      border: 2px solid var(--cyber-yellow);
      color: var(--cyber-yellow);
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 4px;
    }
    
    .create-post-btn:hover {
      background: linear-gradient(135deg, rgba(255, 211, 0, 0.3) 0%, rgba(255, 61, 148, 0.2) 100%);
      box-shadow: 0 0 20px rgba(255, 211, 0, 0.4);
      transform: translateY(-2px);
    }
    
    /* åœ¨çº¿ç”¨æˆ· */
    .online-users {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    
    .online-user {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      font-size: 11px;
    }
    
    .online-dot {
      width: 6px;
      height: 6px;
      background: var(--cyber-cyan);
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* çƒ­é—¨è¯é¢˜ */
    .hot-topic {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .hot-topic:hover {
      background: rgba(255, 211, 0, 0.1);
      transform: translateX(3px);
    }
    
    .hot-topic-rank {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--cyber-pink);
      min-width: 24px;
    }
    
    .hot-topic-title {
      flex: 1;
      font-size: 12px;
      color: var(--text-main);
    }
    
    .hot-topic-heat {
      font-size: 11px;
      color: var(--cyber-yellow);
    }
    
    @media (max-width: 768px) {
      .community-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .board-selector {
        flex-direction: column;
      }
      
      .board-btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body data-current-page="community">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user" onclick="window.location.href='profile.html';" style="cursor: pointer;">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="card">
        <div class="page-title">ğŸ’¬ ç¤¾åŒºå¹¿åœº</div>
        <div class="page-intro">
          ä¸ç©å®¶äº¤æµå¿ƒå¾—ã€åˆ†äº«æ”»ç•¥ã€å‘å¸ƒæˆªå›¾ï¼ŒåŠ å…¥æœ€æ´»è·ƒçš„æ¸¸æˆç¤¾åŒºã€‚
        </div>
      </div>

      <!-- ç¤¾åŒºç»Ÿè®¡ -->
      <div class="community-stats">
        <div class="community-stat">
          <div class="icon">ğŸ“</div>
          <div class="value" id="statPosts">0</div>
          <div class="label">å¸–å­æ€»æ•°</div>
        </div>
        <div class="community-stat">
          <div class="icon">ğŸ‘¥</div>
          <div class="value" id="statMembers">0</div>
          <div class="label">ç¤¾åŒºæˆå‘˜</div>
        </div>
        <div class="community-stat">
          <div class="icon">ğŸ’¬</div>
          <div class="value" id="statReplies">0</div>
          <div class="label">å›å¤æ€»æ•°</div>
        </div>
        <div class="community-stat">
          <div class="icon">ğŸŸ¢</div>
          <div class="value" id="statOnline">0</div>
          <div class="label">åœ¨çº¿äººæ•° <span style="font-size: 9px; opacity: 0.7; color: var(--cyber-cyan);">â—å®æ—¶</span></div>
        </div>
      </div>

      <!-- æ¿å—ä¸æœç´¢ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>// BOARDS</span>
          </div>
          <button class="create-post-btn" onclick="createPost()">
            <span>âœï¸</span>
            <span>å‘å¸ƒæ–°å¸–</span>
          </button>
        </header>
        
        <div class="board-selector" id="boardSelector">
          <button class="board-btn active" data-board="all">
            <span class="board-icon">ğŸŒ</span>
            <span>å…¨éƒ¨</span>
            <span class="board-count" id="countAll">0</span>
          </button>
          <button class="board-btn" data-board="general">
            <span class="board-icon">ğŸ’¬</span>
            <span>ç»¼åˆè®¨è®º</span>
            <span class="board-count" id="countGeneral">0</span>
          </button>
          <button class="board-btn" data-board="guide">
            <span class="board-icon">ğŸ“š</span>
            <span>æ”»ç•¥å¿ƒå¾—</span>
            <span class="board-count" id="countGuide">0</span>
          </button>
          <button class="board-btn" data-board="shot">
            <span class="board-icon">ğŸ“·</span>
            <span>æ¸¸æˆæˆªå›¾</span>
            <span class="board-count" id="countShot">0</span>
          </button>
          <button class="board-btn" data-board="trade">
            <span class="board-icon">ğŸ”„</span>
            <span>äº¤æ˜“æ±‚åŠ©</span>
            <span class="board-count" id="countTrade">0</span>
          </button>
        </div>
        
        <div style="margin-top: 16px;">
          <input id="postSearch" type="text" placeholder="ğŸ” æœç´¢å¸–å­æ ‡é¢˜ã€æ¸¸æˆåç§°..." style="width: 100%;" />
        </div>
      </div>

      <!-- å¸–å­åˆ—è¡¨ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>å¸–å­åˆ—è¡¨</span>
          </div>
          <div class="chip" id="postCount">å…± 0 å¸–</div>
        </header>
        <div id="postList"></div>
      </div>
    </section>

    <aside>
      <!-- çƒ­é—¨è¯é¢˜ -->
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ”¥ çƒ­é—¨è¯é¢˜</div>
        <div id="hotTopics"></div>
      </div>
      
      <!-- åœ¨çº¿ç”¨æˆ· -->
      <div class="sidebar-card" style="margin-top: 16px;">
        <div class="sidebar-title">ğŸŸ¢ åœ¨çº¿ç©å®¶</div>
        <div class="online-users" id="onlineUsers"></div>
      </div>
      
      <!-- ç¤¾åŒºè§„åˆ™ -->
      <div class="sidebar-card" style="margin-top: 16px;">
        <div class="sidebar-title">ğŸ“‹ ç¤¾åŒºè§„åˆ™</div>
        <div class="sidebar-item">
          <span class="label">1</span>
          <span class="value">å‹å–„äº¤æµï¼Œå°Šé‡ä»–äºº</span>
        </div>
        <div class="sidebar-item">
          <span class="label">2</span>
          <span class="value">ç¦æ­¢å¹¿å‘Šå’Œåƒåœ¾ä¿¡æ¯</span>
        </div>
        <div class="sidebar-item">
          <span class="label">3</span>
          <span class="value">å‰§é€è¯·æ ‡æ³¨è­¦å‘Š</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>

<script>
  // ============================================
  // ç¦ç”¨ Service Worker
  // ============================================
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.getRegistrations().then(function(registrations) {
      for(let registration of registrations) {
        registration.unregister();
      }
    });
  }

  initCommon();

  // ============================================
  // Supabase é…ç½®å’Œè¿æ¥ï¼ˆç¡¬ç¼–ç ï¼‰
  // ============================================
  const SUPABASE_URL = 'https://gybgiqyyltckgxbdtzwu.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5YmdpcXl5bHRja2d4YmR0end1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTA2MDksImV4cCI6MjA4MDM4NjYwOX0.WWF_rPUyIVOFDccLXm06Npf6J3fJoA_bbFoVJeZQzrA';

  let supabaseClient = null;
  let postData = [];
  let currentBoard = "all";
  const userId = 'user-' + Date.now();

  // åŠ¨æ€åŠ è½½ Supabase SDK
  function loadSupabaseSDK() {
    return new Promise((resolve, reject) => {
      if (typeof supabase !== 'undefined') {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  // ============================================
  // Supabase æ“ä½œå‡½æ•°
  // ============================================
  
  async function registerUser() {
    try {
      await supabaseClient
        .from('user_profiles')
        .upsert({
          id: userId,
          username: 'è®¿å®¢' + Math.floor(Math.random() * 1000),
          avatar: 'ğŸ‘¤',
          last_login_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }, { onConflict: 'id' });
      console.log('âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ');
    } catch (e) {
      console.error('ç”¨æˆ·æ³¨å†Œå¤±è´¥:', e);
    }
  }

  async function updateOnlineStatus() {
    try {
      // å°è¯•æ›´æ–°åœ¨çº¿çŠ¶æ€ï¼ˆå¦‚æœè¡¨å­˜åœ¨ï¼‰
      const { error } = await supabaseClient
        .from('online_users')
        .upsert({
          user_id: userId,
          last_seen_at: new Date().toISOString()
        }, { onConflict: 'user_id' });
      
      if (!error) {
        console.log('ğŸŸ¢ åœ¨çº¿çŠ¶æ€å·²æ›´æ–°');
      }
    } catch (e) {
      // å¿½ç•¥é”™è¯¯ï¼Œç»§ç»­è¿è¡Œ
      console.warn('âš ï¸ åœ¨çº¿çŠ¶æ€æ›´æ–°å¤±è´¥ï¼ˆè¡¨å¯èƒ½ä¸å­˜åœ¨ï¼‰:', e.message);
    }
  }

  async function loadAllPosts() {
    try {
      const { data, error } = await supabaseClient
        .from('community_posts')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      
      // è½¬æ¢å­—æ®µå
      postData = (data || []).map(post => ({
        id: post.id,
        title: post.title,
        content: post.content,
        author: post.author,
        avatar: post.avatar,
        game: post.game,
        board: post.board,
        replies: post.replies || 0,
        likes: post.likes || 0,
        views: post.views || 0,
        isPinned: post.is_pinned || false,
        isNew: post.is_new || false,
        time: formatTime(post.created_at)
      }));
      
      console.log('âœ… åŠ è½½äº†', postData.length, 'æ¡å¸–å­');
      return postData;
    } catch (e) {
      console.error('åŠ è½½å¸–å­å¤±è´¥:', e);
      return [];
    }
  }

  async function updateStats() {
    try {
      // å¸–å­æ€»æ•°
      const { count: postsCount } = await supabaseClient
        .from('community_posts')
        .select('*', { count: 'exact', head: true });
      
      // æˆå‘˜æ€»æ•°
      const { count: membersCount } = await supabaseClient
        .from('user_profiles')
        .select('*', { count: 'exact', head: true });
      
      // åœ¨çº¿äººæ•°ï¼ˆå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œä½¿ç”¨æˆå‘˜æ•°ä»£æ›¿ï¼‰
      let onlineCount = 0;
      try {
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
        const { count, error } = await supabaseClient
          .from('online_users')
          .select('*', { count: 'exact', head: true })
          .gte('last_seen_at', fiveMinutesAgo);
        
        if (!error) {
          onlineCount = count || 0;
        } else {
          // é™çº§ï¼šä½¿ç”¨æˆå‘˜æ•°çš„ 1/3 ä½œä¸ºä¼°è®¡
          onlineCount = Math.ceil((membersCount || 0) / 3);
        }
      } catch (e) {
        // é™çº§ï¼šä½¿ç”¨æˆå‘˜æ•°çš„ 1/3 ä½œä¸ºä¼°è®¡
        onlineCount = Math.ceil((membersCount || 0) / 3);
      }
      
      // æ€»å›å¤æ•°
      const totalReplies = postData.reduce((sum, p) => sum + (p.replies || 0), 0);
      
      animateNumber('statPosts', postsCount || 0);
      animateNumber('statMembers', membersCount || 0);
      animateNumber('statReplies', totalReplies);
      animateNumber('statOnline', onlineCount || 0);
      
      console.log('ğŸ“Š ç»Ÿè®¡æ›´æ–° [Supabase]:', { posts: postsCount, members: membersCount, online: onlineCount });
    } catch (e) {
      console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', e);
    }
  }

  async function loadOnlineUsers() {
    try {
      const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
      const { data, error } = await supabaseClient
        .from('online_users')
        .select('user_id')
        .gte('last_seen_at', fiveMinutesAgo)
        .limit(10);
      
      if (error) {
        // é™çº§ï¼šä» user_profiles è·å–æœ€è¿‘æ´»è·ƒç”¨æˆ·
        const { data: userData } = await supabaseClient
          .from('user_profiles')
          .select('username')
          .order('last_login_at', { ascending: false })
          .limit(6);
        
        const users = (userData || []).map(u => u.username || 'è®¿å®¢');
        renderOnlineUsers(users.length > 0 ? users : ['è®¿å®¢1', 'è®¿å®¢2', 'è®¿å®¢3']);
        return;
      }
      
      const users = (data || []).map((_, i) => 'ç©å®¶' + (i + 1));
      renderOnlineUsers(users.length > 0 ? users : ['è®¿å®¢1', 'è®¿å®¢2', 'è®¿å®¢3']);
    } catch (e) {
      console.warn('âš ï¸ åŠ è½½åœ¨çº¿ç”¨æˆ·å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', e.message);
      renderOnlineUsers(['è®¿å®¢1', 'è®¿å®¢2', 'è®¿å®¢3']);
    }
  }

  // ============================================
  // UI æ¸²æŸ“å‡½æ•°
  // ============================================
  
  function formatTime(timestamp) {
    const now = new Date();
    const time = new Date(timestamp);
    const diff = Math.floor((now - time) / 1000);
    
    if (diff < 60) return 'åˆšåˆš';
    if (diff < 3600) return Math.floor(diff / 60) + 'åˆ†é’Ÿå‰';
    if (diff < 86400) return Math.floor(diff / 3600) + 'å°æ—¶å‰';
    if (diff < 2592000) return Math.floor(diff / 86400) + 'å¤©å‰';
    return time.toLocaleDateString();
  }

  function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
    if (currentValue === targetValue) return;
    
    if (Math.abs(targetValue - currentValue) < 5) {
      element.textContent = targetValue.toLocaleString();
      return;
    }
    
    const duration = 500;
    const startTime = performance.now();
    
    function update(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const value = Math.round(currentValue + (targetValue - currentValue) * easeOut);
      element.textContent = value.toLocaleString();
      
      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }
    
    requestAnimationFrame(update);
  }

  function renderPosts() {
    const kw = document.getElementById('postSearch').value.trim().toLowerCase();
    
    let list = postData.filter(p => {
      if (currentBoard !== "all" && p.board !== currentBoard) return false;
      if (kw) {
        const text = (p.title + " " + p.game + " " + p.content).toLowerCase();
        if (!text.includes(kw)) return false;
      }
      return true;
    });

    list.sort((a, b) => {
      if (a.isPinned && !b.isPinned) return -1;
      if (!a.isPinned && b.isPinned) return 1;
      return (b.replies + b.likes) - (a.replies + a.likes);
    });

    const postList = document.getElementById('postList');
    const postCount = document.getElementById('postCount');
    postCount.textContent = `å…± ${list.length} å¸–`;

    if (!list.length) {
      postList.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">ğŸ’¬ æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¸–å­</div>';
      return;
    }

    postList.innerHTML = list.map(p => {
      let badges = '';
      if (p.isPinned) badges += '<span class="post-badge pinned">ğŸ“Œ ç½®é¡¶</span>';
      if (p.isNew) badges += '<span class="post-badge new">NEW</span>';
      if ((p.replies + p.likes) > 500) badges += '<span class="post-badge hot">ğŸ”¥ çƒ­é—¨</span>';

      return `
        <div class="post-card ${p.isPinned ? 'pinned' : ''}">
          <div class="post-header">
            <div class="post-avatar">${p.avatar}</div>
            <div class="post-info">
              <div class="post-title">
                ${p.title}
                ${badges}
              </div>
              <div class="post-meta">
                <span>ğŸ‘¤ ${p.author}</span>
                <span>ğŸ•’ ${p.time}</span>
                <span>ğŸ‘ï¸ ${p.views.toLocaleString()}</span>
              </div>
            </div>
          </div>
          <div class="post-content">${p.content}</div>
          <div class="post-footer">
            <div class="post-tags">
              <span class="post-tag">ğŸ® ${p.game}</span>
            </div>
            <div class="post-stats">
              <span class="post-stat">ğŸ’¬ ${p.replies}</span>
              <span class="post-stat">ğŸ‘ ${p.likes}</span>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function updateBoardCounts() {
    const counts = {
      all: postData.length,
      general: postData.filter(p => p.board === 'general').length,
      guide: postData.filter(p => p.board === 'guide').length,
      shot: postData.filter(p => p.board === 'shot').length,
      trade: postData.filter(p => p.board === 'trade').length
    };
    
    document.getElementById('countAll').textContent = counts.all;
    document.getElementById('countGeneral').textContent = counts.general;
    document.getElementById('countGuide').textContent = counts.guide;
    document.getElementById('countShot').textContent = counts.shot;
    document.getElementById('countTrade').textContent = counts.trade;
  }

  function renderHotTopics() {
    const container = document.getElementById('hotTopics');
    const topics = postData
      .map(post => ({
        title: post.title,
        heat: (post.likes || 0) * 2 + (post.replies || 0) * 3 + Math.floor((post.views || 0) / 10)
      }))
      .sort((a, b) => b.heat - a.heat)
      .slice(0, 5);
    
    container.innerHTML = topics.map((topic, i) => `
      <div class="hot-topic">
        <span class="hot-topic-rank" style="color: ${i < 3 ? 'var(--cyber-pink)' : 'var(--text-muted)'}">${i + 1}</span>
        <span class="hot-topic-title">${topic.title}</span>
        <span class="hot-topic-heat">ğŸ”¥ ${topic.heat}</span>
      </div>
    `).join('');
  }

  function renderOnlineUsers(users) {
    const container = document.getElementById('onlineUsers');
    const displayUsers = users.slice(0, 6);
    const remainingCount = Math.max(0, users.length - 6);
    
    container.innerHTML = displayUsers.map(user => `
      <div class="online-user">
        <span class="online-dot"></span>
        <span>${user}</span>
      </div>
    `).join('') + (remainingCount > 0 ? `<div class="online-user" style="color: var(--text-muted);">+${remainingCount} æ›´å¤š</div>` : '');
  }

  // ============================================
  // äº‹ä»¶å¤„ç†
  // ============================================
  
  document.getElementById("boardSelector").addEventListener("click", e => {
    const btn = e.target.closest(".board-btn");
    if (!btn) return;
    
    currentBoard = btn.dataset.board;
    document.querySelectorAll(".board-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderPosts();
  });

  document.getElementById("postSearch").addEventListener("input", renderPosts);

  async function createPost() {
    openCreatePostModal();
  }

  function showStatusBadge(connected) {
    const badge = document.createElement('div');
    badge.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: ${connected ? 'linear-gradient(135deg, rgba(0, 255, 159, 0.2), rgba(85, 234, 212, 0.15))' : 'linear-gradient(135deg, rgba(255, 69, 0, 0.3), rgba(255, 0, 0, 0.2))'};
      border: 2px solid ${connected ? 'var(--cyber-cyan)' : '#ff4500'};
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 11px;
      color: var(--text-main);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-family: 'Orbitron', sans-serif;
    `;
    badge.innerHTML = `
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 14px;">${connected ? 'ğŸŸ¢' : 'ğŸ”´'}</span>
        <span>${connected ? 'Supabase äº‘æ•°æ®åº“' : 'è¿æ¥å¤±è´¥'}</span>
      </div>
    `;
    document.body.appendChild(badge);
    
    setTimeout(() => {
      badge.style.transition = 'opacity 1s ease';
      badge.style.opacity = '0';
      setTimeout(() => badge.remove(), 1000);
    }, 5000);
  }

  // ============================================
  // åˆå§‹åŒ–
  // ============================================
  
  async function init() {
    console.log('ğŸš€ ç¤¾åŒºé¡µé¢åˆå§‹åŒ–...');
    
    try {
      await loadSupabaseSDK();
      console.log('âœ… Supabase SDK åŠ è½½å®Œæˆ');
      
      if (typeof supabase === 'undefined') {
        throw new Error('Supabase SDK åŠ è½½å¤±è´¥');
      }
      
      supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      console.log('âœ… Supabase å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
      
      // æµ‹è¯•è¿æ¥
      const { data: testData, error: testError } = await supabaseClient
        .from('community_posts')
        .select('id')
        .limit(1);
      
      if (testError) throw testError;
      
      console.log('âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•é€šè¿‡');
      showStatusBadge(true);
      
      // æ³¨å†Œç”¨æˆ·å’Œæ›´æ–°åœ¨çº¿çŠ¶æ€
      await registerUser();
      await updateOnlineStatus();
      setInterval(updateOnlineStatus, 30000);
      
      // åŠ è½½æ•°æ®
      await loadAllPosts();
      renderPosts();
      updateBoardCounts();
      renderHotTopics();
      await loadOnlineUsers();
      await updateStats();
      
      // è®¢é˜… Realtime æ›´æ–°
      subscribeToRealtimeUpdates();
      
      // å®šæœŸæ›´æ–°
      setInterval(async () => {
        await updateStats();
        await loadOnlineUsers();
      }, 15000);
      
      console.log('ğŸ‰ ç¤¾åŒºé¡µé¢åˆå§‹åŒ–å®Œæˆï¼');
      
    } catch (e) {
      console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', e);
      showStatusBadge(false);
      document.getElementById('postList').innerHTML = 
        '<div style="text-align:center;padding:40px;color:#ff4444;">âŒ è¿æ¥å¤±è´¥: ' + e.message + '</div>';
    }
  }

  // ============================================
  // Realtime è®¢é˜…
  // ============================================
  
  function subscribeToRealtimeUpdates() {
    try {
      const channel = supabaseClient
        .channel('community-updates')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'community_posts'
        }, async (payload) => {
          console.log('ğŸ“¡ æ”¶åˆ°å®æ—¶æ›´æ–°:', payload);
          await loadAllPosts();
          renderPosts();
          updateBoardCounts();
          await updateStats();
        })
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('âœ… Realtime è®¢é˜…æˆåŠŸ');
          }
        });
    } catch (e) {
      console.error('Realtime è®¢é˜…å¤±è´¥:', e);
    }
  }

  // ============================================
  // å‘å¸–æ¨¡æ€æ¡†
  // ============================================
  
  const modalHTML = `
    <div id="createPostModal" class="create-post-modal" style="display: none;">
      <div class="modal-overlay" onclick="closeCreatePostModal()"></div>
      <div class="modal-content">
        <div class="modal-header">
          <h3>âœï¸ å‘å¸ƒæ–°å¸–</h3>
          <button class="modal-close" onclick="closeCreatePostModal()">âœ•</button>
        </div>
        
        <div class="modal-body">
          <form id="createPostForm" onsubmit="handlePostSubmit(event); return false;">
            <div class="form-group">
              <label for="postTitle">å¸–å­æ ‡é¢˜ *</label>
              <input 
                type="text" 
                id="postTitle" 
                placeholder="è¯·è¾“å…¥å¸–å­æ ‡é¢˜ï¼ˆ10-100å­—ç¬¦ï¼‰" 
                maxlength="100"
                required
              />
            </div>
            
            <div class="form-group">
              <label for="postGame">ç›¸å…³æ¸¸æˆ *</label>
              <input 
                type="text" 
                id="postGame" 
                placeholder="ä¾‹å¦‚ï¼šè‰¾å°”ç™»æ³•ç¯ã€èµ›åšæœ‹å…‹2077"
                required
              />
            </div>
            
            <div class="form-group">
              <label for="postBoard">æ¿å—é€‰æ‹© *</label>
              <select id="postBoard" required>
                <option value="general">ğŸ’¬ ç»¼åˆè®¨è®º</option>
                <option value="guide">ğŸ“š æ”»ç•¥å¿ƒå¾—</option>
                <option value="shot">ğŸ“· æ¸¸æˆæˆªå›¾</option>
                <option value="trade">ğŸ”„ äº¤æ˜“æ±‚åŠ©</option>
              </select>
            </div>
            
            <div class="form-group">
              <label for="postContent">å¸–å­å†…å®¹ *</label>
              <textarea 
                id="postContent" 
                rows="10"
                placeholder="åˆ†äº«ä½ çš„æ¸¸æˆå¿ƒå¾—ã€æ”»ç•¥ã€æˆªå›¾æˆ–é—®é¢˜..."
                required
              ></textarea>
            </div>
            
            <div class="form-actions">
              <button type="button" class="btn btn-secondary" onclick="closeCreatePostModal()">
                å–æ¶ˆ
              </button>
              <button type="submit" class="btn btn-primary" id="submitPostBtn">
                ğŸš€ å‘å¸ƒå¸–å­
              </button>
            </div>
          </form>
          
          <div id="postResult" class="post-result" style="display: none;"></div>
        </div>
      </div>
    </div>
  `;
  
  const modalCSS = `
    <style>
      .create-post-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
      }
      
      .modal-content {
        position: relative;
        width: 90%;
        max-width: 700px;
        max-height: 90vh;
        background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.95) 100%);
        border: 2px solid rgba(255, 211, 0, 0.5);
        border-radius: 12px;
        box-shadow: 0 0 50px rgba(255, 211, 0, 0.3);
        overflow: hidden;
        animation: modalSlideIn 0.3s ease;
      }
      
      @keyframes modalSlideIn {
        from { opacity: 0; transform: translateY(-50px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 20px 24px;
        border-bottom: 2px solid rgba(255, 211, 0, 0.3);
        background: rgba(255, 211, 0, 0.05);
      }
      
      .modal-header h3 {
        margin: 0;
        font-family: 'Orbitron', sans-serif;
        font-size: 20px;
        font-weight: 700;
        color: var(--cyber-yellow);
      }
      
      .modal-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 0, 0, 0.2);
        color: #fff;
        font-size: 20px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .modal-close:hover {
        background: rgba(255, 0, 0, 0.4);
        transform: rotate(90deg);
      }
      
      .modal-body {
        padding: 24px;
        max-height: calc(90vh - 80px);
        overflow-y: auto;
      }
      
      .form-group {
        margin-bottom: 20px;
      }
      
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--cyber-cyan);
      }
      
      .form-group input[type="text"],
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(85, 234, 212, 0.3);
        border-radius: 6px;
        color: var(--text-main);
        font-size: 14px;
        font-family: inherit;
        transition: all 0.3s ease;
      }
      
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: var(--cyber-cyan);
        box-shadow: 0 0 15px rgba(85, 234, 212, 0.3);
      }
      
      .form-group textarea {
        resize: vertical;
        min-height: 200px;
        line-height: 1.6;
      }
      
      .form-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 24px;
        padding-top: 20px;
        border-top: 1px solid rgba(85, 234, 212, 0.2);
      }
      
      .btn {
        padding: 10px 24px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      
      .btn-secondary {
        background: rgba(128, 128, 128, 0.3);
        color: var(--text-main);
        border: 1px solid rgba(128, 128, 128, 0.5);
      }
      
      .btn-secondary:hover {
        background: rgba(128, 128, 128, 0.5);
      }
      
      .btn-primary {
        background: linear-gradient(135deg, rgba(85, 234, 212, 0.3), rgba(0, 255, 159, 0.3));
        color: var(--cyber-cyan);
        border: 2px solid var(--cyber-cyan);
      }
      
      .btn-primary:hover {
        background: linear-gradient(135deg, rgba(85, 234, 212, 0.5), rgba(0, 255, 159, 0.5));
        box-shadow: 0 0 20px rgba(85, 234, 212, 0.4);
        transform: translateY(-2px);
      }
      
      .post-result {
        padding: 16px;
        border-radius: 6px;
        margin-top: 20px;
        text-align: center;
        font-size: 14px;
      }
      
      .post-result.success {
        background: rgba(0, 255, 159, 0.1);
        border: 1px solid rgba(0, 255, 159, 0.3);
        color: var(--cyber-cyan);
      }
      
      .post-result.error {
        background: rgba(255, 0, 0, 0.1);
        border: 1px solid rgba(255, 0, 0, 0.3);
        color: #ff5555;
      }
    </style>
  `;
  
  document.head.insertAdjacentHTML('beforeend', modalCSS);
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  function openCreatePostModal() {
    document.getElementById('createPostModal').style.display = 'flex';
    document.body.style.overflow = 'hidden';
    document.getElementById('postResult').style.display = 'none';
  }
  
  function closeCreatePostModal() {
    document.getElementById('createPostModal').style.display = 'none';
    document.body.style.overflow = 'auto';
  }
  
  async function handlePostSubmit(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitPostBtn');
    const resultDiv = document.getElementById('postResult');
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'â³ å‘å¸ƒä¸­...';
    
    try {
      const title = document.getElementById('postTitle').value.trim();
      const game = document.getElementById('postGame').value.trim();
      const board = document.getElementById('postBoard').value;
      const content = document.getElementById('postContent').value.trim();
      
      if (!title || title.length < 5) {
        throw new Error('æ ‡é¢˜è‡³å°‘éœ€è¦5ä¸ªå­—ç¬¦');
      }
      
      if (!content || content.length < 10) {
        throw new Error('å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦');
      }
      
      const newPost = {
        id: 'post-' + Date.now(),
        title: title,
        content: content,
        game: game,
        board: board,
        author: 'è®¿å®¢' + Math.floor(Math.random() * 1000),
        avatar: 'ğŸ‘¤',
        replies: 0,
        likes: 0,
        views: 0,
        is_pinned: false,
        is_new: true,
        created_at: new Date().toISOString()
      };
      
      const { data, error } = await supabaseClient
        .from('community_posts')
        .insert([newPost])
        .select();
      
      if (error) throw error;
      
      resultDiv.className = 'post-result success';
      resultDiv.style.display = 'block';
      resultDiv.textContent = 'âœ… å¸–å­å‘å¸ƒæˆåŠŸï¼';
      
      document.getElementById('createPostForm').reset();
      
      setTimeout(() => {
        closeCreatePostModal();
      }, 1500);
      
    } catch (error) {
      resultDiv.className = 'post-result error';
      resultDiv.style.display = 'block';
      resultDiv.textContent = 'âŒ ' + error.message;
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'ğŸš€ å‘å¸ƒå¸–å­';
    }
  }

  // å¯åŠ¨åˆå§‹åŒ–
  init();
</script>
</body>
</html>
