<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>GameBox ç¤¾åŒº V2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    h1 {
      font-size: 36px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .status {
      display: inline-block;
      padding: 10px 20px;
      background: #28a745;
      color: white;
      border-radius: 20px;
      font-size: 14px;
      margin-top: 10px;
    }
    .status.error {
      background: #dc3545;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .stat-value {
      font-size: 42px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    .posts {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 15px;
    }
    .post-item {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
    }
    .post-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .post-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    .post-content {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .post-meta {
      font-size: 12px;
      color: #999;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
    }
    .error-msg {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 20px;
      border-radius: 10px;
      color: #856404;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ® GameBox ç¤¾åŒº V2</h1>
      <div id="statusBadge" class="status">æ­£åœ¨è¿æ¥...</div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="statPosts">-</div>
        <div class="stat-label">ğŸ“ å¸–å­æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statMembers">-</div>
        <div class="stat-label">ğŸ‘¥ ç¤¾åŒºæˆå‘˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statReplies">-</div>
        <div class="stat-label">ğŸ’¬ å›å¤æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statOnline">-</div>
        <div class="stat-label">ğŸŸ¢ åœ¨çº¿äººæ•°</div>
      </div>
    </div>

    <div id="errorContainer"></div>

    <div class="posts">
      <h2 style="margin-bottom: 20px; color: #333;">ğŸ“‹ æœ€æ–°å¸–å­</h2>
      <div id="postList" class="loading">æ­£åœ¨åŠ è½½å¸–å­...</div>
    </div>
  </div>

  <script>
    // ç¦ç”¨ Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          registration.unregister();
        }
      });
    }

    // Supabase é…ç½®ï¼ˆç¡¬ç¼–ç ï¼Œé¿å…åŠ è½½å¤–éƒ¨æ–‡ä»¶ï¼‰
    const SUPABASE_URL = 'https://gybgiqyyltckgxbdtzwu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5YmdpcXl5bHRja2d4YmR0end1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTA2MDksImV4cCI6MjA4MDM4NjYwOX0.WWF_rPUyIVOFDccLXm06Npf6J3fJoA_bbFoVJeZQzrA';

    let supabaseClient = null;
    const userId = 'user-' + Date.now();

    // åŠ¨æ€åŠ è½½ Supabase SDK
    function loadSupabaseSDK() {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = () => {
          console.log('âœ… Supabase SDK åŠ è½½æˆåŠŸ');
          resolve();
        };
        script.onerror = () => {
          console.error('âŒ Supabase SDK åŠ è½½å¤±è´¥');
          reject(new Error('SDK åŠ è½½å¤±è´¥'));
        };
        document.head.appendChild(script);
      });
    }

    // æ˜¾ç¤ºé”™è¯¯
    function showError(msg) {
      const errorContainer = document.getElementById('errorContainer');
      errorContainer.innerHTML = `<div class="error-msg">âŒ ${msg}</div>`;
      document.getElementById('statusBadge').className = 'status error';
      document.getElementById('statusBadge').textContent = 'è¿æ¥å¤±è´¥';
    }

    // æ›´æ–°çŠ¶æ€å¾½ç« 
    function updateStatus(connected) {
      const badge = document.getElementById('statusBadge');
      if (connected) {
        badge.className = 'status';
        badge.textContent = 'ğŸŸ¢ Supabase äº‘æ•°æ®åº“';
      } else {
        badge.className = 'status error';
        badge.textContent = 'âŒ è¿æ¥å¤±è´¥';
      }
    }

    // æ³¨å†Œç”¨æˆ·
    async function registerUser() {
      try {
        const { error } = await supabaseClient
          .from('user_profiles')
          .upsert({
            id: userId,
            username: 'è®¿å®¢' + Math.floor(Math.random() * 1000),
            avatar: 'ğŸ‘¤',
            last_login_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
          }, { onConflict: 'id' });
        
        if (!error) {
          console.log('âœ… ç”¨æˆ·æ³¨å†ŒæˆåŠŸ');
        }
      } catch (e) {
        console.error('ç”¨æˆ·æ³¨å†Œå¤±è´¥:', e);
      }
    }

    // æ›´æ–°åœ¨çº¿çŠ¶æ€
    async function updateOnlineStatus() {
      try {
        await supabaseClient
          .from('online_users')
          .upsert({
            user_id: userId,
            last_seen_at: new Date().toISOString()
          }, { onConflict: 'user_id' });
        
        console.log('ğŸŸ¢ åœ¨çº¿çŠ¶æ€å·²æ›´æ–°');
      } catch (e) {
        console.error('æ›´æ–°åœ¨çº¿çŠ¶æ€å¤±è´¥:', e);
      }
    }

    // åŠ è½½å¸–å­
    async function loadPosts() {
      const postListEl = document.getElementById('postList');
      
      try {
        const { data, error } = await supabaseClient
          .from('community_posts')
          .select('*')
          .order('created_at', { ascending: false })
          .limit(20);
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
          postListEl.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">ğŸ“ æš‚æ— å¸–å­</div>';
          return;
        }
        
        postListEl.innerHTML = data.map(post => `
          <div class="post-item">
            <div class="post-title">${post.avatar || 'ğŸ‘¤'} ${post.title}</div>
            <div class="post-content">${(post.content || '').substring(0, 150)}...</div>
            <div class="post-meta">
              ğŸ‘¤ ${post.author} Â· ğŸ’¬ ${post.replies || 0} å›å¤ Â· ğŸ‘ ${post.likes || 0} ç‚¹èµ Â· ğŸ‘ï¸ ${post.views || 0} æµè§ˆ
            </div>
          </div>
        `).join('');
        
        console.log('âœ… æˆåŠŸåŠ è½½', data.length, 'æ¡å¸–å­');
        
      } catch (e) {
        console.error('åŠ è½½å¸–å­å¤±è´¥:', e);
        postListEl.innerHTML = `<div style="text-align:center;padding:40px;color:#dc3545;">âŒ åŠ è½½å¤±è´¥: ${e.message}</div>`;
      }
    }

    // æ›´æ–°ç»Ÿè®¡
    async function updateStats() {
      try {
        // å¸–å­æ€»æ•°
        const { count: postsCount } = await supabaseClient
          .from('community_posts')
          .select('*', { count: 'exact', head: true });
        
        // æˆå‘˜æ€»æ•°
        const { count: membersCount } = await supabaseClient
          .from('user_profiles')
          .select('*', { count: 'exact', head: true });
        
        // åœ¨çº¿äººæ•°ï¼ˆ5åˆ†é’Ÿå†…æ´»è·ƒï¼‰
        const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();
        const { count: onlineCount } = await supabaseClient
          .from('online_users')
          .select('*', { count: 'exact', head: true })
          .gte('last_seen_at', fiveMinutesAgo);
        
        // æ€»å›å¤æ•°
        const { data: posts } = await supabaseClient
          .from('community_posts')
          .select('replies');
        const totalReplies = posts?.reduce((sum, p) => sum + (p.replies || 0), 0) || 0;
        
        document.getElementById('statPosts').textContent = postsCount || 0;
        document.getElementById('statMembers').textContent = membersCount || 0;
        document.getElementById('statReplies').textContent = totalReplies;
        document.getElementById('statOnline').textContent = onlineCount || 0;
        
        console.log('ğŸ“Š ç»Ÿè®¡æ•°æ®:', { posts: postsCount, members: membersCount, online: onlineCount, replies: totalReplies });
        
      } catch (e) {
        console.error('æ›´æ–°ç»Ÿè®¡å¤±è´¥:', e);
      }
    }

    // ä¸»åˆå§‹åŒ–å‡½æ•°
    async function init() {
      console.log('ğŸš€ GameBox ç¤¾åŒº V2 åˆå§‹åŒ–...');
      
      try {
        // 1. åŠ è½½ Supabase SDK
        await loadSupabaseSDK();
        
        // 2. åˆ›å»ºå®¢æˆ·ç«¯
        if (typeof supabase === 'undefined') {
          throw new Error('Supabase SDK æœªåŠ è½½');
        }
        
        console.log('ğŸ”Œ åˆ›å»º Supabase å®¢æˆ·ç«¯...');
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        console.log('âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ');
        
        // 3. æµ‹è¯•è¿æ¥
        console.log('ğŸ” æµ‹è¯•æ•°æ®åº“è¿æ¥...');
        const { data: testData, error: testError } = await supabaseClient
          .from('community_posts')
          .select('id')
          .limit(1);
        
        if (testError) {
          throw new Error('æ•°æ®åº“è¿æ¥æµ‹è¯•å¤±è´¥: ' + testError.message);
        }
        
        console.log('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸');
        updateStatus(true);
        
        // 4. æ³¨å†Œç”¨æˆ·
        await registerUser();
        
        // 5. æ›´æ–°åœ¨çº¿çŠ¶æ€
        await updateOnlineStatus();
        setInterval(updateOnlineStatus, 30000);
        
        // 6. åŠ è½½æ•°æ®
        await loadPosts();
        await updateStats();
        
        // 7. å®šæœŸåˆ·æ–°
        setInterval(updateStats, 15000);
        
        console.log('ğŸ‰ åˆå§‹åŒ–å®Œæˆï¼');
        
      } catch (e) {
        console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', e);
        showError(e.message);
        updateStatus(false);
      }
    }

    // å¯åŠ¨
    init();
  </script>
</body>
</html>
