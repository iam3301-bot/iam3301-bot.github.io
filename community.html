<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - ç¤¾åŒº</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
  <style>
    /* ç¤¾åŒºé¡µé¢ä¸“å±æ ·å¼ */
    .community-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .community-stat {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 1px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .community-stat:hover {
      border-color: var(--cyber-yellow);
      box-shadow: 0 0 20px rgba(255, 211, 0, 0.3);
    }
    
    .community-stat .icon {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .community-stat .value {
      font-family: 'Orbitron', sans-serif;
      font-size: 22px;
      font-weight: 700;
      color: var(--cyber-yellow);
    }
    
    .community-stat .label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* æ¿å—é€‰æ‹©å™¨ */
    .board-selector {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }
    
    .board-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 211, 0, 0.3);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .board-btn:hover {
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
    }
    
    .board-btn.active {
      background: linear-gradient(135deg, rgba(255, 211, 0, 0.15) 0%, rgba(255, 61, 148, 0.1) 100%);
      border-color: var(--cyber-yellow);
      color: var(--cyber-yellow);
      box-shadow: 0 0 15px rgba(255, 211, 0, 0.3);
    }
    
    .board-btn .board-icon {
      font-size: 18px;
    }
    
    .board-btn .board-count {
      background: rgba(255, 211, 0, 0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    
    /* å¸–å­å¡ç‰‡ */
    .post-card {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.9) 0%, rgba(20, 0, 30, 0.85) 100%);
      border: 1px solid rgba(255, 211, 0, 0.2);
      border-radius: 8px;
      padding: 16px 20px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .post-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--cyber-yellow), var(--cyber-pink));
      transform: scaleY(0);
      transition: transform 0.3s ease;
    }
    
    .post-card:hover {
      border-color: rgba(255, 211, 0, 0.5);
      transform: translateX(5px);
      box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4);
    }
    
    .post-card:hover::before {
      transform: scaleY(1);
    }
    
    .post-card.pinned {
      border-color: rgba(255, 61, 148, 0.4);
      background: linear-gradient(135deg, rgba(255, 61, 148, 0.1) 0%, rgba(20, 0, 30, 0.9) 100%);
    }
    
    .post-header {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
    }
    
    .post-avatar {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--cyber-yellow), var(--cyber-pink));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      flex-shrink: 0;
    }
    
    .post-info {
      flex: 1;
    }
    
    .post-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .post-badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .post-badge.hot {
      background: linear-gradient(135deg, #FF0055, #FF3D94);
      color: #fff;
    }
    
    .post-badge.pinned {
      background: linear-gradient(135deg, var(--cyber-yellow), #FFC700);
      color: #000;
    }
    
    .post-badge.new {
      background: linear-gradient(135deg, var(--cyber-cyan), #00FF9F);
      color: #000;
    }
    
    .post-meta {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .post-content {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.5;
      margin-bottom: 12px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .post-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .post-tags {
      display: flex;
      gap: 8px;
    }
    
    .post-tag {
      padding: 3px 10px;
      background: rgba(85, 234, 212, 0.15);
      border: 1px solid rgba(85, 234, 212, 0.3);
      border-radius: 4px;
      font-size: 11px;
      color: var(--cyber-cyan);
    }
    
    .post-stats {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .post-stat {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    /* å‘å¸–æŒ‰é’® */
    .create-post-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(255, 211, 0, 0.2) 0%, rgba(255, 61, 148, 0.15) 100%);
      border: 2px solid var(--cyber-yellow);
      color: var(--cyber-yellow);
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border-radius: 4px;
    }
    
    .create-post-btn:hover {
      background: linear-gradient(135deg, rgba(255, 211, 0, 0.3) 0%, rgba(255, 61, 148, 0.2) 100%);
      box-shadow: 0 0 20px rgba(255, 211, 0, 0.4);
      transform: translateY(-2px);
    }
    
    /* åœ¨çº¿ç”¨æˆ· */
    .online-users {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    
    .online-user {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      font-size: 11px;
    }
    
    .online-dot {
      width: 6px;
      height: 6px;
      background: var(--cyber-cyan);
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* çƒ­é—¨è¯é¢˜ */
    .hot-topic {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 6px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .hot-topic:hover {
      background: rgba(255, 211, 0, 0.1);
      transform: translateX(3px);
    }
    
    .hot-topic-rank {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 700;
      color: var(--cyber-pink);
      min-width: 24px;
    }
    
    .hot-topic-title {
      flex: 1;
      font-size: 12px;
      color: var(--text-main);
    }
    
    .hot-topic-heat {
      font-size: 11px;
      color: var(--cyber-yellow);
    }
    
    @media (max-width: 768px) {
      .community-stats {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .board-selector {
        flex-direction: column;
      }
      
      .board-btn {
        justify-content: center;
      }
    }
  </style>
</head>
<body data-current-page="community">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user" onclick="window.location.href='profile.html';" style="cursor: pointer;">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <!-- é¡µé¢æ ‡é¢˜ -->
      <div class="card">
        <div class="page-title">ğŸ’¬ ç¤¾åŒºå¹¿åœº</div>
        <div class="page-intro">
          ä¸ç©å®¶äº¤æµå¿ƒå¾—ã€åˆ†äº«æ”»ç•¥ã€å‘å¸ƒæˆªå›¾ï¼ŒåŠ å…¥æœ€æ´»è·ƒçš„æ¸¸æˆç¤¾åŒºã€‚
        </div>
      </div>

      <!-- ç¤¾åŒºç»Ÿè®¡ -->
      <div class="community-stats">
        <div class="community-stat">
          <div class="icon">ğŸ“</div>
          <div class="value" id="statPosts">1,234</div>
          <div class="label">å¸–å­æ€»æ•°</div>
        </div>
        <div class="community-stat">
          <div class="icon">ğŸ‘¥</div>
          <div class="value" id="statMembers">5,678</div>
          <div class="label">ç¤¾åŒºæˆå‘˜</div>
        </div>
        <div class="community-stat">
          <div class="icon">ğŸ’¬</div>
          <div class="value" id="statReplies">12,345</div>
          <div class="label">å›å¤æ€»æ•°</div>
        </div>
        <div class="community-stat">
          <div class="icon">ğŸŸ¢</div>
          <div class="value" id="statOnline">89</div>
          <div class="label">åœ¨çº¿äººæ•°</div>
        </div>
      </div>

      <!-- æ¿å—ä¸æœç´¢ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>// BOARDS</span>
          </div>
          <button class="create-post-btn" onclick="createPost()">
            <span>âœï¸</span>
            <span>å‘å¸ƒæ–°å¸–</span>
          </button>
        </header>
        
        <div class="board-selector" id="boardSelector">
          <button class="board-btn active" data-board="all">
            <span class="board-icon">ğŸŒ</span>
            <span>å…¨éƒ¨</span>
            <span class="board-count" id="countAll">50</span>
          </button>
          <button class="board-btn" data-board="general">
            <span class="board-icon">ğŸ’¬</span>
            <span>ç»¼åˆè®¨è®º</span>
            <span class="board-count" id="countGeneral">20</span>
          </button>
          <button class="board-btn" data-board="guide">
            <span class="board-icon">ğŸ“š</span>
            <span>æ”»ç•¥å¿ƒå¾—</span>
            <span class="board-count" id="countGuide">15</span>
          </button>
          <button class="board-btn" data-board="shot">
            <span class="board-icon">ğŸ“·</span>
            <span>æ¸¸æˆæˆªå›¾</span>
            <span class="board-count" id="countShot">10</span>
          </button>
          <button class="board-btn" data-board="trade">
            <span class="board-icon">ğŸ”„</span>
            <span>äº¤æ˜“æ±‚åŠ©</span>
            <span class="board-count" id="countTrade">5</span>
          </button>
        </div>
        
        <div style="margin-top: 16px;">
          <input id="postSearch" type="text" placeholder="ğŸ” æœç´¢å¸–å­æ ‡é¢˜ã€æ¸¸æˆåç§°..." style="width: 100%;" />
        </div>
      </div>

      <!-- å¸–å­åˆ—è¡¨ -->
      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>å¸–å­åˆ—è¡¨</span>
          </div>
          <div class="chip" id="postCount">å…± 0 å¸–</div>
        </header>
        <div id="postList"></div>
      </div>
    </section>

    <aside>
      <!-- çƒ­é—¨è¯é¢˜ -->
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ”¥ çƒ­é—¨è¯é¢˜</div>
        <div id="hotTopics"></div>
      </div>
      
      <!-- åœ¨çº¿ç”¨æˆ· -->
      <div class="sidebar-card" style="margin-top: 16px;">
        <div class="sidebar-title">ğŸŸ¢ åœ¨çº¿ç©å®¶</div>
        <div class="online-users" id="onlineUsers"></div>
      </div>
      
      <!-- ç¤¾åŒºè§„åˆ™ -->
      <div class="sidebar-card" style="margin-top: 16px;">
        <div class="sidebar-title">ğŸ“‹ ç¤¾åŒºè§„åˆ™</div>
        <div class="sidebar-item">
          <span class="label">1</span>
          <span class="value">å‹å–„äº¤æµï¼Œå°Šé‡ä»–äºº</span>
        </div>
        <div class="sidebar-item">
          <span class="label">2</span>
          <span class="value">ç¦æ­¢å¹¿å‘Šå’Œåƒåœ¾ä¿¡æ¯</span>
        </div>
        <div class="sidebar-item">
          <span class="label">3</span>
          <span class="value">å‰§é€è¯·æ ‡æ³¨è­¦å‘Š</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>

<!-- Supabase SDK (çœŸå®æ•°æ®åº“æ”¯æŒ) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="supabase-config.js"></script>

<!-- ç¤¾åŒºæ•°æ®æœåŠ¡ (è‡ªåŠ¨æ£€æµ‹ Supabase æˆ– LocalStorage) -->
<script src="community-data-service.js"></script>
<script src="create-post-modal.js"></script>
<script>
  initCommon();

  // ä½¿ç”¨çœŸå®ç¤¾åŒºæ•°æ®æœåŠ¡
  // åˆå§‹åŒ–æ—¶ä½¿ç”¨æœ¬åœ°æ•°æ®ï¼Œå¼‚æ­¥åŠ è½½å®Œæˆåæ›´æ–°
  let postData = [];
  
  // æ—§çš„ç¤ºä¾‹æ•°æ®ï¼ˆä½œä¸ºå¤‡ä»½ï¼‰
  const postDataBackup = [
    {
      id: "pinned-1",
      title: "ã€å…¬å‘Šã€‘ç¤¾åŒºä½¿ç”¨æŒ‡å— - æ–°äººå¿…è¯»",
      content: "æ¬¢è¿æ¥åˆ° GameBox ç¤¾åŒºï¼æœ¬å¸–åŒ…å«ç¤¾åŒºè§„åˆ™ã€å‘å¸–æŒ‡å—ã€å¸¸è§é—®é¢˜è§£ç­”ç­‰å†…å®¹ï¼Œå»ºè®®æ–°ç©å®¶ä»”ç»†é˜…è¯»...",
      author: "GameBoxå®˜æ–¹",
      avatar: "ğŸ®",
      game: "GameBox",
      board: "general",
      replies: 156,
      likes: 892,
      views: 5432,
      isPinned: true,
      isNew: false,
      time: "ç½®é¡¶"
    },
    {
      id: "elden-newbie",
      title: "æ–°æ‰‹å…¥é—¨ï¼šå¦‚ä½•åœ¨ã€Šè‰¾å°”ç™»æ³•ç¯ã€‹ä¸­å°‘æ­»ä¸€ç‚¹",
      content: "å¤§å®¶å¥½ï¼Œä½œä¸ºä¸€ä¸ªä»é­‚ç³»æ¸¸æˆä¸€è·¯èµ°æ¥çš„è€ç©å®¶ï¼Œä»Šå¤©åˆ†äº«ä¸€äº›è‰¾å°”ç™»æ³•ç¯çš„æ–°æ‰‹æŠ€å·§ã€‚é¦–å…ˆæ˜¯é€‰æ‹©èŒä¸š...",
      author: "è¤ªè‰²è€…å°æ˜",
      avatar: "âš”ï¸",
      game: "è‰¾å°”ç™»æ³•ç¯",
      board: "guide",
      replies: 89,
      likes: 456,
      views: 2341,
      isPinned: false,
      isNew: false,
      time: "2å°æ—¶å‰"
    },
    {
      id: "cp-photo",
      title: "ã€æˆªå›¾åˆ†äº«ã€‘å¤œä¹‹åŸçš„éœ“è™¹ç¯å¤ªç¾äº†ï¼",
      content: "ç”¨ RTX 4090 å¼€æ»¡å…‰è¿½æ‹çš„ï¼Œè¿™æ¸¸æˆçš„ç”»é¢çœŸçš„æ˜¯ç»äº†ï¼Œåˆ†äº«å‡ å¼ æˆ‘æœ€æ»¡æ„çš„æˆªå›¾...",
      author: "V",
      avatar: "ğŸŒƒ",
      game: "èµ›åšæœ‹å…‹ 2077",
      board: "shot",
      replies: 67,
      likes: 234,
      views: 1567,
      isPinned: false,
      isNew: true,
      time: "30åˆ†é’Ÿå‰"
    },
    {
      id: "zelda-tears",
      title: "ç‹å›½ä¹‹æ³ª ç¥åº™å…¨æ”¶é›†æ”»ç•¥ï¼ˆæŒç»­æ›´æ–°ä¸­ï¼‰",
      content: "æœ¬å¸–æ•´ç†äº†ç‹å›½ä¹‹æ³ªæ‰€æœ‰ç¥åº™çš„ä½ç½®å’Œè§£è°œæ–¹æ³•ï¼Œç›®å‰å·²æ›´æ–° 120/152 ä¸ªï¼Œæ¬¢è¿æ”¶è—...",
      author: "æµ·æ‹‰é²å‹‡è€…",
      avatar: "ğŸ—¡ï¸",
      game: "å¡å°”è¾¾ä¼ è¯´ï¼šç‹å›½ä¹‹æ³ª",
      board: "guide",
      replies: 234,
      likes: 678,
      views: 4521,
      isPinned: false,
      isNew: false,
      time: "1å¤©å‰"
    },
    {
      id: "steam-deck",
      title: "Steam Deck ä¸Šç©ä»€ä¹ˆæ¸¸æˆä½“éªŒæœ€å¥½ï¼Ÿ",
      content: "åˆšå…¥æ‰‹ Steam Deckï¼Œæ±‚æ¨èä¸€äº›é€‚åˆæŒæœºç©çš„æ¸¸æˆï¼Œæœ€å¥½æ˜¯èƒ½ç¦»çº¿ç©çš„ï¼Œå‡ºå·®æ—¶å€™æ‰“å‘æ—¶é—´...",
      author: "æŒæœºå…š",
      avatar: "ğŸ®",
      game: "å¤šæ¸¸æˆ",
      board: "general",
      replies: 45,
      likes: 123,
      views: 892,
      isPinned: false,
      isNew: false,
      time: "3å°æ—¶å‰"
    },
    {
      id: "hollow-shot",
      title: "ã€Šç©ºæ´éª‘å£«ã€‹æ·±æ¸ŠåŒºåŸŸæˆªå›¾åˆ†äº«",
      content: "ç»ˆäºæ‰“å®Œäº†æ·±æ¸Šï¼Œè¿™ä¸ªåŒºåŸŸçš„æ°›å›´å¤ªå‹æŠ‘äº†ï¼Œä½†æ˜¯ç¾æœ¯é£æ ¼çœŸçš„å¾ˆæ£’ï¼Œåˆ†äº«ä¸€äº›æˆªå›¾...",
      author: "å°éª‘å£«",
      avatar: "ğŸª²",
      game: "ç©ºæ´éª‘å£«",
      board: "shot",
      replies: 28,
      likes: 167,
      views: 756,
      isPinned: false,
      isNew: false,
      time: "5å°æ—¶å‰"
    },
    {
      id: "trade-1",
      title: "ã€æ±‚è´­ã€‘åšå¾·ä¹‹é—¨3 Steam æ¿€æ´»ç ",
      content: "æƒ³ä¹°ä¸€ä¸ªåšå¾·ä¹‹é—¨3çš„Steamæ¿€æ´»ç ï¼Œæ­£ç‰ˆçš„ï¼Œä»·æ ¼ç§èŠï¼Œéª—å­å‹¿æ‰°...",
      author: "ä¹°å®¶å°ç‹",
      avatar: "ğŸ’°",
      game: "åšå¾·ä¹‹é—¨3",
      board: "trade",
      replies: 12,
      likes: 8,
      views: 234,
      isPinned: false,
      isNew: false,
      time: "6å°æ—¶å‰"
    },
    {
      id: "gta6-hype",
      title: "GTA6 é¢„å‘Šç‰‡å‘å¸ƒï¼å¤§å®¶æ€ä¹ˆçœ‹ï¼Ÿ",
      content: "Ræ˜Ÿç»ˆäºå‘é¢„å‘Šäº†ï¼çœ‹èµ·æ¥æ¯”GTA5è¿˜è¦æƒŠè‰³ï¼Œå¸Œæœ›è¿™æ¬¡PCç‰ˆä¸è¦ç­‰å¤ªä¹…...",
      author: "ç½ªæ¶éƒ½å¸‚ç²‰",
      avatar: "ğŸš—",
      game: "GTA6",
      board: "general",
      replies: 567,
      likes: 1234,
      views: 8765,
      isPinned: false,
      isNew: false,
      time: "12å°æ—¶å‰"
    }
  ];

  // çƒ­é—¨è¯é¢˜
  const hotTopics = [
    { title: "è‰¾å°”ç™»æ³•ç¯ DLC è®¨è®º", heat: 9999 },
    { title: "Steam ç§‹å­£ç‰¹å–æ¨è", heat: 8765 },
    { title: "GTA6 é¢„å‘Šç‰‡åˆ†æ", heat: 7654 },
    { title: "é»‘ç¥è¯æ‚Ÿç©ºæœŸå¾…", heat: 6543 },
    { title: "ç‹¬ç«‹æ¸¸æˆæ¨è", heat: 5432 }
  ];

  // åœ¨çº¿ç”¨æˆ·
  const onlineUsers = ["è¤ªè‰²è€…å°æ˜", "V", "æµ·æ‹‰é²å‹‡è€…", "æŒæœºå…š", "å°éª‘å£«", "ä¹°å®¶å°ç‹", "ç½ªæ¶éƒ½å¸‚ç²‰", "GameBoxå®˜æ–¹"];

  let currentBoard = "all";
  const postList = document.getElementById("postList");
  const postCount = document.getElementById("postCount");
  const postSearch = document.getElementById("postSearch");

  // æ¸²æŸ“å¸–å­åˆ—è¡¨
  function renderPosts() {
    const kw = postSearch.value.trim().toLowerCase();
    
    let list = postData.filter(p => {
      if (currentBoard !== "all" && p.board !== currentBoard) return false;
      if (kw) {
        const text = (p.title + " " + p.game + " " + p.content).toLowerCase();
        if (!text.includes(kw)) return false;
      }
      return true;
    });

    // ç½®é¡¶å¸–æ’å‰é¢ï¼Œç„¶åæŒ‰çƒ­åº¦æ’åº
    list.sort((a, b) => {
      if (a.isPinned && !b.isPinned) return -1;
      if (!a.isPinned && b.isPinned) return 1;
      return (b.replies + b.likes) - (a.replies + a.likes);
    });

    postList.innerHTML = "";
    postCount.textContent = `å…± ${list.length} å¸–`;

    if (!list.length) {
      postList.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">ğŸ’¬ æš‚æ— ç¬¦åˆæ¡ä»¶çš„å¸–å­</div>';
      return;
    }

    list.forEach(p => {
      const card = document.createElement("div");
      card.className = `post-card ${p.isPinned ? 'pinned' : ''}`;

      let badges = '';
      if (p.isPinned) badges += '<span class="post-badge pinned">ğŸ“Œ ç½®é¡¶</span>';
      if (p.isNew) badges += '<span class="post-badge new">NEW</span>';
      if ((p.replies + p.likes) > 500) badges += '<span class="post-badge hot">ğŸ”¥ çƒ­é—¨</span>';

      card.innerHTML = `
        <div class="post-header">
          <div class="post-avatar">${p.avatar}</div>
          <div class="post-info">
            <div class="post-title">
              ${p.title}
              ${badges}
            </div>
            <div class="post-meta">
              <span>ğŸ‘¤ ${p.author}</span>
              <span>ğŸ•’ ${p.time}</span>
              <span>ğŸ‘ï¸ ${p.views.toLocaleString()}</span>
            </div>
          </div>
        </div>
        <div class="post-content">${p.content}</div>
        <div class="post-footer">
          <div class="post-tags">
            <span class="post-tag">ğŸ® ${p.game}</span>
          </div>
          <div class="post-stats">
            <span class="post-stat">ğŸ’¬ ${p.replies}</span>
            <span class="post-stat">ğŸ‘ ${p.likes}</span>
          </div>
        </div>
      `;

      card.onclick = () => {
        window.location.href = `post-detail.html?id=${p.id}`;
      };

      postList.appendChild(card);
    });
  }

  // æ¸²æŸ“çƒ­é—¨è¯é¢˜ï¼ˆåŸºäºçœŸå®å¸–å­æ•°æ®ï¼‰
  async function renderHotTopics() {
    const container = document.getElementById("hotTopics");
    
    try {
      // è·å–æ‰€æœ‰å¸–å­
      const posts = await getAllPostsForTopics();
      
      // æŒ‰çƒ­åº¦æ’åºï¼ˆç‚¹èµæ•° + å›å¤æ•° + æµè§ˆæ•°/10ï¼‰
      const sortedPosts = posts
        .map(post => ({
          title: post.title,
          game: post.game,
          heat: (post.likes || 0) * 2 + (post.replies || 0) * 3 + Math.floor((post.views || 0) / 10)
        }))
        .sort((a, b) => b.heat - a.heat)
        .slice(0, 5);
      
      // å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„çœŸå®æ•°æ®ï¼Œè¡¥å……é»˜è®¤è¯é¢˜
      const displayTopics = sortedPosts.length >= 3 ? sortedPosts : [...sortedPosts, ...hotTopics.slice(0, 5 - sortedPosts.length)];
      
      container.innerHTML = displayTopics.map((topic, i) => `
        <div class="hot-topic" onclick="searchTopic('${topic.title}')">
          <span class="hot-topic-rank" style="color: ${i < 3 ? 'var(--cyber-pink)' : 'var(--text-muted)'}">${i + 1}</span>
          <span class="hot-topic-title">${topic.title}</span>
          <span class="hot-topic-heat">ğŸ”¥ ${topic.heat}</span>
        </div>
      `).join('');
    } catch (e) {
      console.error('æ¸²æŸ“çƒ­é—¨è¯é¢˜å¤±è´¥:', e);
      // é™çº§åˆ°é»˜è®¤è¯é¢˜
      container.innerHTML = hotTopics.map((topic, i) => `
        <div class="hot-topic">
          <span class="hot-topic-rank">${i + 1}</span>
          <span class="hot-topic-title">${topic.title}</span>
          <span class="hot-topic-heat">ğŸ”¥ ${topic.heat}</span>
        </div>
      `).join('');
    }
  }
  
  // è·å–æ‰€æœ‰å¸–å­ç”¨äºçƒ­é—¨è¯é¢˜è®¡ç®—
  async function getAllPostsForTopics() {
    if (window.communityDataService && typeof window.communityDataService.getAllPosts === 'function') {
      const result = window.communityDataService.getAllPosts();
      return result instanceof Promise ? await result : result;
    }
    return postData;
  }
  
  // æœç´¢è¯é¢˜
  window.searchTopic = function(title) {
    const searchBox = document.getElementById('postSearch');
    if (searchBox) {
      searchBox.value = title;
      searchBox.dispatchEvent(new Event('input'));
      // å¹³æ»‘æ»šåŠ¨åˆ°å¸–å­åˆ—è¡¨
      document.getElementById('postList').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  };

  // æ¸²æŸ“åœ¨çº¿ç”¨æˆ· - ä½¿ç”¨å®æ—¶æ•°æ®
  async function renderOnlineUsers() {
    const container = document.getElementById("onlineUsers");
    try {
      // ä»å®æ—¶æ•°æ®æœåŠ¡è·å–åœ¨çº¿ç”¨æˆ·ï¼ˆæ”¯æŒå¼‚æ­¥ï¼‰
      let realOnlineUsers;
      if (typeof window.communityDataService.getOnlineUsers === 'function') {
        const result = window.communityDataService.getOnlineUsers();
        realOnlineUsers = result instanceof Promise ? await result : result;
      }
      realOnlineUsers = realOnlineUsers || onlineUsers;
      
      const displayUsers = realOnlineUsers.slice(0, 6);
      const remainingCount = Math.max(0, realOnlineUsers.length - 6);
      
      container.innerHTML = displayUsers.map(user => `
        <div class="online-user">
          <span class="online-dot"></span>
          <span>${user}</span>
        </div>
      `).join('') + (remainingCount > 0 ? `<div class="online-user" style="color: var(--text-muted);">+${remainingCount} æ›´å¤š</div>` : '');
    } catch (e) {
      console.error('æ¸²æŸ“åœ¨çº¿ç”¨æˆ·å¤±è´¥:', e);
    }
  }

  // æ›´æ–°æ¿å—è®¡æ•°
  function updateBoardCounts() {
    const counts = {
      all: postData.length,
      general: postData.filter(p => p.board === 'general').length,
      guide: postData.filter(p => p.board === 'guide').length,
      shot: postData.filter(p => p.board === 'shot').length,
      trade: postData.filter(p => p.board === 'trade').length
    };
    
    document.getElementById('countAll').textContent = counts.all;
    document.getElementById('countGeneral').textContent = counts.general;
    document.getElementById('countGuide').textContent = counts.guide;
    document.getElementById('countShot').textContent = counts.shot;
    document.getElementById('countTrade').textContent = counts.trade;
  }

  // æ¿å—åˆ‡æ¢
  document.getElementById("boardSelector").addEventListener("click", e => {
    const btn = e.target.closest(".board-btn");
    if (!btn) return;
    
    currentBoard = btn.dataset.board;
    document.querySelectorAll(".board-btn").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
    renderPosts();
  });

  // æœç´¢
  postSearch.addEventListener("input", renderPosts);

  // å‘å¸–
  function createPost() {
    window.openCreatePostModal();
  }

  // æ›´æ–°ç¤¾åŒºç»Ÿè®¡æ•°æ® - å®æ—¶æ›´æ–°
  async function updateCommunityStats() {
    try {
      let stats;
      
      // ä½¿ç”¨ç¤¾åŒºæ•°æ®æœåŠ¡è·å–ç»Ÿè®¡ï¼ˆè‡ªåŠ¨é€‰æ‹© Supabase æˆ–æœ¬åœ°å­˜å‚¨ï¼‰
      if (window.communityDataService && typeof window.communityDataService.getCommunityStats === 'function') {
        const result = window.communityDataService.getCommunityStats();
        stats = result instanceof Promise ? await result : result;
      } else {
        stats = { totalPosts: 0, totalMembers: 5678, totalReplies: 12345, onlineUsers: 89 };
      }
      
      // åŠ¨ç”»æ•ˆæœæ›´æ–°æ•°å­—
      animateNumber('statPosts', stats.totalPosts);
      animateNumber('statMembers', stats.totalMembers);
      animateNumber('statReplies', stats.totalReplies);
      animateNumber('statOnline', stats.onlineUsers);
      
      // åŒæ—¶æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
      await renderOnlineUsers();
      
      // æ˜¾ç¤ºæ•°æ®æ¥æº
      const isSupabase = window.communityDataService?.isSupabaseEnabled?.() || false;
      console.log(`ğŸ“Š ç¤¾åŒºç»Ÿè®¡æ›´æ–° [${isSupabase ? 'Supabase' : 'æœ¬åœ°å­˜å‚¨'}]:`, stats);
    } catch (error) {
      console.error('âŒ æ›´æ–°ç»Ÿè®¡å¤±è´¥:', error);
    }
  }
  
  // æ•°å­—åŠ¨ç”»æ•ˆæœ
  function animateNumber(elementId, targetValue) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    const currentValue = parseInt(element.textContent.replace(/,/g, '')) || 0;
    if (currentValue === targetValue) return;
    
    // å¦‚æœå˜åŒ–ä¸å¤§ï¼Œç›´æ¥è®¾ç½®
    if (Math.abs(targetValue - currentValue) < 5) {
      element.textContent = targetValue.toLocaleString();
      return;
    }
    
    // åŠ¨ç”»æ•ˆæœ
    const duration = 500;
    const startTime = performance.now();
    
    function update(currentTime) {
      const elapsed = currentTime - startTime;
      const progress = Math.min(elapsed / duration, 1);
      const easeOut = 1 - Math.pow(1 - progress, 3);
      const value = Math.round(currentValue + (targetValue - currentValue) * easeOut);
      element.textContent = value.toLocaleString();
      
      if (progress < 1) {
        requestAnimationFrame(update);
      }
    }
    
    requestAnimationFrame(update);
  }

  // åˆ·æ–°å¸–å­æ•°æ®
  async function refreshPostsData() {
    try {
      // ä½¿ç”¨ç¤¾åŒºæ•°æ®æœåŠ¡è·å–å¸–å­ï¼ˆè‡ªåŠ¨é€‰æ‹© Supabase æˆ–æœ¬åœ°å­˜å‚¨ï¼‰
      if (window.communityDataService && typeof window.communityDataService.getAllPosts === 'function') {
        const result = window.communityDataService.getAllPosts();
        postData = result instanceof Promise ? await result : result;
      } else {
        postData = postDataBackup;
      }
      
      // ç¡®ä¿ postData æ˜¯æ•°ç»„
      if (!Array.isArray(postData)) {
        postData = postDataBackup;
      }
      
      renderPosts();
      updateBoardCounts();
      await updateCommunityStats();
      
      // è®°å½•é¡µé¢è®¿é—®
      if (window.communityDataService?.logPageView) {
        window.communityDataService.logPageView('community');
      }
    } catch (error) {
      console.error('âŒ åˆ·æ–°æ•°æ®å¤±è´¥:', error);
      // ä½¿ç”¨å¤‡ä»½æ•°æ®
      postData = postDataBackup;
      renderPosts();
      updateBoardCounts();
    }
  }

  // åˆå§‹åŒ–ï¼ˆå¼‚æ­¥ï¼‰
  async function initializeCommunity() {
    console.log('ğŸš€ åˆå§‹åŒ–ç¤¾åŒºé¡µé¢...');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const postListEl = document.getElementById('postList');
    if (postListEl) {
      postListEl.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-muted);">ğŸ”„ æ­£åœ¨åŠ è½½ç¤¾åŒºæ•°æ®...</div>';
    }
    
    // ç­‰å¾…æ•°æ®æœåŠ¡åˆå§‹åŒ–
    await new Promise(resolve => setTimeout(resolve, 100));
    
    // åŠ è½½æ•°æ®
    await refreshPostsData();
    renderHotTopics();
    await renderOnlineUsers();
    
    // å®šæœŸæ›´æ–°ï¼ˆæ¯30ç§’ï¼‰
    setInterval(updateCommunityStats, 30000);
    
    // æ£€æŸ¥æ•°æ®æ¥æºå¹¶æ˜¾ç¤ºçŠ¶æ€
    const isSupabase = window.communityDataService?.isSupabaseEnabled?.() || false;
    console.log(`âœ… ç¤¾åŒºé¡µé¢åˆå§‹åŒ–å®Œæˆ [æ•°æ®æº: ${isSupabase ? 'Supabase äº‘æ•°æ®åº“ âœ…' : 'æœ¬åœ°å­˜å‚¨ âš ï¸'}]`);
    
    // æ˜¾ç¤ºæ•°æ®æºçŠ¶æ€åˆ°é¡µé¢
    const dataSourceBadge = document.createElement('div');
    dataSourceBadge.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: ${isSupabase ? 'linear-gradient(135deg, rgba(0, 255, 159, 0.2), rgba(85, 234, 212, 0.15))' : 'linear-gradient(135deg, rgba(255, 211, 0, 0.2), rgba(255, 61, 148, 0.15))'};
      border: 1px solid ${isSupabase ? 'var(--cyber-cyan)' : 'var(--cyber-yellow)'};
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 11px;
      color: var(--text-main);
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      font-family: 'Orbitron', sans-serif;
    `;
    dataSourceBadge.innerHTML = `
      <div style="display: flex; align-items: center; gap: 8px;">
        <span style="font-size: 14px;">${isSupabase ? 'ğŸŒ' : 'ğŸ’¾'}</span>
        <span>${isSupabase ? 'Supabase äº‘æ•°æ®åº“' : 'æœ¬åœ°å­˜å‚¨æ¨¡å¼'}</span>
      </div>
    `;
    document.body.appendChild(dataSourceBadge);
    
    // 5ç§’åæ·¡å‡º
    setTimeout(() => {
      dataSourceBadge.style.transition = 'opacity 1s ease';
      dataSourceBadge.style.opacity = '0';
      setTimeout(() => dataSourceBadge.remove(), 1000);
    }, 5000);
    
    // å¦‚æœ Supabase æœªé…ç½®ï¼Œæ˜¾ç¤ºæç¤º
    if (!isSupabase) {
      console.log('ğŸ’¡ æç¤º: é…ç½® Supabase å¯å¯ç”¨äº‘ç«¯æ•°æ®åŒæ­¥å’Œå¤šç”¨æˆ·åŠŸèƒ½ï¼Œè¯¦è§ BACKEND_SETUP.md');
    }
  }

  // å¯åŠ¨åˆå§‹åŒ–
  initializeCommunity();
  
  // æ¯15ç§’åˆ·æ–°åœ¨çº¿ç”¨æˆ·å’Œç»Ÿè®¡æ•°æ®ï¼ˆæ›´å®æ—¶ï¼‰
  setInterval(async () => {
    await renderOnlineUsers();
    await updateCommunityStats();
  }, 15000);
  
  // ç›‘å¬ç¤¾åŒºæ•°æ®æ›´æ–°äº‹ä»¶
  window.addEventListener('community-stats-update', () => {
    updateCommunityStats();
  });
  
  window.addEventListener('community-update', (e) => {
    console.log('ğŸ“¡ æ”¶åˆ°ç¤¾åŒºå®æ—¶æ›´æ–°:', e.detail);
    refreshPostsData();
  });
  
  // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åˆ·æ–°æ•°æ®
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
      refreshPostsData();
    }
  });
</script>
</body>
</html>
