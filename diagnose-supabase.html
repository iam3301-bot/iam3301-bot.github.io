<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Supabase è¿æ¥è¯Šæ–­å·¥å…·</title>
  <style>
    body {
      font-family: 'Courier New', monospace;
      background: #1a1a1a;
      color: #00ff00;
      padding: 20px;
      line-height: 1.6;
    }
    .success { color: #00ff00; }
    .error { color: #ff4444; }
    .warning { color: #ffaa00; }
    .info { color: #00aaff; }
    pre {
      background: #0a0a0a;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #333;
      overflow-x: auto;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 10px 5px;
      cursor: pointer;
      font-weight: bold;
      border-radius: 4px;
    }
    button:hover {
      background: #00cc00;
    }
    .section {
      margin: 20px 0;
      padding: 15px;
      background: #222;
      border-left: 4px solid #00ff00;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ Supabase è¿æ¥è¯Šæ–­å·¥å…·</h1>
  
  <div class="section">
    <h2>æ­¥éª¤ 1ï¼šåŸºç¡€æ£€æŸ¥</h2>
    <button onclick="checkBasics()">è¿è¡ŒåŸºç¡€æ£€æŸ¥</button>
    <pre id="basics-output">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ£€æŸ¥...</pre>
  </div>

  <div class="section">
    <h2>æ­¥éª¤ 2ï¼šæµ‹è¯•æ•°æ®åº“è¿æ¥</h2>
    <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
    <pre id="connection-output">ç‚¹å‡»æŒ‰é’®æµ‹è¯•è¿æ¥...</pre>
  </div>

  <div class="section">
    <h2>æ­¥éª¤ 3ï¼šæŸ¥è¯¢å¸–å­æ•°æ®</h2>
    <button onclick="queryPosts()">æŸ¥è¯¢å¸–å­</button>
    <pre id="posts-output">ç‚¹å‡»æŒ‰é’®æŸ¥è¯¢æ•°æ®...</pre>
  </div>

  <div class="section">
    <h2>æ­¥éª¤ 4ï¼šä¿®å¤å»ºè®®</h2>
    <pre id="fix-output">ç­‰å¾…è¯Šæ–­å®Œæˆ...</pre>
  </div>

  <!-- åŠ è½½ä¾èµ– -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>

  <script>
    function log(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      const className = type === 'success' ? 'success' : 
                       type === 'error' ? 'error' : 
                       type === 'warning' ? 'warning' : 'info';
      element.innerHTML += `<span class="${className}">${message}</span>\n`;
    }

    function clearLog(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }

    async function checkBasics() {
      clearLog('basics-output');
      
      log('basics-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('basics-output', 'ğŸ” å¼€å§‹åŸºç¡€æ£€æŸ¥...', 'info');
      log('basics-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('basics-output', '');

      // æ£€æŸ¥ 1: Supabase SDK
      log('basics-output', '1ï¸âƒ£ æ£€æŸ¥ Supabase SDK...', 'info');
      if (typeof supabase !== 'undefined') {
        log('basics-output', '   âœ… Supabase SDK å·²åŠ è½½', 'success');
      } else {
        log('basics-output', '   âŒ Supabase SDK æœªåŠ è½½ï¼', 'error');
        log('basics-output', '   ğŸ’¡ è§£å†³æ–¹æ³•ï¼šåœ¨ HTML ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š', 'warning');
        log('basics-output', '   <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>', 'info');
        return;
      }
      log('basics-output', '');

      // æ£€æŸ¥ 2: é…ç½®æ–‡ä»¶
      log('basics-output', '2ï¸âƒ£ æ£€æŸ¥é…ç½®æ–‡ä»¶...', 'info');
      if (typeof SUPABASE_CONFIG !== 'undefined') {
        log('basics-output', '   âœ… SUPABASE_CONFIG å·²å®šä¹‰', 'success');
        log('basics-output', `   ğŸ“ URL: ${SUPABASE_CONFIG.url}`, 'info');
        log('basics-output', `   ğŸ“ Enabled: ${SUPABASE_CONFIG.enabled}`, 'info');
        log('basics-output', `   ğŸ“ Has Key: ${SUPABASE_CONFIG.anonKey ? 'Yes' : 'No'}`, 'info');
      } else {
        log('basics-output', '   âŒ SUPABASE_CONFIG æœªå®šä¹‰ï¼', 'error');
        log('basics-output', '   ğŸ’¡ è§£å†³æ–¹æ³•ï¼šç¡®ä¿åŠ è½½äº† supabase-config.js', 'warning');
        return;
      }
      log('basics-output', '');

      // æ£€æŸ¥ 3: é…ç½®æ˜¯å¦å¯ç”¨
      log('basics-output', '3ï¸âƒ£ æ£€æŸ¥é…ç½®çŠ¶æ€...', 'info');
      if (SUPABASE_CONFIG.enabled === true) {
        log('basics-output', '   âœ… Supabase å·²å¯ç”¨', 'success');
      } else {
        log('basics-output', '   âŒ Supabase æœªå¯ç”¨ï¼', 'error');
        log('basics-output', '   ğŸ’¡ è§£å†³æ–¹æ³•ï¼šåœ¨ supabase-config.js ä¸­è®¾ç½® enabled: true', 'warning');
        return;
      }
      log('basics-output', '');

      // æ£€æŸ¥ 4: URL å’Œ Key
      log('basics-output', '4ï¸âƒ£ æ£€æŸ¥ URL å’Œ Key...', 'info');
      if (SUPABASE_CONFIG.url && SUPABASE_CONFIG.url.includes('supabase.co')) {
        log('basics-output', '   âœ… URL æ ¼å¼æ­£ç¡®', 'success');
      } else {
        log('basics-output', '   âŒ URL æ ¼å¼é”™è¯¯ï¼', 'error');
        log('basics-output', `   å½“å‰ URL: ${SUPABASE_CONFIG.url}`, 'info');
        return;
      }

      if (SUPABASE_CONFIG.anonKey && SUPABASE_CONFIG.anonKey.length > 100) {
        log('basics-output', '   âœ… anonKey æ ¼å¼æ­£ç¡®', 'success');
      } else {
        log('basics-output', '   âŒ anonKey æ ¼å¼é”™è¯¯æˆ–æœªè®¾ç½®ï¼', 'error');
        return;
      }
      log('basics-output', '');

      log('basics-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
      log('basics-output', 'âœ… åŸºç¡€æ£€æŸ¥é€šè¿‡ï¼è¯·ç»§ç»­æµ‹è¯•è¿æ¥...', 'success');
      log('basics-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
    }

    async function testConnection() {
      clearLog('connection-output');
      
      log('connection-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('connection-output', 'ğŸ”Œ æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
      log('connection-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('connection-output', '');

      try {
        log('connection-output', '1ï¸âƒ£ åˆ›å»º Supabase å®¢æˆ·ç«¯...', 'info');
        const client = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        log('connection-output', '   âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
        log('connection-output', '');

        log('connection-output', '2ï¸âƒ£ æµ‹è¯• community_posts è¡¨...', 'info');
        const { data, error, count } = await client
          .from('community_posts')
          .select('id', { count: 'exact', head: true });

        if (error) {
          log('connection-output', '   âŒ è¿æ¥å¤±è´¥ï¼', 'error');
          log('connection-output', `   é”™è¯¯ä»£ç : ${error.code}`, 'error');
          log('connection-output', `   é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
          log('connection-output', '', 'error');
          
          if (error.code === '42P01') {
            log('connection-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'error');
            log('connection-output', 'âŒ æ•°æ®åº“è¡¨ä¸å­˜åœ¨ï¼', 'error');
            log('connection-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'error');
            log('connection-output', '', 'error');
            log('connection-output', 'ğŸ“ ä¿®å¤æ­¥éª¤ï¼š', 'warning');
            log('connection-output', '1. è®¿é—®: https://supabase.com/dashboard', 'info');
            log('connection-output', '2. è¿›å…¥é¡¹ç›® SQL Editor', 'info');
            log('connection-output', '3. æ‰§è¡Œ supabase-init.sql è„šæœ¬', 'info');
            log('connection-output', '4. åˆ·æ–°æ­¤é¡µé¢é‡æ–°æµ‹è¯•', 'info');
          } else if (error.code === 'PGRST301') {
            log('connection-output', 'âŒ æƒé™é”™è¯¯ï¼', 'error');
            log('connection-output', 'ğŸ’¡ å¯èƒ½æ˜¯ RLS ç­–ç•¥é—®é¢˜', 'warning');
          }
        } else {
          log('connection-output', `   âœ… è¿æ¥æˆåŠŸï¼è¡¨ä¸­æœ‰ ${count || 0} æ¡è®°å½•`, 'success');
        }
        log('connection-output', '');

        log('connection-output', '3ï¸âƒ£ æµ‹è¯• user_profiles è¡¨...', 'info');
        const { error: profileError, count: profileCount } = await client
          .from('user_profiles')
          .select('id', { count: 'exact', head: true });

        if (profileError) {
          log('connection-output', `   âš ï¸ user_profiles è¡¨æŸ¥è¯¢å¤±è´¥: ${profileError.message}`, 'warning');
        } else {
          log('connection-output', `   âœ… user_profiles è¡¨æ­£å¸¸ï¼æœ‰ ${profileCount || 0} ä¸ªç”¨æˆ·`, 'success');
        }
        log('connection-output', '');

        log('connection-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
        log('connection-output', 'âœ… æ•°æ®åº“è¿æ¥æµ‹è¯•å®Œæˆï¼', 'success');
        log('connection-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');

      } catch (e) {
        log('connection-output', `âŒ è¿æ¥æµ‹è¯•å¼‚å¸¸: ${e.message}`, 'error');
        log('connection-output', `å †æ ˆ: ${e.stack}`, 'error');
      }
    }

    async function queryPosts() {
      clearLog('posts-output');
      
      log('posts-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('posts-output', 'ğŸ“Š æŸ¥è¯¢å¸–å­æ•°æ®...', 'info');
      log('posts-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
      log('posts-output', '');

      try {
        const client = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        log('posts-output', '1ï¸âƒ£ æŸ¥è¯¢æœ€æ–°å¸–å­...', 'info');
        const { data, error } = await client
          .from('community_posts')
          .select('id, title, author, created_at')
          .order('created_at', { ascending: false })
          .limit(10);

        if (error) {
          log('posts-output', `   âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
          return;
        }

        log('posts-output', `   âœ… æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ${data.length} æ¡å¸–å­`, 'success');
        log('posts-output', '');
        
        if (data.length > 0) {
          log('posts-output', 'ğŸ“ å¸–å­åˆ—è¡¨ï¼š', 'info');
          data.forEach((post, index) => {
            log('posts-output', `   ${index + 1}. ${post.title}`, 'info');
            log('posts-output', `      ä½œè€…: ${post.author}`, 'info');
            log('posts-output', `      æ—¶é—´: ${new Date(post.created_at).toLocaleString('zh-CN')}`, 'info');
            log('posts-output', '', 'info');
          });
        } else {
          log('posts-output', '   âš ï¸ æ•°æ®åº“ä¸­æ²¡æœ‰å¸–å­', 'warning');
          log('posts-output', '   ğŸ’¡ è¯·åœ¨ç¤¾åŒºé¡µé¢å‘å¸ƒç¬¬ä¸€ä¸ªå¸–å­', 'info');
        }

        log('posts-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');
        log('posts-output', 'âœ… æ•°æ®æŸ¥è¯¢å®Œæˆï¼', 'success');
        log('posts-output', 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'success');

      } catch (e) {
        log('posts-output', `âŒ æŸ¥è¯¢å¼‚å¸¸: ${e.message}`, 'error');
      }
    }

    // è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
    window.onload = () => {
      setTimeout(checkBasics, 500);
    };
  </script>
</body>
</html>
