<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æ¸¸æˆèµ„è®¯</title>
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="news" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æ¸¸æˆèµ„è®¯</div>
        <div class="page-intro">
          ç¤ºä¾‹èµ„è®¯åˆ—è¡¨ï¼Œæ”¯æŒæŒ‰åˆ†ç±»ä¸å…³é”®å­—è¿‡æ»¤ï¼Œç‚¹å‡»å¯æŸ¥çœ‹è¯¦æƒ…é¡µé¢ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>ç­›é€‰</span>
          </div>
        </header>
        <div class="form">
          <div class="form-row">
            <label>ç±»å‹</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;" id="newsCats">
              <label><input type="radio" name="newsCat" value="all" checked /> å…¨éƒ¨</label>
              <label><input type="radio" name="newsCat" value="update" /> æ›´æ–° / ç‰ˆæœ¬</label>
              <label><input type="radio" name="newsCat" value="new" /> æ–°ä½œ / å‘å”®</label>
              <label><input type="radio" name="newsCat" value="event" /> æ´»åŠ¨ / èµ›äº‹</label>
            </div>
          </div>
          <div class="form-row">
            <label for="newsSearch">æŒ‰æ ‡é¢˜ / æ¸¸æˆæœç´¢</label>
            <input id="newsSearch" type="text" placeholder="ä¾‹å¦‚ï¼šè‰¾å°”ç™»æ³•ç¯ DLC" />
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>èµ„è®¯åˆ—è¡¨</span>
          </div>
          <div class="chip" id="newsCount">å…± 0 æ¡</div>
        </header>
        <div id="newsList" class="news-list" style="max-height: 600px; overflow-y: auto;"></div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">æç¤º</div>
        <div class="sidebar-item">
          <span class="label">è¯¦æƒ…ç¤ºä¾‹</span><span class="value">ç‚¹å‡»è‰¾å°”ç™» DLC</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="news-api.js"></script>
<script>
  initCommon();

  let allNewsData = [];
  let dataLoaded = false;
  let currentPage = 0;
  const PAGE_SIZE = 15;
  let currentFilteredList = [];

  const newsSearch = document.getElementById("newsSearch");
  const newsList = document.getElementById("newsList");
  const newsCount = document.getElementById("newsCount");
  const newsCatsWrap = document.getElementById("newsCats");

  function getCurrentCat() {
    const checked = newsCatsWrap.querySelector("input[name=newsCat]:checked");
    return checked ? checked.value : "all";
  }

  // åŠ è½½æ‰€æœ‰æ–°é—»æ•°æ®
  async function loadAllNews() {
    try {
      newsList.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:20px;text-align:center;">ğŸ“° æ­£åœ¨åŠ è½½æ–°é—»æ•°æ®...</div>';
      
      allNewsData = await window.newsAPI.getAllNews();
      dataLoaded = true;
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allNewsData.length} æ¡æ–°é—»`);
      
      applyFiltersAndRender();
    } catch (err) {
      console.error("åŠ è½½æ–°é—»å¤±è´¥:", err);
      newsList.innerHTML = `
        <div style="text-align: center; color: var(--danger); padding: 20px;">
          âŒ æ–°é—»æ•°æ®åŠ è½½å¤±è´¥<br>
          <span style="font-size: 11px; opacity: 0.8;">é”™è¯¯: ${err.message}</span>
        </div>
      `;
    }
  }

  // åº”ç”¨ç­›é€‰æ¡ä»¶å¹¶æ¸²æŸ“
  function applyFiltersAndRender() {
    if (!dataLoaded) {
      newsList.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:20px;text-align:center;">ğŸ“° æ­£åœ¨åŠ è½½æ–°é—»æ•°æ®...</div>';
      return;
    }

    const cat = getCurrentCat();
    const kw = newsSearch.value.trim().toLowerCase();

    currentFilteredList = allNewsData.filter((n) => {
      if (cat !== "all" && n.type !== cat) return false;
      if (kw) {
        const text = `${n.title} ${n.game} ${n.summary}`.toLowerCase();
        if (!text.includes(kw)) return false;
      }
      return true;
    });

    // æŒ‰æ—¥æœŸé™åºæ’åº
    currentFilteredList.sort((a, b) => b.date.localeCompare(a.date));

    // é‡ç½®åˆ†é¡µå¹¶æ¸²æŸ“
    currentPage = 0;
    newsList.innerHTML = "";
    newsCount.textContent = `å…± ${currentFilteredList.length} æ¡`;

    if (!currentFilteredList.length) {
      newsList.innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:20px;text-align:center;">ğŸ“° æš‚æ— ç¬¦åˆæ¡ä»¶çš„èµ„è®¯ã€‚</div>';
      return;
    }

    loadMoreNews();
  }

  // åŠ è½½æ›´å¤šæ–°é—»
  function loadMoreNews() {
    const startIdx = currentPage * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageItems = currentFilteredList.slice(startIdx, endIdx);
    
    if (!pageItems.length) return;

    pageItems.forEach((n) => {
      const div = document.createElement("div");
      div.className = "news-card";
      div.style.cursor = "pointer";
      
      // æ·»åŠ ç±»å‹å›¾æ ‡
      let typeIcon = "ğŸ“°";
      let typeText = "";
      if (n.type === "update") {
        typeIcon = "ğŸ”„";
        typeText = "æ›´æ–°/ç‰ˆæœ¬";
      } else if (n.type === "new") {
        typeIcon = "ğŸ®";
        typeText = "æ–°ä½œ/å‘å”®";
      } else {
        typeIcon = "ğŸ‰";
        typeText = "æ´»åŠ¨/èµ›äº‹";
      }
      
      div.innerHTML = `
        <div class="news-title">${typeIcon} ${n.title}</div>
        <div class="news-meta">ğŸ¯ ${n.game} Â· ğŸ“… ${n.date} Â· ${typeText} Â· ğŸ‘ï¸ ${n.views || 0} Â· ğŸ’¬ ${n.comments || 0}</div>
        <div class="news-excerpt">${n.summary}</div>
      `;
      
      // æ·»åŠ æ‚¬åœæ•ˆæœ
      div.addEventListener("mouseenter", () => {
        div.style.transform = "translateX(4px)";
        div.style.transition = "all 0.3s ease";
      });
      
      div.addEventListener("mouseleave", () => {
        div.style.transform = "translateX(0)";
      });
      
      div.addEventListener("click", () => {
        window.location.href = `news-detail.html?id=${n.id}`;
      });
      
      newsList.appendChild(div);
    });
    
    currentPage++;
  }

  // æ— é™æ»šåŠ¨ç›‘å¬
  newsList.addEventListener("scroll", () => {
    const scrollTop = newsList.scrollTop;
    const scrollHeight = newsList.scrollHeight;
    const clientHeight = newsList.clientHeight;
    
    // è·ç¦»åº•éƒ¨ 100px æ—¶åŠ è½½æ›´å¤š
    if (scrollHeight - scrollTop - clientHeight < 100) {
      loadMoreNews();
    }
  });

  // ç›‘å¬ç­›é€‰æ¡ä»¶å˜åŒ–
  newsSearch.addEventListener("input", applyFiltersAndRender);
  newsCatsWrap.addEventListener("change", applyFiltersAndRender);

  // åˆå§‹åŠ è½½
  loadAllNews();
</script>
</body>
</html>
