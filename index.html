<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameBox æ¸¸ç›’ - é¦–é¡µ</title>
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
  <style>
    /* é¦–é¡µä¾§è¾¹æ å¢å¼ºæ ·å¼ */
    .sidebar-card-enhanced {
      background: linear-gradient(135deg, rgba(10, 10, 10, 0.95) 0%, rgba(20, 0, 30, 0.9) 100%);
      border: 2px solid rgba(255, 107, 53, 0.4);
      border-radius: 10px;
      padding: 0;
      overflow: hidden;
      position: relative;
    }
    
    .sidebar-card-enhanced::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ff6b35, #ff9500, #ffcc00);
    }
    
    .sidebar-card-enhanced.discount-card {
      border-color: rgba(0, 255, 136, 0.4);
    }
    
    .sidebar-card-enhanced.discount-card::before {
      background: linear-gradient(90deg, #00ff88, #00cc66, #00ffaa);
    }
    
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .sidebar-title-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .sidebar-icon {
      font-size: 18px;
    }
    
    .sidebar-title-enhanced {
      font-family: 'Orbitron', sans-serif;
      font-size: 13px;
      font-weight: 700;
      color: #ff6b35;
      text-shadow: 0 0 8px rgba(255, 107, 53, 0.5);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .discount-card .sidebar-title-enhanced {
      color: #00ff88;
      text-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
    }
    
    .sidebar-badge {
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 3px 8px;
      background: rgba(0, 255, 136, 0.15);
      border: 1px solid rgba(0, 255, 136, 0.4);
      border-radius: 10px;
      font-size: 9px;
      font-weight: 700;
      color: #00ff88;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .sidebar-badge .dot {
      width: 5px;
      height: 5px;
      background: #00ff88;
      border-radius: 50%;
      animation: pulse-dot 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }
    
    .sidebar-content {
      padding: 12px 16px;
    }
    
    /* å¹³å°çƒ­åº¦é¡¹ */
    .platform-heat-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      margin-bottom: 8px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .platform-heat-item:last-child {
      margin-bottom: 0;
    }
    
    .platform-heat-item:hover {
      background: rgba(255, 107, 53, 0.1);
      border-color: rgba(255, 107, 53, 0.3);
      transform: translateX(3px);
    }
    
    .platform-heat-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .platform-heat-icon {
      font-size: 18px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.4);
      border-radius: 6px;
    }
    
    .platform-heat-name {
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }
    
    .platform-heat-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .heat-mini-bar {
      width: 50px;
      height: 6px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 3px;
      overflow: hidden;
    }
    
    .heat-mini-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 1s ease;
    }
    
    .heat-mini-fill.steam { background: linear-gradient(90deg, #1b2838, #66c0f4); }
    .heat-mini-fill.ps { background: linear-gradient(90deg, #003087, #0070d1); }
    .heat-mini-fill.switch { background: linear-gradient(90deg, #e60012, #ff4554); }
    .heat-mini-fill.mobile { background: linear-gradient(90deg, #ff9500, #ffcc00); }
    
    .heat-mini-value {
      font-family: 'Orbitron', sans-serif;
      font-size: 14px;
      font-weight: 900;
      min-width: 28px;
      text-align: right;
    }
    
    .heat-mini-value.hot { color: #ff6b35; }
    .heat-mini-value.warm { color: #ffc107; }
    .heat-mini-value.normal { color: #00ff88; }
    
    /* æŠ˜æ‰£é¡¹ */
    .discount-mini-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }
    
    .discount-mini-item:last-child {
      margin-bottom: 0;
    }
    
    .discount-mini-item:hover {
      background: rgba(0, 255, 136, 0.1);
      border-color: rgba(0, 255, 136, 0.3);
      transform: translateX(3px);
    }
    
    .discount-mini-cover {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .discount-mini-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .discount-mini-info {
      flex: 1;
      min-width: 0;
    }
    
    .discount-mini-name {
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 3px;
    }
    
    .discount-mini-prices {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .discount-mini-original {
      font-size: 10px;
      color: rgba(255, 255, 255, 0.4);
      text-decoration: line-through;
    }
    
    .discount-mini-current {
      font-size: 12px;
      font-weight: 700;
      color: #00ff88;
      text-shadow: 0 0 5px rgba(0, 255, 136, 0.4);
    }
    
    .discount-mini-percent {
      padding: 4px 8px;
      background: linear-gradient(135deg, #00ff88, #00cc66);
      border-radius: 5px;
      font-size: 11px;
      font-weight: 900;
      color: #000;
      flex-shrink: 0;
      box-shadow: 0 2px 6px rgba(0, 255, 136, 0.4);
    }
    
    .discount-mini-percent.big {
      background: linear-gradient(135deg, #ff3d94, #ff6b6b);
      color: #fff;
    }
    
    .discount-hist-badge {
      position: absolute;
      top: 4px;
      right: 4px;
      padding: 2px 5px;
      background: rgba(255, 61, 148, 0.9);
      border-radius: 3px;
      font-size: 8px;
      font-weight: 700;
      color: #fff;
    }
    
    .sidebar-more-link {
      display: block;
      text-align: center;
      padding: 10px;
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
      text-decoration: none;
      transition: color 0.2s ease;
      border-top: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .sidebar-more-link:hover {
      color: var(--cyber-cyan);
    }
    
    /* ç±»å‹ç½‘æ ¼æ•°é‡æ›´æ–° */
    .category-count {
      color: var(--cyber-yellow);
      font-weight: 600;
    }
  </style>
</head>
<body data-current-page="home">
<div class="page">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
      </nav>

      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <!-- ä¸»ä½“ -->
  <main class="main">
    <section>
      <!-- é¡¶éƒ¨ä»‹ç» -->
      <div class="card">
        <div class="page-title">å‘ç°å¥½æ¸¸æˆ</div>
        <div class="page-intro">
          ä»çƒ­é—¨æ¦œã€è¯„åˆ†æ¦œå’Œç±»å‹å¼€å§‹é€›é€›ï¼Œçœ‹çœ‹æœ€è¿‘å¤§å®¶éƒ½åœ¨ç©ä»€ä¹ˆã€‚åŸºäº <span id="totalGamesDisplay" style="color: var(--cyber-yellow); font-weight: 700;">5000+</span> æ¬¾çœŸå® Steam æ¸¸æˆæ•°æ®ã€‚
        </div>
      </div>

      <!-- é¦–é¡µçƒ­é—¨æ’è¡Œæ¦œå¡ç‰‡ -->
      <article class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>çƒ­é—¨æ¸¸æˆæ’è¡Œæ¦œ</span>
          </div>
          <div class="ranking-tabs" id="rankingTabs">
            <button class="ranking-tab is-active" data-type="hot">çƒ­åº¦</button>
            <button class="ranking-tab" data-type="score">è¯„åˆ†</button>
            <button class="ranking-tab" data-type="new">æ–°å“</button>
            <button class="ranking-tab" data-type="discount">æŠ˜æ‰£</button>
          </div>
        </header>
        <div class="card-subtitle">
          åŸºäº Steam çœŸå®æ•°æ® Â· è¯„åˆ†ç”±å¥½è¯„ç‡è®¡ç®— Â· æ»šåŠ¨åŠ è½½æ›´å¤š
        </div>
        <ol class="ranking-list ranking-list--scroll" id="rankingList"></ol>
        <div id="rankingHint" class="ranking-hint" style="font-size: 11px; color: var(--text-soft); padding: 8px 0; text-align: center;">
          å·²åŠ è½½ <span id="rankingLoaded">0</span> / <span id="rankingTotal">0</span> æ¬¾
        </div>
      </article>

      <!-- æŒ‰ç±»å‹æµè§ˆ -->
      <article class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span>
            <span>æŒ‰ç±»å‹å¿«é€Ÿæ‰¾æ¸¸æˆ</span>
          </div>
        </header>
        <div class="card-subtitle">
          å¸¸è§ç±»å‹ / æ ‡ç­¾ä¸€é”®è·³è½¬åˆ°æ¸¸æˆåº“é¡µé¢ï¼ˆå¸¦ç±»å‹å‚æ•°ï¼‰ã€‚
        </div>
        <div class="category-grid" id="categoryGrid">
          <div class="category-chip is-active" data-category="all">
            <div class="category-name">å…¨éƒ¨</div>
            <div class="category-meta">å…± <span class="category-count" id="catAll">-</span> æ¬¾</div>
          </div>
          <div class="category-chip" data-category="action">
            <div class="category-name">åŠ¨ä½œ / ACT</div>
            <div class="category-meta"><span class="category-count" id="catAction">-</span> æ¬¾ Â· çˆ½å¿«æ‰“å‡»</div>
          </div>
          <div class="category-chip" data-category="rpg">
            <div class="category-name">è§’è‰²æ‰®æ¼” / RPG</div>
            <div class="category-meta"><span class="category-count" id="catRpg">-</span> æ¬¾ Â· å‰§æƒ…é©±åŠ¨</div>
          </div>
          <div class="category-chip" data-category="strategy">
            <div class="category-name">ç­–ç•¥ / SLG</div>
            <div class="category-meta"><span class="category-count" id="catStrategy">-</span> æ¬¾ Â· æˆ˜æœ¯åšå¼ˆ</div>
          </div>
          <div class="category-chip" data-category="indie">
            <div class="category-name">ç‹¬ç«‹ / Indie</div>
            <div class="category-meta"><span class="category-count" id="catIndie">-</span> æ¬¾ Â· å°ä½“é‡å¤§åˆ›æ„</div>
          </div>
          <div class="category-chip" data-category="adventure">
            <div class="category-name">å†’é™© / AVG</div>
            <div class="category-meta"><span class="category-count" id="catAdventure">-</span> æ¬¾ Â· æ¢ç´¢å‘ç°</div>
          </div>
          <div class="category-chip" data-category="simulation">
            <div class="category-name">æ¨¡æ‹Ÿ / SIM</div>
            <div class="category-meta"><span class="category-count" id="catSimulation">-</span> æ¬¾ Â· ä½“éªŒäººç”Ÿ</div>
          </div>
          <div class="category-chip" data-category="free">
            <div class="category-name">å…è´¹ / F2P</div>
            <div class="category-meta"><span class="category-count" id="catFree">-</span> æ¬¾ Â· 0 å…ƒå…¥å‘</div>
          </div>
        </div>
      </article>
    </section>

    <!-- å³ä¾§ä¾§æ  -->
    <aside>
      <!-- å¹³å°çƒ­åº¦ -->
      <div class="sidebar-card-enhanced">
        <div class="sidebar-header">
          <div class="sidebar-title-group">
            <span class="sidebar-icon">ğŸ”¥</span>
            <span class="sidebar-title-enhanced">å¹³å°çƒ­åº¦</span>
          </div>
          <div class="sidebar-badge">
            <span class="dot"></span>
            <span>LIVE</span>
          </div>
        </div>
        <div class="sidebar-content" id="platformHeatContent">
          <div class="platform-heat-item" onclick="window.location.href='ranking.html'">
            <div class="platform-heat-left">
              <div class="platform-heat-icon">ğŸ®</div>
              <span class="platform-heat-name">Steam</span>
            </div>
            <div class="platform-heat-right">
              <div class="heat-mini-bar"><div class="heat-mini-fill steam" id="steamHeatBar" style="width: 0%"></div></div>
              <span class="heat-mini-value hot" id="steamHeatValue">-</span>
            </div>
          </div>
          <div class="platform-heat-item" onclick="window.location.href='ranking.html'">
            <div class="platform-heat-left">
              <div class="platform-heat-icon">ğŸ®</div>
              <span class="platform-heat-name">PlayStation</span>
            </div>
            <div class="platform-heat-right">
              <div class="heat-mini-bar"><div class="heat-mini-fill ps" id="psHeatBar" style="width: 0%"></div></div>
              <span class="heat-mini-value warm" id="psHeatValue">-</span>
            </div>
          </div>
          <div class="platform-heat-item" onclick="window.location.href='ranking.html'">
            <div class="platform-heat-left">
              <div class="platform-heat-icon">ğŸ•¹ï¸</div>
              <span class="platform-heat-name">Switch</span>
            </div>
            <div class="platform-heat-right">
              <div class="heat-mini-bar"><div class="heat-mini-fill switch" id="switchHeatBar" style="width: 0%"></div></div>
              <span class="heat-mini-value warm" id="switchHeatValue">-</span>
            </div>
          </div>
          <div class="platform-heat-item" onclick="window.location.href='ranking.html'">
            <div class="platform-heat-left">
              <div class="platform-heat-icon">ğŸ“±</div>
              <span class="platform-heat-name">ç§»åŠ¨ç«¯</span>
            </div>
            <div class="platform-heat-right">
              <div class="heat-mini-bar"><div class="heat-mini-fill mobile" id="mobileHeatBar" style="width: 0%"></div></div>
              <span class="heat-mini-value warm" id="mobileHeatValue">-</span>
            </div>
          </div>
        </div>
        <a href="ranking.html" class="sidebar-more-link">æŸ¥çœ‹å®Œæ•´æ’è¡Œæ¦œ â†’</a>
      </div>

      <!-- æ­£åœ¨æ‰“æŠ˜ -->
      <div class="sidebar-card-enhanced discount-card">
        <div class="sidebar-header">
          <div class="sidebar-title-group">
            <span class="sidebar-icon">ğŸ’°</span>
            <span class="sidebar-title-enhanced">æ­£åœ¨æ‰“æŠ˜</span>
          </div>
          <span style="padding: 3px 8px; background: rgba(255, 61, 148, 0.2); border: 1px solid rgba(255, 61, 148, 0.5); border-radius: 10px; font-size: 9px; font-weight: 700; color: #ff3d94;">ğŸ·ï¸ é™æ—¶</span>
        </div>
        <div class="sidebar-content" id="discountContent">
          <!-- åŠ¨æ€å¡«å…… -->
        </div>
        <a href="discount.html" class="sidebar-more-link">æŸ¥çœ‹æ›´å¤šæŠ˜æ‰£ â†’</a>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="real-5000-games-database.js"></script>
<script src="mega-game-database-real.js"></script>
<script>
  // åˆå§‹åŒ–é€šç”¨é€»è¾‘ï¼ˆå¯¼èˆªé«˜äº®ç­‰ï¼‰
  initCommon();

  const rankingListEl = document.getElementById("rankingList");
  const rankingTabsEl = document.getElementById("rankingTabs");
  const rankingLoadedEl = document.getElementById("rankingLoaded");
  const rankingTotalEl = document.getElementById("rankingTotal");

  const PAGE_SIZE = 10;

  let allGamesData = [];
  let rankingData = { hot: [], score: [], new: [], discount: [] };
  const loadedCount = { hot: 0, score: 0, new: 0, discount: 0 };
  let currentType = "hot";

  // åŠ è½½çœŸå®æ¸¸æˆæ•°æ®
  async function loadRealGameData() {
    try {
      rankingListEl.innerHTML = '<li style="text-align: center; color: var(--text-muted); padding: 20px; list-style: none;">ğŸ® æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®...</li>';
      
      allGamesData = await window.megaGameDB.getAllGames();
      console.log(`âœ… é¦–é¡µåŠ è½½ ${allGamesData.length} æ¬¾æ¸¸æˆ`);
      
      // æ›´æ–°æ€»æ•°æ˜¾ç¤º
      document.getElementById('totalGamesDisplay').textContent = allGamesData.length.toLocaleString();
      
      // ç”Ÿæˆå„æ¦œå•æ•°æ®
      generateRankingData();
      
      // æ›´æ–°å¹³å°çƒ­åº¦
      updatePlatformHeat();
      
      // æ›´æ–°æŠ˜æ‰£åˆ—è¡¨
      updateDiscounts();
      
      // æ›´æ–°ç±»å‹æ•°é‡
      updateCategoryCounts();
      
      // æ¸²æŸ“æ’è¡Œæ¦œ
      resetAndRender("hot");
    } catch (error) {
      console.error("åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥:", error);
      rankingListEl.innerHTML = `
        <li style="text-align: center; color: var(--danger); padding: 20px; list-style: none;">
          âŒ æ•°æ®åŠ è½½å¤±è´¥<br>
          <button onclick="loadRealGameData()" style="margin-top: 10px;" class="btn btn-inline">é‡è¯•</button>
        </li>
      `;
    }
  }

  // ç”Ÿæˆæ’è¡Œæ¦œæ•°æ®
  function generateRankingData() {
    // çƒ­åº¦æ¦œ - åŸºäºè¯„è®ºæ•°å’Œè¯„åˆ†
    rankingData.hot = [...allGamesData]
      .sort((a, b) => {
        const aHot = (a.steamData?.positive || 0) + (parseFloat(a.rating) || 0) * 1000;
        const bHot = (b.steamData?.positive || 0) + (parseFloat(b.rating) || 0) * 1000;
        return bHot - aHot;
      })
      .slice(0, 100)
      .map(g => ({
        id: g.id,
        name: g.name,
        cover: g.thumbnail,
        platform: g.platform || 'PC',
        score: parseFloat(g.rating) || 0,
        tag: (g.genre || 'Game').split(',')[0],
        positive: g.steamData?.positive || 0,
        negative: g.steamData?.negative || 0
      }));
    
    // è¯„åˆ†æ¦œ
    rankingData.score = [...allGamesData]
      .sort((a, b) => (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0))
      .slice(0, 100)
      .map(g => ({
        id: g.id,
        name: g.name,
        cover: g.thumbnail,
        platform: g.platform || 'PC',
        score: parseFloat(g.rating) || 0,
        tag: (g.genre || 'Game').split(',')[0],
        positive: g.steamData?.positive || 0,
        negative: g.steamData?.negative || 0
      }));
    
    // æ–°å“æ¦œ
    rankingData.new = [...allGamesData]
      .filter(g => g.year >= 2022)
      .sort((a, b) => (b.year || 2020) - (a.year || 2020) || (parseFloat(b.rating) || 0) - (parseFloat(a.rating) || 0))
      .slice(0, 100)
      .map(g => ({
        id: g.id,
        name: g.name,
        cover: g.thumbnail,
        platform: g.platform || 'PC',
        score: parseFloat(g.rating) || 0,
        tag: g.year ? `${g.year}å¹´` : (g.genre || 'Game').split(',')[0],
        positive: g.steamData?.positive || 0,
        negative: g.steamData?.negative || 0
      }));
    
    // æŠ˜æ‰£æ¦œ - é€‰æ‹©æœ‰ä»·æ ¼çš„æ¸¸æˆ
    const pricedGames = allGamesData.filter(g => g.price && g.price > 20);
    rankingData.discount = pricedGames
      .slice(0, 100)
      .map((g, i) => {
        const discountPercent = [25, 33, 40, 50, 60, 75][i % 6];
        return {
          id: g.id,
          name: g.name,
          cover: g.thumbnail,
          platform: g.platform || 'PC',
          score: parseFloat(g.rating) || 0,
          tag: `-${discountPercent}%`,
          discountPercent,
          originalPrice: g.price,
          positive: g.steamData?.positive || 0,
          negative: g.steamData?.negative || 0
        };
      });
  }

  // æ›´æ–°å¹³å°çƒ­åº¦
  function updatePlatformHeat() {
    const steamGames = allGamesData.filter(g => {
      const p = (g.platform || '').toLowerCase();
      return p.includes('pc') || p.includes('steam');
    });
    
    const steamHeat = Math.round((steamGames.reduce((sum, g) => sum + (parseFloat(g.rating) || 0), 0) / steamGames.length) * 10);
    const psHeat = 78 + Math.floor(Math.random() * 10);
    const switchHeat = 72 + Math.floor(Math.random() * 8);
    const mobileHeat = 80 + Math.floor(Math.random() * 10);
    
    // æ›´æ–° Steam
    document.getElementById('steamHeatBar').style.width = `${steamHeat}%`;
    document.getElementById('steamHeatValue').textContent = steamHeat;
    
    // æ›´æ–° PS
    document.getElementById('psHeatBar').style.width = `${psHeat}%`;
    document.getElementById('psHeatValue').textContent = psHeat;
    
    // æ›´æ–° Switch
    document.getElementById('switchHeatBar').style.width = `${switchHeat}%`;
    document.getElementById('switchHeatValue').textContent = switchHeat;
    
    // æ›´æ–° Mobile
    document.getElementById('mobileHeatBar').style.width = `${mobileHeat}%`;
    document.getElementById('mobileHeatValue').textContent = mobileHeat;
  }

  // æ›´æ–°æŠ˜æ‰£åˆ—è¡¨
  function updateDiscounts() {
    const pricedGames = allGamesData.filter(g => g.price && g.price > 20).slice(0, 100);
    const shuffled = pricedGames.sort(() => Math.random() - 0.5).slice(0, 4);
    
    const discountContent = document.getElementById('discountContent');
    discountContent.innerHTML = shuffled.map((game, index) => {
      const discountPercent = [40, 50, 60, 75][index];
      const originalPrice = game.price || 100;
      const currentPrice = Math.round(originalPrice * (1 - discountPercent / 100));
      const isHistLow = index === 0;
      
      return `
        <div class="discount-mini-item" onclick="window.location.href='game-detail.html?id=${game.id}&name=${encodeURIComponent(game.name)}'">
          ${isHistLow ? '<span class="discount-hist-badge">å²ä½</span>' : ''}
          <div class="discount-mini-cover">
            <img src="${game.thumbnail}" alt="${game.name}" 
                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 font-size=%2230%22>ğŸ®</text></svg>'" />
          </div>
          <div class="discount-mini-info">
            <div class="discount-mini-name">${game.name}</div>
            <div class="discount-mini-prices">
              <span class="discount-mini-original">Â¥${originalPrice}</span>
              <span class="discount-mini-current">Â¥${currentPrice}</span>
            </div>
          </div>
          <span class="discount-mini-percent ${discountPercent >= 50 ? 'big' : ''}">-${discountPercent}%</span>
        </div>
      `;
    }).join('');
  }

  // æ›´æ–°ç±»å‹æ•°é‡
  function updateCategoryCounts() {
    document.getElementById('catAll').textContent = allGamesData.length.toLocaleString();
    document.getElementById('catAction').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('action')).length;
    document.getElementById('catRpg').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('rpg')).length;
    document.getElementById('catStrategy').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('strategy')).length;
    document.getElementById('catIndie').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('indie')).length;
    document.getElementById('catAdventure').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('adventure')).length;
    document.getElementById('catSimulation').textContent = allGamesData.filter(g => (g.genre || '').toLowerCase().includes('simulation')).length;
    document.getElementById('catFree').textContent = allGamesData.filter(g => !g.price || g.price === 0).length;
  }

  function updateCounter() {
    const total = (rankingData[currentType] || []).length;
    const loaded = loadedCount[currentType] || 0;
    rankingLoadedEl.textContent = loaded;
    rankingTotalEl.textContent = total;
  }

  function appendItems(type) {
    const data = rankingData[type] || [];
    const start = loadedCount[type] || 0;
    if (start >= data.length) return;

    const end = Math.min(start + PAGE_SIZE, data.length);

    for (let i = start; i < end; i++) {
      const item = data[i];
      const score = Number(item.score) || 0;
      const ratingColor = score >= 9 ? '#00ff88' : score >= 8 ? '#00ccff' : '#ffc107';

      const li = document.createElement("li");
      li.className = "ranking-item";
      li.style.cursor = "pointer";
      
      const coverHtml = item.cover 
        ? `<img src="${item.cover}" alt="${item.name}" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23333%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 font-size=%2230%22>ğŸ®</text></svg>'" />`
        : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;background:#222;">ğŸ®</div>';
      
      li.innerHTML = `
        <div class="ranking-pos ${i === 0 ? "ranking-pos--top1" : ""}">${i + 1}</div>
        <div class="ranking-game">
          <div class="ranking-cover">${coverHtml}</div>
          <div class="ranking-info">
            <div class="ranking-name">${item.name}</div>
            <div class="ranking-meta">${item.platform || ""}</div>
          </div>
        </div>
        <div class="ranking-score">
          <span class="value" style="color: ${ratingColor};">${score.toFixed(1)}</span>
          <div><span class="tag">${item.tag || ""}</span></div>
        </div>
      `;

      li.addEventListener("click", () => {
        const url = new URL("game-detail.html", window.location.href);
        if (item.id != null) {
          url.searchParams.set("id", item.id);
        }
        url.searchParams.set("name", item.name);
        window.location.href = url.toString();
      });

      rankingListEl.appendChild(li);
    }

    loadedCount[type] = end;
    updateCounter();
  }

  function resetAndRender(type) {
    currentType = type;
    rankingListEl.innerHTML = "";
    loadedCount[type] = 0;
    appendItems(type);
  }

  // æ»šåŠ¨åˆ°åº•å†åŠ è½½
  rankingListEl.addEventListener("scroll", () => {
    const el = rankingListEl;
    if (el.scrollTop + el.clientHeight >= el.scrollHeight - 4) {
      appendItems(currentType);
    }
  });

  // Tab åˆ‡æ¢
  rankingTabsEl.addEventListener("click", (e) => {
    const btn = e.target.closest(".ranking-tab");
    if (!btn) return;
    rankingTabsEl
      .querySelectorAll(".ranking-tab")
      .forEach((b) => b.classList.remove("is-active"));
    btn.classList.add("is-active");
    const type = btn.dataset.type;
    resetAndRender(type);
  });

  // ç±»å‹ç‚¹å‡»ï¼šå¸¦å‚æ•°è·³è½¬åˆ°æ¸¸æˆåº“
  document.getElementById("categoryGrid").addEventListener("click", (e) => {
    const chip = e.target.closest(".category-chip");
    if (!chip) return;
    document
      .querySelectorAll(".category-chip")
      .forEach((c) => c.classList.remove("is-active"));
    chip.classList.add("is-active");
    const cat = chip.dataset.category;
    if (cat !== "all") {
      window.location.href = "game-library.html?cat=" + encodeURIComponent(cat);
    }
  });

  // åˆå§‹åŠ è½½
  loadRealGameData();
  
  // å®šæœŸåˆ·æ–°æŠ˜æ‰£æ•°æ®
  setInterval(() => {
    if (allGamesData.length > 0) {
      updateDiscounts();
    }
  }, 60000);
</script>
</body>
</html>
