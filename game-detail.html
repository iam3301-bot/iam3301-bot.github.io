<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GameBox 游盒 - 游戏详情</title>
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="detail">
<div class="page">
  <!-- 顶部导航 -->
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox 游盒</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">首页</a>
        <a href="game-library.html" data-page="library" class="nav-link">游戏库</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">排行榜</a>
      </nav>
    </div>
  </header>

  <!-- 主体 -->
  <main class="main main--single">
    <section>
      <article class="card detail-card">
        <!-- 顶部标题 + 返回 -->
        <div class="detail-header-bar">
          <div class="detail-breadcrumb">
            游戏详情 / <span id="breadcrumbName">加载中...</span>
          </div>
          <button class="btn-secondary" onclick="history.back()">← 返回上一页</button>
        </div>

        <!-- 视觉主区域（封面 + 标题 + 大号评分 + 标签） -->
        <div class="detail-hero">
          <div class="detail-hero-left">
            <div class="detail-cover-large">
              <img id="gameCover" src="" alt="游戏封面" />
            </div>
          </div>

          <div class="detail-hero-right">
            <div class="detail-title-row">
              <div class="detail-title-block">
                <h1 id="gameTitle" class="detail-title">游戏名称加载中...</h1>
                <div id="gamePlatform" class="detail-platform">平台信息加载中...</div>
              </div>

              <div class="detail-score-card">
                <div class="detail-score-label">游盒热度评分</div>
                <div class="detail-score-main">
                  <span id="gameScore" class="detail-score-value">-</span>
                  <span class="detail-score-outof">/ 10</span>
                </div>
                <div class="detail-score-sub">基于排行榜位置模拟</div>
              </div>
            </div>

            <div class="detail-tag-row">
              <span class="pill" id="gameTag">标签加载中...</span>
              <span class="pill pill-soft">
                发售：<span id="gameReleaseDate">未知</span>
              </span>
              <span class="pill pill-soft">
                开发：<span id="gameDeveloper">未知</span>
              </span>
              <span class="pill pill-soft">
                发行：<span id="gamePublisher">未知</span>
              </span>
            </div>

            <p id="gameDescription" class="detail-hero-desc">
              游戏简介加载中...
            </p>

            <div class="detail-links">
              <a
                id="gameUrl"
                href="#"
                target="_blank"
                rel="noopener"
                class="detail-btn detail-btn-main"
              >
                <span>前往游戏官网 / 启动平台</span>
                <span class="detail-btn-icon">↗</span>
              </a>

              <a
                id="gameProfileUrl"
                href="#"
                target="_blank"
                rel="noopener"
                class="detail-btn detail-btn-ghost"
              >
                <span>查看 FreeToGame 详情页</span>
                <span class="detail-btn-icon">↗</span>
              </a>
            </div>
          </div>
        </div>

        <!-- 下方信息区 -->
        <div class="detail-info-grid">
          <!-- 左：基础信息 -->
          <section class="detail-section">
            <h2 class="detail-section-title">基础信息</h2>
            <div class="detail-meta-list">
              <div class="detail-meta-row">
                <span class="detail-meta-label">开发商</span>
                <span class="detail-meta-value" id="gameDeveloperMeta">未知</span>
              </div>
              <div class="detail-meta-row">
                <span class="detail-meta-label">发行商</span>
                <span class="detail-meta-value" id="gamePublisherMeta">未知</span>
              </div>
              <div class="detail-meta-row">
                <span class="detail-meta-label">发售日期</span>
                <span class="detail-meta-value" id="gameReleaseMeta">未知</span>
              </div>
              <div class="detail-meta-row">
                <span class="detail-meta-label">平台 / 类型</span>
                <span class="detail-meta-value" id="gamePlatformMeta">-</span>
              </div>
              <div class="detail-meta-row">
                <span class="detail-meta-label">推荐指数</span>
                <span class="detail-meta-value">
                  <span id="gameScoreMeta">-</span> / 10（项目内部模拟评分）
                </span>
              </div>
            </div>
          </section>

          <!-- 右：系统配置（最低 + 推荐配置） -->
          <section class="detail-section detail-section--secondary">
            <h2 class="detail-section-title">系统配置（来自 FreeToGame）</h2>

            <div class="sysreq-grid">
              <!-- 最低配置 -->
              <div class="sysreq-column">
                <div class="sysreq-title">最低配置</div>
                <ul class="sysreq-list" id="sysMinList">
                  <!-- 最低配置项将填充这里 -->
                </ul>
              </div>

              <!-- 推荐配置 -->
              <div class="sysreq-column sysreq-column--recommended">
                <div class="sysreq-title">推荐配置</div>
                <ul class="sysreq-list" id="sysRecommendedList">
                  <!-- 推荐配置项将填充这里 -->
                </ul>
              </div>
            </div>

            <p class="detail-section-text sysreq-note">
              以上最低配置数据直接来自 FreeToGame API 的
              <code>minimum_system_requirements</code> 字段；若某项仍显示“接口未提供”，
              表示该游戏在接口中没有给出对应配置。
            </p>
          </section>
        </div>
      </article>
    </section>
  </main>
</div>

<script src="common.js"></script>
<script>
// 初始化通用逻辑（导航高亮）
initCommon();

const params = new URLSearchParams(window.location.search);
const gameId = params.get("id"); // 优先用 id 精确定位
const gameName = params.get("name");

// 顶部元素
const breadcrumbNameEl = document.getElementById("breadcrumbName");
const titleEl = document.getElementById("gameTitle");
const platformEl = document.getElementById("gamePlatform");
const coverEl = document.getElementById("gameCover");
const scoreEl = document.getElementById("gameScore");
const devEl = document.getElementById("gameDeveloper");
const pubEl = document.getElementById("gamePublisher");
const dateEl = document.getElementById("gameReleaseDate");
const tagEl = document.getElementById("gameTag");
const descEl = document.getElementById("gameDescription");
const urlEl = document.getElementById("gameUrl");
const profileEl = document.getElementById("gameProfileUrl");

// 下方“基础信息”区域
const devMetaEl = document.getElementById("gameDeveloperMeta");
const pubMetaEl = document.getElementById("gamePublisherMeta");
const releaseMetaEl = document.getElementById("gameReleaseMeta");
const platformMetaEl = document.getElementById("gamePlatformMeta");
const scoreMetaEl = document.getElementById("gameScoreMeta");

// 系统配置 DOM
const sysMinListEl = document.getElementById("sysMinList");
const sysRecommendedListEl = document.getElementById("sysRecommendedList");

// 安全设置文本
function safeSetText(el, text) {
  if (el) el.textContent = text;
}

if (!gameId && !gameName) {
  safeSetText(breadcrumbNameEl, "未指定");
  safeSetText(titleEl, "未指定游戏名称");
  safeSetText(
    descEl,
    "URL 中没有携带 id 或 name 参数，无法识别要查看的游戏。"
  );
} else {
  safeSetText(breadcrumbNameEl, gameName || ("#" + gameId));
  safeSetText(
    titleEl,
    "正在加载：" + (gameName || ("ID " + gameId))
  );
}

// 在 ranking.json 中查找对应游戏：优先用 id，找不到再按 name
function findGame(data) {
  const all = []
    .concat(data.hot || [], data.score || [], data.new || [], data.discount || []);

  let found = null;

  if (gameId) {
    found = all.find((g) => String(g.id) === String(gameId));
  }
  if (!found && gameName) {
    found = all.find((g) => g.name === gameName);
  }
  return found;
}

// 填充最低配置的函数
function fillMinSysReq(sys) {
  const fallback = "接口未提供";

  if (!sys) {
    sysMinListEl.innerHTML = `
      <li><span class="sysreq-label">系统</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">处理器</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">内存</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">显卡</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">存储</span><span class="sysreq-value">${fallback}</span></li>
    `;
    return;
  }

  sysMinListEl.innerHTML = `
    <li><span class="sysreq-label">系统</span><span class="sysreq-value">${sys.os || fallback}</span></li>
    <li><span class="sysreq-label">处理器</span><span class="sysreq-value">${sys.processor || fallback}</span></li>
    <li><span class="sysreq-label">内存</span><span class="sysreq-value">${sys.memory || fallback}</span></li>
    <li><span class="sysreq-label">显卡</span><span class="sysreq-value">${sys.graphics || fallback}</span></li>
    <li><span class="sysreq-label">存储</span><span class="sysreq-value">${sys.storage || fallback}</span></li>
  `;
}

// 填充推荐配置的函数
function fillRecommendedSysReq(sys) {
  const fallback = "接口未提供";

  if (!sys) {
    sysRecommendedListEl.innerHTML = `
      <li><span class="sysreq-label">系统</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">处理器</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">内存</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">显卡</span><span class="sysreq-value">${fallback}</span></li>
      <li><span class="sysreq-label">存储</span><span class="sysreq-value">${fallback}</span></li>
    `;
    return;
  }

  sysRecommendedListEl.innerHTML = `
    <li><span class="sysreq-label">系统</span><span class="sysreq-value">${sys.os || fallback}</span></li>
    <li><span class="sysreq-label">处理器</span><span class="sysreq-value">${sys.processor || fallback}</span></li>
    <li><span class="sysreq-label">内存</span><span class="sysreq-value">${sys.memory || fallback}</span></li>
    <li><span class="sysreq-label">显卡</span><span class="sysreq-value">${sys.graphics || fallback}</span></li>
    <li><span class="sysreq-label">存储</span><span class="sysreq-value">${sys.storage || fallback}</span></li>
  `;
}

// 解析 Steam HTML 格式的系统配置
function parseSteamRequirements(htmlString) {
  if (!htmlString || typeof htmlString !== 'string') return null;
  
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlString, 'text/html');
  const text = doc.body.textContent || '';
  
  const result = {};
  
  // 提取操作系统
  const osMatch = text.match(/OS[:\s]*([^\n]+)/i);
  if (osMatch) result.os = osMatch[1].trim();
  
  // 提取处理器
  const procMatch = text.match(/Processor[:\s]*([^\n]+)/i);
  if (procMatch) result.processor = procMatch[1].trim();
  
  // 提取内存
  const memMatch = text.match(/Memory[:\s]*([^\n]+)/i);
  if (memMatch) result.memory = memMatch[1].trim();
  
  // 提取显卡
  const gpuMatch = text.match(/Graphics[:\s]*([^\n]+)/i);
  if (gpuMatch) result.graphics = gpuMatch[1].trim();
  
  // 提取存储
  const storMatch = text.match(/Storage[:\s]*([^\n]+)/i);
  if (storMatch) result.storage = storMatch[1].trim();
  
  return Object.keys(result).length > 0 ? result : null;
}

// 获取 Steam 推荐配置并填充
async function fetchSteamRecommendedSysReq(gameTitle) {
  try {
    const appId = await searchSteamAppIdByName(gameTitle);
    
    if (!appId) {
      console.log(`Steam 未找到游戏：${gameTitle}`);
      fillRecommendedSysReq(null);
      return;
    }
    
    const pcReq = await fetchSteamRequirements(appId);
    
    if (pcReq && pcReq.recommended) {
      const parsed = parseSteamRequirements(pcReq.recommended);
      fillRecommendedSysReq(parsed);
    } else {
      console.log(`Steam 未提供推荐配置：${gameTitle}`);
      fillRecommendedSysReq(null);
    }
  } catch (err) {
    console.error("从 Steam 获取推荐配置时出错：", err);
    fillRecommendedSysReq(null);
  }
}

// 获取 Steam 推荐配置的标题
async function searchSteamAppIdByName(gameTitle) {
  if (!gameTitle) return null;

  try {
    // 请求自己的代理服务器
    const proxyUrl = "http://localhost:3000/api/steam?term=" + encodeURIComponent(gameTitle);
    const response = await fetch(proxyUrl);
    
    if (!response.ok) {
      console.warn(`Steam 搜索失败: ${response.status}`);
      return null;
    }
    
    const data = await response.json();

    if (data && data.items && data.items.length > 0) {
      return data.items[0].id;  // 返回 appId
    }
    return null;
  } catch (err) {
    console.warn(`Steam 搜索异常: ${err.message}`);
    return null;
  }
}

// 获取 Steam 配置
async function fetchSteamRequirements(appId) {
  if (!appId) return null;
  
  try {
    const proxyUrl = `http://localhost:3000/api/steam/appdetails?appid=${appId}`;
    const response = await fetch(proxyUrl);
    
    if (!response.ok) {
      console.warn(`Steam 详情获取失败: ${response.status}`);
      return null;
    }
    
    const data = await response.json();
    
    if (data && data[appId] && data[appId].success && data[appId].data) {
      return data[appId].data.pc_requirements;
    }
    return null;
  } catch (err) {
    console.warn(`Steam 详情异常: ${err.message}`);
    return null;
  }
}

function loadDetail() {
  if (!gameId && !gameName) return;

  // 显示加载提示
  sysMinListEl.innerHTML = '<li style="text-align: center; color: var(--text-muted); padding: 20px;">加载中...</li>';
  sysRecommendedListEl.innerHTML = '<li style="text-align: center; color: var(--text-muted); padding: 20px;">加载中...</li>';

  fetch("ranking.json")
    .then((res) => {
      if (!res.ok) throw new Error("HTTP 状态码 " + res.status);
      return res.json();
    })
    .then((data) => {
      const game = findGame(data);

      if (!game) {
        safeSetText(titleEl, "游戏未找到");
        safeSetText(descEl, "在排行榜数据中找不到该游戏，请返回重新选择。");
        sysMinListEl.innerHTML = '<li style="color: var(--danger);">游戏数据未找到</li>';
        sysRecommendedListEl.innerHTML = '<li style="color: var(--danger);">游戏数据未找到</li>';
        return;
      }

      // 填充基本信息
      safeSetText(breadcrumbNameEl, game.name);
      safeSetText(titleEl, game.name);
      safeSetText(platformEl, game.platform || "PC");
      safeSetText(devEl, game.developer || "未知");
      safeSetText(pubEl, game.publisher || "未知");
      safeSetText(dateEl, game.release_date || "未知");
      safeSetText(tagEl, game.genre || "游戏");
      safeSetText(descEl, game.short_description || "暂无游戏简介");
      
      // 填充元信息区域
      safeSetText(devMetaEl, game.developer || "未知");
      safeSetText(pubMetaEl, game.publisher || "未知");
      safeSetText(releaseMetaEl, game.release_date || "未知");
      safeSetText(platformMetaEl, `${game.platform || "PC"} / ${game.genre || "未分类"}`);
      
      // 评分
      const score = Number(game.score) || 0;
      safeSetText(scoreEl, score.toFixed(1));
      safeSetText(scoreMetaEl, score.toFixed(1));
      
      // 封面图
      if (game.thumbnail) {
        coverEl.src = game.thumbnail;
        coverEl.alt = game.name + " 封面";
      }
      
      // 外链
      if (game.game_url) {
        urlEl.href = game.game_url;
      }
      if (game.freetogame_profile_url) {
        profileEl.href = game.freetogame_profile_url;
      }

      // 填充最低配置
      const sysMin = game.minimum_system_requirements;
      fillMinSysReq(sysMin);

      // 获取推荐配置（异步）
      fetchSteamRecommendedSysReq(game.name);
    })
    .catch((err) => {
      console.error("加载详情失败：", err);
      safeSetText(titleEl, "加载失败");
      safeSetText(descEl, "无法加载游戏数据，请检查网络连接或稍后重试。错误: " + err.message);
      sysMinListEl.innerHTML = '<li style="color: var(--danger);">数据加载失败</li>';
      sysRecommendedListEl.innerHTML = '<li style="color: var(--danger);">数据加载失败</li>';
    });
}

loadDetail();
</script>
</body>
</html>
