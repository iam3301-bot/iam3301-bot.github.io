<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æ’è¡Œæ¦œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="ranking" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">ç»¼åˆæ’è¡Œæ¦œ</div>
        <div class="page-intro">
          æŒ‰è¯„åˆ†æ¦œ / çƒ­åº¦æ¦œ / æ–°å“æ¦œæŸ¥çœ‹ç¤ºä¾‹æ¸¸æˆæ’åï¼Œæ”¯æŒå¹³å°ç­›é€‰ä¸åç§°æœç´¢ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>æ¦œå•ç­›é€‰</span>
          </div>
        </header>
        <div class="form">
          <div class="form-row">
            <label for="rankType">æ¦œå•ç±»å‹</label>
            <select id="rankType">
              <option value="score">è¯„åˆ†æ¦œ</option>
              <option value="hot">çƒ­åº¦æ¦œ</option>
              <option value="new">æ–°å“æ¦œ</option>
            </select>
          </div>
          <div class="form-row">
            <label for="rankPlatform">å¹³å°</label>
            <select id="rankPlatform">
              <option value="all">å…¨éƒ¨å¹³å°</option>
              <option value="steam">Steam</option>
              <option value="pc">PCï¼ˆå…¶ä»–ï¼‰</option>
              <option value="ps">PlayStation</option>
              <option value="switch">Switch</option>
              <option value="mobile">æ‰‹æœº</option>
            </select>
          </div>
          <div class="form-row">
            <label for="rankSearch">åç§°å…³é”®å­—</label>
            <input id="rankSearch" type="text" placeholder="è¾“å…¥æ¸¸æˆåï¼Œä¾‹å¦‚ï¼šè‰¾å°”ç™»æ³•ç¯" />
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>æ¦œå•ç»“æœ</span>
          </div>
          <div class="chip" id="rankCount">å…± 0 æ¬¾</div>
        </header>
        <ol class="ranking-list" id="rankList" style="max-height: 600px; overflow-y: auto;"></ol>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">è¯´æ˜</div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®</span><span class="value">å‰ç«¯å‡æ•°æ®</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ’åº</span><span class="value">æŒ‰è¯„åˆ†æˆ–çƒ­åº¦æ’åº</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="game-api.js"></script>
<script>
  initCommon();

  // æ•°æ®æºï¼šä» ranking.json + FreeToGame API æ··åˆåŠ è½½
  let allGamesData = [];
  let dataLoaded = false;
  let currentPage = 0;
  const PAGE_SIZE = 20;
  let currentFilteredList = [];

  const rankType = document.getElementById("rankType");
  const rankPlatform = document.getElementById("rankPlatform");
  const rankSearch = document.getElementById("rankSearch");
  const rankList = document.getElementById("rankList");
  const rankCount = document.getElementById("rankCount");

  // åŠ è½½æ‰€æœ‰æ¸¸æˆæ•°æ®
  async function loadAllData() {
    try {
      // 1. åŠ è½½ ranking.json
      const rankRes = await fetch("ranking.json");
      if (!rankRes.ok) throw new Error("HTTP çŠ¶æ€ç  " + rankRes.status);
      const rankData = await rankRes.json();
      
      const rankingGames = [
        ...(rankData.hot || []).map(g => ({...g, source: "ranking", board: "hot"})),
        ...(rankData.score || []).map(g => ({...g, source: "ranking", board: "score"})),
        ...(rankData.new || []).map(g => ({...g, source: "ranking", board: "new"})),
      ];
      
      // 2. åŠ è½½ FreeToGame API
      const apiGames = await window.gameAPI.getAllGames();
      const apiGamesFormatted = apiGames.map(g => ({
        id: g.id,
        name: g.title,
        platform: g.platform === "PC (Windows)" ? "Windows" : g.platform,
        cover: g.thumbnail,
        score: Math.random() * 2 + 7, // 7-9åˆ†éšæœºè¯„åˆ†
        tag: g.genre,
        genre: g.genre,
        description: g.short_description,
        releaseDate: g.release_date,
        publisher: g.publisher,
        developer: g.developer,
        gameUrl: g.game_url,
        profileUrl: g.freetogame_profile_url,
        source: "api",
        board: "hot" // é»˜è®¤å½’ç±»ä¸ºçƒ­é—¨
      }));
      
      // 3. åˆå¹¶æ•°æ®å¹¶å»é‡
      const combined = [...rankingGames, ...apiGamesFormatted];
      const seen = new Set();
      allGamesData = combined.filter(g => {
        const key = (g.id || g.name).toString().toLowerCase();
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allGamesData.length} æ¬¾æ¸¸æˆæ•°æ®`);
      dataLoaded = true;
      applyFiltersAndRender();
    } catch (err) {
      console.error("åŠ è½½æ•°æ®å¤±è´¥:", err);
      rankList.innerHTML = `
        <li style="text-align: center; color: var(--danger); padding: 20px;">
          âŒ æ’è¡Œæ¦œæ•°æ®åŠ è½½å¤±è´¥<br>
          <span style="font-size: 11px; opacity: 0.8;">é”™è¯¯: ${err.message}</span>
        </li>
      `;
    }
  }

  // åº”ç”¨ç­›é€‰æ¡ä»¶
  function applyFiltersAndRender() {
    if (!dataLoaded) {
      rankList.innerHTML = '<li style="text-align: center; color: var(--text-muted); padding: 20px;">ğŸ® æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</li>';
      return;
    }

    const type = rankType.value; // score / hot / new
    const plat = rankPlatform.value;
    const kw = rankSearch.value.trim().toLowerCase();

    // æ ¹æ®æ¦œå•ç±»å‹ç­›é€‰
    let sourceData = allGamesData;
    if (type === "score") {
      sourceData = allGamesData.filter(g => g.board === "score" || (g.source === "api" && g.score >= 8));
    } else if (type === "hot") {
      sourceData = allGamesData.filter(g => g.board === "hot" || g.source === "api");
    } else if (type === "new") {
      sourceData = allGamesData.filter(g => g.board === "new" || (g.source === "api" && new Date(g.releaseDate) > new Date("2023-01-01")));
    }

    // åº”ç”¨å¹³å°å’Œå…³é”®è¯ç­›é€‰
    currentFilteredList = sourceData.filter(item => {
      if (plat !== "all") {
        const itemPlatform = (item.platform || "").toLowerCase();
        if (!itemPlatform.includes(plat.toLowerCase())) return false;
      }
      
      if (kw) {
        const searchText = [
          item.name || "",
          item.description || item.short_description || "",
          item.genre || item.tag || "",
          item.developer || ""
        ].join(" ").toLowerCase();
        if (!searchText.includes(kw)) return false;
      }
      
      return true;
    });

    // æ’åºï¼šä¼˜å…ˆ ranking.json æ•°æ®ï¼Œç„¶åæŒ‰è¯„åˆ†é™åº
    currentFilteredList.sort((a, b) => {
      if (a.source === "ranking" && b.source === "api") return -1;
      if (a.source === "api" && b.source === "ranking") return 1;
      return (b.score || 0) - (a.score || 0);
    });

    // é‡ç½®åˆ†é¡µå¹¶æ¸²æŸ“
    currentPage = 0;
    rankList.innerHTML = "";
    rankCount.textContent = `å…± ${currentFilteredList.length} æ¬¾`;
    
    if (!currentFilteredList.length) {
      rankList.innerHTML = '<li style="font-size:12px;color:var(--text-muted);padding:20px;text-align:center;">ğŸ” æš‚æ— ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆã€‚</li>';
      return;
    }
    
    loadMoreItems();
  }

  // åŠ è½½æ›´å¤šé¡¹ç›®
  function loadMoreItems() {
    const startIdx = currentPage * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageItems = currentFilteredList.slice(startIdx, endIdx);
    
    if (!pageItems.length) return;
    
    pageItems.forEach((item, localIdx) => {
      const globalIdx = startIdx + localIdx;
      const score = Number(item.score) || 0;
      const li = document.createElement("li");
      li.className = "ranking-item";
      li.style.cursor = "pointer";
      
      const coverImage = item.cover || item.thumbnail || "";
      const coverHtml = coverImage 
        ? `<img src="${coverImage}" alt="${item.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;\\'>ğŸ®</div>'" />` 
        : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 24px;">ğŸ®</div>';
      
      li.innerHTML = `
        <div class="ranking-pos ${globalIdx === 0 ? "ranking-pos--top1" : ""}">${globalIdx + 1}</div>
        <div class="ranking-game">
          <div class="ranking-cover">${coverHtml}</div>
          <div class="ranking-info">
            <div class="ranking-name">${item.name || "æœªçŸ¥æ¸¸æˆ"}</div>
            <div class="ranking-meta">${item.genre || item.tag || ""} Â· ${item.platform || "PC"}</div>
          </div>
        </div>
        <div class="ranking-score">
          <span class="value">${score.toFixed(1)}</span>
          <div><span class="tag">${item.source === "ranking" ? "ç²¾é€‰" : item.tag || item.genre || "æ¸¸æˆ"}</span></div>
        </div>
      `;
      
      li.addEventListener("mouseenter", () => {
        li.style.backgroundColor = "rgba(56, 189, 248, 0.05)";
        li.style.transition = "all 0.3s ease";
      });
      
      li.addEventListener("mouseleave", () => {
        li.style.backgroundColor = "";
      });
      
      li.addEventListener("click", () => {
        const url = new URL("game-detail.html", window.location.href);
        if (item.id) url.searchParams.set("id", item.id);
        url.searchParams.set("name", item.name);
        window.location.href = url.toString();
      });
      
      rankList.appendChild(li);
    });
    
    currentPage++;
  }

  // æ— é™æ»šåŠ¨ç›‘å¬
  rankList.addEventListener("scroll", () => {
    const scrollTop = rankList.scrollTop;
    const scrollHeight = rankList.scrollHeight;
    const clientHeight = rankList.clientHeight;
    
    // è·ç¦»åº•éƒ¨ 100px æ—¶åŠ è½½æ›´å¤š
    if (scrollHeight - scrollTop - clientHeight < 100) {
      loadMoreItems();
    }
  });

  // ç›‘å¬ç­›é€‰æ¡ä»¶å˜åŒ–
  rankType.addEventListener("change", applyFiltersAndRender);
  rankPlatform.addEventListener("change", applyFiltersAndRender);
  rankSearch.addEventListener("input", applyFiltersAndRender);

  // åˆå§‹åŠ è½½
  loadAllData();
</script>
</body>
</html>
