<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æ’è¡Œæ¦œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="ranking" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">ç»¼åˆæ’è¡Œæ¦œ</div>
        <div class="page-intro">
          æŒ‰è¯„åˆ†æ¦œ / çƒ­åº¦æ¦œ / æ–°å“æ¦œæŸ¥çœ‹ç¤ºä¾‹æ¸¸æˆæ’åï¼Œæ”¯æŒå¹³å°ç­›é€‰ä¸åç§°æœç´¢ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>æ¦œå•ç­›é€‰</span>
          </div>
        </header>
        <div class="form">
          <div class="form-row">
            <label for="rankType">æ¦œå•ç±»å‹</label>
            <select id="rankType">
              <option value="score">è¯„åˆ†æ¦œ</option>
              <option value="hot">çƒ­åº¦æ¦œ</option>
              <option value="new">æ–°å“æ¦œ</option>
            </select>
          </div>
          <div class="form-row">
            <label for="rankPlatform">å¹³å°</label>
            <select id="rankPlatform">
              <option value="all">å…¨éƒ¨å¹³å°</option>
              <option value="steam">Steam</option>
              <option value="pc">PCï¼ˆå…¶ä»–ï¼‰</option>
              <option value="ps">PlayStation</option>
              <option value="switch">Switch</option>
              <option value="mobile">æ‰‹æœº</option>
            </select>
          </div>
          <div class="form-row">
            <label for="rankSearch">åç§°å…³é”®å­—</label>
            <input id="rankSearch" type="text" placeholder="è¾“å…¥æ¸¸æˆåï¼Œä¾‹å¦‚ï¼šè‰¾å°”ç™»æ³•ç¯" />
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>æ¦œå•ç»“æœ</span>
          </div>
          <div class="chip" id="rankCount">å…± 0 æ¬¾</div>
        </header>
        <ol class="ranking-list" id="rankList" style="max-height: 600px; overflow-y: auto;"></ol>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">è¯´æ˜</div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®</span><span class="value">å‰ç«¯å‡æ•°æ®</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æ’åº</span><span class="value">æŒ‰è¯„åˆ†æˆ–çƒ­åº¦æ’åº</span>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="mega-game-database.js"></script>
<script>
  initCommon();

  let allGamesData = [];
  let filteredGames = [];
  let currentPage = 0;
  const PAGE_SIZE = 20;
  let isDataLoaded = false;

  const rankType = document.getElementById("rankType");
  const rankPlatform = document.getElementById("rankPlatform");
  const rankSearch = document.getElementById("rankSearch");
  const rankList = document.getElementById("rankList");
  const rankCount = document.getElementById("rankCount");

  // åŠ è½½æ‰€æœ‰æ¸¸æˆæ•°æ®
  async function loadAllGames() {
    try {
      rankList.innerHTML = '<li style="text-align: center; padding: 40px; color: var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½æ’è¡Œæ¦œæ•°æ®...</li>';
      
      allGamesData = await window.megaGameDB.getAllGames();
      isDataLoaded = true;
      
      console.log(`âœ… æˆåŠŸåŠ è½½ ${allGamesData.length} æ¬¾æ¸¸æˆåˆ°æ’è¡Œæ¦œ`);
      applyFiltersAndRender();
    } catch (error) {
      console.error("âŒ åŠ è½½å¤±è´¥:", error);
      rankList.innerHTML = '<li style="text-align: center; padding: 40px; color: var(--danger);">âŒ æ’è¡Œæ¦œæ•°æ®åŠ è½½å¤±è´¥</li>';
    }
  }

  // åº”ç”¨ç­›é€‰å’Œæ¸²æŸ“
  function applyFiltersAndRender() {
    if (!isDataLoaded) {
      rankList.innerHTML = '<li style="text-align: center; padding: 40px; color: var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½...</li>';
      return;
    }

    const type = rankType.value; // score / hot / new
    const platform = rankPlatform.value;
    const keyword = rankSearch.value.trim().toLowerCase();

    // ç­›é€‰æ¸¸æˆ
    filteredGames = allGamesData.filter(game => {
      // å¹³å°ç­›é€‰
      if (platform !== "all" && !game.platform.toLowerCase().includes(platform.toLowerCase())) {
        return false;
      }

      // å…³é”®è¯æœç´¢
      if (keyword) {
        const searchText = `${game.name} ${game.genre} ${game.publisher} ${game.short_description}`.toLowerCase();
        if (!searchText.includes(keyword)) return false;
      }

      return true;
    });

    // æ ¹æ®æ¦œå•ç±»å‹æ’åº
    if (type === "score") {
      // è¯„åˆ†æ¦œï¼šé«˜è¯„åˆ†ä¼˜å…ˆ
      filteredGames.sort((a, b) => b.rating - a.rating);
    } else if (type === "hot") {
      // çƒ­åº¦æ¦œï¼šæ··åˆè¯„åˆ†å’Œå…è´¹æ¸¸æˆ
      filteredGames.sort((a, b) => {
        if (a.price === 0 && b.price !== 0) return -1;
        if (a.price !== 0 && b.price === 0) return 1;
        return b.rating - a.rating;
      });
    } else if (type === "new") {
      // æ–°å“æ¦œï¼šæœ€æ–°å¹´ä»½ä¼˜å…ˆ
      filteredGames.sort((a, b) => {
        if (b.year !== a.year) return b.year - a.year;
        return b.rating - a.rating;
      });
    }

    // é‡ç½®åˆ—è¡¨
    currentPage = 0;
    rankList.innerHTML = "";
    rankCount.textContent = `å…± ${filteredGames.length} æ¬¾`;

    if (filteredGames.length === 0) {
      rankList.innerHTML = '<li style="text-align: center; padding: 40px; color: var(--text-muted);">ğŸ” æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ¸¸æˆ</li>';
      return;
    }

    loadMoreItems();
  }

  // åŠ è½½æ›´å¤šé¡¹ç›®
  function loadMoreItems() {
    const start = currentPage * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageItems = filteredGames.slice(start, end);

    if (pageItems.length === 0) return;

    pageItems.forEach((game, localIdx) => {
      const globalIdx = start + localIdx;
      const li = document.createElement("li");
      li.className = "ranking-item";
      li.style.cursor = "pointer";

      // å°é¢å›¾
      const coverHtml = game.thumbnail
        ? `<img src="${game.thumbnail}" alt="${game.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:24px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);\\'>ğŸ®</div>'" />`
        : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 24px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ®</div>';

      // æ’åæ ·å¼
      const rankClass = globalIdx === 0 ? "ranking-pos--top1" : "";
      const medalIcon = globalIdx === 0 ? "ğŸ¥‡" : globalIdx === 1 ? "ğŸ¥ˆ" : globalIdx === 2 ? "ğŸ¥‰" : "";

      li.innerHTML = `
        <div class="ranking-pos ${rankClass}">${medalIcon}${globalIdx + 1}</div>
        <div class="ranking-game">
          <div class="ranking-cover">${coverHtml}</div>
          <div class="ranking-info">
            <div class="ranking-name">${game.name}</div>
            <div class="ranking-meta">${game.genre} Â· ${game.platform.split(',')[0].trim()}</div>
          </div>
        </div>
        <div class="ranking-score">
          <span class="value">${game.rating.toFixed(1)}</span>
          <div><span class="tag">${game.price === 0 ? "å…è´¹" : game.genre}</span></div>
        </div>
      `;

      // æ‚¬åœæ•ˆæœ
      li.addEventListener("mouseenter", () => {
        li.style.backgroundColor = "rgba(56, 189, 248, 0.05)";
        li.style.transition = "all 0.3s ease";
      });

      li.addEventListener("mouseleave", () => {
        li.style.backgroundColor = "";
      });

      // ç‚¹å‡»è·³è½¬
      li.addEventListener("click", () => {
        const url = new URL("game-detail.html", window.location.href);
        url.searchParams.set("id", game.id);
        url.searchParams.set("name", game.name);
        window.location.href = url.toString();
      });

      rankList.appendChild(li);
    });

    currentPage++;
  }

  // æ— é™æ»šåŠ¨
  rankList.addEventListener("scroll", () => {
    const scrollTop = rankList.scrollTop;
    const scrollHeight = rankList.scrollHeight;
    const clientHeight = rankList.clientHeight;

    if (scrollHeight - scrollTop - clientHeight < 100) {
      loadMoreItems();
    }
  });

  // ç›‘å¬ç­›é€‰æ¡ä»¶å˜åŒ–
  rankType.addEventListener("change", applyFiltersAndRender);
  rankPlatform.addEventListener("change", applyFiltersAndRender);
  rankSearch.addEventListener("input", applyFiltersAndRender);

  // åˆå§‹åŠ è½½
  loadAllGames();
</script>
</body>
</html>
