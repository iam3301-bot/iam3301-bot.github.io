<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - ç”¨æˆ·ä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* ç”¨æˆ·ä¸­å¿ƒä¸“å±æ ·å¼ */
    .profile-container {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 24px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    @media (max-width: 900px) {
      .profile-container {
        grid-template-columns: 1fr;
      }
    }
    
    .profile-card {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      border: 1px solid rgba(56, 189, 248, 0.2);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .profile-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(56, 189, 248, 0.15);
    }
    
    .profile-card-icon {
      font-size: 24px;
    }
    
    .profile-card-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--accent);
      font-family: 'Orbitron', sans-serif;
    }
    
    /* ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨ */
    .user-header {
      display: flex;
      align-items: center;
      gap: 24px;
      padding: 32px;
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.1), rgba(168, 85, 247, 0.05));
      border-radius: 16px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .user-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00ff88, #00ccff, #a855f7);
    }
    
    .user-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4fc3f7, #7c4dff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.5);
      flex-shrink: 0;
    }
    
    .user-avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .user-info {
      flex: 1;
    }
    
    .user-name {
      font-size: 28px;
      font-weight: 900;
      color: var(--text-main);
      font-family: 'Orbitron', sans-serif;
      margin-bottom: 8px;
    }
    
    .user-email {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    
    .user-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .user-badge {
      padding: 4px 12px;
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 20px;
      font-size: 12px;
      color: var(--accent);
    }
    
    .user-badge.verified {
      background: rgba(0, 255, 136, 0.15);
      border-color: rgba(0, 255, 136, 0.3);
      color: #00ff88;
    }
    
    .user-badge.steam {
      background: rgba(102, 192, 244, 0.15);
      border-color: rgba(102, 192, 244, 0.3);
      color: #66c0f4;
    }
    
    /* ç»Ÿè®¡å¡ç‰‡ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 16px;
      margin-bottom: 24px;
    }
    
    @media (max-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.9), rgba(31, 41, 55, 0.8));
      border: 1px solid rgba(56, 189, 248, 0.2);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 900;
      font-family: 'Orbitron', sans-serif;
      color: var(--accent);
      margin-bottom: 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* Steam åŒºåŸŸ - å°é»‘ç›’é£æ ¼ */
    .steam-section {
      background: linear-gradient(135deg, rgba(27, 40, 56, 0.95), rgba(20, 30, 45, 0.9));
      border: 1px solid rgba(102, 192, 244, 0.3);
      border-radius: 16px;
      padding: 0;
      margin-bottom: 24px;
      overflow: hidden;
    }
    
    .steam-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: rgba(0, 0, 0, 0.3);
      border-bottom: 1px solid rgba(102, 192, 244, 0.15);
    }
    
    .steam-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .steam-logo-icon {
      width: 36px;
      height: 36px;
      background: linear-gradient(135deg, #1b2838, #2a475e);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }
    
    .steam-logo-text {
      font-size: 16px;
      font-weight: 700;
      color: #66c0f4;
    }
    
    .steam-logo-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .steam-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
    }
    
    .steam-status.linked {
      color: #00ff88;
    }
    
    .steam-status.unlinked {
      color: var(--text-muted);
    }
    
    .steam-help-link {
      font-size: 12px;
      color: var(--accent);
      text-decoration: none;
      cursor: pointer;
    }
    
    .steam-help-link:hover {
      text-decoration: underline;
    }
    
    /* çƒ­é—¨æ¸¸æˆæ¨ªå¹… */
    .steam-games-banner {
      display: flex;
      gap: 8px;
      padding: 12px 20px;
      overflow-x: auto;
      background: rgba(0, 0, 0, 0.15);
    }
    
    .steam-games-banner::-webkit-scrollbar {
      height: 0;
    }
    
    .steam-banner-item {
      width: 70px;
      height: 90px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .steam-banner-item:hover {
      transform: scale(1.05);
    }
    
    .steam-banner-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    /* ç»‘å®šå†…å®¹åŒºåŸŸ */
    .steam-bind-content {
      padding: 20px;
    }
    
    .steam-profile {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .steam-avatar {
      width: 56px;
      height: 56px;
      border-radius: 8px;
      overflow: hidden;
      flex-shrink: 0;
    }
    
    .steam-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .steam-user-info {
      flex: 1;
      min-width: 0;
    }
    
    .steam-persona-name {
      font-size: 16px;
      font-weight: 700;
      color: #66c0f4;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .steam-primary-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: linear-gradient(135deg, #f59e0b, #d97706);
      border-radius: 4px;
      color: white;
      font-weight: 600;
    }
    
    .steam-id {
      font-size: 11px;
      color: var(--text-muted);
      font-family: monospace;
    }
    
    .steam-profile-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .steam-action-btn {
      padding: 8px 14px;
      background: rgba(102, 192, 244, 0.2);
      border: 1px solid rgba(102, 192, 244, 0.3);
      border-radius: 6px;
      color: #66c0f4;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .steam-action-btn:hover {
      background: rgba(102, 192, 244, 0.3);
      border-color: #66c0f4;
    }
    
    .steam-action-btn.primary {
      background: #66c0f4;
      color: #1b2838;
      border-color: transparent;
    }
    
    .steam-action-btn.danger {
      background: rgba(239, 68, 68, 0.2);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .steam-action-btn.danger:hover {
      background: rgba(239, 68, 68, 0.3);
    }
    
    .steam-stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .steam-stat {
      text-align: center;
      padding: 14px 12px;
      background: rgba(0, 0, 0, 0.25);
      border-radius: 10px;
      border: 1px solid rgba(102, 192, 244, 0.1);
    }
    
    .steam-stat-value {
      font-size: 22px;
      font-weight: 700;
      color: #66c0f4;
      font-family: 'Orbitron', sans-serif;
    }
    
    .steam-stat-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* å¤šè´¦å·ç®¡ç†å…¥å£ */
    .steam-multi-account {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: rgba(102, 192, 244, 0.05);
      border: 1px dashed rgba(102, 192, 244, 0.3);
      border-radius: 10px;
      margin-bottom: 16px;
    }
    
    .steam-multi-account-text {
      font-size: 13px;
      color: var(--text-soft);
    }
    
    .steam-multi-account-link {
      font-size: 13px;
      color: #66c0f4;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .steam-multi-account-link:hover {
      text-decoration: underline;
    }
    
    /* Steam æ¸¸æˆåˆ—è¡¨ */
    .steam-games-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 20px 0 16px;
    }
    
    .steam-games-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-soft);
    }
    
    .steam-games-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
      max-height: 500px;
      overflow-y: auto;
      padding-right: 8px;
      padding-bottom: 8px;
    }
    
    .steam-game-item {
      position: relative;
      display: flex;
      flex-direction: column;
      background: linear-gradient(145deg, rgba(27, 40, 56, 0.9), rgba(42, 71, 94, 0.8));
      border-radius: 12px;
      overflow: hidden;
      transition: all 0.3s ease;
      border: 1px solid rgba(102, 192, 244, 0.15);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
    }
    
    .steam-game-item:hover {
      transform: translateY(-5px) scale(1.02);
      border-color: rgba(102, 192, 244, 0.5);
      box-shadow: 0 8px 30px rgba(102, 192, 244, 0.2), 0 0 20px rgba(102, 192, 244, 0.1);
    }
    
    .steam-game-img {
      width: 100%;
      height: 150px;
      position: relative;
      overflow: hidden;
    }
    
    .steam-game-img::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 60px;
      background: linear-gradient(to top, rgba(27, 40, 56, 1), transparent);
      pointer-events: none;
    }
    
    .steam-game-img img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s ease;
    }
    
    .steam-game-item:hover .steam-game-img img {
      transform: scale(1.1);
    }
    
    .steam-game-info {
      padding: 16px;
      position: relative;
      z-index: 1;
      margin-top: -30px;
    }
    
    .steam-game-name {
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 8px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }
    
    .steam-game-playtime {
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .steam-game-playtime .recent-play {
      background: linear-gradient(90deg, rgba(0, 255, 136, 0.2), transparent);
      padding: 3px 8px;
      border-radius: 12px;
      color: #00ff88;
      font-size: 11px;
    }
    
    .steam-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: linear-gradient(135deg, #66c0f4, #3d6a8e);
      color: #fff;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .view-store-btn {
      position: absolute;
      bottom: 12px;
      right: 12px;
      background: rgba(102, 192, 244, 0.2);
      border: 1px solid rgba(102, 192, 244, 0.4);
      color: #66c0f4;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      opacity: 0;
      transition: all 0.3s ease;
    }
    
    .steam-game-item:hover .view-store-btn {
      opacity: 1;
    }
    
    .view-store-btn:hover {
      background: rgba(102, 192, 244, 0.4);
    }
    
    /* ç»‘å®šè¡¨å• */
    .link-form {
      display: flex;
      gap: 12px;
      margin-top: 16px;
    }
    
    .link-input {
      flex: 1;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(102, 192, 244, 0.3);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 14px;
    }
    
    .link-input:focus {
      outline: none;
      border-color: #66c0f4;
    }
    
    .link-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, #1b2838, #2a475e);
      border: 1px solid rgba(102, 192, 244, 0.5);
      border-radius: 8px;
      color: #66c0f4;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    
    .link-btn:hover {
      background: linear-gradient(135deg, #2a475e, #3d6a8e);
      border-color: #66c0f4;
    }
    
    .link-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* æŒ‰é’®æ ·å¼ */
    .profile-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, var(--accent), #00ff88);
      border: none;
      border-radius: 8px;
      color: #0a0f1a;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .profile-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(56, 189, 248, 0.4);
    }
    
    .profile-btn.secondary {
      background: transparent;
      border: 1px solid rgba(56, 189, 248, 0.3);
      color: var(--accent);
    }
    
    .profile-btn.danger {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .profile-btn.danger:hover {
      background: rgba(239, 68, 68, 0.3);
      box-shadow: none;
    }
    
    /* è´¦æˆ·æ“ä½œæŒ‰é’®æ ·å¼ */
    .account-action-btn {
      display: flex;
      align-items: center;
      gap: 16px;
      width: 100%;
      padding: 16px 20px;
      background: linear-gradient(135deg, rgba(31, 41, 55, 0.9), rgba(17, 24, 39, 0.95));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: left;
    }
    
    .account-action-btn:hover {
      transform: translateX(5px);
      border-color: rgba(255, 255, 255, 0.2);
    }
    
    .account-action-btn .action-icon {
      font-size: 24px;
      width: 48px;
      height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
    }
    
    .account-action-btn .action-info {
      flex: 1;
    }
    
    .account-action-btn .action-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-soft);
      margin-bottom: 4px;
    }
    
    .account-action-btn .action-desc {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .account-action-btn .action-arrow {
      font-size: 18px;
      color: var(--text-muted);
      transition: transform 0.3s ease;
    }
    
    .account-action-btn:hover .action-arrow {
      transform: translateX(5px);
    }
    
    /* åˆ‡æ¢è´¦æˆ·æŒ‰é’® - è“è‰²ä¸»é¢˜ */
    .account-action-btn.switch-btn {
      border-color: rgba(102, 192, 244, 0.2);
    }
    
    .account-action-btn.switch-btn:hover {
      background: linear-gradient(135deg, rgba(102, 192, 244, 0.15), rgba(17, 24, 39, 0.95));
      border-color: rgba(102, 192, 244, 0.4);
    }
    
    .account-action-btn.switch-btn .action-icon {
      background: rgba(102, 192, 244, 0.15);
      color: #66c0f4;
    }
    
    .account-action-btn.switch-btn .action-title {
      color: #66c0f4;
    }
    
    /* é€€å‡ºç™»å½•æŒ‰é’® - çº¢è‰²ä¸»é¢˜ */
    .account-action-btn.logout-btn {
      border-color: rgba(239, 68, 68, 0.2);
    }
    
    .account-action-btn.logout-btn:hover {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(17, 24, 39, 0.95));
      border-color: rgba(239, 68, 68, 0.4);
    }
    
    .account-action-btn.logout-btn .action-icon {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }
    
    .account-action-btn.logout-btn .action-title {
      color: #ef4444;
    }
    
    /* è®¾ç½®é¡¹ */
    .settings-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 0;
      border-bottom: 1px solid rgba(56, 189, 248, 0.1);
    }
    
    .settings-item:last-child {
      border-bottom: none;
    }
    
    .settings-label {
      font-size: 14px;
      color: var(--text-soft);
    }
    
    .settings-desc {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* å¼€å…³ */
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(56, 189, 248, 0.2);
      transition: .3s;
      border-radius: 26px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background-color: var(--text-muted);
      transition: .3s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--accent);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(22px);
      background-color: #0a0f1a;
    }
    
    /* ç”¨æˆ·IDæ˜¾ç¤º */
    .user-id-display {
      font-family: 'Orbitron', monospace;
      font-size: 11px;
      color: var(--text-muted);
      background: rgba(0, 0, 0, 0.3);
      padding: 4px 10px;
      border-radius: 4px;
      margin-top: 8px;
      margin-bottom: 8px;
      display: inline-block;
    }
    
    .user-id-display::before {
      content: 'ID: ';
      color: var(--accent);
    }
    
    /* æœªç™»å½•æç¤º */
    .login-prompt {
      text-align: center;
      padding: 60px 20px;
    }
    
    .login-prompt-icon {
      font-size: 64px;
      margin-bottom: 24px;
    }
    
    .login-prompt-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 12px;
    }
    
    .login-prompt-text {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }
    
    /* æ¶ˆæ¯æç¤º */
    .profile-message {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 16px;
      display: none;
    }
    
    .profile-message.show {
      display: block;
    }
    
    .profile-message.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .profile-message.success {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .profile-message.info {
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.3);
      color: var(--accent);
    }
    
    /* ä¾§è¾¹æ å¿«æ·æ“ä½œ */
    .quick-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .quick-action-btn {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(56, 189, 248, 0.2);
      border-radius: 10px;
      color: var(--text-soft);
      font-size: 14px;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .quick-action-btn:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
      color: var(--accent);
    }
    
    .quick-action-icon {
      font-size: 20px;
    }
    
    /* Demo æç¤º */
    .demo-notice {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 12px;
      color: #f59e0b;
      margin-top: 12px;
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    .steam-games-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .steam-games-list::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 3px;
    }
    
    .steam-games-list::-webkit-scrollbar-thumb {
      background: rgba(102, 192, 244, 0.3);
      border-radius: 3px;
    }
    
    .steam-games-list::-webkit-scrollbar-thumb:hover {
      background: rgba(102, 192, 244, 0.5);
    }
  </style>
</head>
<body data-current-page="profile" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="profile.html" data-page="profile" class="nav-link active">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user" id="headerUserBtn">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>

  <main class="main" style="display: block; padding: 20px;">
    
    <!-- æœªç™»å½•æç¤º -->
    <div id="loginPrompt" class="profile-card login-prompt" style="display: none;">
      <div class="login-prompt-icon">ğŸ”</div>
      <div class="login-prompt-title">è¯·å…ˆç™»å½•</div>
      <div class="login-prompt-text">ç™»å½•åå³å¯è®¿é—®ç”¨æˆ·ä¸­å¿ƒï¼Œç®¡ç†æ‚¨çš„æ¸¸æˆåº“å’Œè´¦å·è®¾ç½®</div>
      <a href="login.html" class="profile-btn" style="display: inline-block; text-decoration: none;">
        å‰å¾€ç™»å½•
      </a>
    </div>
    
    <!-- å·²ç™»å½•å†…å®¹ -->
    <div id="profileContent" class="profile-container" style="display: none;">
      
      <!-- å·¦ä¾§ä¸»å†…å®¹ -->
      <div class="profile-main">
        
        <!-- æ¶ˆæ¯æç¤º -->
        <div id="profileMessage" class="profile-message"></div>
        
        <!-- ç”¨æˆ·ä¿¡æ¯å¤´éƒ¨ -->
        <div class="user-header">
          <div class="user-avatar" id="userAvatar">ğŸ®</div>
          <div class="user-info">
            <div class="user-name" id="userName">åŠ è½½ä¸­...</div>
            <div class="user-email" id="userEmail">-</div>
            <div class="user-id-display" id="userIdDisplay">-</div>
            <div class="user-badges" id="userBadges">
              <!-- å¾½ç« åŠ¨æ€ç”Ÿæˆ -->
            </div>
          </div>
          <div>
            <a href="profile-edit.html" class="profile-btn secondary">âœï¸ ç¼–è¾‘èµ„æ–™</a>
          </div>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statOwnedGames">0</div>
            <div class="stat-label">å·²æ‹¥æœ‰æ¸¸æˆ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statWishlistGames">0</div>
            <div class="stat-label">æƒ³ç©æ¸¸æˆ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPlaytime">0</div>
            <div class="stat-label">æ€»æ¸¸æˆæ—¶é•¿</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statLevel">Lv.1</div>
            <div class="stat-label">è´¦å·ç­‰çº§</div>
          </div>
        </div>
        
        <!-- Steam ç»‘å®šåŒºåŸŸ - å°é»‘ç›’é£æ ¼ -->
        <div class="steam-section" id="steamSection">
          <div class="steam-header">
            <div class="steam-logo">
              <div class="steam-logo-icon">ğŸ®</div>
              <div>
                <div class="steam-logo-text">Steam</div>
                <div class="steam-logo-desc">åŒæ­¥æ¸¸ç©æ•°æ®</div>
              </div>
            </div>
            <div style="display: flex; align-items: center; gap: 16px;">
              <a href="#" class="steam-help-link" onclick="showSteamHelp(); return false;">å¸®åŠ©</a>
              <div class="steam-status" id="steamStatus">
                <span>â—</span> <span id="steamStatusText">æœªç»‘å®š</span>
              </div>
            </div>
          </div>
          
          <!-- çƒ­é—¨æ¸¸æˆæ¨ªå¹… -->
          <div class="steam-games-banner">
            <div class="steam-banner-item" onclick="window.open('https://store.steampowered.com/app/730', '_blank')">
              <img src="https://cdn.cloudflare.steamstatic.com/steam/apps/730/capsule_231x87.jpg" alt="CS2">
            </div>
            <div class="steam-banner-item" onclick="window.open('https://store.steampowered.com/app/570', '_blank')">
              <img src="https://cdn.cloudflare.steamstatic.com/steam/apps/570/capsule_231x87.jpg" alt="Dota2">
            </div>
            <div class="steam-banner-item" onclick="window.open('https://store.steampowered.com/app/578080', '_blank')">
              <img src="https://cdn.cloudflare.steamstatic.com/steam/apps/578080/capsule_231x87.jpg" alt="PUBG">
            </div>
            <div class="steam-banner-item" onclick="window.open('https://store.steampowered.com/app/1172470', '_blank')">
              <img src="https://cdn.cloudflare.steamstatic.com/steam/apps/1172470/capsule_231x87.jpg" alt="Apex">
            </div>
            <div class="steam-banner-item" onclick="window.open('https://store.steampowered.com/app/1245620', '_blank')">
              <img src="https://cdn.cloudflare.steamstatic.com/steam/apps/1245620/capsule_231x87.jpg" alt="Elden Ring">
            </div>
            <div class="steam-banner-item" onclick="window.open('https://store.steampowered.com/app/2358720', '_blank')">
              <img src="https://cdn.cloudflare.steamstatic.com/steam/apps/2358720/capsule_231x87.jpg" alt="Black Myth">
            </div>
          </div>
          
          <div class="steam-bind-content">
            <!-- æœªç»‘å®šçŠ¶æ€ -->
            <div id="steamUnlinked">
              <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
                ç»‘å®š Steam è´¦å·åï¼Œå¯ä»¥è‡ªåŠ¨åŒæ­¥æ‚¨çš„æ¸¸æˆåº“ã€æ¸¸æˆæ—¶é•¿ç­‰æ•°æ®
              </p>
              
              <!-- æ¨èï¼šä½¿ç”¨ç»‘å®šå‘å¯¼ -->
              <div style="margin-bottom: 20px;">
                <a href="steam-binding.html" class="link-btn" style="display: inline-flex; align-items: center; gap: 8px; text-decoration: none; background: linear-gradient(135deg, #1b2838, #2a475e); padding: 14px 24px; font-size: 15px;">
                  <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  ğŸ® ä½¿ç”¨ç»‘å®šå‘å¯¼ï¼ˆæ¨èï¼‰
                </a>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                  å‘å¯¼å°†å¼•å¯¼æ‚¨å®Œæˆ Steam ç™»å½•éªŒè¯å’Œ API Key é…ç½®
                </p>
              </div>
              
              <!-- å¿«æ·æ–¹å¼ï¼šç›´æ¥è¾“å…¥ Steam ID -->
              <div style="border-top: 1px solid rgba(56, 189, 248, 0.2); padding-top: 16px; margin-top: 16px;">
                <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 10px;">
                  æˆ–è€…ç›´æ¥è¾“å…¥ Steam ID å¿«é€Ÿç»‘å®šï¼š
                </p>
                <div class="link-form">
                  <input type="text" class="link-input" id="steamIdInput" 
                    placeholder="è¾“å…¥ Steam ID æˆ–ä¸ªäººèµ„æ–™é“¾æ¥" />
                  <button class="link-btn" id="linkSteamBtn">å¿«é€Ÿç»‘å®š</button>
                </div>
              </div>
              
              <div class="demo-notice" id="steamDemoNotice">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>æ¨èä½¿ç”¨ç»‘å®šå‘å¯¼è·å–å®Œæ•´åŠŸèƒ½ã€‚<br>
                å¿«é€Ÿç»‘å®šä»…æ”¯æŒå…¬å¼€æ•°æ®ï¼Œå¯èƒ½æ— æ³•è·å–å®Œæ•´æ¸¸æˆåº“ã€‚
              </div>
            </div>
            
            <!-- å·²ç»‘å®šçŠ¶æ€ -->
            <div id="steamLinked" style="display: none;">
              <div class="steam-profile">
                <div class="steam-avatar" id="steamAvatar">
                  <img src="" alt="Steam Avatar" />
                </div>
                <div class="steam-user-info">
                  <div class="steam-persona-name">
                    <span id="steamPersonaName">-</span>
                    <span class="steam-primary-badge">ä¸»è´¦å·</span>
                  </div>
                  <div class="steam-id" id="steamIdDisplay">-</div>
                </div>
                <div class="steam-profile-actions">
                  <button class="steam-action-btn primary" id="showFriendCodeBtn">æ˜¾ç¤ºå¥½å‹ç </button>
                  <button class="steam-action-btn" id="syncSteamBtn">ğŸ”„ åŒæ­¥</button>
                  <button class="steam-action-btn danger" id="unlinkSteamBtn">è§£ç»‘</button>
                </div>
              </div>
              
              <div class="steam-stats">
                <div class="steam-stat">
                  <div class="steam-stat-value" id="steamGameCount">0</div>
                  <div class="steam-stat-label">Steam æ¸¸æˆ</div>
                </div>
                <div class="steam-stat">
                  <div class="steam-stat-value" id="steamPlaytime">0</div>
                  <div class="steam-stat-label">æ€»æ—¶é•¿</div>
                </div>
                <div class="steam-stat">
                  <div class="steam-stat-value" id="steamRecentCount">0</div>
                  <div class="steam-stat-label">è¿‘æœŸæ¸¸ç©</div>
                </div>
              </div>
              
              <!-- å¤šè´¦å·ç®¡ç†å…¥å£ -->
              <div class="steam-multi-account">
                <span class="steam-multi-account-text">ç®¡ç†å¤šä¸ª Steam è´¦å·</span>
                <a href="accounts.html" class="steam-multi-account-link">
                  æ¸¸æˆè´¦å·ç®¡ç† â†’
                </a>
              </div>
              
              <div class="steam-games-header">
                <div class="steam-games-title">ğŸ® æ¸¸æˆåº“ (æŒ‰æ¸¸æˆæ—¶é•¿æ’åº)</div>
                <select id="steamGamesSort" style="background: rgba(0,0,0,0.3); border: 1px solid rgba(102,192,244,0.3); border-radius: 4px; padding: 4px 8px; color: var(--text-soft); font-size: 12px;">
                  <option value="playtime">æŒ‰æ—¶é•¿</option>
                  <option value="recent">æœ€è¿‘æ¸¸ç©</option>
                  <option value="name">æŒ‰åç§°</option>
                </select>
              </div>
              
              <div class="steam-games-list" id="steamGamesList">
                <!-- æ¸¸æˆåˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
              </div>
              
              <div class="demo-notice" id="steamLinkedDemoNotice" style="display: none;">
                âš ï¸ å½“å‰æ˜¾ç¤ºçš„æ˜¯æ¼”ç¤ºæ•°æ®ã€‚é…ç½® Steam API Key åå¯è·å–çœŸå®æ¸¸æˆåº“ã€‚
              </div>
            </div>
          </div>
        </div>
        
        <!-- è´¦å·è®¾ç½® -->
        <div class="profile-card">
          <div class="profile-card-header">
            <span class="profile-card-icon">âš™ï¸</span>
            <span class="profile-card-title">è´¦å·è®¾ç½®</span>
          </div>
          
          <div class="settings-item">
            <div>
              <div class="settings-label">é‚®ç®±é€šçŸ¥</div>
              <div class="settings-desc">æ¥æ”¶æ¸¸æˆæŠ˜æ‰£ã€æ–°é—»ç­‰é‚®ä»¶é€šçŸ¥</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="settingNotifications" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="settings-item">
            <div>
              <div class="settings-label">å…¬å¼€èµ„æ–™</div>
              <div class="settings-desc">å…è®¸å…¶ä»–ç”¨æˆ·æŸ¥çœ‹æ‚¨çš„æ¸¸æˆåº“</div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="settingPublicProfile" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="settings-item">
            <div>
              <div class="settings-label">ä¿®æ”¹å¯†ç </div>
              <div class="settings-desc">æ›´æ–°æ‚¨çš„ç™»å½•å¯†ç </div>
            </div>
            <a href="reset-password.html" class="profile-btn secondary" style="text-decoration: none;">ä¿®æ”¹</a>
          </div>
        </div>
        
        <!-- è´¦æˆ·æ“ä½œå¡ç‰‡ - æ›´æ˜æ˜¾çš„ä½ç½® -->
        <div class="profile-card" style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.05), rgba(17, 24, 39, 0.95)); border-color: rgba(239, 68, 68, 0.3);">
          <div class="profile-card-header">
            <span class="profile-card-icon">ğŸ‘¤</span>
            <span class="profile-card-title" style="color: #f87171;">è´¦æˆ·æ“ä½œ</span>
          </div>
          
          <div style="display: flex; flex-direction: column; gap: 12px;">
            <!-- åˆ‡æ¢è´¦æˆ· -->
            <button class="account-action-btn switch-btn" id="switchAccountBtn">
              <span class="action-icon">ğŸ”„</span>
              <div class="action-info">
                <div class="action-title">åˆ‡æ¢è´¦æˆ·</div>
                <div class="action-desc">ç™»å½•å…¶ä»– GameBox è´¦å·</div>
              </div>
              <span class="action-arrow">â†’</span>
            </button>
            
            <!-- é€€å‡ºç™»å½• -->
            <button class="account-action-btn logout-btn" id="logoutBtn">
              <span class="action-icon">ğŸšª</span>
              <div class="action-info">
                <div class="action-title">é€€å‡ºç™»å½•</div>
                <div class="action-desc">å®‰å…¨é€€å‡ºå½“å‰è´¦å·</div>
              </div>
              <span class="action-arrow">â†’</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§è¾¹æ  -->
      <div class="profile-sidebar">
        
        <!-- å¿«æ·æ“ä½œ -->
        <div class="profile-card">
          <div class="profile-card-header">
            <span class="profile-card-icon">âš¡</span>
            <span class="profile-card-title">å¿«æ·æ“ä½œ</span>
          </div>
          <div class="quick-actions">
            <a href="accounts.html" class="quick-action-btn" style="border-color: rgba(102, 192, 244, 0.4);">
              <span class="quick-action-icon">ğŸ®</span>
              <span>æ¸¸æˆè´¦å·ç®¡ç†</span>
            </a>
            <a href="my-library.html" class="quick-action-btn">
              <span class="quick-action-icon">ğŸ“š</span>
              <span>æˆ‘çš„æ¸¸æˆåº“</span>
            </a>
            <a href="tools.html" class="quick-action-btn">
              <span class="quick-action-icon">ğŸ”§</span>
              <span>é…ç½®æ£€æµ‹å·¥å…·</span>
            </a>
            <a href="discount.html" class="quick-action-btn">
              <span class="quick-action-icon">ğŸ’°</span>
              <span>æŸ¥çœ‹æŠ˜æ‰£æ¸¸æˆ</span>
            </a>
            <a href="ranking.html" class="quick-action-btn">
              <span class="quick-action-icon">ğŸ†</span>
              <span>çƒ­é—¨æ’è¡Œæ¦œ</span>
            </a>
          </div>
        </div>
        
        <!-- æœ€è¿‘æ´»åŠ¨ -->
        <div class="profile-card">
          <div class="profile-card-header">
            <span class="profile-card-icon">ğŸ“Š</span>
            <span class="profile-card-title">æœ€è¿‘æ´»åŠ¨</span>
          </div>
          <div id="recentActivity" style="font-size: 13px; color: var(--text-muted);">
            <p>æš‚æ— æœ€è¿‘æ´»åŠ¨è®°å½•</p>
          </div>
        </div>
        
        <!-- å¸®åŠ©ä¿¡æ¯ -->
        <div class="profile-card" style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.05), rgba(56, 189, 248, 0.05));">
          <div class="profile-card-header">
            <span class="profile-card-icon">ğŸ’¡</span>
            <span class="profile-card-title" style="color: #00ff88;">ä½¿ç”¨æç¤º</span>
          </div>
          <div style="font-size: 12px; color: var(--text-soft); line-height: 1.8;">
            <p>â€¢ ç»‘å®š Steam è´¦å·å¯è‡ªåŠ¨åŒæ­¥æ¸¸æˆåº“</p>
            <p>â€¢ Steam èµ„æ–™éœ€è®¾ä¸ºå…¬å¼€æ‰èƒ½è·å–æ¸¸æˆæ•°æ®</p>
            <p>â€¢ æœ¬åœ°æ ‡è®°çš„æ¸¸æˆä¼šä¿å­˜åœ¨æµè§ˆå™¨ä¸­</p>
            <p>â€¢ é…ç½® Supabase å¯è·¨è®¾å¤‡åŒæ­¥æ•°æ®</p>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <footer class="footer">
    GameBox æ¸¸ç›’ Â· ç”¨æˆ·ä¸­å¿ƒ Â· Powered by Steam & Supabase
  </footer>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="supabase-config.js"></script>
<script>
  // =============================================
  // é¡µé¢åˆå§‹åŒ–
  // =============================================
  
  initCommon();
  
  const loginPrompt = document.getElementById('loginPrompt');
  const profileContent = document.getElementById('profileContent');
  const profileMessage = document.getElementById('profileMessage');
  
  let currentUser = null;
  let userData = null;
  
  // =============================================
  // åˆå§‹åŒ–
  // =============================================
  
  async function init() {
    await GameBoxAuth.init();
    SteamAPI.init();
    
    currentUser = await GameBoxAuth.getCurrentUser();
    
    // è°ƒè¯•ï¼šè¾“å‡ºå½“å‰ç”¨æˆ·ä¿¡æ¯
    console.log('[Profile] ========== ç”¨æˆ·ä¸­å¿ƒåˆå§‹åŒ– ==========');
    console.log('[Profile] å½“å‰ç”¨æˆ·:', currentUser);
    console.log('[Profile] ç”¨æˆ· ID:', currentUser?.id);
    
    if (currentUser) {
      loginPrompt.style.display = 'none';
      profileContent.style.display = 'grid';
      
      // åŠ è½½ç”¨æˆ·æ•°æ® - ä¸¥æ ¼æŒ‰ç”¨æˆ· ID è·å–
      userData = UserDataManager.getData(currentUser.id);
      
      // ã€é‡è¦ä¿®å¤ã€‘æ£€æŸ¥æ˜¯å¦æœ‰é€šè¿‡ç»‘å®šå‘å¯¼ä¿å­˜çš„ Steam æ•°æ®
      // ä½¿ç”¨ç”¨æˆ·ä¸“å±çš„ key: steam_binding_{userId}
      const userSteamBindingKey = 'steam_binding_' + currentUser.id;
      const steamBinding = localStorage.getItem(userSteamBindingKey);
      
      // ã€è¿ç§»æ—§æ•°æ®ã€‘å¦‚æœå­˜åœ¨æ—§çš„å…¨å±€ steam_bindingï¼Œæ£€æŸ¥æ˜¯å¦å±äºå½“å‰ç”¨æˆ·
      const oldGlobalBinding = localStorage.getItem('steam_binding');
      if (oldGlobalBinding && !steamBinding) {
        try {
          const oldData = JSON.parse(oldGlobalBinding);
          // åªæœ‰å½“æ—§æ•°æ®çš„ç»‘å®šç”¨æˆ· ID åŒ¹é…å½“å‰ç”¨æˆ·æ—¶æ‰è¿ç§»
          if (oldData.userId === currentUser.id) {
            console.log('[Profile] è¿ç§»æ—§çš„ Steam ç»‘å®šæ•°æ®åˆ°ç”¨æˆ·ä¸“å±å­˜å‚¨');
            localStorage.setItem(userSteamBindingKey, oldGlobalBinding);
            localStorage.removeItem('steam_binding'); // æ¸…é™¤æ—§çš„å…¨å±€æ•°æ®
          }
        } catch (e) {
          // å¿½ç•¥è§£æé”™è¯¯
        }
      }
      
      // ä½¿ç”¨ç”¨æˆ·ä¸“å±çš„ç»‘å®šæ•°æ®
      const userSteamBinding = localStorage.getItem(userSteamBindingKey);
      if (userSteamBinding) {
        try {
          const bindingData = JSON.parse(userSteamBinding);
          
          // éªŒè¯ç»‘å®šæ•°æ®çš„ç”¨æˆ· IDï¼ˆåŒé‡ç¡®è®¤ï¼‰
          if (bindingData.userId && bindingData.userId !== currentUser.id) {
            console.warn('[Profile] Steam ç»‘å®šæ•°æ®çš„ç”¨æˆ· ID ä¸åŒ¹é…ï¼Œå¿½ç•¥');
          } else {
            // æ£€æŸ¥ç»‘å®šæ•°æ®æ˜¯å¦æ¯”ç°æœ‰æ•°æ®æ›´æ–°
            const bindingTime = new Date(bindingData.boundAt || 0).getTime();
            const existingTime = new Date(userData.steam?.lastSync || 0).getTime();
            
            // å¦‚æœç»‘å®šæ•°æ®å­˜åœ¨ä¸”æ›´æ–°ï¼Œæˆ–è€…å½“å‰æ²¡æœ‰ç»‘å®š
            if (!userData.steam?.linked || bindingTime > existingTime || !userData.steam?.steamId) {
              userData.steam = {
                linked: true,
                steamId: bindingData.steamId,
                personaName: bindingData.personaName,
                avatar: bindingData.avatar,
                profileUrl: bindingData.profileUrl,
                lastSync: bindingData.boundAt,
                games: bindingData.games || [],
                gameCount: bindingData.gameCount || 0,
                totalPlaytime: bindingData.totalPlaytime || 0
              };
              // ä¿å­˜æ›´æ–°åçš„æ•°æ®
              UserDataManager.saveData(currentUser.id, userData);
              console.log('[Profile] å·²ä»ç»‘å®šå‘å¯¼åŒæ­¥ Steam æ•°æ®', {
                steamId: bindingData.steamId,
                gameCount: bindingData.gameCount
              });
            }
          }
        } catch (e) {
          console.error('[Profile] è§£æ steam_binding æ•°æ®å¤±è´¥:', e);
        }
      }
      
      // å†æ¬¡è·å–æœ€æ–°æ•°æ®ï¼ˆç¡®ä¿åŒæ­¥åçš„æ•°æ®è¢«æ­£ç¡®åŠ è½½ï¼‰
      userData = UserDataManager.getData(currentUser.id);
      
      console.log('[Profile] ç”¨æˆ·æ•°æ®åŠ è½½å®Œæˆ:', {
        userId: currentUser.id,
        steamLinked: userData.steam?.linked,
        steamPersonaName: userData.steam?.personaName,
        steamId: userData.steam?.steamId,
        gameCount: userData.steam?.gameCount
      });
      console.log('[Profile] ========================================');
      
      renderUserInfo();
      renderStats();
      renderSteamSection();
      updateHeaderUser();
    } else {
      loginPrompt.style.display = 'block';
      profileContent.style.display = 'none';
    }
  }
  
  // =============================================
  // æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯
  // =============================================
  
  function renderUserInfo() {
    document.getElementById('userName').textContent = currentUser.username || 'ç©å®¶';
    document.getElementById('userEmail').textContent = currentUser.email || '-';
    document.getElementById('userIdDisplay').textContent = currentUser.id || '-';
    
    // å¤´åƒ - ä¼˜å…ˆä½¿ç”¨è‡ªå®šä¹‰å¤´åƒï¼Œå…¶æ¬¡Steamå¤´åƒï¼Œæœ€åè¡¨æƒ…
    const avatarEl = document.getElementById('userAvatar');
    if (userData.customAvatar) {
      avatarEl.innerHTML = `<img src="${userData.customAvatar}" alt="Avatar" />`;
    } else if (userData.useSteamAvatar && userData.steam?.linked && userData.steam?.avatar) {
      avatarEl.innerHTML = `<img src="${userData.steam.avatar}" alt="Avatar" />`;
    } else if (userData.steam?.linked && userData.steam?.avatar && !currentUser.avatar) {
      avatarEl.innerHTML = `<img src="${userData.steam.avatar}" alt="Avatar" />`;
    } else {
      avatarEl.textContent = currentUser.avatar || 'ğŸ®';
    }
    
    // å¾½ç« 
    const badgesEl = document.getElementById('userBadges');
    let badges = '';
    
    if (currentUser.email_confirmed) {
      badges += '<span class="user-badge verified">âœ“ å·²éªŒè¯</span>';
    }
    
    if (userData.steam?.linked) {
      badges += '<span class="user-badge steam">ğŸ® Steam å·²ç»‘å®š</span>';
    }
    
    badges += '<span class="user-badge">Lv.' + calculateLevel() + '</span>';
    
    badgesEl.innerHTML = badges;
  }
  
  // =============================================
  // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
  // =============================================
  
  function renderStats() {
    // æœ¬åœ°æ¸¸æˆæ•°æ®
    const ownedGames = getLocalArray('ownedGames');
    const wishlistGames = getLocalArray('wishlistGames');
    
    // æ€»æ¸¸æˆæ•° (æœ¬åœ° + Steam)
    let totalOwned = ownedGames.length;
    if (userData.steam?.linked && userData.steam?.gameCount) {
      totalOwned = Math.max(totalOwned, userData.steam.gameCount);
    }
    
    document.getElementById('statOwnedGames').textContent = totalOwned;
    document.getElementById('statWishlistGames').textContent = wishlistGames.length;
    
    // æ¸¸æˆæ—¶é•¿
    let totalPlaytime = userData.steam?.totalPlaytime || 0;
    document.getElementById('statPlaytime').textContent = formatPlaytimeShort(totalPlaytime);
    
    // ç­‰çº§
    document.getElementById('statLevel').textContent = 'Lv.' + calculateLevel();
  }
  
  function calculateLevel() {
    let points = 0;
    
    // æœ¬åœ°æ¸¸æˆ
    points += getLocalArray('ownedGames').length * 10;
    points += getLocalArray('wishlistGames').length * 2;
    
    // Steam æ•°æ®
    if (userData.steam?.linked) {
      points += userData.steam.gameCount * 5;
      points += Math.floor(userData.steam.totalPlaytime / 60); // æ¯å°æ—¶1ç‚¹
    }
    
    // è®¡ç®—ç­‰çº§
    if (points >= 1000) return 10;
    if (points >= 500) return 8;
    if (points >= 300) return 6;
    if (points >= 150) return 4;
    if (points >= 50) return 2;
    return 1;
  }
  
  function formatPlaytimeShort(minutes) {
    if (minutes < 60) return minutes + 'åˆ†';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'å°æ—¶';
    const days = Math.floor(hours / 24);
    return days + 'å¤©';
  }
  
  function getLocalArray(key) {
    try {
      return JSON.parse(localStorage.getItem(key) || '[]');
    } catch {
      return [];
    }
  }
  
  // =============================================
  // Steam åŒºåŸŸæ¸²æŸ“
  // =============================================
  
  function renderSteamSection() {
    const steamUnlinked = document.getElementById('steamUnlinked');
    const steamLinked = document.getElementById('steamLinked');
    const steamStatus = document.getElementById('steamStatus');
    const steamStatusText = document.getElementById('steamStatusText');
    
    if (userData.steam?.linked) {
      steamUnlinked.style.display = 'none';
      steamLinked.style.display = 'block';
      steamStatus.className = 'steam-status linked';
      steamStatusText.textContent = 'å·²ç»‘å®š';
      
      // æ¸²æŸ“ Steam ä¿¡æ¯
      document.getElementById('steamAvatar').querySelector('img').src = userData.steam.avatar || '';
      const personaNameEl = document.getElementById('steamPersonaName');
      if (personaNameEl) personaNameEl.textContent = userData.steam.personaName || '-';
      document.getElementById('steamIdDisplay').textContent = 'Steam ID: ' + userData.steam.steamId;
      
      // ç»Ÿè®¡
      document.getElementById('steamGameCount').textContent = userData.steam.gameCount || 0;
      document.getElementById('steamPlaytime').textContent = formatPlaytimeShort(userData.steam.totalPlaytime || 0);
      
      // æœ€è¿‘æ¸¸ç©æ•°
      const recentGames = (userData.steam.games || []).filter(g => g.playtime2Weeks > 0);
      document.getElementById('steamRecentCount').textContent = recentGames.length;
      
      // æ¸²æŸ“æ¸¸æˆåˆ—è¡¨
      renderSteamGames(userData.steam.games || []);
      
      // æ£€æŸ¥æ˜¯å¦æ˜¯æ¼”ç¤ºæ•°æ®
      // (é€šè¿‡æ£€æŸ¥ localStorage ä¸­ä¿å­˜çš„æ•°æ®æ˜¯å¦æœ‰ isDemo æ ‡è®°)
      if (!SteamAPI.isEnabled()) {
        document.getElementById('steamLinkedDemoNotice').style.display = 'block';
      }
    } else {
      steamUnlinked.style.display = 'block';
      steamLinked.style.display = 'none';
      steamStatus.className = 'steam-status unlinked';
      steamStatusText.textContent = 'æœªç»‘å®š';
    }
  }
  
  function renderSteamGames(games, sortBy = 'playtime') {
    const gamesList = document.getElementById('steamGamesList');
    
    if (!games || games.length === 0) {
      gamesList.innerHTML = '<p style="color: var(--text-muted); padding: 20px; text-align: center;">æš‚æ— æ¸¸æˆæ•°æ®</p>';
      return;
    }
    
    // æ’åº
    let sortedGames = [...games];
    switch (sortBy) {
      case 'playtime':
        sortedGames.sort((a, b) => (b.playtimeForever || 0) - (a.playtimeForever || 0));
        break;
      case 'recent':
        sortedGames.sort((a, b) => (b.playtime2Weeks || 0) - (a.playtime2Weeks || 0));
        break;
      case 'name':
        sortedGames.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        break;
    }
    
    // æ¸¸æˆåç§°åˆ° AppID çš„æ˜ å°„è¡¨ï¼ˆç”¨äºæ— æœ‰æ•ˆ AppID çš„æƒ…å†µï¼‰
    const gameNameToAppId = {
      'counter-strike 2': 730, 'cs2': 730, 'dota 2': 570, 'elden ring': 1245620,
      'terraria': 105600, 'apex legends': 1172470, 'pubg': 578080, 'pubg: battlegrounds': 578080,
      'gta v': 271590, 'grand theft auto v': 271590, 'rust': 252490, 'cyberpunk 2077': 1091500,
      'valheim': 892970, 'red dead redemption 2': 1174180, 'monster hunter: world': 582010,
      'dead by daylight': 381210, 'among us': 945360, 'stardew valley': 413150,
      'fall guys': 1097150, 'destiny 2': 1085660, 'rainbow six siege': 359550,
      'tom clancy\'s rainbow six siege': 359550, 'ark': 346110, 'ark: survival evolved': 346110,
      'warframe': 230410, 'path of exile': 238960, 'the witcher 3': 292030,
      'the witcher 3: wild hunt': 292030, 'civilization vi': 289070, 'sid meier\'s civilization vi': 289070,
      'hollow knight': 367520, 'hades': 1145360, 'celeste': 504230, 'sekiro': 814380,
      'dark souls iii': 374320, 'monster hunter rise': 1446780, 'persona 5 royal': 1687950,
      'baldur\'s gate 3': 1086940, 'palworld': 1623730, 'lethal company': 1966720
    };
    
    // æ ¹æ®æ¸¸æˆåç§°æŸ¥æ‰¾ AppID
    function findAppIdByName(gameName) {
      if (!gameName) return null;
      const normalized = gameName.toLowerCase().trim();
      return gameNameToAppId[normalized] || null;
    }
    
    gamesList.innerHTML = sortedGames.map(game => {
      // è·å–æœ‰æ•ˆçš„ AppIDï¼ˆä¼˜å…ˆä½¿ç”¨æ•°æ®ä¸­çš„ï¼Œå¦åˆ™ç”¨åç§°æŸ¥æ‰¾ï¼‰
      let appId = game.appId || game.appid || game.id;
      let validAppId = appId && /^\d+$/.test(String(appId)) ? appId : null;
      
      // å¦‚æœæ²¡æœ‰æœ‰æ•ˆ AppIDï¼Œå°è¯•ç”¨åç§°æŸ¥æ‰¾
      if (!validAppId && game.name) {
        validAppId = findAppIdByName(game.name);
      }
      
      // ç”Ÿæˆå¤šçº§å°é¢å›¾ URL
      let coverUrl = '';
      let fallback1 = '';
      let fallback2 = '';
      
      if (game.headerImage && game.headerImage.startsWith('http')) {
        coverUrl = game.headerImage;
      }
      
      if (validAppId) {
        if (!coverUrl) {
          coverUrl = `https://cdn.cloudflare.steamstatic.com/steam/apps/${validAppId}/header.jpg`;
        }
        fallback1 = `https://cdn.cloudflare.steamstatic.com/steam/apps/${validAppId}/capsule_616x353.jpg`;
        fallback2 = `https://cdn.cloudflare.steamstatic.com/steam/apps/${validAppId}/library_600x900.jpg`;
      }
      
      // ç”Ÿæˆå ä½ç¬¦èƒŒæ™¯
      const placeholderBg = `linear-gradient(135deg, #1b2838 0%, #2a475e 50%, #1b2838 100%)`;
      const gameLetter = (game.name || 'G').charAt(0).toUpperCase();
      
      // æ ¼å¼åŒ–æ¸¸æˆæ—¶é—´
      const playtime = SteamAPI.formatPlaytime(game.playtimeForever || 0);
      const hasRecentPlay = game.playtime2Weeks > 0;
      const recentPlaytime = hasRecentPlay ? SteamAPI.formatPlaytime(game.playtime2Weeks) : '';
      
      return `
        <div class="steam-game-item" onclick="window.open('https://store.steampowered.com/app/${validAppId || ''}', '_blank')" title="ç‚¹å‡»æŸ¥çœ‹Steamå•†åº—é¡µé¢">
          <div class="steam-badge">
            <span>ğŸ®</span> Steam
          </div>
          <div class="steam-game-img">
            ${coverUrl 
              ? `<img src="${coverUrl}" alt="${game.name}" 
                  onerror="
                    if (this.dataset.fallback === '1') {
                      this.onerror = null;
                      this.parentElement.innerHTML = '<div style=\\'background:${placeholderBg};width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;\\'><div style=\\'font-size:48px;color:rgba(102,192,244,0.5);\\'>${gameLetter}</div><div style=\\'font-size:12px;color:rgba(102,192,244,0.6);margin-top:8px;\\'>${game.name ? game.name.substring(0, 15) : ''}</div></div>';
                    } else if (this.dataset.fallback === '0' && '${fallback1}') {
                      this.dataset.fallback = '1';
                      this.src = '${fallback1}';
                    } else {
                      this.dataset.fallback = '1';
                      this.src = '${fallback2}';
                    }
                  " 
                  data-fallback="0" />`
              : `<div style="background:${placeholderBg};width:100%;height:100%;display:flex;flex-direction:column;align-items:center;justify-content:center;">
                  <div style="font-size:48px;color:rgba(102,192,244,0.5);">${gameLetter}</div>
                  <div style="font-size:12px;color:rgba(102,192,244,0.6);margin-top:8px;">${game.name ? game.name.substring(0, 15) : ''}</div>
                </div>`
            }
          </div>
          <div class="steam-game-info">
            <div class="steam-game-name">${game.name}</div>
            <div class="steam-game-playtime">
              <span>â± ${playtime}</span>
              ${hasRecentPlay ? `<span class="recent-play">ğŸ”¥ è¿‘ä¸¤å‘¨ ${recentPlaytime}</span>` : ''}
            </div>
          </div>
          <div class="view-store-btn">æŸ¥çœ‹å•†åº— â†’</div>
        </div>
      `;
    }).join('');
  }
  
  // =============================================
  // äº‹ä»¶å¤„ç†
  // =============================================
  
  // ç»‘å®š Steam
  document.getElementById('linkSteamBtn').addEventListener('click', async () => {
    const steamInput = document.getElementById('steamIdInput');
    const btn = document.getElementById('linkSteamBtn');
    const steamIdOrUrl = steamInput.value.trim();
    
    if (!steamIdOrUrl) {
      showMessage('è¯·è¾“å…¥ Steam ID æˆ–ä¸ªäººèµ„æ–™é“¾æ¥', 'error');
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'ç»‘å®šä¸­...';
    
    try {
      const result = await UserDataManager.linkSteam(currentUser.id, steamIdOrUrl);
      
      if (result.success) {
        userData = UserDataManager.getData(currentUser.id);
        renderUserInfo();
        renderStats();
        renderSteamSection();
        
        let message = result.message;
        if (result.isDemo) {
          message += ' (æ¼”ç¤ºæ•°æ®)';
        }
        showMessage(message, 'success');
      } else {
        showMessage(result.error, 'error');
      }
    } catch (error) {
      showMessage('ç»‘å®šå¤±è´¥: ' + error.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ç»‘å®šè´¦å·';
    }
  });
  
  // åŒæ­¥ Steam
  document.getElementById('syncSteamBtn').addEventListener('click', async () => {
    const btn = document.getElementById('syncSteamBtn');
    btn.disabled = true;
    btn.textContent = 'åŒæ­¥ä¸­...';
    
    try {
      const result = await UserDataManager.syncSteam(currentUser.id);
      
      if (result.success) {
        userData = UserDataManager.getData(currentUser.id);
        renderStats();
        renderSteamSection();
        showMessage('Steam æ•°æ®å·²åŒæ­¥', 'success');
      } else {
        showMessage(result.error, 'error');
      }
    } catch (error) {
      showMessage('åŒæ­¥å¤±è´¥: ' + error.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ”„ åŒæ­¥';
    }
  });
  
  // è§£ç»‘ Steam
  document.getElementById('unlinkSteamBtn').addEventListener('click', () => {
    if (confirm('ç¡®å®šè¦è§£ç»‘ Steam è´¦å·å—ï¼Ÿè¿™å°†æ¸…é™¤å·²åŒæ­¥çš„æ¸¸æˆæ•°æ®ã€‚')) {
      UserDataManager.unlinkSteam(currentUser.id);
      userData = UserDataManager.getData(currentUser.id);
      renderUserInfo();
      renderStats();
      renderSteamSection();
      showMessage('Steam è´¦å·å·²è§£ç»‘', 'info');
    }
  });
  
  // æ˜¾ç¤ºå¥½å‹ç 
  document.getElementById('showFriendCodeBtn').addEventListener('click', () => {
    if (!userData.steam?.steamId) return;
    showFriendCode(userData.steam.steamId);
  });
  
  // æ˜¾ç¤ºå¥½å‹ç å¼¹çª—
  function showFriendCode(steamId) {
    // Steam å¥½å‹ç è®¡ç®—
    // å¥½å‹ç  = SteamID64 - 76561197960265728 (Steam64 ID Offset)
    const steamIdNum = BigInt(steamId);
    const offset = BigInt('76561197960265728');
    const friendCode = (steamIdNum - offset).toString();
    
    const modal = document.createElement('div');
    modal.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
        <div style="background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.95)); border: 1px solid rgba(102, 192, 244, 0.3); border-radius: 16px; padding: 32px; max-width: 400px; text-align: center;" onclick="event.stopPropagation()">
          <h3 style="color: #66c0f4; margin-bottom: 16px;">Steam å¥½å‹ç </h3>
          <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 8px; margin-bottom: 16px;">
            <div style="font-size: 32px; font-weight: bold; color: #00ff88; letter-spacing: 4px; font-family: monospace;">${friendCode}</div>
          </div>
          <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 16px;">
            SteamID64: ${steamId}
          </p>
          <button onclick="navigator.clipboard.writeText('${friendCode}'); this.textContent='å·²å¤åˆ¶!'; setTimeout(() => this.textContent='å¤åˆ¶å¥½å‹ç ', 2000)" 
            style="padding: 10px 24px; background: #66c0f4; border: none; border-radius: 8px; color: #1b2838; font-weight: 600; cursor: pointer; margin-right: 8px;">
            å¤åˆ¶å¥½å‹ç 
          </button>
          <button onclick="this.parentElement.parentElement.remove()" 
            style="padding: 10px 24px; background: transparent; border: 1px solid rgba(102, 192, 244, 0.3); border-radius: 8px; color: var(--text-soft); cursor: pointer;">
            å…³é—­
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // Steam å¸®åŠ©å¼¹çª—
  function showSteamHelp() {
    const modal = document.createElement('div');
    modal.innerHTML = `
      <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
        <div style="background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.95)); border: 1px solid rgba(102, 192, 244, 0.3); border-radius: 16px; padding: 32px; max-width: 500px; max-height: 80vh; overflow-y: auto;" onclick="event.stopPropagation()">
          <h3 style="color: #66c0f4; margin-bottom: 16px;">å¦‚ä½•è·å– Steam IDï¼Ÿ</h3>
          
          <div style="color: var(--text-soft); font-size: 14px; line-height: 1.8;">
            <p><strong>æ–¹æ³•ä¸€ï¼šä»ä¸ªäººèµ„æ–™é¡µé¢è·å–</strong></p>
            <ol style="margin: 12px 0; padding-left: 20px;">
              <li>æ‰“å¼€ Steam å®¢æˆ·ç«¯æˆ–ç½‘é¡µç‰ˆ</li>
              <li>ç‚¹å‡»æ‚¨çš„ç”¨æˆ·åï¼Œè¿›å…¥ä¸ªäººèµ„æ–™</li>
              <li>å¤åˆ¶æµè§ˆå™¨åœ°å€æ ä¸­çš„é“¾æ¥</li>
              <li>æ ¼å¼å¦‚: steamcommunity.com/id/xxx æˆ– steamcommunity.com/profiles/xxx</li>
            </ol>
            
            <p><strong>æ–¹æ³•äºŒï¼šåœ¨ Steam è®¾ç½®ä¸­æŸ¥çœ‹</strong></p>
            <ol style="margin: 12px 0; padding-left: 20px;">
              <li>æ‰“å¼€ Steam å®¢æˆ·ç«¯</li>
              <li>è¿›å…¥ è®¾ç½® > ç•Œé¢</li>
              <li>å‹¾é€‰ "å½“å¯ç”¨æ—¶åœ¨ Steam URL æ ä¸­æ˜¾ç¤º Steam URL"</li>
              <li>æ‚¨çš„ SteamID64 ä¼šæ˜¾ç¤ºåœ¨ä¸ªäººèµ„æ–™ä¸­</li>
            </ol>
            
            <div style="background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 12px; margin-top: 16px;">
              <strong style="color: #f59e0b;">âš ï¸ æ³¨æ„</strong>
              <p style="margin-top: 8px;">æ‚¨çš„ Steam èµ„æ–™éœ€è¦è®¾ä¸ºå…¬å¼€æ‰èƒ½è·å–æ¸¸æˆæ•°æ®ã€‚<br>åœ¨ Steam ä¸­è¿›å…¥ ç¼–è¾‘ä¸ªäººèµ„æ–™ > éšç§è®¾ç½®ï¼Œå°†"æ¸¸æˆè¯¦æƒ…"è®¾ä¸ºå…¬å¼€ã€‚</p>
            </div>
          </div>
          
          <button onclick="this.parentElement.parentElement.remove()" 
            style="margin-top: 20px; padding: 10px 24px; background: #66c0f4; border: none; border-radius: 8px; color: #1b2838; font-weight: 600; cursor: pointer; width: 100%;">
            çŸ¥é“äº†
          </button>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  // æ¸¸æˆæ’åº
  document.getElementById('steamGamesSort').addEventListener('change', (e) => {
    renderSteamGames(userData.steam?.games || [], e.target.value);
  });
  
  // åˆ‡æ¢è´¦æˆ· - æ˜¾ç¤ºè´¦æˆ·åˆ‡æ¢å¼¹çª—
  document.getElementById('switchAccountBtn').addEventListener('click', () => {
    showSwitchAccountModal();
  });
  
  // åˆ‡æ¢è´¦æˆ·å¼¹çª—
  function showSwitchAccountModal() {
    const modal = document.createElement('div');
    modal.id = 'switchAccountModal';
    
    // è·å–æ‰€æœ‰å·²ä¿å­˜çš„è´¦æˆ·
    let savedAccounts = [];
    try {
      savedAccounts = JSON.parse(localStorage.getItem('gamebox_saved_accounts') || '[]');
    } catch (e) {
      savedAccounts = [];
    }
    
    // æ·»åŠ å½“å‰è´¦æˆ·åˆ°å·²ä¿å­˜åˆ—è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if (currentUser && !savedAccounts.find(acc => acc.id === currentUser.id)) {
      savedAccounts.push({
        id: currentUser.id,
        email: currentUser.email,
        username: currentUser.username,
        avatar: userData?.avatar || ''
      });
      localStorage.setItem('gamebox_saved_accounts', JSON.stringify(savedAccounts));
    }
    
    const accountsHtml = savedAccounts.length > 0 
      ? savedAccounts.map(acc => `
          <div class="saved-account-item ${acc.id === currentUser?.id ? 'current' : ''}" 
               data-account-id="${acc.id}" 
               onclick="${acc.id !== currentUser?.id ? 'switchToAccount(\'' + acc.id + '\')' : ''}">
            <div class="account-avatar">
              ${acc.avatar ? `<img src="${acc.avatar}" alt="">` : acc.username?.charAt(0)?.toUpperCase() || '?'}
            </div>
            <div class="account-info">
              <div class="account-name">${acc.username || 'æœªè®¾ç½®æ˜µç§°'}</div>
              <div class="account-email">${acc.email || ''}</div>
            </div>
            ${acc.id === currentUser?.id 
              ? '<span class="current-badge">å½“å‰è´¦æˆ·</span>' 
              : '<span class="switch-arrow">åˆ‡æ¢ â†’</span>'}
          </div>
        `).join('')
      : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">æš‚æ— ä¿å­˜çš„è´¦æˆ·</p>';
    
    modal.innerHTML = `
      <div class="modal-overlay" onclick="document.getElementById('switchAccountModal').remove()">
        <div class="switch-account-modal" onclick="event.stopPropagation()">
          <div class="modal-header">
            <h3>ğŸ”„ åˆ‡æ¢è´¦æˆ·</h3>
            <button class="modal-close" onclick="document.getElementById('switchAccountModal').remove()">Ã—</button>
          </div>
          
          <div class="saved-accounts-list">
            ${accountsHtml}
          </div>
          
          <div class="modal-actions">
            <button class="add-account-btn" onclick="showAddAccountForm()">
              <span>â•</span> æ·»åŠ å…¶ä»–è´¦æˆ·
            </button>
            <button class="logout-all-btn" onclick="logoutAllAccounts()">
              <span>ğŸšª</span> é€€å‡ºæ‰€æœ‰è´¦æˆ·
            </button>
          </div>
        </div>
      </div>
      
      <style>
        .modal-overlay {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.8);
          z-index: 1000;
          display: flex;
          align-items: center;
          justify-content: center;
          animation: fadeIn 0.2s ease;
        }
        
        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }
        
        .switch-account-modal {
          background: linear-gradient(145deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.95));
          border: 1px solid rgba(102, 192, 244, 0.3);
          border-radius: 20px;
          padding: 0;
          width: 90%;
          max-width: 420px;
          overflow: hidden;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
          animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
          from { transform: translateY(30px); opacity: 0; }
          to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 20px 24px;
          border-bottom: 1px solid rgba(102, 192, 244, 0.15);
        }
        
        .modal-header h3 {
          margin: 0;
          color: #66c0f4;
          font-size: 18px;
        }
        
        .modal-close {
          background: none;
          border: none;
          color: var(--text-muted);
          font-size: 24px;
          cursor: pointer;
          padding: 0;
          width: 32px;
          height: 32px;
          border-radius: 8px;
          transition: all 0.2s;
        }
        
        .modal-close:hover {
          background: rgba(255, 255, 255, 0.1);
          color: var(--text-soft);
        }
        
        .saved-accounts-list {
          padding: 12px;
          max-height: 300px;
          overflow-y: auto;
        }
        
        .saved-account-item {
          display: flex;
          align-items: center;
          gap: 14px;
          padding: 14px 16px;
          border-radius: 12px;
          margin-bottom: 8px;
          cursor: pointer;
          transition: all 0.2s ease;
          background: rgba(255, 255, 255, 0.03);
          border: 1px solid transparent;
        }
        
        .saved-account-item:hover:not(.current) {
          background: rgba(102, 192, 244, 0.1);
          border-color: rgba(102, 192, 244, 0.3);
        }
        
        .saved-account-item.current {
          background: rgba(0, 255, 136, 0.08);
          border-color: rgba(0, 255, 136, 0.3);
          cursor: default;
        }
        
        .account-avatar {
          width: 48px;
          height: 48px;
          border-radius: 12px;
          background: linear-gradient(135deg, #1b2838, #2a475e);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 20px;
          font-weight: bold;
          color: #66c0f4;
          overflow: hidden;
        }
        
        .account-avatar img {
          width: 100%;
          height: 100%;
          object-fit: cover;
        }
        
        .account-info {
          flex: 1;
          min-width: 0;
        }
        
        .account-name {
          font-size: 15px;
          font-weight: 600;
          color: var(--text-soft);
          margin-bottom: 3px;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .account-email {
          font-size: 12px;
          color: var(--text-muted);
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }
        
        .current-badge {
          font-size: 11px;
          color: #00ff88;
          background: rgba(0, 255, 136, 0.15);
          padding: 4px 10px;
          border-radius: 20px;
          font-weight: 600;
        }
        
        .switch-arrow {
          font-size: 12px;
          color: #66c0f4;
          opacity: 0;
          transition: opacity 0.2s;
        }
        
        .saved-account-item:hover .switch-arrow {
          opacity: 1;
        }
        
        .modal-actions {
          padding: 16px 20px;
          border-top: 1px solid rgba(102, 192, 244, 0.15);
          display: flex;
          flex-direction: column;
          gap: 10px;
        }
        
        .add-account-btn, .logout-all-btn {
          width: 100%;
          padding: 14px 20px;
          border-radius: 10px;
          border: none;
          cursor: pointer;
          font-size: 14px;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          transition: all 0.2s ease;
        }
        
        .add-account-btn {
          background: linear-gradient(135deg, rgba(102, 192, 244, 0.2), rgba(102, 192, 244, 0.1));
          border: 1px solid rgba(102, 192, 244, 0.4);
          color: #66c0f4;
        }
        
        .add-account-btn:hover {
          background: linear-gradient(135deg, rgba(102, 192, 244, 0.3), rgba(102, 192, 244, 0.2));
        }
        
        .logout-all-btn {
          background: rgba(239, 68, 68, 0.1);
          border: 1px solid rgba(239, 68, 68, 0.3);
          color: #ef4444;
        }
        
        .logout-all-btn:hover {
          background: rgba(239, 68, 68, 0.2);
        }
      </style>
    `;
    
    document.body.appendChild(modal);
  }
  
  // åˆ‡æ¢åˆ°æŒ‡å®šè´¦æˆ· - æ˜¾ç¤ºå¯†ç è¾“å…¥å¼¹çª—
  window.switchToAccount = async function(accountId) {
    // è·å–ç›®æ ‡è´¦æˆ·ä¿¡æ¯
    const savedAccounts = JSON.parse(localStorage.getItem('gamebox_saved_accounts') || '[]');
    const targetAccount = savedAccounts.find(acc => acc.id === accountId);
    
    if (!targetAccount) {
      showMessage('è´¦æˆ·ä¿¡æ¯ä¸å­˜åœ¨', 'error');
      return;
    }
    
    // å…³é—­åˆ‡æ¢è´¦æˆ·å¼¹çª—
    const switchModal = document.getElementById('switchAccountModal');
    if (switchModal) switchModal.remove();
    
    // æ˜¾ç¤ºå¯†ç è¾“å…¥å¼¹çª—
    const modal = document.createElement('div');
    modal.id = 'switchPasswordModal';
    modal.innerHTML = `
      <div class="modal-overlay" onclick="document.getElementById('switchPasswordModal').remove()">
        <div class="switch-password-modal" onclick="event.stopPropagation()">
          <div class="modal-header">
            <h3>ğŸ”„ åˆ‡æ¢åˆ° ${targetAccount.username || targetAccount.email}</h3>
            <button class="modal-close" onclick="document.getElementById('switchPasswordModal').remove()">Ã—</button>
          </div>
          
          <div class="switch-password-content">
            <div class="target-account-info">
              <div class="target-avatar">${targetAccount.username?.charAt(0)?.toUpperCase() || '?'}</div>
              <div class="target-details">
                <div class="target-name">${targetAccount.username || 'ç”¨æˆ·'}</div>
                <div class="target-email">${targetAccount.email}</div>
              </div>
            </div>
            
            <form id="switchPasswordForm" onsubmit="handleSwitchAccount(event, '${accountId}', '${targetAccount.email}')">
              <div class="form-group">
                <label>è¯·è¾“å…¥å¯†ç ä»¥åˆ‡æ¢è´¦æˆ·</label>
                <input type="password" id="switchPassword" placeholder="è¾“å…¥å¯†ç " required autofocus />
              </div>
              
              <div id="switchError" class="error-message" style="display: none;"></div>
              
              <button type="submit" class="submit-btn" id="switchSubmitBtn">
                åˆ‡æ¢è´¦æˆ·
              </button>
            </form>
          </div>
        </div>
      </div>
      
      <style>
        .switch-password-modal {
          background: linear-gradient(145deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.95));
          border: 1px solid rgba(102, 192, 244, 0.3);
          border-radius: 20px;
          width: 90%;
          max-width: 380px;
          overflow: hidden;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
          animation: slideUp 0.3s ease;
        }
        
        .switch-password-content {
          padding: 24px;
        }
        
        .target-account-info {
          display: flex;
          align-items: center;
          gap: 14px;
          padding: 16px;
          background: rgba(102, 192, 244, 0.1);
          border-radius: 12px;
          margin-bottom: 20px;
        }
        
        .target-avatar {
          width: 50px;
          height: 50px;
          border-radius: 12px;
          background: linear-gradient(135deg, #66c0f4, #3d6a8e);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 22px;
          font-weight: bold;
          color: #fff;
        }
        
        .target-details {
          flex: 1;
        }
        
        .target-name {
          font-size: 16px;
          font-weight: 600;
          color: var(--text-soft);
          margin-bottom: 4px;
        }
        
        .target-email {
          font-size: 13px;
          color: var(--text-muted);
        }
        
        .switch-password-modal .form-group {
          margin-bottom: 16px;
        }
        
        .switch-password-modal .form-group label {
          display: block;
          font-size: 13px;
          color: var(--text-muted);
          margin-bottom: 8px;
        }
        
        .switch-password-modal .form-group input {
          width: 100%;
          padding: 14px 16px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(102, 192, 244, 0.2);
          border-radius: 10px;
          color: var(--text-soft);
          font-size: 15px;
          box-sizing: border-box;
        }
        
        .switch-password-modal .form-group input:focus {
          outline: none;
          border-color: #66c0f4;
        }
        
        .switch-password-modal .error-message {
          color: #ef4444;
          font-size: 13px;
          padding: 10px 12px;
          background: rgba(239, 68, 68, 0.1);
          border-radius: 8px;
          margin-bottom: 16px;
        }
        
        .switch-password-modal .submit-btn {
          width: 100%;
          padding: 14px;
          background: linear-gradient(135deg, #66c0f4, #3d6a8e);
          border: none;
          border-radius: 10px;
          color: #fff;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
        }
        
        .switch-password-modal .submit-btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(102, 192, 244, 0.4);
        }
        
        .switch-password-modal .submit-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
      </style>
    `;
    
    document.body.appendChild(modal);
    
    // èšç„¦å¯†ç è¾“å…¥æ¡†
    setTimeout(() => {
      document.getElementById('switchPassword')?.focus();
    }, 100);
  }
  
  // å¤„ç†è´¦æˆ·åˆ‡æ¢
  window.handleSwitchAccount = async function(event, accountId, email) {
    event.preventDefault();
    
    const password = document.getElementById('switchPassword').value;
    const submitBtn = document.getElementById('switchSubmitBtn');
    const errorEl = document.getElementById('switchError');
    
    if (!password) {
      errorEl.textContent = 'è¯·è¾“å…¥å¯†ç ';
      errorEl.style.display = 'block';
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.textContent = 'åˆ‡æ¢ä¸­...';
    errorEl.style.display = 'none';
    
    try {
      // å…ˆé€€å‡ºå½“å‰è´¦æˆ·
      await GameBoxAuth.signOut();
      
      // ç™»å½•ç›®æ ‡è´¦æˆ·
      const result = await GameBoxAuth.signIn(email, password);
      
      if (result.success) {
        // å…³é—­å¼¹çª—
        document.getElementById('switchPasswordModal')?.remove();
        
        // åˆ·æ–°é¡µé¢
        showMessage('è´¦æˆ·åˆ‡æ¢æˆåŠŸï¼', 'success');
        setTimeout(() => {
          window.location.reload();
        }, 500);
      } else {
        // ç™»å½•å¤±è´¥ï¼Œæ¢å¤åŸè´¦æˆ·çŠ¶æ€ï¼ˆé‡æ–°ç™»å½•å½“å‰ç”¨æˆ·ï¼‰
        errorEl.textContent = result.error || 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•';
        errorEl.style.display = 'block';
      }
    } catch (error) {
      console.error('åˆ‡æ¢è´¦æˆ·å¤±è´¥:', error);
      errorEl.textContent = 'åˆ‡æ¢å¤±è´¥: ' + error.message;
      errorEl.style.display = 'block';
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = 'åˆ‡æ¢è´¦æˆ·';
    }
  }
  
  // é€€å‡ºæ‰€æœ‰è´¦æˆ·
  window.logoutAllAccounts = async function() {
    if (confirm('ç¡®å®šè¦é€€å‡ºæ‰€æœ‰è´¦æˆ·å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰å·²ä¿å­˜çš„ç™»å½•ä¿¡æ¯ã€‚')) {
      try {
        // æ¸…é™¤ä¿å­˜çš„è´¦æˆ·
        localStorage.removeItem('gamebox_saved_accounts');
        // é€€å‡ºå½“å‰è´¦æˆ·
        await GameBoxAuth.signOut();
        // è·³è½¬åˆ°ç™»å½•é¡µ
        window.location.href = 'login.html';
      } catch (error) {
        console.error('é€€å‡ºå¤±è´¥:', error);
        showMessage('é€€å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    }
  }
  
  // æ˜¾ç¤ºæ·»åŠ è´¦æˆ·è¡¨å•
  window.showAddAccountForm = function() {
    // å…³é—­åˆ‡æ¢è´¦æˆ·å¼¹çª—
    const switchModal = document.getElementById('switchAccountModal');
    if (switchModal) switchModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'addAccountModal';
    modal.innerHTML = `
      <div class="modal-overlay" onclick="document.getElementById('addAccountModal').remove()">
        <div class="add-account-modal" onclick="event.stopPropagation()">
          <div class="modal-header">
            <h3>â• æ·»åŠ å…¶ä»–è´¦æˆ·</h3>
            <button class="modal-close" onclick="document.getElementById('addAccountModal').remove()">Ã—</button>
          </div>
          
          <div class="add-account-content">
            <p class="add-account-note">
              ç™»å½•å…¶ä»– GameBox è´¦æˆ·ï¼Œç™»å½•åå°†è‡ªåŠ¨ä¿å­˜åˆ°è´¦æˆ·åˆ—è¡¨ä¸­ï¼Œæ–¹ä¾¿å¿«é€Ÿåˆ‡æ¢ã€‚
            </p>
            
            <form id="addAccountForm" onsubmit="handleAddAccount(event)">
              <div class="form-group">
                <label>é‚®ç®±åœ°å€</label>
                <input type="email" id="addAccountEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" required />
              </div>
              
              <div class="form-group">
                <label>ç™»å½•å¯†ç </label>
                <input type="password" id="addAccountPassword" placeholder="è¯·è¾“å…¥å¯†ç " required />
              </div>
              
              <div id="addAccountError" class="error-message" style="display: none;"></div>
              
              <button type="submit" class="submit-btn" id="addAccountSubmitBtn">
                <span>ç™»å½•å¹¶æ·»åŠ </span>
              </button>
            </form>
            
            <div class="form-footer">
              <p>æ²¡æœ‰è´¦æˆ·ï¼Ÿ<a href="login.html?tab=register" target="_blank">ç«‹å³æ³¨å†Œ</a></p>
            </div>
          </div>
        </div>
      </div>
      
      <style>
        .add-account-modal {
          background: linear-gradient(145deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.95));
          border: 1px solid rgba(102, 192, 244, 0.3);
          border-radius: 20px;
          padding: 0;
          width: 90%;
          max-width: 400px;
          overflow: hidden;
          box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
          animation: slideUp 0.3s ease;
        }
        
        .add-account-content {
          padding: 24px;
        }
        
        .add-account-note {
          color: var(--text-muted);
          font-size: 13px;
          line-height: 1.6;
          margin-bottom: 20px;
          padding: 12px;
          background: rgba(102, 192, 244, 0.1);
          border-radius: 8px;
          border-left: 3px solid #66c0f4;
        }
        
        .form-group {
          margin-bottom: 16px;
        }
        
        .form-group label {
          display: block;
          font-size: 13px;
          color: var(--text-soft);
          margin-bottom: 8px;
          font-weight: 500;
        }
        
        .form-group input {
          width: 100%;
          padding: 14px 16px;
          background: rgba(0, 0, 0, 0.3);
          border: 1px solid rgba(102, 192, 244, 0.2);
          border-radius: 10px;
          color: var(--text-soft);
          font-size: 14px;
          transition: all 0.2s;
          box-sizing: border-box;
        }
        
        .form-group input:focus {
          outline: none;
          border-color: #66c0f4;
          background: rgba(0, 0, 0, 0.4);
        }
        
        .error-message {
          color: #ef4444;
          font-size: 13px;
          padding: 10px 12px;
          background: rgba(239, 68, 68, 0.1);
          border-radius: 8px;
          margin-bottom: 16px;
        }
        
        .submit-btn {
          width: 100%;
          padding: 14px 24px;
          background: linear-gradient(135deg, #66c0f4, #3d6a8e);
          border: none;
          border-radius: 10px;
          color: #fff;
          font-size: 15px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
        }
        
        .submit-btn:hover:not(:disabled) {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(102, 192, 244, 0.4);
        }
        
        .submit-btn:disabled {
          opacity: 0.6;
          cursor: not-allowed;
        }
        
        .form-footer {
          text-align: center;
          margin-top: 16px;
          padding-top: 16px;
          border-top: 1px solid rgba(102, 192, 244, 0.15);
        }
        
        .form-footer p {
          color: var(--text-muted);
          font-size: 13px;
        }
        
        .form-footer a {
          color: #66c0f4;
          text-decoration: none;
        }
        
        .form-footer a:hover {
          text-decoration: underline;
        }
      </style>
    `;
    
    document.body.appendChild(modal);
    
    // èšç„¦åˆ°é‚®ç®±è¾“å…¥æ¡†
    setTimeout(() => {
      document.getElementById('addAccountEmail')?.focus();
    }, 100);
  }
  
  // å¤„ç†æ·»åŠ è´¦æˆ·è¡¨å•æäº¤
  window.handleAddAccount = async function(event) {
    event.preventDefault();
    
    const email = document.getElementById('addAccountEmail').value.trim();
    const password = document.getElementById('addAccountPassword').value;
    const submitBtn = document.getElementById('addAccountSubmitBtn');
    const errorEl = document.getElementById('addAccountError');
    
    if (!email || !password) {
      errorEl.textContent = 'è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ';
      errorEl.style.display = 'block';
      return;
    }
    
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span>ç™»å½•ä¸­...</span>';
    errorEl.style.display = 'none';
    
    try {
      // å°è¯•ç™»å½•æ–°è´¦æˆ·
      const result = await GameBoxAuth.signIn(email, password);
      
      if (result.success) {
        // ç™»å½•æˆåŠŸï¼Œå°†æ–°è´¦æˆ·æ·»åŠ åˆ°ä¿å­˜åˆ—è¡¨
        let savedAccounts = [];
        try {
          savedAccounts = JSON.parse(localStorage.getItem('gamebox_saved_accounts') || '[]');
        } catch (e) {
          savedAccounts = [];
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
        const existingIndex = savedAccounts.findIndex(acc => acc.email === email);
        const newAccount = {
          id: result.user.id,
          email: result.user.email,
          username: result.user.username || email.split('@')[0],
          avatar: ''
        };
        
        if (existingIndex >= 0) {
          savedAccounts[existingIndex] = newAccount;
        } else {
          savedAccounts.push(newAccount);
        }
        
        localStorage.setItem('gamebox_saved_accounts', JSON.stringify(savedAccounts));
        
        // å…³é—­å¼¹çª—
        document.getElementById('addAccountModal')?.remove();
        
        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        showMessage('è´¦æˆ·æ·»åŠ æˆåŠŸï¼å·²åˆ‡æ¢åˆ°æ–°è´¦æˆ·', 'success');
        
        // åˆ·æ–°é¡µé¢ä»¥æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      } else {
        errorEl.textContent = result.error || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥é‚®ç®±å’Œå¯†ç ';
        errorEl.style.display = 'block';
      }
    } catch (error) {
      console.error('æ·»åŠ è´¦æˆ·å¤±è´¥:', error);
      errorEl.textContent = 'ç™»å½•å¤±è´¥: ' + error.message;
      errorEl.style.display = 'block';
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span>ç™»å½•å¹¶æ·»åŠ </span>';
    }
  }
  
  // ç™»å‡º
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
      await GameBoxAuth.signOut();
      window.location.href = 'login.html';
    }
  });
  
  // =============================================
  // å·¥å…·å‡½æ•°
  // =============================================
  
  function showMessage(text, type = 'info') {
    profileMessage.textContent = text;
    profileMessage.className = 'profile-message show ' + type;
    
    setTimeout(() => {
      profileMessage.classList.remove('show');
    }, 5000);
  }
  
  async function updateHeaderUser() {
    const headerBtn = document.getElementById('headerUserBtn');
    if (currentUser) {
      headerBtn.textContent = currentUser.username;
      headerBtn.style.color = 'var(--accent)';
    }
  }
  
  // =============================================
  // å¯åŠ¨
  // =============================================
  
  init();
</script>
</body>
</html>
