<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - ç¼–è¾‘èµ„æ–™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    /* ç¼–è¾‘èµ„æ–™é¡µé¢ä¸“å±æ ·å¼ */
    .edit-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .edit-card {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      position: relative;
      overflow: hidden;
    }
    
    .edit-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00ff88, #00ccff, #a855f7, #ff00ff);
    }
    
    .edit-header {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 32px;
      padding-bottom: 20px;
      border-bottom: 1px solid rgba(56, 189, 248, 0.2);
    }
    
    .edit-header-icon {
      font-size: 32px;
    }
    
    .edit-header-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      font-family: 'Orbitron', sans-serif;
    }
    
    .edit-header-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* ç”¨æˆ·IDæ˜¾ç¤º */
    .user-id-section {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 32px;
    }
    
    .user-id-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    
    .user-id-value {
      font-family: 'Orbitron', monospace;
      font-size: 14px;
      color: var(--accent);
      padding: 12px 16px;
      background: rgba(56, 189, 248, 0.1);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .copy-btn {
      background: transparent;
      border: none;
      color: var(--accent);
      cursor: pointer;
      padding: 4px 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    
    .copy-btn:hover {
      color: #00ff88;
    }
    
    /* å¤´åƒé€‰æ‹© */
    .avatar-section {
      margin-bottom: 32px;
    }
    
    .section-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-soft);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .current-avatar {
      display: flex;
      align-items: center;
      gap: 24px;
      margin-bottom: 20px;
    }
    
    .avatar-preview {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(135deg, #4fc3f7, #7c4dff);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 56px;
      box-shadow: 0 0 40px rgba(56, 189, 248, 0.5);
      position: relative;
      overflow: hidden;
    }
    
    .avatar-preview img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .avatar-preview-label {
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .avatar-options {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .avatar-option {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      background: rgba(17, 24, 39, 0.8);
      border: 2px solid rgba(56, 189, 248, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .avatar-option:hover {
      border-color: var(--accent);
      transform: scale(1.1);
    }
    
    .avatar-option.selected {
      border-color: #00ff88;
      box-shadow: 0 0 20px rgba(0, 255, 136, 0.4);
    }
    
    /* è‡ªå®šä¹‰å¤´åƒä¸Šä¼  */
    .avatar-upload {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 12px;
      margin-top: 16px;
    }
    
    .upload-btn {
      padding: 12px 20px;
      background: rgba(56, 189, 248, 0.2);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      color: var(--accent);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .upload-btn:hover {
      background: rgba(56, 189, 248, 0.3);
      border-color: var(--accent);
    }
    
    .upload-hint {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* è¡¨å•æ ·å¼ */
    .form-section {
      margin-bottom: 28px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-soft);
      margin-bottom: 10px;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 15px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
    }
    
    .form-input::placeholder {
      color: var(--text-muted);
    }
    
    .form-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }
    
    .char-count {
      text-align: right;
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* æŒ‰é’®æ ·å¼ */
    .btn-group {
      display: flex;
      gap: 16px;
      margin-top: 32px;
    }
    
    .save-btn {
      flex: 1;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--accent), #00ff88);
      border: none;
      border-radius: 8px;
      color: #0a0f1a;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.4);
    }
    
    .save-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .cancel-btn {
      padding: 16px 32px;
      background: transparent;
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      color: var(--text-soft);
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .cancel-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    /* æ¶ˆæ¯æç¤º */
    .edit-message {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
    }
    
    .edit-message.show {
      display: block;
    }
    
    .edit-message.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .edit-message.success {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    /* æœªç™»å½•æç¤º */
    .login-required {
      text-align: center;
      padding: 60px 20px;
    }
    
    .login-required-icon {
      font-size: 64px;
      margin-bottom: 24px;
    }
    
    .login-required-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 12px;
    }
    
    .login-required-text {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }
    
    .login-btn {
      display: inline-block;
      padding: 14px 32px;
      background: linear-gradient(135deg, var(--accent), #00ff88);
      border-radius: 8px;
      color: #0a0f1a;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.4);
    }
    
    /* é¢œè‰²é€‰æ‹©å™¨ */
    .color-options {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    
    .color-option {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .color-option:hover {
      transform: scale(1.1);
    }
    
    .color-option.selected {
      border-color: #fff;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
    }
    
    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .edit-card {
        padding: 24px 16px;
      }
      
      .current-avatar {
        flex-direction: column;
        text-align: center;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .cancel-btn {
        order: 1;
      }
    }
  </style>
</head>
<body data-current-page="profile" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="profile.html" data-page="profile" class="nav-link active">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user" id="headerUserBtn">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>

  <main class="main" style="display: block;">
    
    <!-- æœªç™»å½•æç¤º -->
    <div id="loginRequired" class="edit-container" style="display: none;">
      <div class="edit-card login-required">
        <div class="login-required-icon">ğŸ”</div>
        <div class="login-required-title">è¯·å…ˆç™»å½•</div>
        <div class="login-required-text">ç™»å½•åå³å¯ç¼–è¾‘æ‚¨çš„ä¸ªäººèµ„æ–™</div>
        <a href="login.html" class="login-btn">å‰å¾€ç™»å½•</a>
      </div>
    </div>
    
    <!-- ç¼–è¾‘è¡¨å• -->
    <div id="editContainer" class="edit-container" style="display: none;">
      <div class="edit-card">
        <div class="edit-header">
          <span class="edit-header-icon">âœï¸</span>
          <div>
            <div class="edit-header-title">ç¼–è¾‘ä¸ªäººèµ„æ–™</div>
            <div class="edit-header-subtitle">è‡ªå®šä¹‰æ‚¨çš„å¤´åƒå’Œæ˜µç§°ï¼Œå±•ç¤ºç‹¬ç‰¹çš„æ¸¸æˆç©å®¶èº«ä»½</div>
          </div>
        </div>
        
        <!-- æ¶ˆæ¯æç¤º -->
        <div id="editMessage" class="edit-message"></div>
        
        <!-- ç”¨æˆ·å”¯ä¸€ID -->
        <div class="user-id-section">
          <div class="user-id-label">æ‚¨çš„å”¯ä¸€ç”¨æˆ·ID (ä¸å¯æ›´æ”¹)</div>
          <div class="user-id-value">
            <span id="userIdDisplay">-</span>
            <button class="copy-btn" onclick="copyUserId()" title="å¤åˆ¶ID">ğŸ“‹</button>
          </div>
        </div>
        
        <!-- å¤´åƒé€‰æ‹© -->
        <div class="avatar-section">
          <div class="section-title">
            <span>ğŸ‘¤</span> é€‰æ‹©å¤´åƒ
          </div>
          
          <div class="current-avatar">
            <div class="avatar-preview" id="avatarPreview">ğŸ®</div>
            <div>
              <div class="avatar-preview-label">å½“å‰å¤´åƒé¢„è§ˆ</div>
              <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                ç‚¹å‡»ä¸‹æ–¹è¡¨æƒ…é€‰æ‹©ï¼Œæˆ–ä¸Šä¼ è‡ªå®šä¹‰å›¾ç‰‡
              </div>
            </div>
          </div>
          
          <!-- è¡¨æƒ…å¤´åƒé€‰é¡¹ -->
          <div class="section-title" style="font-size: 13px; margin-bottom: 12px;">
            <span>ğŸ˜Š</span> è¡¨æƒ…å¤´åƒ
          </div>
          <div class="avatar-options" id="emojiAvatars">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
          
          <!-- æ¸¸æˆä¸»é¢˜å¤´åƒ -->
          <div class="section-title" style="font-size: 13px; margin-bottom: 12px; margin-top: 20px;">
            <span>ğŸ®</span> æ¸¸æˆä¸»é¢˜
          </div>
          <div class="avatar-options" id="gameAvatars">
            <!-- åŠ¨æ€ç”Ÿæˆ -->
          </div>
          
          <!-- è‡ªå®šä¹‰ä¸Šä¼  -->
          <div class="avatar-upload">
            <input type="file" id="avatarFile" accept="image/*" style="display: none;" />
            <button class="upload-btn" onclick="document.getElementById('avatarFile').click()">
              ğŸ“¤ ä¸Šä¼ å›¾ç‰‡
            </button>
            <div class="upload-hint">
              æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 2MB<br>
              å»ºè®®ä½¿ç”¨æ­£æ–¹å½¢å›¾ç‰‡ä»¥è·å¾—æœ€ä½³æ•ˆæœ
            </div>
          </div>
        </div>
        
        <!-- æ˜µç§°ç¼–è¾‘ -->
        <div class="form-section">
          <label class="form-label">æ˜µç§° / ç”¨æˆ·å</label>
          <input type="text" class="form-input" id="nicknameInput" 
            placeholder="è¾“å…¥æ‚¨æƒ³è¦çš„æ˜µç§°" maxlength="20" />
          <div class="char-count">
            <span id="nicknameCount">0</span>/20
          </div>
          <div class="form-hint">
            2-20ä¸ªå­—ç¬¦ï¼Œæ”¯æŒä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—å’Œéƒ¨åˆ†ç‰¹æ®Šå­—ç¬¦
          </div>
        </div>
        
        <!-- ä¸ªæ€§ç­¾å (å¯é€‰) -->
        <div class="form-section">
          <label class="form-label">ä¸ªæ€§ç­¾å (å¯é€‰)</label>
          <input type="text" class="form-input" id="bioInput" 
            placeholder="å†™ä¸€å¥è¯ä»‹ç»è‡ªå·±..." maxlength="50" />
          <div class="char-count">
            <span id="bioCount">0</span>/50
          </div>
        </div>
        
        <!-- æŒ‰é’®ç»„ -->
        <div class="btn-group">
          <button class="save-btn" id="saveBtn">ğŸ’¾ ä¿å­˜ä¿®æ”¹</button>
          <button class="cancel-btn" onclick="window.location.href='profile.html'">å–æ¶ˆ</button>
        </div>
      </div>
      
      <!-- æç¤ºä¿¡æ¯ -->
      <div class="edit-card" style="padding: 20px;">
        <div class="section-title" style="color: #00ff88; margin-bottom: 12px;">
          <span>ğŸ’¡</span> æç¤º
        </div>
        <ul style="font-size: 13px; color: var(--text-soft); line-height: 2; margin: 0; padding-left: 20px;">
          <li>æ‚¨çš„ç”¨æˆ·IDæ˜¯ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆçš„å”¯ä¸€æ ‡è¯†ï¼Œæ— æ³•æ›´æ”¹</li>
          <li>æ˜µç§°å’Œå¤´åƒå¯ä»¥éšæ—¶ä¿®æ”¹</li>
          <li>å¦‚æœç»‘å®šäº†Steamè´¦å·ï¼Œå¯ä»¥é€‰æ‹©ä½¿ç”¨Steamå¤´åƒ</li>
          <li>ä¸Šä¼ çš„è‡ªå®šä¹‰å¤´åƒä¼šä¿å­˜åœ¨æµè§ˆå™¨æœ¬åœ°</li>
          <li>é…ç½®Supabaseåï¼Œèµ„æ–™å°†è‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯</li>
        </ul>
      </div>
    </div>
  </main>
  
  <footer class="footer">
    GameBox æ¸¸ç›’ Â· ç¼–è¾‘èµ„æ–™ Â· Powered by Supabase
  </footer>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="supabase-config.js"></script>
<script>
  // =============================================
  // é¡µé¢åˆå§‹åŒ–
  // =============================================
  
  initCommon();
  
  // è¡¨æƒ…å¤´åƒåˆ—è¡¨
  const emojiAvatars = [
    'ğŸ˜€', 'ğŸ˜', 'ğŸ¤“', 'ğŸ¥³', 'ğŸ˜ˆ', 'ğŸ‘»', 'ğŸ¤–', 'ğŸ‘½',
    'ğŸ¦Š', 'ğŸ±', 'ğŸ¶', 'ğŸ¼', 'ğŸ¦', 'ğŸ¯', 'ğŸ¸', 'ğŸµ',
    'ğŸ¦„', 'ğŸ²', 'ğŸ¦…', 'ğŸ¦ˆ', 'ğŸ™', 'ğŸ¦‹', 'ğŸ¢', 'ğŸ¦'
  ];
  
  // æ¸¸æˆä¸»é¢˜å¤´åƒ
  const gameAvatars = [
    'ğŸ®', 'ğŸ²', 'ğŸ¯', 'ğŸ†', 'âš”ï¸', 'ğŸ›¡ï¸', 'ğŸ—¡ï¸', 'ğŸ”®',
    'ğŸ’', 'ğŸ”¥', 'âš¡', 'ğŸ’€', 'ğŸ‘¾', 'ğŸš€', 'ğŸŒŸ', 'âœ¨',
    'ğŸª', 'ğŸ¨', 'ğŸ­', 'ğŸ¢', 'ğŸ¡', 'ğŸ ', 'ğŸƒ', 'ğŸ€„'
  ];
  
  let currentUser = null;
  let userData = null;
  let selectedAvatar = 'ğŸ®';
  let selectedAvatarType = 'emoji'; // 'emoji', 'custom', 'steam'
  let customAvatarUrl = null;
  
  // =============================================
  // åˆå§‹åŒ–
  // =============================================
  
  async function init() {
    await GameBoxAuth.init();
    
    currentUser = await GameBoxAuth.getCurrentUser();
    
    if (currentUser) {
      document.getElementById('loginRequired').style.display = 'none';
      document.getElementById('editContainer').style.display = 'block';
      
      userData = UserDataManager.getData(currentUser.id);
      
      loadCurrentProfile();
      renderAvatarOptions();
      updateHeaderUser();
    } else {
      document.getElementById('loginRequired').style.display = 'block';
      document.getElementById('editContainer').style.display = 'none';
    }
  }
  
  // =============================================
  // åŠ è½½å½“å‰èµ„æ–™
  // =============================================
  
  function loadCurrentProfile() {
    // ç”¨æˆ·ID
    document.getElementById('userIdDisplay').textContent = currentUser.id;
    
    // æ˜µç§°
    const nicknameInput = document.getElementById('nicknameInput');
    nicknameInput.value = currentUser.username || '';
    updateCharCount('nicknameInput', 'nicknameCount');
    
    // ä¸ªæ€§ç­¾å
    const bioInput = document.getElementById('bioInput');
    bioInput.value = userData.bio || '';
    updateCharCount('bioInput', 'bioCount');
    
    // å¤´åƒ
    if (userData.customAvatar) {
      selectedAvatarType = 'custom';
      customAvatarUrl = userData.customAvatar;
      updateAvatarPreview(customAvatarUrl, 'custom');
    } else if (userData.steam?.linked && userData.steam?.avatar) {
      selectedAvatarType = 'steam';
      updateAvatarPreview(userData.steam.avatar, 'steam');
    } else {
      selectedAvatar = currentUser.avatar || 'ğŸ®';
      selectedAvatarType = 'emoji';
      updateAvatarPreview(selectedAvatar, 'emoji');
    }
  }
  
  // =============================================
  // æ¸²æŸ“å¤´åƒé€‰é¡¹
  // =============================================
  
  function renderAvatarOptions() {
    // è¡¨æƒ…å¤´åƒ
    const emojiContainer = document.getElementById('emojiAvatars');
    emojiContainer.innerHTML = emojiAvatars.map(emoji => `
      <div class="avatar-option ${selectedAvatarType === 'emoji' && selectedAvatar === emoji ? 'selected' : ''}"
           onclick="selectEmoji('${emoji}')"
           title="${emoji}">
        ${emoji}
      </div>
    `).join('');
    
    // æ¸¸æˆä¸»é¢˜å¤´åƒ
    const gameContainer = document.getElementById('gameAvatars');
    gameContainer.innerHTML = gameAvatars.map(emoji => `
      <div class="avatar-option ${selectedAvatarType === 'emoji' && selectedAvatar === emoji ? 'selected' : ''}"
           onclick="selectEmoji('${emoji}')"
           title="${emoji}">
        ${emoji}
      </div>
    `).join('');
    
    // å¦‚æœæœ‰Steamå¤´åƒï¼Œæ·»åŠ Steamé€‰é¡¹
    if (userData.steam?.linked && userData.steam?.avatar) {
      const steamOption = document.createElement('div');
      steamOption.className = `avatar-option ${selectedAvatarType === 'steam' ? 'selected' : ''}`;
      steamOption.style.cssText = 'width: 60px; height: 60px; padding: 0; overflow: hidden;';
      steamOption.innerHTML = `<img src="${userData.steam.avatar}" alt="Steam" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">`;
      steamOption.onclick = () => selectSteamAvatar();
      steamOption.title = 'Steam å¤´åƒ';
      
      gameContainer.insertBefore(steamOption, gameContainer.firstChild);
    }
  }
  
  // =============================================
  // å¤´åƒé€‰æ‹©
  // =============================================
  
  function selectEmoji(emoji) {
    selectedAvatar = emoji;
    selectedAvatarType = 'emoji';
    customAvatarUrl = null;
    updateAvatarPreview(emoji, 'emoji');
    renderAvatarOptions();
  }
  
  function selectSteamAvatar() {
    if (userData.steam?.avatar) {
      selectedAvatarType = 'steam';
      customAvatarUrl = null;
      updateAvatarPreview(userData.steam.avatar, 'steam');
      renderAvatarOptions();
    }
  }
  
  function updateAvatarPreview(value, type) {
    const preview = document.getElementById('avatarPreview');
    
    if (type === 'emoji') {
      preview.innerHTML = value;
      preview.style.background = 'linear-gradient(135deg, #4fc3f7, #7c4dff)';
    } else {
      preview.innerHTML = `<img src="${value}" alt="Avatar" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
      preview.style.background = 'transparent';
    }
  }
  
  // æ–‡ä»¶ä¸Šä¼ å¤„ç†
  document.getElementById('avatarFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // éªŒè¯æ–‡ä»¶ç±»å‹
    if (!file.type.startsWith('image/')) {
      showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
      return;
    }
    
    // éªŒè¯æ–‡ä»¶å¤§å° (æœ€å¤§ 2MB)
    if (file.size > 2 * 1024 * 1024) {
      showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡ 2MB', 'error');
      return;
    }
    
    // è¯»å–æ–‡ä»¶å¹¶è½¬ä¸º Base64
    const reader = new FileReader();
    reader.onload = function(event) {
      customAvatarUrl = event.target.result;
      selectedAvatarType = 'custom';
      updateAvatarPreview(customAvatarUrl, 'custom');
      renderAvatarOptions();
      showMessage('å¤´åƒå·²é€‰æ‹©ï¼Œç‚¹å‡»ä¿å­˜ç”Ÿæ•ˆ', 'success');
    };
    reader.readAsDataURL(file);
  });
  
  // =============================================
  // å­—ç¬¦è®¡æ•°
  // =============================================
  
  function updateCharCount(inputId, countId) {
    const input = document.getElementById(inputId);
    const count = document.getElementById(countId);
    count.textContent = input.value.length;
  }
  
  document.getElementById('nicknameInput').addEventListener('input', function() {
    updateCharCount('nicknameInput', 'nicknameCount');
  });
  
  document.getElementById('bioInput').addEventListener('input', function() {
    updateCharCount('bioInput', 'bioCount');
  });
  
  // =============================================
  // ä¿å­˜èµ„æ–™
  // =============================================
  
  document.getElementById('saveBtn').addEventListener('click', async function() {
    const btn = this;
    const nickname = document.getElementById('nicknameInput').value.trim();
    const bio = document.getElementById('bioInput').value.trim();
    
    // éªŒè¯æ˜µç§°
    if (!nickname) {
      showMessage('è¯·è¾“å…¥æ˜µç§°', 'error');
      return;
    }
    
    if (nickname.length < 2) {
      showMessage('æ˜µç§°è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦', 'error');
      return;
    }
    
    btn.disabled = true;
    btn.textContent = 'ä¿å­˜ä¸­...';
    
    try {
      // å‡†å¤‡æ›´æ–°æ•°æ®
      const updates = {
        username: nickname
      };
      
      // æ ¹æ®å¤´åƒç±»å‹è®¾ç½®
      if (selectedAvatarType === 'emoji') {
        updates.avatar = selectedAvatar;
      } else if (selectedAvatarType === 'steam' && userData.steam?.avatar) {
        updates.avatar = 'ğŸ®'; // ä¿ç•™è¡¨æƒ…ä½œä¸ºå¤‡ç”¨
      }
      
      // æ›´æ–°è®¤è¯ç”¨æˆ·èµ„æ–™
      const result = await GameBoxAuth.updateProfile(updates);
      
      if (result.success) {
        // æ›´æ–°æœ¬åœ°ç”¨æˆ·æ•°æ®
        UserDataManager.saveData(currentUser.id, {
          bio: bio,
          customAvatar: selectedAvatarType === 'custom' ? customAvatarUrl : null,
          usesteamAvatar: selectedAvatarType === 'steam'
        });
        
        showMessage('èµ„æ–™ä¿å­˜æˆåŠŸï¼', 'success');
        
        // 2ç§’åè·³è½¬å›ç”¨æˆ·ä¸­å¿ƒ
        setTimeout(() => {
          window.location.href = 'profile.html';
        }, 1500);
      } else {
        showMessage(result.error || 'ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    } catch (error) {
      showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ’¾ ä¿å­˜ä¿®æ”¹';
    }
  });
  
  // =============================================
  // å·¥å…·å‡½æ•°
  // =============================================
  
  function showMessage(text, type) {
    const msg = document.getElementById('editMessage');
    msg.textContent = text;
    msg.className = 'edit-message show ' + type;
    
    if (type === 'success') {
      setTimeout(() => {
        msg.classList.remove('show');
      }, 3000);
    }
  }
  
  function copyUserId() {
    const userId = document.getElementById('userIdDisplay').textContent;
    navigator.clipboard.writeText(userId).then(() => {
      showMessage('ç”¨æˆ·IDå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(() => {
      showMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
    });
  }
  
  async function updateHeaderUser() {
    const headerBtn = document.getElementById('headerUserBtn');
    if (currentUser) {
      headerBtn.textContent = currentUser.username;
      headerBtn.style.color = 'var(--accent)';
    }
  }
  
  // =============================================
  // å¯åŠ¨
  // =============================================
  
  init();
</script>
</body>
</html>
