<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - ç™»å½•/æ³¨å†Œ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
  
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- EmailJS SDK (ç”¨äºå‘é€çœŸå®éªŒè¯ç é‚®ä»¶) -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  
  <style>
    /* ç™»å½•é¡µé¢ä¸“å±æ ·å¼ */
    .auth-container {
      max-width: 480px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .auth-card {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 16px;
      padding: 40px;
      position: relative;
      overflow: hidden;
    }
    
    .auth-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #00ff88, #00ccff, #a855f7, #ff00ff);
    }
    
    .auth-header {
      text-align: center;
      margin-bottom: 32px;
    }
    
    .auth-logo {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .auth-title {
      font-size: 28px;
      font-weight: 900;
      font-family: 'Orbitron', sans-serif;
      color: var(--accent);
      margin-bottom: 8px;
      text-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
    }
    
    .auth-subtitle {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    /* Tab åˆ‡æ¢ */
    .auth-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 32px;
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid rgba(56, 189, 248, 0.3);
    }
    
    .auth-tab {
      flex: 1;
      padding: 14px 20px;
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Rajdhani', sans-serif;
    }
    
    .auth-tab:hover {
      background: rgba(56, 189, 248, 0.1);
      color: var(--text-soft);
    }
    
    .auth-tab.active {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(0, 255, 136, 0.1));
      color: var(--accent);
      text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
    }
    
    /* è¡¨å•æ ·å¼ */
    .auth-form {
      display: none;
    }
    
    .auth-form.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-soft);
      margin-bottom: 8px;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 16px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 15px;
      transition: all 0.3s ease;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 15px rgba(56, 189, 248, 0.3);
    }
    
    .form-input::placeholder {
      color: var(--text-muted);
    }
    
    .form-hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 6px;
    }
    
    /* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ */
    .password-strength {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }
    
    .strength-bar {
      flex: 1;
      height: 4px;
      background: rgba(56, 189, 248, 0.2);
      border-radius: 2px;
      transition: all 0.3s ease;
    }
    
    .strength-bar.weak { background: #ef4444; }
    .strength-bar.medium { background: #f59e0b; }
    .strength-bar.strong { background: #10b981; }
    .strength-bar.very-strong { background: #00ff88; }
    
    .strength-text {
      font-size: 11px;
      margin-top: 4px;
    }
    
    /* æŒ‰é’® */
    .auth-btn {
      width: 100%;
      padding: 16px 24px;
      background: linear-gradient(135deg, var(--accent), #00ff88);
      border: none;
      border-radius: 8px;
      color: #0a0f1a;
      font-size: 16px;
      font-weight: 700;
      font-family: 'Rajdhani', sans-serif;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 8px;
    }
    
    .auth-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(56, 189, 248, 0.4);
    }
    
    .auth-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    
    .auth-btn.loading {
      position: relative;
      color: transparent;
    }
    
    .auth-btn.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin: -10px 0 0 -10px;
      border: 2px solid transparent;
      border-top-color: #0a0f1a;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* æ¶ˆæ¯æç¤º */
    .auth-message {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 13px;
      margin-bottom: 20px;
      display: none;
    }
    
    .auth-message.show {
      display: block;
    }
    
    .auth-message.error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .auth-message.success {
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .auth-message.info {
      background: rgba(56, 189, 248, 0.15);
      border: 1px solid rgba(56, 189, 248, 0.3);
      color: var(--accent);
    }
    
    /* åˆ†éš”çº¿ */
    .auth-divider {
      display: flex;
      align-items: center;
      margin: 24px 0;
      gap: 16px;
    }
    
    .auth-divider::before,
    .auth-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(56, 189, 248, 0.3), transparent);
    }
    
    .auth-divider span {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* ç¤¾äº¤ç™»å½•æŒ‰é’® */
    .social-login {
      display: flex;
      gap: 12px;
    }
    
    .social-btn {
      flex: 1;
      padding: 12px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      color: var(--text-soft);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .social-btn:hover {
      border-color: var(--accent);
      background: rgba(56, 189, 248, 0.1);
    }
    
    /* é¢å¤–é“¾æ¥ */
    .auth-links {
      text-align: center;
      margin-top: 24px;
      font-size: 13px;
      color: var(--text-muted);
    }
    
    .auth-links a {
      color: var(--accent);
      text-decoration: none;
      transition: all 0.3s ease;
    }
    
    .auth-links a:hover {
      text-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
    }
    
    /* ç”¨æˆ·åè®®å¤é€‰æ¡† */
    .form-checkbox {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .form-checkbox input {
      margin-top: 3px;
      accent-color: var(--accent);
    }
    
    .form-checkbox label {
      font-size: 12px;
      color: var(--text-muted);
      line-height: 1.5;
    }
    
    .form-checkbox a {
      color: var(--accent);
      text-decoration: none;
    }
    
    /* å·²ç™»å½•çŠ¶æ€ */
    .logged-in-card {
      text-align: center;
      padding: 40px;
    }
    
    .user-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent), #00ff88);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      margin: 0 auto 20px;
      box-shadow: 0 0 30px rgba(56, 189, 248, 0.4);
    }
    
    .user-name {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-main);
      margin-bottom: 8px;
    }
    
    .user-email {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 24px;
    }
    
    .logout-btn {
      padding: 12px 32px;
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      color: #ef4444;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .logout-btn:hover {
      background: rgba(239, 68, 68, 0.3);
      border-color: #ef4444;
    }
    
    /* ä¾§è¾¹æ ä¿¡æ¯ */
    .auth-info-card {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.9), rgba(31, 41, 55, 0.8));
      border: 1px solid rgba(56, 189, 248, 0.2);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .auth-info-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .auth-info-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .auth-info-list li {
      padding: 8px 0;
      font-size: 13px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 10px;
      border-bottom: 1px solid rgba(56, 189, 248, 0.1);
    }
    
    .auth-info-list li:last-child {
      border-bottom: none;
    }
    
    .auth-info-list .icon {
      color: #00ff88;
    }
    
    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .auth-card {
        padding: 24px;
      }
      
      .auth-title {
        font-size: 22px;
      }
      
      .social-login {
        flex-direction: column;
      }
    }
  </style>
</head>
<body data-current-page="profile" class="cyberpunk-theme">
<div class="page">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>

      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user" id="headerUserBtn">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>

  <!-- ä¸»ä½“ -->
  <main class="main" style="display: block; max-width: 1200px; margin: 0 auto; padding: 40px 20px;">
    <div style="display: grid; grid-template-columns: 1fr 320px; gap: 30px; align-items: start;">
      
      <!-- å·¦ä¾§ï¼šç™»å½•/æ³¨å†Œå¡ç‰‡ -->
      <div class="auth-container" style="max-width: none; padding: 0;">
        
        <!-- æœªç™»å½•çŠ¶æ€ï¼šæ˜¾ç¤ºç™»å½•/æ³¨å†Œè¡¨å• -->
        <div id="authFormContainer" class="auth-card">
          <div class="auth-header">
            <div class="auth-logo">ğŸ®</div>
            <div class="auth-title">GAMEBOX</div>
            <div class="auth-subtitle">å¼€å¯ä½ çš„æ¸¸æˆä¸–ç•Œ</div>
          </div>
          
          <!-- æ¶ˆæ¯æç¤º -->
          <div id="authMessage" class="auth-message"></div>
          
          <!-- Tab åˆ‡æ¢ -->
          <div class="auth-tabs">
            <button class="auth-tab active" data-tab="login">ç™»å½•</button>
            <button class="auth-tab" data-tab="register">æ³¨å†Œ</button>
          </div>
          
          <!-- ç™»å½•è¡¨å• -->
          <form id="loginForm" class="auth-form active">
            <div class="form-group">
              <label class="form-label">é‚®ç®±åœ°å€</label>
              <input type="email" class="form-input" id="loginEmail" placeholder="your@email.com" required />
            </div>
            
            <div class="form-group">
              <label class="form-label">å¯†ç </label>
              <input type="password" class="form-input" id="loginPassword" placeholder="è¾“å…¥å¯†ç " required />
            </div>
            
            <button type="submit" class="auth-btn" id="loginBtn">ç™» å½•</button>
          </form>
          
          <!-- æ³¨å†Œè¡¨å• -->
          <form id="registerForm" class="auth-form">
            <div class="form-group">
              <label class="form-label">é‚®ç®±åœ°å€</label>
              <div style="display: flex; gap: 8px;">
                <input type="email" class="form-input" id="registerEmail" placeholder="your@email.com" required style="flex: 1;" />
                <button type="button" class="auth-btn" id="sendOtpBtn" style="width: auto; padding: 14px 16px; font-size: 13px;">
                  å‘é€éªŒè¯ç 
                </button>
              </div>
              <div class="form-hint">ç”¨äºç™»å½•å’Œæ¥æ”¶éªŒè¯é‚®ä»¶</div>
            </div>
            
            <div class="form-group" id="otpGroup" style="display: none;">
              <label class="form-label">é‚®ç®±éªŒè¯ç </label>
              <input type="text" class="form-input" id="emailOtp" placeholder="è¾“å…¥6ä½éªŒè¯ç " maxlength="6" pattern="\d{6}" />
              <div class="form-hint" id="otpHint">éªŒè¯ç å·²å‘é€ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆ</div>
            </div>
            
            <div class="form-group">
              <label class="form-label">ç”¨æˆ·å (æ˜µç§°)</label>
              <input type="text" class="form-input" id="registerUsername" placeholder="ç»™è‡ªå·±èµ·ä¸ªåå­—" required minlength="2" maxlength="20" />
            </div>
            
            <div class="form-group">
              <label class="form-label">å¯†ç </label>
              <input type="password" class="form-input" id="registerPassword" placeholder="è‡³å°‘6ä½å­—ç¬¦" required minlength="6" autocomplete="new-password" />
              <div class="password-strength" id="passwordStrength">
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
                <div class="strength-bar"></div>
              </div>
              <div class="strength-text" id="strengthText"></div>
            </div>
            
            <div class="form-group">
              <label class="form-label">ç¡®è®¤å¯†ç </label>
              <input type="password" class="form-input" id="registerPasswordConfirm" placeholder="å†æ¬¡è¾“å…¥å¯†ç " required autocomplete="new-password" />
            </div>
            
            <div class="form-checkbox">
              <input type="checkbox" id="agreeTerms" required />
              <label for="agreeTerms">
                æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#">ã€Šç”¨æˆ·åè®®ã€‹</a> å’Œ <a href="#">ã€Šéšç§æ”¿ç­–ã€‹</a>
              </label>
            </div>
            
            <button type="submit" class="auth-btn" id="registerBtn">æ³¨ å†Œ</button>
          </form>
          
          <div class="auth-divider">
            <span>æˆ–è€…ä½¿ç”¨ä»¥ä¸‹æ–¹å¼</span>
          </div>
          
          <!-- ç¤¾äº¤ç™»å½• -->
          <div class="social-login">
            <button type="button" class="social-btn" id="googleLoginBtn">
              <span>ğŸ”µ</span> Google
            </button>
            <button type="button" class="social-btn" id="githubLoginBtn">
              <span>âš«</span> GitHub
            </button>
          </div>
          
          <div class="auth-links">
            <a href="#" id="forgotPasswordLink">å¿˜è®°å¯†ç ï¼Ÿ</a>
          </div>
        </div>
        
        <!-- å·²ç™»å½•çŠ¶æ€ -->
        <div id="loggedInContainer" class="auth-card logged-in-card" style="display: none;">
          <div class="user-avatar" id="userAvatar">ğŸ®</div>
          <div class="user-name" id="userName">ç”¨æˆ·å</div>
          <div class="user-email" id="userEmail">email@example.com</div>
          
          <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
            <a href="profile.html" class="auth-btn" style="flex: 1; max-width: 160px; text-align: center; text-decoration: none;">ä¸ªäººä¸­å¿ƒ</a>
            <button class="logout-btn" id="logoutBtn">é€€å‡ºç™»å½•</button>
          </div>
          
          <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(56, 189, 248, 0.2);">
            <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">
              ç™»å½•æ—¶é—´: <span id="loginTime">-</span>
            </div>
            <div style="font-size: 13px; color: var(--text-muted);">
              é‚®ç®±çŠ¶æ€: <span id="emailVerifyStatus">-</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- å³ä¾§ï¼šè¯´æ˜ä¿¡æ¯ -->
      <div>
        <div class="auth-info-card">
          <div class="auth-info-title">
            <span>âœ¨</span> æ³¨å†Œç¦åˆ©
          </div>
          <ul class="auth-info-list">
            <li><span class="icon">âœ“</span> æ°¸ä¹…å…è´¹ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½</li>
            <li><span class="icon">âœ“</span> ä¸ªæ€§åŒ–æ¸¸æˆæ¨è</li>
            <li><span class="icon">âœ“</span> æ¸¸æˆåº“æ”¶è—åŒæ­¥</li>
            <li><span class="icon">âœ“</span> ç¤¾åŒºäº’åŠ¨è¯„è®º</li>
            <li><span class="icon">âœ“</span> ä»·æ ¼è¿½è¸ªæé†’</li>
          </ul>
        </div>
        
        <div class="auth-info-card">
          <div class="auth-info-title">
            <span>ğŸ”’</span> å®‰å…¨ä¿éšœ
          </div>
          <ul class="auth-info-list">
            <li><span class="icon">âœ“</span> å¯†ç åŠ å¯†å­˜å‚¨</li>
            <li><span class="icon">âœ“</span> Supabase å®‰å…¨è®¤è¯</li>
            <li><span class="icon">âœ“</span> æ”¯æŒé‚®ç®±éªŒè¯</li>
            <li><span class="icon">âœ“</span> éšç§æ•°æ®ä¿æŠ¤</li>
          </ul>
        </div>
        
        <div class="auth-info-card" style="background: linear-gradient(135deg, rgba(0, 255, 136, 0.1), rgba(56, 189, 248, 0.1));">
          <div class="auth-info-title" style="color: #00ff88;">
            <span>ğŸ’¡</span> å¿«é€Ÿä½“éªŒ
          </div>
          <p style="font-size: 13px; color: var(--text-soft); line-height: 1.6; margin: 0;">
            ä¸æƒ³æ³¨å†Œï¼Ÿå¯ä»¥ä½¿ç”¨æµ‹è¯•è´¦å·ï¼š<br>
            <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">demo@gamebox.test</code><br>
            å¯†ç ï¼š<code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">demo123456</code>
          </p>
        </div>
      </div>
    </div>
  </main>

  <footer class="footer">
    GameBox æ¸¸ç›’ Â· å®‰å…¨ç™»å½•ç³»ç»Ÿ Â· Powered by Supabase
  </footer>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<!-- GameBox è®¤è¯ç³»ç»Ÿ -->
<script src="supabase-config.js"></script>
<script>
  // =============================================
  // é¡µé¢åˆå§‹åŒ–
  // =============================================
  
  initCommon();
  
  // DOM å…ƒç´ 
  const authFormContainer = document.getElementById('authFormContainer');
  const loggedInContainer = document.getElementById('loggedInContainer');
  const authMessage = document.getElementById('authMessage');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const tabs = document.querySelectorAll('.auth-tab');
  const authModeIndicator = document.createElement('div');
  
  // æ·»åŠ è®¤è¯æ¨¡å¼æŒ‡ç¤ºå™¨
  authModeIndicator.className = 'auth-mode-indicator';
  authModeIndicator.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 8px 16px;
    background: rgba(17, 24, 39, 0.9);
    border: 1px solid rgba(56, 189, 248, 0.3);
    border-radius: 8px;
    font-size: 12px;
    color: var(--text-muted);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
  `;
  document.body.appendChild(authModeIndicator);
  
  // =============================================
  // åˆå§‹åŒ–è®¤è¯ç³»ç»Ÿ
  // =============================================
  
  async function initAuth() {
    try {
      const result = await GameBoxAuth.init();
      
      // æ›´æ–°æ¨¡å¼æŒ‡ç¤ºå™¨
      if (result.mode === 'supabase') {
        authModeIndicator.innerHTML = `
          <span style="color: #00ff88;">â—</span>
          <span>Supabase åœ¨çº¿æ¨¡å¼</span>
        `;
      } else {
        authModeIndicator.innerHTML = `
          <span style="color: #f59e0b;">â—</span>
          <span>æœ¬åœ°æ¼”ç¤ºæ¨¡å¼</span>
          <a href="#" onclick="showConfigHelp(); return false;" style="color: var(--accent); margin-left: 8px;">é…ç½®æŒ‡å—</a>
        `;
      }
      
      // æ£€æŸ¥ç™»å½•çŠ¶æ€
      await checkAuthState();
      
      console.log('[GameBox] è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('[GameBox] è®¤è¯ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
      showMessage('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
    }
  }
  
  // =============================================
  // è®¤è¯çŠ¶æ€æ£€æŸ¥
  // =============================================
  
  async function checkAuthState() {
    const user = await GameBoxAuth.getCurrentUser();
    
    if (user) {
      const session = await GameBoxAuth.getSession();
      showLoggedInState(user, session);
    } else {
      showAuthForm();
    }
    
    updateHeaderUser();
  }
  
  function showLoggedInState(user, session) {
    authFormContainer.style.display = 'none';
    loggedInContainer.style.display = 'block';
    
    document.getElementById('userAvatar').textContent = user.avatar || 'ğŸ®';
    document.getElementById('userName').textContent = user.username;
    document.getElementById('userEmail').textContent = user.email;
    
    const loginTime = session?.login_time || new Date().toISOString();
    document.getElementById('loginTime').textContent = new Date(loginTime).toLocaleString('zh-CN');
    
    // æ˜¾ç¤ºé‚®ç®±éªŒè¯çŠ¶æ€
    const emailStatus = document.getElementById('emailVerifyStatus');
    if (emailStatus) {
      if (user.email_confirmed) {
        emailStatus.innerHTML = '<span style="color: #00ff88;">âœ“ å·²éªŒè¯</span>';
      } else {
        emailStatus.innerHTML = '<span style="color: #f59e0b;">âš  æœªéªŒè¯</span>';
      }
    }
  }
  
  function showAuthForm() {
    authFormContainer.style.display = 'block';
    loggedInContainer.style.display = 'none';
  }
  
  async function updateHeaderUser() {
    const user = await GameBoxAuth.getCurrentUser();
    const headerBtn = document.getElementById('headerUserBtn');
    
    if (user) {
      headerBtn.textContent = user.username;
      headerBtn.style.color = 'var(--accent)';
    } else {
      headerBtn.textContent = 'æœªç™»å½• Â· æ¸¸å®¢';
      headerBtn.style.color = '';
    }
  }
  
  // =============================================
  // UI å·¥å…·å‡½æ•°
  // =============================================
  
  function showMessage(text, type = 'error') {
    authMessage.textContent = text;
    authMessage.className = 'auth-message show ' + type;
    
    if (type === 'success' || type === 'info') {
      setTimeout(() => {
        authMessage.classList.remove('show');
      }, 5000);
    }
  }
  
  function hideMessage() {
    authMessage.classList.remove('show');
  }
  
  function showConfigHelp() {
    const helpModal = document.createElement('div');
    helpModal.className = 'config-help-modal';
    helpModal.innerHTML = `
      <div class="config-help-content" style="
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, rgba(17, 24, 39, 0.98), rgba(31, 41, 55, 0.95));
        border: 1px solid rgba(56, 189, 248, 0.3);
        border-radius: 16px;
        padding: 32px;
        max-width: 600px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 10001;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      ">
        <h2 style="color: var(--accent); margin: 0 0 20px; font-family: 'Orbitron', sans-serif;">
          ğŸ”§ é…ç½® Supabase åç«¯
        </h2>
        
        <div style="color: var(--text-soft); line-height: 1.8; font-size: 14px;">
          <p><strong>æ­¥éª¤ 1:</strong> è®¿é—® <a href="https://supabase.com" target="_blank" style="color: var(--accent);">supabase.com</a> åˆ›å»ºå…è´¹è´¦æˆ·</p>
          
          <p><strong>æ­¥éª¤ 2:</strong> åˆ›å»ºæ–°é¡¹ç›® (å…è´¹è®¡åˆ’æ”¯æŒ 50,000 æœˆæ´»ç”¨æˆ·)</p>
          
          <p><strong>æ­¥éª¤ 3:</strong> åœ¨é¡¹ç›® Settings â†’ API ä¸­è·å–:</p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>Project URL</li>
            <li>anon/public key</li>
          </ul>
          
          <p><strong>æ­¥éª¤ 4:</strong> ç¼–è¾‘ <code style="background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 4px;">supabase-config.js</code> æ–‡ä»¶:</p>
          
          <pre style="background: rgba(0,0,0,0.3); padding: 16px; border-radius: 8px; overflow-x: auto; margin: 12px 0;">
const SUPABASE_CONFIG = {
  url: 'https://YOUR_PROJECT.supabase.co',
  anonKey: 'YOUR_ANON_KEY',
  enabled: true,  // æ”¹ä¸º true
  ...
};</pre>
          
          <p><strong>å¯é€‰é…ç½®:</strong></p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li>OAuth ç™»å½•: åœ¨ Supabase â†’ Authentication â†’ Providers é…ç½® Google/GitHub</li>
            <li>é‚®ä»¶æœåŠ¡: é…ç½® SMTP å‘é€éªŒè¯é‚®ä»¶</li>
          </ul>
          
          <div style="margin-top: 20px; padding: 12px; background: rgba(0, 255, 136, 0.1); border-radius: 8px;">
            <strong style="color: #00ff88;">ğŸ’¡ æç¤º:</strong> 
            Supabase å…è´¹è®¡åˆ’åŒ…å« 500MB æ•°æ®åº“ã€50,000 æœˆæ´»ç”¨æˆ·ï¼Œè¶³å¤Ÿå¤§å¤šæ•°é¡¹ç›®ä½¿ç”¨ã€‚
          </div>
        </div>
        
        <button onclick="this.parentElement.parentElement.remove()" style="
          margin-top: 24px;
          padding: 12px 24px;
          background: linear-gradient(135deg, var(--accent), #00ff88);
          border: none;
          border-radius: 8px;
          color: #0a0f1a;
          font-weight: 600;
          cursor: pointer;
          width: 100%;
        ">çŸ¥é“äº†</button>
      </div>
      <div onclick="this.parentElement.remove()" style="
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
      "></div>
    `;
    document.body.appendChild(helpModal);
  }
  
  // =============================================
  // Tab åˆ‡æ¢
  // =============================================
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const targetTab = tab.dataset.tab;
      
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      if (targetTab === 'login') {
        loginForm.classList.add('active');
        registerForm.classList.remove('active');
      } else {
        loginForm.classList.remove('active');
        registerForm.classList.add('active');
      }
      
      hideMessage();
    });
  });
  
  // =============================================
  // å¯†ç å¼ºåº¦æ£€æµ‹
  // =============================================
  
  const registerPassword = document.getElementById('registerPassword');
  const strengthBars = document.querySelectorAll('.strength-bar');
  const strengthText = document.getElementById('strengthText');
  
  registerPassword.addEventListener('input', () => {
    const password = registerPassword.value;
    const strength = checkPasswordStrength(password);
    
    strengthBars.forEach((bar, index) => {
      bar.className = 'strength-bar';
      if (index < strength.level) {
        bar.classList.add(strength.class);
      }
    });
    
    strengthText.textContent = strength.text;
    strengthText.style.color = strength.color;
  });
  
  function checkPasswordStrength(password) {
    let score = 0;
    
    if (password.length >= 6) score++;
    if (password.length >= 10) score++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score++;
    if (/\d/.test(password)) score++;
    if (/[^a-zA-Z0-9]/.test(password)) score++;
    
    if (score <= 1) return { level: 1, class: 'weak', text: 'å¼±', color: '#ef4444' };
    if (score <= 2) return { level: 2, class: 'medium', text: 'ä¸­ç­‰', color: '#f59e0b' };
    if (score <= 3) return { level: 3, class: 'strong', text: 'å¼º', color: '#10b981' };
    return { level: 4, class: 'very-strong', text: 'éå¸¸å¼º', color: '#00ff88' };
  }
  
  // =============================================
  // ç™»å½•è¡¨å•æäº¤
  // =============================================
  
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value.trim();
    const password = document.getElementById('loginPassword').value;
    const btn = document.getElementById('loginBtn');
    
    if (!email || !password) {
      showMessage('è¯·å¡«å†™é‚®ç®±å’Œå¯†ç ', 'error');
      return;
    }
    
    btn.classList.add('loading');
    btn.disabled = true;
    hideMessage();
    
    try {
      const result = await GameBoxAuth.signIn(email, password);
      
      if (result.success) {
        showMessage(result.message, 'success');
        
        setTimeout(async () => {
          await checkAuthState();
        }, 1000);
      } else {
        showMessage(result.error, 'error');
      }
    } catch (error) {
      showMessage('ç™»å½•å¤±è´¥: ' + error.message, 'error');
    } finally {
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  });
  
  // =============================================
  // é‚®ç®±éªŒè¯ç åŠŸèƒ½
  // =============================================
  
  let otpSent = false;
  let otpCountdown = 0;
  let otpTimer = null;
  
  const sendOtpBtn = document.getElementById('sendOtpBtn');
  const otpGroup = document.getElementById('otpGroup');
  const emailOtpInput = document.getElementById('emailOtp');
  const otpHint = document.getElementById('otpHint');
  
  sendOtpBtn.addEventListener('click', async () => {
    const email = document.getElementById('registerEmail').value.trim();
    
    if (!email) {
      showMessage('è¯·å…ˆè¾“å…¥é‚®ç®±åœ°å€', 'error');
      return;
    }
    
    // éªŒè¯é‚®ç®±æ ¼å¼
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
      return;
    }
    
    sendOtpBtn.disabled = true;
    sendOtpBtn.textContent = 'å‘é€ä¸­...';
    
    try {
      const result = await GameBoxAuth.sendEmailOTP(email);
      
      if (result.success) {
        otpSent = true;
        otpGroup.style.display = 'block';
        
        // æ¼”ç¤ºæ¨¡å¼ä¸‹æ˜¾ç¤ºéªŒè¯ç 
        if (result.demoCode) {
          otpHint.innerHTML = `éªŒè¯ç å·²å‘é€ <span style="color: #00ff88; font-weight: bold;">(æ¼”ç¤ºéªŒè¯ç : ${result.demoCode})</span>`;
        } else {
          otpHint.textContent = 'éªŒè¯ç å·²å‘é€åˆ°æ‚¨çš„é‚®ç®±ï¼Œ5åˆ†é’Ÿå†…æœ‰æ•ˆ';
        }
        
        showMessage(result.message, 'success');
        
        // å€’è®¡æ—¶
        startOtpCountdown(60);
      } else {
        showMessage(result.error, 'error');
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'å‘é€éªŒè¯ç ';
      }
    } catch (error) {
      showMessage('å‘é€å¤±è´¥: ' + error.message, 'error');
      sendOtpBtn.disabled = false;
      sendOtpBtn.textContent = 'å‘é€éªŒè¯ç ';
    }
  });
  
  function startOtpCountdown(seconds) {
    otpCountdown = seconds;
    updateOtpButton();
    
    if (otpTimer) clearInterval(otpTimer);
    
    otpTimer = setInterval(() => {
      otpCountdown--;
      if (otpCountdown <= 0) {
        clearInterval(otpTimer);
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'é‡æ–°å‘é€';
      } else {
        updateOtpButton();
      }
    }, 1000);
  }
  
  function updateOtpButton() {
    sendOtpBtn.textContent = `${otpCountdown}s åé‡å‘`;
    sendOtpBtn.disabled = true;
  }
  
  // =============================================
  // æ³¨å†Œè¡¨å•æäº¤
  // =============================================
  
  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('registerEmail').value.trim();
    const username = document.getElementById('registerUsername').value.trim();
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const agreeTerms = document.getElementById('agreeTerms').checked;
    const otpCode = emailOtpInput.value.trim();
    const btn = document.getElementById('registerBtn');
    
    // éªŒè¯
    if (!email || !username || !password) {
      showMessage('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹', 'error');
      return;
    }
    
    // éªŒè¯ç æ£€æŸ¥ (å¦‚æœå·²å‘é€)
    if (otpSent && !otpCode) {
      showMessage('è¯·è¾“å…¥é‚®ç®±éªŒè¯ç ', 'error');
      return;
    }
    
    if (otpSent && otpCode.length !== 6) {
      showMessage('éªŒè¯ç åº”ä¸º6ä½æ•°å­—', 'error');
      return;
    }
    
    if (password !== passwordConfirm) {
      showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
      return;
    }
    
    if (password.length < 6) {
      showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦', 'error');
      return;
    }
    
    if (username.length < 2) {
      showMessage('ç”¨æˆ·åè‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦', 'error');
      return;
    }
    
    if (!agreeTerms) {
      showMessage('è¯·å…ˆåŒæ„ç”¨æˆ·åè®®', 'error');
      return;
    }
    
    btn.classList.add('loading');
    btn.disabled = true;
    hideMessage();
    
    try {
      let result;
      
      // å¦‚æœå‘é€äº†éªŒè¯ç ï¼Œä½¿ç”¨å¸¦éªŒè¯ç çš„æ³¨å†Œ
      if (otpSent && otpCode) {
        result = await GameBoxAuth.signUpWithOTP(email, password, username, otpCode);
      } else {
        // å¦åˆ™ä½¿ç”¨æ™®é€šæ³¨å†Œ
        result = await GameBoxAuth.signUp(email, password, username);
      }
      
      if (result.success) {
        if (result.needsEmailConfirmation) {
          showMessage(result.message, 'info');
          // åˆ‡æ¢åˆ°ç™»å½• tab
          tabs.forEach(t => t.classList.remove('active'));
          tabs[0].classList.add('active');
          loginForm.classList.add('active');
          registerForm.classList.remove('active');
        } else {
          showMessage(result.message + ' è‡ªåŠ¨ç™»å½•ä¸­...', 'success');
          
          // è‡ªåŠ¨ç™»å½•
          const loginResult = await GameBoxAuth.signIn(email, password);
          
          if (loginResult.success) {
            setTimeout(async () => {
              await checkAuthState();
            }, 1500);
          }
        }
        
        // é‡ç½®éªŒè¯ç çŠ¶æ€
        otpSent = false;
        otpGroup.style.display = 'none';
        emailOtpInput.value = '';
        if (otpTimer) clearInterval(otpTimer);
        sendOtpBtn.disabled = false;
        sendOtpBtn.textContent = 'å‘é€éªŒè¯ç ';
        
      } else {
        showMessage(result.error, 'error');
      }
    } catch (error) {
      showMessage('æ³¨å†Œå¤±è´¥: ' + error.message, 'error');
    } finally {
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  });
  
  // =============================================
  // ç™»å‡º
  // =============================================
  
  document.getElementById('logoutBtn').addEventListener('click', async () => {
    const btn = document.getElementById('logoutBtn');
    btn.disabled = true;
    btn.textContent = 'é€€å‡ºä¸­...';
    
    try {
      const result = await GameBoxAuth.signOut();
      showMessage(result.message, 'info');
      await checkAuthState();
    } catch (error) {
      showMessage('é€€å‡ºå¤±è´¥: ' + error.message, 'error');
    } finally {
      btn.disabled = false;
      btn.textContent = 'é€€å‡ºç™»å½•';
    }
  });
  
  // =============================================
  // OAuth ç¤¾äº¤ç™»å½•
  // =============================================
  
  document.getElementById('googleLoginBtn').addEventListener('click', async () => {
    const result = await GameBoxAuth.signInWithGoogle();
    
    if (!result.success) {
      showMessage(result.error, 'info');
    }
    // å¦‚æœæˆåŠŸï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ° Google ç™»å½•é¡µé¢
  });
  
  document.getElementById('githubLoginBtn').addEventListener('click', async () => {
    const result = await GameBoxAuth.signInWithGitHub();
    
    if (!result.success) {
      showMessage(result.error, 'info');
    }
    // å¦‚æœæˆåŠŸï¼Œä¼šè‡ªåŠ¨è·³è½¬åˆ° GitHub ç™»å½•é¡µé¢
  });
  
  // =============================================
  // å¿˜è®°å¯†ç 
  // =============================================
  
  document.getElementById('forgotPasswordLink').addEventListener('click', async (e) => {
    e.preventDefault();
    
    const email = document.getElementById('loginEmail').value.trim();
    
    if (!email) {
      showMessage('è¯·å…ˆåœ¨ç™»å½•æ¡†ä¸­è¾“å…¥æ‚¨çš„é‚®ç®±åœ°å€', 'info');
      document.getElementById('loginEmail').focus();
      return;
    }
    
    const result = await GameBoxAuth.resetPassword(email);
    
    if (result.success) {
      showMessage(result.message, 'success');
    } else {
      showMessage(result.error, 'error');
    }
  });
  
  // =============================================
  // å¯åŠ¨
  // =============================================
  
  initAuth();
</script>
</body>
</html>
