<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸ› Community.html ç¯å¢ƒè°ƒè¯•</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <style>
    body { 
      font-family: 'Courier New', monospace; 
      padding: 40px; 
      background: #1a1a1a; 
      color: #00ff00;
    }
    .box { 
      background: #000; 
      padding: 30px; 
      border: 2px solid #00ff00;
      border-radius: 10px; 
      margin-bottom: 20px; 
    }
    button { 
      background: #00ff00; 
      color: #000; 
      border: none; 
      padding: 15px 30px; 
      font-size: 16px; 
      font-weight: bold;
      border-radius: 5px; 
      cursor: pointer; 
      margin: 10px; 
    }
    button:hover { 
      background: #00cc00; 
    }
    #result { 
      background: #000; 
      color: #00ff00; 
      padding: 20px; 
      border: 1px solid #00ff00;
      border-radius: 5px; 
      font-family: 'Courier New', monospace; 
      white-space: pre-wrap; 
      min-height: 300px;
      font-size: 13px;
    }
    .error { color: #ff0000; }
    .success { color: #00ff00; }
    .warning { color: #ffaa00; }
    .info { color: #00aaff; }
  </style>
</head>
<body>
  <div class="box">
    <h1>ğŸ› Community.html ç¯å¢ƒå®Œå…¨æ¨¡æ‹Ÿè°ƒè¯•</h1>
    <p>è¿™ä¸ªé¡µé¢å®Œå…¨æ¨¡æ‹Ÿ community.html çš„ç¯å¢ƒå’Œé€»è¾‘</p>
    <button onclick="runFullTest()">ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•</button>
    <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <div class="box">
    <h2>ğŸ“‹ è°ƒè¯•æ—¥å¿—</h2>
    <div id="result">ç‚¹å‡» "è¿è¡Œå®Œæ•´æµ‹è¯•" å¼€å§‹...</div>
  </div>

  <script>
    let logContent = '';
    
    function log(msg, type = 'info') {
      const colors = {
        error: '#ff0000',
        success: '#00ff00',
        warning: '#ffaa00',
        info: '#00aaff'
      };
      const timestamp = new Date().toLocaleTimeString();
      logContent += `<span style="color: ${colors[type]}">[${timestamp}] ${msg}</span>\n`;
      document.getElementById('result').innerHTML = logContent;
      console.log(msg);
    }
    
    function clearLog() {
      logContent = '';
      document.getElementById('result').innerHTML = 'æ—¥å¿—å·²æ¸…ç©ºï¼Œç‚¹å‡» "è¿è¡Œå®Œæ•´æµ‹è¯•" å¼€å§‹...';
    }
    
    async function runFullTest() {
      clearLog();
      log('='.repeat(60), 'info');
      log('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•ï¼ˆæ¨¡æ‹Ÿ community.html ç¯å¢ƒï¼‰', 'success');
      log('='.repeat(60), 'info');
      log('', 'info');
      
      // ===== æ­¥éª¤ 1: æ£€æŸ¥ SDK =====
      log('ã€æ­¥éª¤ 1ã€‘æ£€æŸ¥ Supabase SDK...', 'info');
      if (typeof supabase === 'undefined') {
        log('âŒ Supabase SDK æœªåŠ è½½ï¼', 'error');
        return;
      }
      log('âœ… Supabase SDK å·²åŠ è½½', 'success');
      log('', 'info');
      
      // ===== æ­¥éª¤ 2: æ£€æŸ¥é…ç½® =====
      log('ã€æ­¥éª¤ 2ã€‘æ£€æŸ¥ SUPABASE_CONFIG...', 'info');
      if (typeof SUPABASE_CONFIG === 'undefined') {
        log('âŒ SUPABASE_CONFIG æœªå®šä¹‰ï¼', 'error');
        return;
      }
      log('âœ… SUPABASE_CONFIG å·²åŠ è½½', 'success');
      log('  - URL: ' + SUPABASE_CONFIG.url, 'info');
      log('  - enabled: ' + SUPABASE_CONFIG.enabled, 'info');
      log('  - anonKey: ' + (SUPABASE_CONFIG.anonKey ? 'å·²è®¾ç½®ï¼ˆå‰10å­—ç¬¦: ' + SUPABASE_CONFIG.anonKey.substring(0, 10) + '...)' : 'æœªè®¾ç½®'), 'info');
      log('', 'info');
      
      if (!SUPABASE_CONFIG.enabled) {
        log('âš ï¸ SUPABASE_CONFIG.enabled = false', 'warning');
        log('âŒ æµ‹è¯•ä¸­æ­¢ï¼šSupabase æœªå¯ç”¨', 'error');
        return;
      }
      
      // ===== æ­¥éª¤ 3: åˆ›å»ºå®¢æˆ·ç«¯ï¼ˆä¸ community-data-service.js å®Œå…¨ä¸€è‡´ï¼‰=====
      log('ã€æ­¥éª¤ 3ã€‘åˆ›å»º Supabase å®¢æˆ·ç«¯ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰...', 'info');
      let client;
      try {
        client = supabase.createClient(
          SUPABASE_CONFIG.url, 
          SUPABASE_CONFIG.anonKey
        );
        log('âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
        log('', 'info');
      } catch (e) {
        log('âŒ å®¢æˆ·ç«¯åˆ›å»ºå¤±è´¥: ' + e.message, 'error');
        log('å †æ ˆ: ' + e.stack, 'error');
        return;
      }
      
      // ===== æ­¥éª¤ 4: æ£€æŸ¥ community_posts è¡¨ï¼ˆä¸ ensureDatabaseTables å®Œå…¨ä¸€è‡´ï¼‰=====
      log('ã€æ­¥éª¤ 4ã€‘æ£€æŸ¥ community_posts è¡¨...', 'info');
      try {
        log('å‘é€è¯·æ±‚: SELECT id FROM community_posts LIMIT 1', 'info');
        const { data, error } = await client
          .from('community_posts')
          .select('id')
          .limit(1);
        
        if (error) {
          log('âŒ æŸ¥è¯¢å¤±è´¥ï¼', 'error');
          log('  - é”™è¯¯ä»£ç : ' + error.code, 'error');
          log('  - é”™è¯¯ä¿¡æ¯: ' + error.message, 'error');
          log('  - è¯¦ç»†ä¿¡æ¯: ' + JSON.stringify(error, null, 2), 'error');
          log('', 'info');
          
          if (error.code === '42P01') {
            log('âš ï¸ è¿™æ˜¯ "è¡¨ä¸å­˜åœ¨" é”™è¯¯ï¼ˆPostgreSQL é”™è¯¯ç  42P01ï¼‰', 'warning');
            log('', 'info');
            log('ğŸ› ï¸ è¯·æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ä¿®å¤ï¼š', 'info');
            log('1. è®¿é—® https://supabase.com/dashboard/project/gybgiqyyltckgxbdtzwu/sql', 'info');
            log('2. æ–°å»ºæŸ¥è¯¢ï¼Œå¤åˆ¶ supabase-init.sql å†…å®¹', 'info');
            log('3. ç‚¹å‡» "Run" æ‰§è¡Œ', 'info');
          } else if (error.code === 'PGRST301') {
            log('âš ï¸ è¿™æ˜¯ "æƒé™é”™è¯¯"ï¼ˆRLS ç­–ç•¥é—®é¢˜ï¼‰', 'warning');
            log('', 'info');
            log('ğŸ› ï¸ è¯·æ‰§è¡Œä»¥ä¸‹ SQL ä¿®å¤ï¼š', 'info');
            log('ALTER TABLE community_posts DISABLE ROW LEVEL SECURITY;', 'info');
          } else {
            log('âš ï¸ æœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ Supabase é¡¹ç›®çŠ¶æ€', 'warning');
          }
          
          log('', 'info');
          log('âŒ æµ‹è¯•å¤±è´¥ï¼šæ•°æ®åº“è¡¨æ£€æŸ¥ä¸é€šè¿‡', 'error');
          return;
        }
        
        log('âœ… æŸ¥è¯¢æˆåŠŸï¼', 'success');
        log('  - è¿”å›æ•°æ®: ' + JSON.stringify(data, null, 2), 'success');
        log('', 'info');
        
        // ===== æ­¥éª¤ 5: æ£€æŸ¥ user_profiles è¡¨ =====
        log('ã€æ­¥éª¤ 5ã€‘æ£€æŸ¥ user_profiles è¡¨...', 'info');
        const { data: userData, error: userError } = await client
          .from('user_profiles')
          .select('id')
          .limit(1);
        
        if (userError) {
          log('âŒ user_profiles è¡¨æ£€æŸ¥å¤±è´¥: ' + userError.message, 'error');
        } else {
          log('âœ… user_profiles è¡¨æ­£å¸¸', 'success');
          log('  - æ•°æ®: ' + JSON.stringify(userData, null, 2), 'success');
        }
        log('', 'info');
        
        // ===== æ­¥éª¤ 6: æµ‹è¯•å†™å…¥ =====
        log('ã€æ­¥éª¤ 6ã€‘æµ‹è¯•å†™å…¥æƒé™...', 'info');
        const testUserId = 'test-user-' + Date.now();
        const { data: insertData, error: insertError } = await client
          .from('user_profiles')
          .insert({
            id: testUserId,
            username: 'Test User',
            created_at: new Date().toISOString()
          })
          .select();
        
        if (insertError) {
          log('âš ï¸ å†™å…¥æµ‹è¯•å¤±è´¥: ' + insertError.message, 'warning');
          log('  - è¿™å¯èƒ½æ˜¯ RLS ç­–ç•¥é™åˆ¶', 'warning');
        } else {
          log('âœ… å†™å…¥æµ‹è¯•æˆåŠŸï¼', 'success');
          log('  - æ’å…¥æ•°æ®: ' + JSON.stringify(insertData, null, 2), 'success');
          
          // æ¸…ç†æµ‹è¯•æ•°æ®
          await client.from('user_profiles').delete().eq('id', testUserId);
          log('âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†', 'success');
        }
        log('', 'info');
        
      } catch (e) {
        log('âŒ æµ‹è¯•è¿‡ç¨‹å¼‚å¸¸: ' + e.message, 'error');
        log('å †æ ˆ: ' + e.stack, 'error');
        return;
      }
      
      // ===== æµ‹è¯•å®Œæˆ =====
      log('='.repeat(60), 'info');
      log('ğŸ‰ æµ‹è¯•å®Œæˆï¼æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼', 'success');
      log('='.repeat(60), 'info');
      log('', 'info');
      log('ğŸ’¡ ç»“è®ºï¼šSupabase è¿æ¥å®Œå…¨æ­£å¸¸ï¼Œcommunity.html åº”è¯¥èƒ½æ­£å¸¸å·¥ä½œ', 'success');
      log('', 'info');
      log('â“ å¦‚æœ community.html ä»æ˜¾ç¤º "æœªè¿æ¥"ï¼Œè¯·ï¼š', 'info');
      log('1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+Delï¼‰', 'info');
      log('2. ä½¿ç”¨éšèº«æ¨¡å¼æµ‹è¯•', 'info');
      log('3. å°†æ­¤æµ‹è¯•ç»“æœæˆªå›¾å‘ç»™å¼€å‘è€…', 'info');
    }
  </script>
</body>
</html>
