<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æœç´¢ç»“æœ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css" />
</head>
<body class="cyberpunk-theme">
<div class="page">
  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>

      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>

      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>

  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æœç´¢ç»“æœ</div>
        <div class="page-intro">
          å…³é”®è¯ï¼š<strong id="searchKeyword">ï¼ˆç©ºï¼‰</strong>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>æ¸¸æˆåŒ¹é…</span>
          </div>
        </header>
        <div id="searchGames"></div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>èµ„è®¯åŒ¹é…</span>
          </div>
        </header>
        <div id="searchNews" style="max-height: 400px; overflow-y: auto;"></div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title">
            <span class="dot"></span><span>ç¤¾åŒºå¸–å­åŒ¹é…</span>
          </div>
        </header>
        <div id="searchPosts" style="max-height: 400px; overflow-y: auto;"></div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">æç¤º</div>
        <div class="sidebar-item">
          <span class="label">é¡¶éƒ¨æœç´¢æ¡†ä¹Ÿå¯ä»¥é‡æ–°è¾“å…¥å…³é”®å­—</span>
        </div>
      </div>
    </aside>
  </main>
</div>


<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="enhanced-game-api.js"></script>
<script src="news-api.js"></script>
<script>
  initCommon();

  const searchKeyword = document.getElementById("searchKeyword");
  const searchGames = document.getElementById("searchGames");
  const searchNews = document.getElementById("searchNews");
  const searchPosts = document.getElementById("searchPosts");

  let gamesData = [];
  let newsData = [];
  let postsData = [];
  let isDataLoaded = false;

  // åˆ†é¡µçŠ¶æ€
  let gamesPage = 0;
  let newsPage = 0;
  let postsPage = 0;
  const PAGE_SIZE = 10;
  
  let filteredGames = [];
  let filteredNews = [];
  let filteredPosts = [];

  // è·å– URL å‚æ•°ä¸­çš„å…³é”®è¯
  function getKeyword() {
    const params = new URLSearchParams(window.location.search);
    return params.get("q") || "";
  }

  // åŠ è½½æ‰€æœ‰æ•°æ®
  async function loadAllData() {
    try {
      searchGames.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ® åŠ è½½ä¸­...</div>';
      searchNews.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ“° åŠ è½½ä¸­...</div>';
      searchPosts.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ’¬ åŠ è½½ä¸­...</div>';

      // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
      const [games, news] = await Promise.all([
        window.enhancedGameAPI.getAllGames(),
        window.newsAPI.getAllNews()
      ]);

      gamesData = games.map(g => ({
        name: g.title || g.name,
        desc: `${g.genre} Â· ${g.platform.split(',')[0].trim()} Â· ${g.publisher}`,
        url: `game-detail.html?id=${g.id}&name=${encodeURIComponent(g.name)}`,
        cover: g.thumbnail,
        genre: g.genre,
        publisher: g.publisher,
        rating: g.rating,
        price: g.price,
        short_description: g.short_description
      }));

      newsData = news.map(n => ({
        title: n.title,
        summary: n.summary,
        url: `news-detail.html?id=${n.id}`,
        game: n.game,
        type: n.type,
        date: n.date
      }));

      // ç”Ÿæˆç¤¾åŒºå¸–å­æ•°æ®
      postsData = generatePostsData();

      console.log(`âœ… æœç´¢æ•°æ®åŠ è½½å®Œæˆï¼š${gamesData.length} æ¸¸æˆï¼Œ${newsData.length} æ–°é—»ï¼Œ${postsData.length} å¸–å­`);
      isDataLoaded = true;
      performSearch();
    } catch (err) {
      console.error("åŠ è½½æ•°æ®å¤±è´¥:", err);
      searchGames.innerHTML = '<div style="padding:20px;text-align:center;color:var(--danger);">âŒ åŠ è½½å¤±è´¥</div>';
      searchNews.innerHTML = '<div style="padding:20px;text-align:center;color:var(--danger);">âŒ åŠ è½½å¤±è´¥</div>';
      searchPosts.innerHTML = '<div style="padding:20px;text-align:center;color:var(--danger);">âŒ åŠ è½½å¤±è´¥</div>';
    }
  }

  // ç”Ÿæˆç¤¾åŒºå¸–å­æ•°æ®
  function generatePostsData() {
    const boards = ["ç»¼åˆè®¨è®º", "æ”»ç•¥å¿ƒå¾—", "æˆªå›¾åˆ†äº«", "æ±‚åŠ©é—®ç­”"];
    const topics = [
      "æ–°æ‰‹å…¥é—¨æŒ‡å—", "é…ç½®æ¨è", "é€šå…³å¿ƒå¾—", "å½©è›‹å‘ç°", 
      "éšè—Bossæ”»ç•¥", "é€Ÿé€šæŠ€å·§", "MODæ¨è", "è”æœºç»„é˜Ÿ",
      "å‰§æƒ…è®¨è®º", "ç»“å±€è§£æ", "äººç‰©åˆ†æ", "ä¸–ç•Œè§‚æ¢è®¨"
    ];
    
    const posts = [];
    gamesData.slice(0, 200).forEach(game => {
      for (let i = 0; i < 5; i++) {
        const board = boards[Math.floor(Math.random() * boards.length)];
        const topic = topics[Math.floor(Math.random() * topics.length)];
        posts.push({
          title: `ã€${board}ã€‘ã€Š${game.name}ã€‹${topic}`,
          board: board,
          author: `ç©å®¶${Math.floor(Math.random() * 10000)}`,
          replies: Math.floor(Math.random() * 500),
          views: Math.floor(Math.random() * 5000),
          url: `post-detail.html?id=post-${posts.length}`
        });
      }
    });
    return posts;
  }

  // æ‰§è¡Œæœç´¢
  function performSearch() {
    if (!isDataLoaded) return;

    const kw = getKeyword().trim().toLowerCase();
    searchKeyword.textContent = kw || "ï¼ˆç©ºï¼‰";

    if (!kw) {
      searchGames.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ” è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>';
      searchNews.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ” è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>';
      searchPosts.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ” è¯·è¾“å…¥æœç´¢å…³é”®è¯</div>';
      return;
    }

    // ç­›é€‰æ•°æ®
    filteredGames = gamesData.filter(g => {
      const text = `${g.name} ${g.desc} ${g.genre} ${g.publisher} ${g.short_description}`.toLowerCase();
      return text.includes(kw);
    });

    filteredNews = newsData.filter(n => {
      const text = `${n.title} ${n.summary} ${n.game}`.toLowerCase();
      return text.includes(kw);
    });

    filteredPosts = postsData.filter(p => {
      const text = `${p.title} ${p.board}`.toLowerCase();
      return text.includes(kw);
    });

    console.log(`ğŸ” æœç´¢"${kw}"ç»“æœï¼š${filteredGames.length} æ¸¸æˆï¼Œ${filteredNews.length} æ–°é—»ï¼Œ${filteredPosts.length} å¸–å­`);

    // é‡ç½®åˆ†é¡µå¹¶æ¸²æŸ“
    gamesPage = 0;
    newsPage = 0;
    postsPage = 0;
    
    searchGames.innerHTML = "";
    searchNews.innerHTML = "";
    searchPosts.innerHTML = "";
    
    renderGames();
    renderNews();
    renderPosts();
  }

  // æ¸²æŸ“æ¸¸æˆç»“æœ
  function renderGames() {
    const startIdx = gamesPage * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageItems = filteredGames.slice(startIdx, endIdx);

    if (gamesPage === 0 && !filteredGames.length) {
      searchGames.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ” æœªæ‰¾åˆ°ç›¸å…³æ¸¸æˆ</div>';
      return;
    }

    pageItems.forEach(g => {
      const div = document.createElement("div");
      div.className = "search-item";
      div.style.cursor = "pointer";
      
      const coverImg = g.cover 
        ? `<img src="${g.cover}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'" />` 
        : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:30px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);">ğŸ®</div>';
      
      const priceTag = g.price === 0 ? '<span style="color:var(--success);">å…è´¹</span>' : `Â¥${g.price}`;
      
      div.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;">
          <div style="width:80px;height:80px;border-radius:8px;overflow:hidden;flex-shrink:0;background:#1a1a2e;">
            ${coverImg}
          </div>
          <div style="flex:1;">
            <div class="search-title">ğŸ® ${g.name}</div>
            <div class="search-excerpt">${g.desc}</div>
            <div style="display:flex;gap:12px;margin-top:6px;font-size:12px;">
              <span style="color:var(--accent);">â­ ${g.rating}</span>
              <span>${priceTag}</span>
            </div>
          </div>
        </div>
      `;
      div.addEventListener("click", () => window.location.href = g.url);
      div.addEventListener("mouseenter", () => {
        div.style.backgroundColor = "rgba(56, 189, 248, 0.05)";
        div.style.transition = "all 0.3s ease";
      });
      div.addEventListener("mouseleave", () => {
        div.style.backgroundColor = "";
      });
      searchGames.appendChild(div);
    });

    gamesPage++;
  }

  // æ¸²æŸ“æ–°é—»ç»“æœ
  function renderNews() {
    const startIdx = newsPage * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageItems = filteredNews.slice(startIdx, endIdx);

    if (newsPage === 0 && !filteredNews.length) {
      searchNews.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ” æœªæ‰¾åˆ°ç›¸å…³èµ„è®¯</div>';
      return;
    }

    pageItems.forEach(n => {
      const div = document.createElement("div");
      div.className = "search-item";
      div.style.cursor = "pointer";
      div.innerHTML = `
        <div class="search-title">ğŸ“° ${n.title}</div>
        <div class="search-meta">ğŸ¯ ${n.game} Â· ğŸ“… ${n.date}</div>
        <div class="search-excerpt">${n.summary}</div>
      `;
      div.addEventListener("click", () => window.location.href = n.url);
      div.addEventListener("mouseenter", () => {
        div.style.backgroundColor = "rgba(56, 189, 248, 0.05)";
        div.style.transition = "all 0.3s ease";
      });
      div.addEventListener("mouseleave", () => {
        div.style.backgroundColor = "";
      });
      searchNews.appendChild(div);
    });

    newsPage++;
  }

  // æ¸²æŸ“å¸–å­ç»“æœ
  function renderPosts() {
    const startIdx = postsPage * PAGE_SIZE;
    const endIdx = startIdx + PAGE_SIZE;
    const pageItems = filteredPosts.slice(startIdx, endIdx);

    if (postsPage === 0 && !filteredPosts.length) {
      searchPosts.innerHTML = '<div style="padding:20px;text-align:center;color:var(--text-muted);">ğŸ” æœªæ‰¾åˆ°ç›¸å…³å¸–å­</div>';
      return;
    }

    pageItems.forEach(p => {
      const div = document.createElement("div");
      div.className = "search-item";
      div.style.cursor = "pointer";
      div.innerHTML = `
        <div class="search-title">ğŸ’¬ ${p.title}</div>
        <div class="search-meta">ğŸ‘¤ ${p.author} Â· ğŸ’¬ ${p.replies} å›å¤ Â· ğŸ‘ï¸ ${p.views} æµè§ˆ</div>
      `;
      div.addEventListener("click", () => window.location.href = p.url);
      div.addEventListener("mouseenter", () => {
        div.style.backgroundColor = "rgba(56, 189, 248, 0.05)";
        div.style.transition = "all 0.3s ease";
      });
      div.addEventListener("mouseleave", () => {
        div.style.backgroundColor = "";
      });
      searchPosts.appendChild(div);
    });

    postsPage++;
  }

  // æ— é™æ»šåŠ¨
  searchGames.addEventListener("scroll", () => {
    if (searchGames.scrollHeight - searchGames.scrollTop - searchGames.clientHeight < 100) {
      renderGames();
    }
  });

  searchNews.addEventListener("scroll", () => {
    if (searchNews.scrollHeight - searchNews.scrollTop - searchNews.clientHeight < 100) {
      renderNews();
    }
  });

  searchPosts.addEventListener("scroll", () => {
    if (searchPosts.scrollHeight - searchPosts.scrollTop - searchPosts.clientHeight < 100) {
      renderPosts();
    }
  });

  // åˆå§‹åŒ–
  loadAllData();
</script>
</body>
</html>
