<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç›´æ¥è¿æ¥æµ‹è¯•</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .box {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2196F3;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    #result {
      background: #263238;
      color: #aed581;
      padding: 20px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 14px;
      margin-top: 20px;
      min-height: 200px;
      white-space: pre-wrap;
    }
    .error { color: #ef5350; }
    .success { color: #66bb6a; }
    .info { color: #42a5f5; }
  </style>
</head>
<body>
  <div class="box">
    <h1>ğŸ”Œ ç›´æ¥è¿æ¥æµ‹è¯•</h1>
    <p>ä½¿ç”¨ supabase-config.js æ–‡ä»¶æµ‹è¯•</p>
    
    <button onclick="testConnection()">å¼€å§‹æµ‹è¯•</button>
    <button onclick="testOnlineUsers()">æµ‹è¯• online_users è¡¨</button>
    <button onclick="goToCommunity()">æ‰“å¼€ç¤¾åŒºé¡µé¢</button>
    
    <div id="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹...</div>
  </div>

  <script>
    function log(msg, type = 'info') {
      const result = document.getElementById('result');
      const span = document.createElement('span');
      span.className = type;
      span.textContent = msg + '\n';
      result.appendChild(span);
    }
    
    function clear() {
      document.getElementById('result').innerHTML = '';
    }
    
    async function testConnection() {
      clear();
      log('=== å¼€å§‹æµ‹è¯• ===', 'info');
      log('');
      
      // æ£€æŸ¥é…ç½®
      if (typeof SUPABASE_CONFIG === 'undefined') {
        log('âŒ SUPABASE_CONFIG æœªå®šä¹‰', 'error');
        log('supabase-config.js å¯èƒ½æœªåŠ è½½', 'error');
        return;
      }
      
      log('âœ… é…ç½®æ–‡ä»¶å·²åŠ è½½', 'success');
      log(`URL: ${SUPABASE_CONFIG.url}`, 'info');
      log(`Key: ${SUPABASE_CONFIG.anonKey.substring(0, 30)}...`, 'info');
      log(`å¯ç”¨: ${SUPABASE_CONFIG.enabled}`, 'info');
      log('');
      
      if (!SUPABASE_CONFIG.enabled) {
        log('âŒ Supabase æœªå¯ç”¨', 'error');
        return;
      }
      
      // æ£€æŸ¥ SDK
      if (typeof supabase === 'undefined') {
        log('âŒ Supabase SDK æœªåŠ è½½', 'error');
        return;
      }
      
      log('âœ… Supabase SDK å·²åŠ è½½', 'success');
      log('');
      
      // åˆ›å»ºå®¢æˆ·ç«¯
      log('åˆ›å»ºå®¢æˆ·ç«¯...', 'info');
      try {
        const client = supabase.createClient(
          SUPABASE_CONFIG.url,
          SUPABASE_CONFIG.anonKey
        );
        
        log('âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
        log('');
        
        // æµ‹è¯•æŸ¥è¯¢
        log('æµ‹è¯•æŸ¥è¯¢ community_posts...', 'info');
        const { data, error } = await client
          .from('community_posts')
          .select('id, title')
          .limit(3);
        
        if (error) {
          log(`âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}`, 'error');
          log(`é”™è¯¯ç : ${error.code}`, 'error');
          return;
        }
        
        log(`âœ… æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ${data.length} æ¡å¸–å­`, 'success');
        data.forEach((post, i) => {
          log(`  ${i + 1}. ${post.title || post.id}`, 'info');
        });
        
        // ä¿å­˜å®¢æˆ·ç«¯
        window.testClient = client;
        
        log('');
        log('ğŸ‰ è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success');
        log('å¯ä»¥ç‚¹å‡»"æµ‹è¯• online_users è¡¨"ç»§ç»­', 'info');
        
      } catch (e) {
        log(`âŒ å¼‚å¸¸: ${e.message}`, 'error');
        console.error(e);
      }
    }
    
    async function testOnlineUsers() {
      clear();
      log('=== æµ‹è¯• online_users è¡¨ ===', 'info');
      log('');
      
      if (!window.testClient) {
        log('âŒ è¯·å…ˆè¿è¡Œ"å¼€å§‹æµ‹è¯•"', 'error');
        return;
      }
      
      try {
        // æŸ¥è¯¢
        log('æŸ¥è¯¢ online_users è¡¨...', 'info');
        const { data: queryData, error: queryError } = await window.testClient
          .from('online_users')
          .select('*')
          .limit(5);
        
        if (queryError) {
          log(`âŒ æŸ¥è¯¢å¤±è´¥: ${queryError.message}`, 'error');
          log(`é”™è¯¯ç : ${queryError.code}`, 'error');
          return;
        }
        
        log(`âœ… æŸ¥è¯¢æˆåŠŸï¼æ‰¾åˆ° ${queryData.length} æ¡è®°å½•`, 'success');
        queryData.forEach((user, i) => {
          log(`  ${i + 1}. ${user.username} (${user.user_id})`, 'info');
        });
        log('');
        
        // æµ‹è¯•å†™å…¥
        log('æµ‹è¯•å†™å…¥...', 'info');
        const testUserId = 'test-' + Date.now();
        const { data: insertData, error: insertError } = await window.testClient
          .from('online_users')
          .upsert({
            user_id: testUserId,
            username: 'æµ‹è¯•ç”¨æˆ·',
            last_active: new Date().toISOString()
          })
          .select();
        
        if (insertError) {
          log(`âŒ å†™å…¥å¤±è´¥: ${insertError.message}`, 'error');
          return;
        }
        
        log('âœ… å†™å…¥æˆåŠŸï¼', 'success');
        log('');
        
        // æ¸…ç†æµ‹è¯•æ•°æ®
        await window.testClient
          .from('online_users')
          .delete()
          .eq('user_id', testUserId);
        
        log('âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†', 'success');
        log('');
        log('ğŸ‰ online_users è¡¨å®Œå…¨æ­£å¸¸ï¼', 'success');
        
      } catch (e) {
        log(`âŒ å¼‚å¸¸: ${e.message}`, 'error');
        console.error(e);
      }
    }
    
    function goToCommunity() {
      // å¸¦æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
      window.location.href = `community.html?t=${Date.now()}`;
    }
  </script>
</body>
</html>
