<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ç¤¾åŒºåŠŸèƒ½æµ‹è¯• - GameBox</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 20px auto;
      padding: 20px;
      background: #1a1a1a;
      color: #e0e0e0;
    }
    .test-section {
      background: #2a2a2a;
      border: 2px solid #FFD300;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
    }
    .test-section h2 {
      color: #FFD300;
      margin-top: 0;
    }
    .test-result {
      background: #333;
      padding: 10px;
      margin: 10px 0;
      border-left: 4px solid #55EAD4;
      font-family: monospace;
      font-size: 12px;
    }
    .success {
      color: #55EAD4;
    }
    .error {
      color: #FF3D94;
    }
    button {
      background: linear-gradient(135deg, #FFD300, #FF3D94);
      border: none;
      color: #000;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      margin: 5px;
    }
    button:hover {
      opacity: 0.8;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .stat-card {
      background: #333;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #FFD300;
    }
    .stat-label {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <h1>ğŸ§ª GameBox ç¤¾åŒºåŠŸèƒ½æµ‹è¯•</h1>
  
  <div class="test-section">
    <h2>ğŸ“Š æ•°æ®æºçŠ¶æ€</h2>
    <div id="dataSourceStatus" class="test-result">æ£€æµ‹ä¸­...</div>
    <div class="stats-grid" id="statsGrid">
      <div class="stat-card">
        <div class="stat-value" id="totalPosts">-</div>
        <div class="stat-label">å¸–å­æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalMembers">-</div>
        <div class="stat-label">ç¤¾åŒºæˆå‘˜</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="totalReplies">-</div>
        <div class="stat-label">å›å¤æ€»æ•°</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="onlineUsers">-</div>
        <div class="stat-label">åœ¨çº¿äººæ•°</div>
      </div>
    </div>
  </div>

  <div class="test-section">
    <h2>ğŸ“ å¸–å­åŠŸèƒ½æµ‹è¯•</h2>
    <button onclick="testCreatePost()">åˆ›å»ºæµ‹è¯•å¸–å­</button>
    <button onclick="testGetPosts()">è·å–æ‰€æœ‰å¸–å­</button>
    <button onclick="testLikePost()">ç‚¹èµå¸–å­</button>
    <div id="postTestResult" class="test-result">ç­‰å¾…æµ‹è¯•...</div>
  </div>

  <div class="test-section">
    <h2>ğŸ’¬ è¯„è®ºåŠŸèƒ½æµ‹è¯•</h2>
    <button onclick="testAddComment()">æ·»åŠ æµ‹è¯•è¯„è®º</button>
    <button onclick="testGetComments()">è·å–è¯„è®º</button>
    <button onclick="testLikeComment()">ç‚¹èµè¯„è®º</button>
    <div id="commentTestResult" class="test-result">ç­‰å¾…æµ‹è¯•...</div>
  </div>

  <div class="test-section">
    <h2>ğŸ“ˆ ç»Ÿè®¡åŠŸèƒ½æµ‹è¯•</h2>
    <button onclick="testGetStats()">è·å–ç¤¾åŒºç»Ÿè®¡</button>
    <button onclick="testGetOnlineUsers()">è·å–åœ¨çº¿ç”¨æˆ·</button>
    <button onclick="testActivityLog()">è®°å½•æ´»åŠ¨æ—¥å¿—</button>
    <div id="statsTestResult" class="test-result">ç­‰å¾…æµ‹è¯•...</div>
  </div>

  <div class="test-section">
    <h2>ğŸ”„ å®æ—¶æ›´æ–°æµ‹è¯•</h2>
    <button onclick="testRealtimeUpdates()">æµ‹è¯•å®æ—¶æ›´æ–°</button>
    <div id="realtimeTestResult" class="test-result">ç­‰å¾…æµ‹è¯•...</div>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <script src="community-data-service.js"></script>

  <script>
    let testPostId = null;
    let testCommentId = null;

    // åˆå§‹åŒ–æ£€æµ‹
    async function init() {
      await new Promise(resolve => setTimeout(resolve, 500));
      
      const isSupabase = window.communityDataService?.isSupabaseEnabled?.() || false;
      const statusEl = document.getElementById('dataSourceStatus');
      
      if (isSupabase) {
        statusEl.innerHTML = '<span class="success">âœ… Supabase äº‘æ•°æ®åº“å·²è¿æ¥</span>';
        statusEl.innerHTML += '<br>âœ… çœŸå®æ•°æ®å¯¹æ¥åŠŸèƒ½å·²å¯ç”¨';
        statusEl.innerHTML += '<br>âœ… æ”¯æŒå¤šç”¨æˆ·å®æ—¶æ•°æ®åŒæ­¥';
      } else {
        statusEl.innerHTML = '<span class="error">âš ï¸ æœ¬åœ°å­˜å‚¨æ¨¡å¼</span>';
        statusEl.innerHTML += '<br>ğŸ’¡ é…ç½® Supabase å¯å¯ç”¨äº‘ç«¯åŠŸèƒ½';
        statusEl.innerHTML += '<br>ğŸ’¡ è¯¦è§ BACKEND_SETUP.md';
      }
      
      // åŠ è½½ç»Ÿè®¡æ•°æ®
      await loadStats();
    }

    async function loadStats() {
      try {
        const stats = await window.communityDataService.getCommunityStats();
        document.getElementById('totalPosts').textContent = stats.totalPosts;
        document.getElementById('totalMembers').textContent = stats.totalMembers.toLocaleString();
        document.getElementById('totalReplies').textContent = stats.totalReplies.toLocaleString();
        document.getElementById('onlineUsers').textContent = stats.onlineUsers;
      } catch (e) {
        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
      }
    }

    // æµ‹è¯•åˆ›å»ºå¸–å­
    async function testCreatePost() {
      const resultEl = document.getElementById('postTestResult');
      resultEl.innerHTML = 'â³ åˆ›å»ºæµ‹è¯•å¸–å­...';
      
      try {
        const postData = {
          title: `æµ‹è¯•å¸–å­ - ${new Date().toLocaleString()}`,
          content: 'è¿™æ˜¯ä¸€ä¸ªè‡ªåŠ¨åŒ–æµ‹è¯•å¸–å­ï¼Œç”¨äºéªŒè¯ç¤¾åŒºåŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚',
          game: 'æµ‹è¯•æ¸¸æˆ',
          board: 'general',
          author: 'æµ‹è¯•ç”¨æˆ·',
          avatar: 'ğŸ§ª'
        };
        
        const result = await window.communityDataService.createPost(postData);
        
        if (result.success) {
          testPostId = result.post.id;
          resultEl.innerHTML = `<span class="success">âœ… å¸–å­åˆ›å»ºæˆåŠŸ</span><br>`;
          resultEl.innerHTML += `å¸–å­ID: ${testPostId}<br>`;
          resultEl.innerHTML += `æ ‡é¢˜: ${result.post.title}<br>`;
          resultEl.innerHTML += `ä½œè€…: ${result.post.author}`;
          await loadStats();
        } else {
          resultEl.innerHTML = `<span class="error">âŒ åˆ›å»ºå¤±è´¥: ${result.error}</span>`;
        }
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•è·å–å¸–å­
    async function testGetPosts() {
      const resultEl = document.getElementById('postTestResult');
      resultEl.innerHTML = 'â³ è·å–å¸–å­åˆ—è¡¨...';
      
      try {
        const posts = await window.communityDataService.getAllPosts();
        resultEl.innerHTML = `<span class="success">âœ… è·å–æˆåŠŸ</span><br>`;
        resultEl.innerHTML += `å¸–å­æ€»æ•°: ${posts.length}<br>`;
        resultEl.innerHTML += `æœ€æ–°å¸–å­: ${posts[0]?.title || 'æ— '}`;
        
        if (posts.length > 0 && !testPostId) {
          testPostId = posts[0].id;
        }
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•ç‚¹èµå¸–å­
    async function testLikePost() {
      const resultEl = document.getElementById('postTestResult');
      
      if (!testPostId) {
        resultEl.innerHTML = '<span class="error">âŒ è¯·å…ˆåˆ›å»ºæˆ–è·å–å¸–å­</span>';
        return;
      }
      
      resultEl.innerHTML = 'â³ æµ‹è¯•ç‚¹èµåŠŸèƒ½...';
      
      try {
        // ç¬¬ä¸€æ¬¡ç‚¹èµ
        const result1 = await window.communityDataService.likePost(testPostId);
        
        // ç¬¬äºŒæ¬¡ç‚¹èµï¼ˆå–æ¶ˆï¼‰
        const result2 = await window.communityDataService.likePost(testPostId);
        
        resultEl.innerHTML = `<span class="success">âœ… ç‚¹èµåŠŸèƒ½æµ‹è¯•æˆåŠŸ</span><br>`;
        resultEl.innerHTML += `ç¬¬ä¸€æ¬¡: ${result1.liked ? 'å·²ç‚¹èµ' : 'æœªç‚¹èµ'} (${result1.likes}ä¸ªèµ)<br>`;
        resultEl.innerHTML += `ç¬¬äºŒæ¬¡: ${result2.liked ? 'å·²ç‚¹èµ' : 'æœªç‚¹èµ'} (${result2.likes}ä¸ªèµ)`;
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•æ·»åŠ è¯„è®º
    async function testAddComment() {
      const resultEl = document.getElementById('commentTestResult');
      
      if (!testPostId) {
        resultEl.innerHTML = '<span class="error">âŒ è¯·å…ˆåˆ›å»ºæˆ–è·å–å¸–å­</span>';
        return;
      }
      
      resultEl.innerHTML = 'â³ æ·»åŠ æµ‹è¯•è¯„è®º...';
      
      try {
        const commentData = {
          author: 'æµ‹è¯•è¯„è®ºè€…',
          avatar: 'ğŸ’¬',
          content: `æµ‹è¯•è¯„è®º - ${new Date().toLocaleTimeString()}`
        };
        
        const result = await window.communityDataService.addComment(testPostId, commentData);
        
        if (result.success) {
          testCommentId = result.comment.id;
          resultEl.innerHTML = `<span class="success">âœ… è¯„è®ºæ·»åŠ æˆåŠŸ</span><br>`;
          resultEl.innerHTML += `è¯„è®ºID: ${testCommentId}<br>`;
          resultEl.innerHTML += `å†…å®¹: ${result.comment.content}`;
          await loadStats();
        } else {
          resultEl.innerHTML = `<span class="error">âŒ æ·»åŠ å¤±è´¥: ${result.error}</span>`;
        }
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•è·å–è¯„è®º
    async function testGetComments() {
      const resultEl = document.getElementById('commentTestResult');
      
      if (!testPostId) {
        resultEl.innerHTML = '<span class="error">âŒ è¯·å…ˆåˆ›å»ºæˆ–è·å–å¸–å­</span>';
        return;
      }
      
      resultEl.innerHTML = 'â³ è·å–è¯„è®ºåˆ—è¡¨...';
      
      try {
        const comments = await window.communityDataService.getPostComments(testPostId);
        resultEl.innerHTML = `<span class="success">âœ… è·å–æˆåŠŸ</span><br>`;
        resultEl.innerHTML += `è¯„è®ºæ€»æ•°: ${comments.length}<br>`;
        
        if (comments.length > 0) {
          resultEl.innerHTML += `æœ€æ–°è¯„è®º: ${comments[comments.length - 1]?.content || 'æ— '}`;
          if (!testCommentId) {
            testCommentId = comments[0].id;
          }
        }
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•ç‚¹èµè¯„è®º
    async function testLikeComment() {
      const resultEl = document.getElementById('commentTestResult');
      
      if (!testCommentId) {
        resultEl.innerHTML = '<span class="error">âŒ è¯·å…ˆæ·»åŠ æˆ–è·å–è¯„è®º</span>';
        return;
      }
      
      resultEl.innerHTML = 'â³ æµ‹è¯•è¯„è®ºç‚¹èµ...';
      
      try {
        const result1 = await window.communityDataService.likeComment(testCommentId);
        const result2 = await window.communityDataService.likeComment(testCommentId);
        
        resultEl.innerHTML = `<span class="success">âœ… è¯„è®ºç‚¹èµæµ‹è¯•æˆåŠŸ</span><br>`;
        resultEl.innerHTML += `ç¬¬ä¸€æ¬¡: ${result1.liked ? 'å·²ç‚¹èµ' : 'æœªç‚¹èµ'} (${result1.likes}ä¸ªèµ)<br>`;
        resultEl.innerHTML += `ç¬¬äºŒæ¬¡: ${result2.liked ? 'å·²ç‚¹èµ' : 'æœªç‚¹èµ'} (${result2.likes}ä¸ªèµ)`;
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•ç»Ÿè®¡
    async function testGetStats() {
      const resultEl = document.getElementById('statsTestResult');
      resultEl.innerHTML = 'â³ è·å–ç¤¾åŒºç»Ÿè®¡...';
      
      try {
        const stats = await window.communityDataService.getCommunityStats();
        resultEl.innerHTML = `<span class="success">âœ… ç»Ÿè®¡è·å–æˆåŠŸ</span><br>`;
        resultEl.innerHTML += `å¸–å­æ€»æ•°: ${stats.totalPosts}<br>`;
        resultEl.innerHTML += `ç¤¾åŒºæˆå‘˜: ${stats.totalMembers.toLocaleString()}<br>`;
        resultEl.innerHTML += `å›å¤æ€»æ•°: ${stats.totalReplies.toLocaleString()}<br>`;
        resultEl.innerHTML += `åœ¨çº¿äººæ•°: ${stats.onlineUsers}`;
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•åœ¨çº¿ç”¨æˆ·
    async function testGetOnlineUsers() {
      const resultEl = document.getElementById('statsTestResult');
      resultEl.innerHTML = 'â³ è·å–åœ¨çº¿ç”¨æˆ·...';
      
      try {
        const users = await window.communityDataService.getOnlineUsers();
        resultEl.innerHTML = `<span class="success">âœ… åœ¨çº¿ç”¨æˆ·è·å–æˆåŠŸ</span><br>`;
        resultEl.innerHTML += `åœ¨çº¿ç”¨æˆ·æ•°: ${users.length}<br>`;
        resultEl.innerHTML += `ç”¨æˆ·åˆ—è¡¨: ${users.slice(0, 5).join(', ')}${users.length > 5 ? '...' : ''}`;
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•æ´»åŠ¨æ—¥å¿—
    async function testActivityLog() {
      const resultEl = document.getElementById('statsTestResult');
      resultEl.innerHTML = 'â³ æµ‹è¯•æ´»åŠ¨æ—¥å¿—...';
      
      try {
        await window.communityDataService.logActivity('TEST_ACTION', { 
          test: true, 
          timestamp: Date.now() 
        });
        
        const logs = window.communityDataService.getActivityLogs({ limit: 5 });
        const summary = window.communityDataService.getActivitySummary(1);
        
        resultEl.innerHTML = `<span class="success">âœ… æ´»åŠ¨æ—¥å¿—æµ‹è¯•æˆåŠŸ</span><br>`;
        resultEl.innerHTML += `æœ€è¿‘æ´»åŠ¨: ${logs.length} æ¡<br>`;
        resultEl.innerHTML += `è¿‡å»1å°æ—¶æ´»åŠ¨: ${summary.totalActivities} æ¡<br>`;
        resultEl.innerHTML += `ç‹¬ç«‹ç”¨æˆ·: ${summary.uniqueUsers} äºº`;
      } catch (e) {
        resultEl.innerHTML = `<span class="error">âŒ é”™è¯¯: ${e.message}</span>`;
      }
    }

    // æµ‹è¯•å®æ—¶æ›´æ–°
    async function testRealtimeUpdates() {
      const resultEl = document.getElementById('realtimeTestResult');
      resultEl.innerHTML = 'â³ æµ‹è¯•å®æ—¶æ›´æ–°ç›‘å¬...';
      
      let updateCount = 0;
      
      const handler = (e) => {
        updateCount++;
        resultEl.innerHTML += `<br>ğŸ“¡ æ”¶åˆ°æ›´æ–° #${updateCount}: ${e.detail.type}`;
      };
      
      window.addEventListener('community-update', handler);
      
      resultEl.innerHTML = `<span class="success">âœ… å®æ—¶æ›´æ–°ç›‘å¬å·²å¯åŠ¨</span><br>`;
      resultEl.innerHTML += 'ç­‰å¾…æ›´æ–°äº‹ä»¶...ï¼ˆåœ¨å…¶ä»–é¡µé¢æ“ä½œå¯è§¦å‘ï¼‰<br>';
      resultEl.innerHTML += `<button onclick="window.removeEventListener('community-update', ${handler})">åœæ­¢ç›‘å¬</button>`;
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    init();
  </script>
</body>
</html>
