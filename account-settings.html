<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è´¦å·è®¾ç½® - GameBox æ¸¸ç›’</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="index.css">
  <style>
    body {
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .settings-container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    .settings-header {
      text-align: center;
      margin-bottom: 50px;
    }
    
    .settings-header h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 42px;
      color: var(--accent);
      margin-bottom: 15px;
      text-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
    }
    
    .settings-header .icon {
      font-size: 60px;
      margin-bottom: 20px;
      display: block;
    }
    
    .settings-header p {
      color: var(--text-muted);
      font-size: 16px;
    }

    /* è®¾ç½®å¡ç‰‡ */
    .settings-card {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      border: 2px solid rgba(56, 189, 248, 0.3);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 25px;
      transition: all 0.3s ease;
    }

    .settings-card:hover {
      border-color: var(--accent);
      box-shadow: 0 5px 30px rgba(56, 189, 248, 0.2);
    }

    .settings-card h2 {
      font-family: 'Orbitron', sans-serif;
      font-size: 24px;
      color: var(--text-soft);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .settings-card h2 .icon {
      font-size: 28px;
    }

    /* è®¾ç½®é¡¹ */
    .setting-item {
      padding: 20px 0;
      border-bottom: 1px solid rgba(56, 189, 248, 0.1);
    }

    .setting-item:last-child {
      border-bottom: none;
    }

    .setting-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .setting-item-title {
      font-size: 16px;
      color: var(--text-soft);
      font-weight: 600;
    }

    .setting-item-desc {
      font-size: 14px;
      color: var(--text-muted);
      line-height: 1.6;
    }

    /* è¾“å…¥æ¡† */
    .input-group {
      margin-top: 15px;
    }

    .input-group label {
      display: block;
      color: var(--text-soft);
      font-size: 14px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .input-group input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 8px;
      color: var(--text-soft);
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .input-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.2);
    }

    .input-hint {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 6px;
    }

    /* æŒ‰é’® */
    .btn {
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
      font-family: 'Rajdhani', sans-serif;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), #00ff88);
      color: #000;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(56, 189, 248, 0.4);
    }

    .btn-secondary {
      background: rgba(56, 189, 248, 0.1);
      color: var(--accent);
      border: 1px solid var(--accent);
    }

    .btn-secondary:hover {
      background: rgba(56, 189, 248, 0.2);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid #ef4444;
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    /* è´¦å·ä¿¡æ¯æ˜¾ç¤º */
    .account-info {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .account-info-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .account-info-item:last-child {
      border-bottom: none;
    }

    .account-label {
      color: var(--text-muted);
      font-size: 14px;
    }

    .account-value {
      color: var(--text-soft);
      font-weight: 600;
      font-size: 14px;
    }

    /* è¿”å›æŒ‰é’® */
    .back-button {
      text-align: center;
      margin-top: 40px;
    }

    .back-button a {
      color: var(--accent);
      text-decoration: none;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .back-button a:hover {
      text-shadow: 0 0 10px rgba(56, 189, 248, 0.8);
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .settings-header h1 {
        font-size: 32px;
      }

      .settings-card {
        padding: 20px;
      }

      .btn-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="settings-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="settings-header">
      <span class="icon">âš™ï¸</span>
      <h1>è´¦å·è®¾ç½®</h1>
      <p>ç®¡ç†æ‚¨çš„è´¦å·ä¿¡æ¯ã€å¯†ç å’Œå…¶ä»–è´¦å·</p>
    </div>

    <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
    <div class="settings-card">
      <h2><span class="icon">ğŸ‘¤</span> åŸºæœ¬ä¿¡æ¯</h2>
      
      <div class="account-info">
        <div class="account-info-item">
          <span class="account-label">ç”¨æˆ·å</span>
          <span class="account-value" id="displayUsername">åŠ è½½ä¸­...</span>
        </div>
        <div class="account-info-item">
          <span class="account-label">é‚®ç®±</span>
          <span class="account-value" id="displayEmail">åŠ è½½ä¸­...</span>
        </div>
        <div class="account-info-item">
          <span class="account-label">æ³¨å†Œæ—¶é—´</span>
          <span class="account-value" id="displayCreatedAt">åŠ è½½ä¸­...</span>
        </div>
      </div>

      <div class="setting-item">
        <div class="setting-item-header">
          <div class="setting-item-title">æ›´æ–°æ‚¨çš„ç™»å½•å¯†ç </div>
        </div>
        <div class="setting-item-desc">
          å®šæœŸæ›´æ–°å¯†ç å¯ä»¥æé«˜è´¦å·å®‰å…¨æ€§
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showPasswordChange()">
            ğŸ”’ ä¿®æ”¹å¯†ç 
          </button>
        </div>
      </div>

      <div class="setting-item" id="passwordChangeSection" style="display: none;">
        <div class="input-group">
          <label>å½“å‰å¯†ç </label>
          <input type="password" id="currentPassword" placeholder="è¾“å…¥å½“å‰å¯†ç ">
        </div>
        <div class="input-group">
          <label>æ–°å¯†ç </label>
          <input type="password" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰">
        </div>
        <div class="input-group">
          <label>ç¡®è®¤æ–°å¯†ç </label>
          <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥æ–°å¯†ç ">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="changePassword()">
            ğŸ’¾ ä¿å­˜æ–°å¯†ç 
          </button>
          <button class="btn btn-secondary" onclick="hidePasswordChange()">
            âŒ å–æ¶ˆ
          </button>
        </div>
      </div>
    </div>

    <!-- è´¦å·åˆ‡æ¢å¡ç‰‡ -->
    <div class="settings-card">
      <h2><span class="icon">ğŸ”„</span> åˆ‡æ¢è´¦å·</h2>
      
      <div class="setting-item">
        <div class="setting-item-header">
          <div class="setting-item-title">ç™»å½•åˆ°å…¶ä»–è´¦å·</div>
        </div>
        <div class="setting-item-desc">
          å®‰å…¨é€€å‡ºå½“å‰è´¦å·å¹¶åˆ‡æ¢åˆ°å…¶ä»–è´¦å·
        </div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="switchAccount()">
            ğŸ”„ åˆ‡æ¢è´¦å·
          </button>
        </div>
      </div>
    </div>

    <!-- é€€å‡ºç™»å½•å¡ç‰‡ -->
    <div class="settings-card">
      <h2><span class="icon">ğŸšª</span> é€€å‡ºç™»å½•</h2>
      
      <div class="setting-item">
        <div class="setting-item-header">
          <div class="setting-item-title">å®‰å…¨é€€å‡ºå½“å‰è´¦å·</div>
        </div>
        <div class="setting-item-desc">
          é€€å‡ºåéœ€è¦é‡æ–°ç™»å½•æ‰èƒ½è®¿é—®æ‚¨çš„è´¦å·
        </div>
        <div class="btn-group">
          <button class="btn btn-danger" onclick="logout()">
            ğŸšª é€€å‡ºç™»å½•
          </button>
        </div>
      </div>
    </div>

    <!-- è¿”å›æŒ‰é’® -->
    <div class="back-button">
      <a href="profile.html">â† è¿”å›ç”¨æˆ·ä¸­å¿ƒ</a>
    </div>
  </div>

  <script src="supabase-config.js"></script>
  <script src="common.js"></script>
  <script>
    // =============================================
    // è´¦å·è®¾ç½®è„šæœ¬
    // =============================================

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadUserInfo() {
      try {
        // ç­‰å¾… GameBoxAuth åˆå§‹åŒ–
        if (typeof GameBoxAuth.init === 'function') {
          await GameBoxAuth.init();
        }
        
        // è·å–ç”¨æˆ·æ•°æ®
        let userData = GameBoxAuth.getCurrentUser();
        
        // å¦‚æœ getCurrentUser è¿”å› Promiseï¼Œç­‰å¾…å®ƒ
        if (userData instanceof Promise) {
          userData = await userData;
        }
        
        console.log('å½“å‰ç”¨æˆ·æ•°æ®:', userData);
      
        if (!userData) {
          console.log('æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ');
          window.location.href = 'login.html';
          return;
        }
      
        // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
        document.getElementById('displayUsername').textContent = userData.username || userData.email?.split('@')[0] || 'æœªçŸ¥ç”¨æˆ·';
        document.getElementById('displayEmail').textContent = userData.email || 'æœªè®¾ç½®é‚®ç®±';
      
        if (userData.createdAt) {
          const date = new Date(userData.createdAt);
          document.getElementById('displayCreatedAt').textContent = date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        } else if (userData.created_at) {
          const date = new Date(userData.created_at);
          document.getElementById('displayCreatedAt').textContent = date.toLocaleDateString('zh-CN', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
        } else {
          document.getElementById('displayCreatedAt').textContent = 'æœªçŸ¥';
        }
      
        console.log('ç”¨æˆ·ä¿¡æ¯åŠ è½½å®Œæˆ');
      } catch (error) {
        console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        document.getElementById('displayUsername').textContent = 'åŠ è½½å¤±è´¥';
        document.getElementById('displayEmail').textContent = 'åŠ è½½å¤±è´¥';
        document.getElementById('displayCreatedAt').textContent = 'åŠ è½½å¤±è´¥';
      }
    }

    // æ˜¾ç¤ºå¯†ç ä¿®æ”¹åŒºåŸŸ
    function showPasswordChange() {
      document.getElementById('passwordChangeSection').style.display = 'block';
    }

    // éšè—å¯†ç ä¿®æ”¹åŒºåŸŸ
    function hidePasswordChange() {
      document.getElementById('passwordChangeSection').style.display = 'none';
      // æ¸…ç©ºè¾“å…¥æ¡†
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    }

    // ä¿®æ”¹å¯†ç 
    async function changePassword() {
      const currentPassword = document.getElementById('currentPassword').value.trim();
      const newPassword = document.getElementById('newPassword').value.trim();
      const confirmPassword = document.getElementById('confirmPassword').value.trim();

      // éªŒè¯è¾“å…¥
      if (!currentPassword || !newPassword || !confirmPassword) {
        alert('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ');
        return;
      }

      if (newPassword.length < 6) {
        alert('æ–°å¯†ç è‡³å°‘éœ€è¦6ä½å­—ç¬¦');
        return;
      }

      if (newPassword !== confirmPassword) {
        alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´');
        return;
      }

      try {
        // ä½¿ç”¨ Supabase ä¿®æ”¹å¯†ç 
        if (typeof window._supabase !== 'undefined') {
          // å…ˆéªŒè¯å½“å‰å¯†ç 
          const userData = GameBoxAuth.getCurrentUser();
          const { error: signInError } = await window._supabase.auth.signInWithPassword({
            email: userData.email,
            password: currentPassword
          });

          if (signInError) {
            alert('å½“å‰å¯†ç é”™è¯¯');
            return;
          }

          // æ›´æ–°å¯†ç 
          const { error: updateError } = await window._supabase.auth.updateUser({
            password: newPassword
          });

          if (updateError) {
            throw updateError;
          }

          alert('âœ… å¯†ç ä¿®æ”¹æˆåŠŸï¼');
          hidePasswordChange();
        } else {
          // æœ¬åœ°å­˜å‚¨æ¨¡å¼ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
          alert('âš ï¸ æ¼”ç¤ºæ¨¡å¼ä¸‹æ— æ³•ä¿®æ”¹å¯†ç ');
          hidePasswordChange();
        }
      } catch (error) {
        console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
        alert('ä¿®æ”¹å¯†ç å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
      }
    }

    // åˆ‡æ¢è´¦å·
    function switchAccount() {
      if (confirm('ç¡®å®šè¦åˆ‡æ¢åˆ°å…¶ä»–è´¦å·å—ï¼Ÿ\n\nå½“å‰è´¦å·å°†ä¼šé€€å‡ºç™»å½•ã€‚')) {
        window.location.href = 'switch-account.html';
      }
    }

    // é€€å‡ºç™»å½•
    function logout() {
      if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
        window.location.href = 'logout-confirm.html';
      }
    }

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      loadUserInfo();
      console.log('âœ… è´¦å·è®¾ç½®é¡µé¢å·²åˆå§‹åŒ–');
    });
  </script>
</body>
</html>
