<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç´§æ€¥ä¿®å¤ - ç›´æ¥è¿è¡Œç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background: #f0f0f0;
    }
    .box {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #d32f2f;
      font-size: 28px;
      margin-bottom: 10px;
    }
    h2 {
      color: #1976d2;
      font-size: 20px;
      margin: 20px 0 10px 0;
    }
    button {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 5px;
      font-weight: bold;
    }
    button:hover {
      background: #b71c1c;
    }
    button.success {
      background: #4CAF50;
    }
    button.success:hover {
      background: #45a049;
    }
    #log {
      background: #263238;
      color: #aed581;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.8;
      min-height: 300px;
      max-height: 500px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .error { color: #ef5350; }
    .success { color: #66bb6a; }
    .warning { color: #ffa726; }
    .info { color: #42a5f5; }
    .config-box {
      background: #fff3cd;
      border: 2px solid #ffc107;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .step {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>ğŸš¨ ç´§æ€¥ä¿®å¤å·¥å…·</h1>
    <p style="font-size: 16px; color: #666;">
      è¿™ä¸ªå·¥å…·ä¼šç›´æ¥åœ¨æµè§ˆå™¨ä¸­åˆå§‹åŒ– Supabase å¹¶æµ‹è¯•è¿æ¥
    </p>
    
    <div class="config-box">
      <strong>ğŸ“ ä½ çš„ Supabase é…ç½®ï¼š</strong><br>
      URL: https://gybgiqyyltckgxbdtzwu.supabase.co<br>
      Key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...ï¼ˆå·²é…ç½®ï¼‰
    </div>
    
    <h2>ç¬¬ä¸€æ­¥ï¼šæµ‹è¯•ç›´æ¥è¿æ¥</h2>
    <button onclick="directTest()">ğŸ”Œ ç›´æ¥æµ‹è¯• Supabase è¿æ¥</button>
    
    <h2>ç¬¬äºŒæ­¥ï¼šåˆå§‹åŒ–å¹¶è·³è½¬</h2>
    <button class="success" onclick="initAndGo()">âœ… åˆå§‹åŒ–å¹¶æ‰“å¼€ç¤¾åŒºé¡µé¢</button>
    
    <h2>æ—¥å¿—è¾“å‡ºï¼š</h2>
    <div id="log">ç­‰å¾…æ“ä½œ...</div>
  </div>

  <script>
    // ç›´æ¥å†…åµŒé…ç½®ï¼Œä¸ä¾èµ–å¤–éƒ¨æ–‡ä»¶
    const SUPABASE_URL = 'https://gybgiqyyltckgxbdtzwu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd5YmdpcXl5bHRja2d4YmR0end1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4MTA2MDksImV4cCI6MjA4MDM4NjYwOX0.WWF_rPUyIVOFDccLXm06Npf6J3fJoA_bbFoVJeZQzrA';
    
    let supabaseClient = null;
    
    function log(msg, type = 'info') {
      const logEl = document.getElementById('log');
      const span = document.createElement('span');
      span.className = type;
      span.textContent = msg + '\n';
      logEl.appendChild(span);
      logEl.scrollTop = logEl.scrollHeight;
    }
    
    function clear() {
      document.getElementById('log').innerHTML = '';
    }
    
    async function directTest() {
      clear();
      log('='.repeat(60), 'info');
      log('ğŸš€ å¼€å§‹ç›´æ¥æµ‹è¯• Supabase è¿æ¥', 'info');
      log('='.repeat(60), 'info');
      log('');
      
      // æ­¥éª¤1: æ£€æŸ¥ SDK
      log('ã€æ­¥éª¤ 1/5ã€‘æ£€æŸ¥ Supabase SDK', 'info');
      if (typeof supabase === 'undefined') {
        log('âŒ Supabase SDK æœªåŠ è½½ï¼', 'error');
        log('è¯·åˆ·æ–°é¡µé¢é‡è¯•', 'error');
        return;
      }
      log('âœ… Supabase SDK å·²åŠ è½½', 'success');
      log('');
      
      // æ­¥éª¤2: åˆ›å»ºå®¢æˆ·ç«¯
      log('ã€æ­¥éª¤ 2/5ã€‘åˆ›å»º Supabase å®¢æˆ·ç«¯', 'info');
      log(`URL: ${SUPABASE_URL}`, 'info');
      log(`Key: ${SUPABASE_KEY.substring(0, 30)}...`, 'info');
      try {
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        log('âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
      } catch (e) {
        log('âŒ åˆ›å»ºå®¢æˆ·ç«¯å¤±è´¥: ' + e.message, 'error');
        return;
      }
      log('');
      
      // æ­¥éª¤3: æµ‹è¯•è¿æ¥
      log('ã€æ­¥éª¤ 3/5ã€‘æµ‹è¯•æ•°æ®åº“è¿æ¥', 'info');
      try {
        const { data, error } = await supabaseClient
          .from('community_posts')
          .select('id, title')
          .limit(3);
        
        if (error) {
          log('âŒ è¿æ¥å¤±è´¥', 'error');
          log(`é”™è¯¯ä»£ç : ${error.code}`, 'error');
          log(`é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
          log('', 'error');
          
          if (error.code === '42P01') {
            log('ğŸ“‹ é—®é¢˜è¯Šæ–­ï¼š', 'warning');
            log('  æ•°æ®åº“è¡¨ community_posts ä¸å­˜åœ¨', 'warning');
            log('', 'warning');
            log('ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š', 'info');
            log('  1. è®¿é—® https://supabase.com/dashboard/project/gybgiqyyltckgxbdtzwu/sql', 'info');
            log('  2. æ‰§è¡Œ supabase-init.sql è„šæœ¬', 'info');
            log('  3. è¿”å›æ­¤é¡µé¢é‡æ–°æµ‹è¯•', 'info');
          } else if (error.code === 'PGRST301') {
            log('ğŸ“‹ é—®é¢˜è¯Šæ–­ï¼š', 'warning');
            log('  RLS æƒé™é”™è¯¯', 'warning');
            log('', 'warning');
            log('ğŸ”§ è§£å†³æ–¹æ¡ˆï¼š', 'info');
            log('  åœ¨ SQL Editor æ‰§è¡Œ:', 'info');
            log('  ALTER TABLE community_posts DISABLE ROW LEVEL SECURITY;', 'info');
          }
          return;
        }
        
        log('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
        log(`æŸ¥è¯¢åˆ° ${data.length} æ¡å¸–å­:`, 'success');
        data.forEach((post, i) => {
          log(`  ${i + 1}. ${post.title || post.id}`, 'info');
        });
      } catch (e) {
        log('âŒ æµ‹è¯•å¼‚å¸¸: ' + e.message, 'error');
        return;
      }
      log('');
      
      // æ­¥éª¤4: æ£€æŸ¥æ‰€æœ‰è¡¨
      log('ã€æ­¥éª¤ 4/5ã€‘æ£€æŸ¥æ‰€æœ‰æ•°æ®åº“è¡¨', 'info');
      const tables = [
        'user_profiles',
        'community_posts',
        'community_comments',
        'community_likes',
        'community_stats',
        'online_users',
        'activity_logs',
        'user_platform_bindings'
      ];
      
      let okCount = 0;
      for (const table of tables) {
        const { error } = await supabaseClient.from(table).select('id').limit(1);
        if (error) {
          log(`  âŒ ${table} - é”™è¯¯ç : ${error.code}, ${error.message}`, 'error');
        } else {
          log(`  âœ… ${table}`, 'success');
          okCount++;
        }
      }
      log('');
      log(`ç»“æœ: ${okCount}/${tables.length} ä¸ªè¡¨æ­£å¸¸`, okCount === tables.length ? 'success' : 'warning');
      log('');
      
      // æ­¥éª¤5: å†™å…¥æµ‹è¯•
      log('ã€æ­¥éª¤ 5/5ã€‘æµ‹è¯•å†™å…¥æƒé™', 'info');
      try {
        const testId = 'test-' + Date.now();
        const { error: writeError } = await supabaseClient
          .from('activity_logs')
          .insert({
            id: testId,
            action: 'emergency_fix_test',
            details: { timestamp: new Date().toISOString() }
          });
        
        if (writeError) {
          log('âŒ å†™å…¥æµ‹è¯•å¤±è´¥: ' + writeError.message, 'error');
        } else {
          log('âœ… å†™å…¥æƒé™æ­£å¸¸', 'success');
          // æ¸…ç†æµ‹è¯•æ•°æ®
          await supabaseClient.from('activity_logs').delete().eq('id', testId);
          log('âœ… æµ‹è¯•æ•°æ®å·²æ¸…ç†', 'success');
        }
      } catch (e) {
        log('âŒ å†™å…¥æµ‹è¯•å¼‚å¸¸: ' + e.message, 'error');
      }
      
      log('');
      log('='.repeat(60), 'info');
      if (okCount === tables.length) {
        log('ğŸ‰ğŸ‰ğŸ‰ å®Œç¾ï¼æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼', 'success');
        log('', 'success');
        log('âœ… Supabase æ•°æ®åº“å®Œå…¨æ­£å¸¸', 'success');
        log('âœ… å¯ä»¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆå§‹åŒ–å¹¶æ‰“å¼€ç¤¾åŒºé¡µé¢', 'success');
      } else {
        log('âš ï¸ éƒ¨åˆ†æµ‹è¯•å¤±è´¥', 'warning');
        log('è¯·æ ¹æ®ä¸Šæ–¹æç¤ºä¿®å¤é—®é¢˜', 'warning');
      }
      log('='.repeat(60), 'info');
    }
    
    async function initAndGo() {
      clear();
      log('ğŸš€ æ­£åœ¨åˆå§‹åŒ– Supabase å¹¶å‡†å¤‡è·³è½¬...', 'info');
      log('');
      
      if (!supabaseClient) {
        log('åˆ›å»º Supabase å®¢æˆ·ç«¯...', 'info');
        supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      }
      
      // æµ‹è¯•è¿æ¥
      log('æµ‹è¯•è¿æ¥...', 'info');
      const { error } = await supabaseClient.from('community_posts').select('id').limit(1);
      
      if (error) {
        log('âŒ è¿æ¥å¤±è´¥: ' + error.message, 'error');
        log('è¯·å…ˆç‚¹å‡»"ç›´æ¥æµ‹è¯•"æŒ‰é’®æ’æŸ¥é—®é¢˜', 'error');
        return;
      }
      
      log('âœ… è¿æ¥æˆåŠŸï¼', 'success');
      log('');
      
      // å­˜å‚¨åˆå§‹åŒ–æ ‡è®°
      localStorage.setItem('supabase_manual_init', 'true');
      localStorage.setItem('supabase_init_time', Date.now().toString());
      
      log('âœ… åˆå§‹åŒ–æ ‡è®°å·²ä¿å­˜', 'success');
      log('');
      log('â³ 3ç§’åè·³è½¬åˆ°ç¤¾åŒºé¡µé¢...', 'warning');
      
      let countdown = 3;
      const timer = setInterval(() => {
        countdown--;
        if (countdown > 0) {
          log(`${countdown}...`, 'warning');
        } else {
          clearInterval(timer);
          log('ğŸš€ æ­£åœ¨è·³è½¬...', 'success');
          // è·³è½¬åˆ°ç¤¾åŒºé¡µé¢ï¼Œå¸¦æ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜
          window.location.href = `community.html?init=manual&t=${Date.now()}`;
        }
      }, 1000);
    }
  </script>
</body>
</html>
