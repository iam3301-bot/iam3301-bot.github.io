<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ğŸ”¥ ç»ˆæç¼“å­˜æ¸…ç†å·¥å…·</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      text-align: center;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 32px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 20px 40px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    .status {
      margin-top: 30px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.6;
      text-align: left;
      display: none;
    }
    .status.show {
      display: block;
    }
    .step {
      margin: 10px 0;
      padding: 10px;
      background: white;
      border-left: 4px solid #667eea;
      border-radius: 4px;
    }
    .success { color: #28a745; }
    .warning { color: #ffc107; }
    .error { color: #dc3545; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”¥ ç»ˆæç¼“å­˜æ¸…ç†å·¥å…·</h1>
    <p class="subtitle">ä¸€é”®æ¸…é™¤æ‰€æœ‰ç¼“å­˜ï¼Œå¼ºåˆ¶åŠ è½½æœ€æ–°ç‰ˆæœ¬</p>
    
    <button class="btn" onclick="clearAll()">
      ğŸš€ ç«‹å³æ¸…é™¤ç¼“å­˜å¹¶è·³è½¬
    </button>
    
    <button class="btn" onclick="testSupabase()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
      ğŸ§ª æµ‹è¯• Supabase è¿æ¥
    </button>
    
    <div id="status" class="status"></div>
  </div>

  <script>
    function log(msg, type = '') {
      const status = document.getElementById('status');
      status.classList.add('show');
      const step = document.createElement('div');
      step.className = 'step ' + type;
      step.textContent = msg;
      status.appendChild(step);
      console.log(msg);
    }
    
    async function clearAll() {
      document.getElementById('status').innerHTML = '';
      log('ğŸ”„ å¼€å§‹æ¸…ç†ç¼“å­˜...', 'warning');
      
      // 1. æ¸…é™¤ localStorage
      try {
        localStorage.clear();
        log('âœ… localStorage å·²æ¸…é™¤', 'success');
      } catch (e) {
        log('âŒ localStorage æ¸…é™¤å¤±è´¥: ' + e.message, 'error');
      }
      
      // 2. æ¸…é™¤ sessionStorage
      try {
        sessionStorage.clear();
        log('âœ… sessionStorage å·²æ¸…é™¤', 'success');
      } catch (e) {
        log('âŒ sessionStorage æ¸…é™¤å¤±è´¥: ' + e.message, 'error');
      }
      
      // 3. æ¸…é™¤ Service Worker
      if ('serviceWorker' in navigator) {
        try {
          const registrations = await navigator.serviceWorker.getRegistrations();
          for (let registration of registrations) {
            await registration.unregister();
          }
          log('âœ… Service Worker å·²æ¸…é™¤', 'success');
        } catch (e) {
          log('âš ï¸ Service Worker æ¸…é™¤å¤±è´¥: ' + e.message, 'warning');
        }
      }
      
      // 4. æ¸…é™¤æ‰€æœ‰ç¼“å­˜
      if ('caches' in window) {
        try {
          const cacheNames = await caches.keys();
          for (let name of cacheNames) {
            await caches.delete(name);
          }
          log('âœ… Cache API å·²æ¸…é™¤ (' + cacheNames.length + ' ä¸ªç¼“å­˜)', 'success');
        } catch (e) {
          log('âš ï¸ Cache API æ¸…é™¤å¤±è´¥: ' + e.message, 'warning');
        }
      }
      
      log('', '');
      log('ğŸ‰ æ¸…ç†å®Œæˆï¼å‡†å¤‡è·³è½¬...', 'success');
      log('â° 3 ç§’åè‡ªåŠ¨è·³è½¬åˆ°ç¤¾åŒºé¡µé¢', 'warning');
      
      setTimeout(() => {
        // æ·»åŠ æ—¶é—´æˆ³å¼ºåˆ¶åˆ·æ–°
        window.location.href = 'community.html?t=' + Date.now();
      }, 3000);
    }
    
    async function testSupabase() {
      document.getElementById('status').innerHTML = '';
      log('ğŸ§ª å¼€å§‹æµ‹è¯• Supabase è¿æ¥...', 'warning');
      
      // åŠ è½½ä¾èµ–
      if (typeof supabase === 'undefined') {
        log('ğŸ“¦ åŠ è½½ Supabase SDK...', 'warning');
        await loadScript('https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2');
        await new Promise(resolve => setTimeout(resolve, 1000));
      }
      
      if (typeof SUPABASE_CONFIG === 'undefined') {
        log('ğŸ“¦ åŠ è½½é…ç½®æ–‡ä»¶...', 'warning');
        await loadScript('supabase-config.js');
        await new Promise(resolve => setTimeout(resolve, 500));
      }
      
      if (typeof supabase === 'undefined') {
        log('âŒ Supabase SDK åŠ è½½å¤±è´¥', 'error');
        return;
      }
      
      if (typeof SUPABASE_CONFIG === 'undefined') {
        log('âŒ é…ç½®æ–‡ä»¶åŠ è½½å¤±è´¥', 'error');
        return;
      }
      
      log('âœ… ä¾èµ–åŠ è½½å®Œæˆ', 'success');
      log('', '');
      log('ğŸ“‹ é…ç½®ä¿¡æ¯:', 'warning');
      log('  URL: ' + SUPABASE_CONFIG.url, '');
      log('  Enabled: ' + SUPABASE_CONFIG.enabled, '');
      log('', '');
      
      if (!SUPABASE_CONFIG.enabled) {
        log('âŒ Supabase æœªå¯ç”¨', 'error');
        return;
      }
      
      try {
        log('ğŸ”Œ åˆ›å»º Supabase å®¢æˆ·ç«¯...', 'warning');
        const client = supabase.createClient(
          SUPABASE_CONFIG.url,
          SUPABASE_CONFIG.anonKey
        );
        log('âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
        
        log('', '');
        log('ğŸ” æµ‹è¯•æŸ¥è¯¢ community_posts...', 'warning');
        const { data, error } = await client
          .from('community_posts')
          .select('id, title')
          .limit(3);
        
        if (error) {
          log('âŒ æŸ¥è¯¢å¤±è´¥: ' + error.message, 'error');
          log('é”™è¯¯ç : ' + error.code, 'error');
        } else {
          log('âœ… æŸ¥è¯¢æˆåŠŸï¼', 'success');
          log('è¿”å›æ•°æ®: ' + JSON.stringify(data, null, 2), 'success');
          log('', '');
          log('ğŸ‰ Supabase è¿æ¥å®Œå…¨æ­£å¸¸ï¼', 'success');
          log('ğŸ’¡ é—®é¢˜å¯èƒ½åœ¨ community-data-service.js çš„åˆå§‹åŒ–é€»è¾‘', 'warning');
        }
      } catch (e) {
        log('âŒ æµ‹è¯•å¼‚å¸¸: ' + e.message, 'error');
      }
    }
    
    function loadScript(src) {
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = resolve;
        script.onerror = reject;
        document.head.appendChild(script);
      });
    }
  </script>
</body>
</html>
