<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æˆ‘çš„æ¸¸æˆ</title>
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
  <style>
    /* æˆ‘çš„æ¸¸æˆé¡µé¢ä¸“å±æ ·å¼ */
    .library-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, rgba(17, 24, 39, 0.95), rgba(31, 41, 55, 0.9));
      border: 1px solid rgba(102, 192, 244, 0.3);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover {
      border-color: #66c0f4;
      box-shadow: 0 0 20px rgba(102, 192, 244, 0.3);
      transform: translateY(-2px);
    }
    
    .stat-card .icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .stat-card .value {
      font-family: 'Orbitron', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: #66c0f4;
    }
    
    .stat-card .label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    .stat-card.steam {
      border-color: rgba(102, 192, 244, 0.5);
      background: linear-gradient(135deg, rgba(27, 40, 56, 0.95), rgba(42, 71, 94, 0.9));
    }
    
    /* æ¸¸æˆå¡ç‰‡å¢å¼º - ç²¾ç¾å¡ç‰‡è®¾è®¡ */
    .game-card-enhanced {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      aspect-ratio: 92 / 43; /* Steam header.jpg æ¯”ä¾‹ 460x215 */
      background: linear-gradient(145deg, #1a2634 0%, #0d1421 100%);
      border: 1px solid rgba(102, 192, 244, 0.15);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }
    
    .game-card-enhanced:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 20px 50px rgba(102, 192, 244, 0.25), 0 0 0 1px rgba(102, 192, 244, 0.5);
      border-color: rgba(102, 192, 244, 0.6);
    }
    
    .game-card-enhanced .game-cover {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    .game-card-enhanced .game-cover img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), filter 0.3s ease;
    }
    
    .game-card-enhanced:hover .game-cover img {
      transform: scale(1.08);
      filter: brightness(1.1);
    }
    
    /* å°é¢å ä½ç¬¦ - ç¾è§‚çš„æ¸å˜èƒŒæ™¯ */
    .game-card-enhanced .cover-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 48px;
      background: linear-gradient(145deg, #1e3a5f 0%, #0d1f35 50%, #0a1628 100%);
      color: rgba(102, 192, 244, 0.4);
    }
    
    .game-card-enhanced .cover-placeholder::after {
      content: attr(data-name);
      font-size: 14px;
      color: rgba(255,255,255,0.5);
      margin-top: 8px;
      max-width: 80%;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* å¡ç‰‡ä¿¡æ¯è¦†ç›–å±‚ - æ›´ç²¾è‡´çš„æ¸å˜ */
    .game-card-enhanced .game-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, 
        rgba(0,0,0,0.95) 0%, 
        rgba(0,0,0,0.85) 30%,
        rgba(0,0,0,0.5) 60%, 
        transparent 100%);
      padding: 50px 16px 14px 16px;
      transition: all 0.35s ease;
    }
    
    .game-card-enhanced:hover .game-overlay {
      background: linear-gradient(to top, 
        rgba(0,0,0,0.98) 0%, 
        rgba(0,0,0,0.9) 40%,
        rgba(0,0,0,0.6) 70%, 
        transparent 100%);
      padding-bottom: 18px;
    }
    
    /* æ¸¸æˆæ—¶é•¿å¾½ç«  */
    .game-card-enhanced .playtime-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 30, 48, 0.9) 100%);
      color: #66c0f4;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 192, 244, 0.3);
      display: flex;
      align-items: center;
      gap: 5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    
    /* Steam å¾½ç«  */
    .game-card-enhanced .steam-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: linear-gradient(135deg, rgba(27, 40, 56, 0.95) 0%, rgba(42, 71, 94, 0.9) 100%);
      color: #66c0f4;
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 5px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(102, 192, 244, 0.3);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    .game-card-enhanced .game-title {
      font-size: 15px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
      line-height: 1.3;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
    }
    
    .game-card-enhanced .game-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: rgba(255,255,255,0.7);
    }
    
    .game-card-enhanced .recent-play {
      color: #00ff88;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
    }
    
    .game-card-enhanced .view-btn {
      position: absolute;
      bottom: 16px;
      right: 16px;
      background: linear-gradient(135deg, #66c0f4, #4a9fd4);
      color: #000;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      opacity: 0;
      transform: translateY(10px);
      transition: all 0.3s ease;
    }
    
    .game-card-enhanced:hover .view-btn {
      opacity: 1;
      transform: translateY(0);
    }
    
    .game-card-enhanced .cover-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
      background: linear-gradient(135deg, #1b2838 0%, #2a475e 100%);
    }
    
    /* Steam è¿æ¥æç¤º */
    .steam-connect-banner {
      background: linear-gradient(135deg, rgba(27, 40, 56, 0.95), rgba(42, 71, 94, 0.9));
      border: 2px dashed rgba(102, 192, 244, 0.4);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      margin-bottom: 24px;
    }
    
    .steam-connect-banner h3 {
      color: #66c0f4;
      margin-bottom: 12px;
      font-size: 18px;
    }
    
    .steam-connect-banner p {
      color: var(--text-muted);
      margin-bottom: 16px;
      font-size: 14px;
    }
    
    .steam-connect-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 24px;
      background: linear-gradient(135deg, #1b2838, #2a475e);
      border: 2px solid #66c0f4;
      border-radius: 8px;
      color: #66c0f4;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
    }
    
    .steam-connect-btn:hover {
      background: linear-gradient(135deg, #2a475e, #3d6a8a);
      box-shadow: 0 0 20px rgba(102, 192, 244, 0.4);
      transform: translateY(-2px);
    }
    
    /* é€‰é¡¹å¡å¢å¼º */
    .tab-container {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .tab-btn {
      padding: 10px 20px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(56, 189, 248, 0.2);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .tab-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, rgba(56, 189, 248, 0.2), rgba(56, 189, 248, 0.1));
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .tab-btn .count {
      background: rgba(56, 189, 248, 0.2);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    
    /* æ¸¸æˆåˆ—è¡¨ç½‘æ ¼ - å“åº”å¼ç¾è§‚å¸ƒå±€ */
    .games-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding: 4px;
    }
    
    @media (min-width: 1400px) {
      .games-grid {
        grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        gap: 24px;
      }
    }
    
    @media (max-width: 768px) {
      .games-grid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
        gap: 16px;
      }
    }
    
    /* æ— é™æ»šåŠ¨åŠ è½½æç¤º */
    .load-more-trigger {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    
    .load-more-trigger .loading-spinner {
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid rgba(102, 192, 244, 0.3);
      border-top-color: #66c0f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .load-more-trigger.hidden {
      display: none;
    }
    
    /* æ»šåŠ¨æ¡ç¾åŒ– */
    .games-grid-container {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
      padding-right: 8px;
    }
    
    .games-grid-container::-webkit-scrollbar {
      width: 8px;
    }
    
    .games-grid-container::-webkit-scrollbar-track {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 4px;
    }
    
    .games-grid-container::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, #66c0f4, #4a9fd4);
      border-radius: 4px;
    }
    
    .games-grid-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, #7dd0ff, #5ab0e4);
    }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
    }
    
    .empty-state h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: var(--text-soft);
    }
    
    .empty-state p {
      font-size: 14px;
      margin-bottom: 20px;
    }
    
    /* æ’åºå’Œç­›é€‰ */
    .filter-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .filter-bar select {
      padding: 8px 12px;
      background: rgba(17, 24, 39, 0.8);
      border: 1px solid rgba(56, 189, 248, 0.3);
      border-radius: 6px;
      color: var(--text-main);
      font-size: 13px;
    }
  </style>
</head>
<body data-current-page="my" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user" id="headerUser">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">ğŸ® æˆ‘çš„æ¸¸æˆåº“</div>
        <div class="page-intro" id="libraryIntro">
          ç®¡ç†æ‚¨çš„æ¸¸æˆæ”¶è—ï¼ŒæŸ¥çœ‹SteamåŒæ­¥çš„æ¸¸æˆæ•°æ®å’Œæ¸¸ç©æ—¶é•¿ã€‚
        </div>
      </div>

      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="library-stats" id="libraryStats">
        <div class="stat-card steam">
          <div class="icon">ğŸ®</div>
          <div class="value" id="statSteamGames">0</div>
          <div class="label">Steam æ¸¸æˆ</div>
        </div>
        <div class="stat-card">
          <div class="icon">âœ…</div>
          <div class="value" id="statOwnedGames">0</div>
          <div class="label">æœ¬åœ°å·²æ‹¥æœ‰</div>
        </div>
        <div class="stat-card">
          <div class="icon">â­</div>
          <div class="value" id="statWishlistGames">0</div>
          <div class="label">æƒ³ç©åˆ—è¡¨</div>
        </div>
        <div class="stat-card steam">
          <div class="icon">â±ï¸</div>
          <div class="value" id="statTotalPlaytime">0h</div>
          <div class="label">æ€»æ¸¸æˆæ—¶é•¿</div>
        </div>
      </div>

      <!-- Steam è¿æ¥æç¤ºï¼ˆæœªç»‘å®šæ—¶æ˜¾ç¤ºï¼‰ -->
      <div class="steam-connect-banner" id="steamConnectBanner" style="display: none;">
        <h3>ğŸ® è¿æ¥æ‚¨çš„ Steam è´¦å·</h3>
        <p>ç»‘å®š Steam è´¦å·åï¼Œå¯ä»¥è‡ªåŠ¨åŒæ­¥æ‚¨çš„æ¸¸æˆåº“ã€æ¸¸ç©æ—¶é•¿å’Œæˆå°±æ•°æ®</p>
        <a href="steam-binding.html" class="steam-connect-btn">
          <svg viewBox="0 0 24 24" fill="currentColor" style="width: 20px; height: 20px;">
            <path d="M12 2C6.48 2 2 6.48 2 12c0 4.84 3.44 8.87 8 9.8V15H8v-3h2V9.5C10 7.57 11.57 6 13.5 6H16v3h-2c-.55 0-1 .45-1 1v2h3v3h-3v6.95c5.05-.5 9-4.76 9-9.95 0-5.52-4.48-10-10-10z"/>
          </svg>
          è¿æ¥ Steam è´¦å·
        </a>
      </div>

      <!-- é€‰é¡¹å¡ -->
      <div class="card">
        <div class="tab-container">
          <button class="tab-btn active" data-tab="steam">
            ğŸ® Steam æ¸¸æˆ <span class="count" id="tabSteamCount">0</span>
          </button>
          <button class="tab-btn" data-tab="owned">
            âœ… æœ¬åœ°å·²æ‹¥æœ‰ <span class="count" id="tabOwnedCount">0</span>
          </button>
          <button class="tab-btn" data-tab="wishlist">
            â­ æƒ³ç©åˆ—è¡¨ <span class="count" id="tabWishlistCount">0</span>
          </button>
          <button class="tab-btn" data-tab="recent">
            ğŸ”¥ æœ€è¿‘æ¸¸ç© <span class="count" id="tabRecentCount">0</span>
          </button>
        </div>
        
        <!-- ç­›é€‰å’Œæ’åº -->
        <div class="filter-bar">
          <div class="form-row" style="margin: 0;">
            <input id="gameSearch" type="text" placeholder="æœç´¢æ¸¸æˆ..." style="max-width: 300px;" />
          </div>
          <div style="display: flex; gap: 8px;">
            <select id="sortBy">
              <option value="playtime">æŒ‰æ¸¸æˆæ—¶é•¿</option>
              <option value="recent">æŒ‰æœ€è¿‘æ¸¸ç©</option>
              <option value="name">æŒ‰åç§°</option>
            </select>
          </div>
        </div>
      </div>

      <!-- æ¸¸æˆåˆ—è¡¨ - æ— é™æ»šåŠ¨ -->
      <div class="card">
        <div class="games-grid-container" id="gamesContainer">
          <div class="games-grid" id="gamesList"></div>
          <div class="load-more-trigger" id="loadMoreTrigger">
            <div class="loading-spinner"></div>
            <div>åŠ è½½æ›´å¤šæ¸¸æˆ...</div>
          </div>
        </div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ“Š æ¸¸æˆåº“æ¦‚è§ˆ</div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®æ¥æº</span>
          <span class="value" id="dataSource">Steam + æœ¬åœ°æ ‡è®°</span>
        </div>
        <div class="sidebar-item">
          <span class="label">æœ€ååŒæ­¥</span>
          <span class="value" id="lastSync">-</span>
        </div>
        <div class="sidebar-item">
          <span class="label">Steam çŠ¶æ€</span>
          <span class="value" id="steamStatus">æœªè¿æ¥</span>
        </div>
      </div>
      
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ¯ å¿«æ·æ“ä½œ</div>
        <div style="display: flex; flex-direction: column; gap: 8px;">
          <a href="game-library.html" class="btn btn-inline" style="text-align: center;">æµè§ˆæ¸¸æˆåº“</a>
          <a href="profile.html" class="btn btn-inline" style="text-align: center;">ç”¨æˆ·ä¸­å¿ƒ</a>
          <button class="btn btn-inline" onclick="syncSteamData()">ğŸ”„ åŒæ­¥ Steam</button>
        </div>
      </div>
      
      <div class="sidebar-card">
        <div class="sidebar-title">ğŸ’¡ ä½¿ç”¨æç¤º</div>
        <div style="font-size: 12px; color: var(--text-muted); line-height: 1.8;">
          <p>â€¢ ç»‘å®š Steam è‡ªåŠ¨åŒæ­¥æ¸¸æˆæ•°æ®</p>
          <p>â€¢ æœ¬åœ°æ ‡è®°çš„æ¸¸æˆä¿å­˜åœ¨æµè§ˆå™¨</p>
          <p>â€¢ æ¸¸æˆæ—¶é•¿æ¥è‡ª Steam å®˜æ–¹æ•°æ®</p>
          <p>â€¢ ç‚¹å‡»æ¸¸æˆå¡ç‰‡æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯</p>
        </div>
      </div>
    </aside>
  </main>
</div>

<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="supabase-config.js"></script>
<script src="mega-game-database.js"></script>
<script>
  initCommon();
  
  // åˆå§‹åŒ–
  let currentTab = 'steam';
  let steamGames = [];
  let ownedGames = [];
  let wishlistGames = [];
  let allGamesData = [];
  let currentUser = null;
  let userData = null;
  
  // åˆå§‹åŒ–é¡µé¢
  async function init() {
    // åˆå§‹åŒ–è®¤è¯
    await GameBoxAuth.init();
    SteamAPI.init();
    
    currentUser = await GameBoxAuth.getCurrentUser();
    
    if (currentUser) {
      userData = UserDataManager.getData(currentUser.id);
      document.getElementById('headerUser').textContent = currentUser.username || 'ç©å®¶';
    }
    
    // åŠ è½½æœ¬åœ°æ¸¸æˆæ•°æ®åº“
    try {
      allGamesData = await window.megaGameDB.getAllGames();
      console.log(`âœ… æ¸¸æˆæ•°æ®åº“åŠ è½½å®Œæˆ: ${allGamesData.length} æ¬¾`);
    } catch (e) {
      console.error('åŠ è½½æ¸¸æˆæ•°æ®åº“å¤±è´¥:', e);
    }
    
    // åŠ è½½å„ç±»æ¸¸æˆæ•°æ®
    loadSteamGames();
    loadLocalGames();
    updateStats();
    renderGames();
    updateSidebarInfo();
    
    // æ£€æŸ¥ Steam ç»‘å®šçŠ¶æ€
    checkSteamStatus();
  }
  
  // æ£€æŸ¥ Steam ç»‘å®šçŠ¶æ€
  function checkSteamStatus() {
    const steamLinked = userData?.steam?.linked;
    const steamBanner = document.getElementById('steamConnectBanner');
    const steamStatusEl = document.getElementById('steamStatus');
    
    if (steamLinked) {
      steamBanner.style.display = 'none';
      steamStatusEl.textContent = 'âœ… å·²è¿æ¥';
      steamStatusEl.style.color = '#00ff88';
    } else {
      steamBanner.style.display = 'block';
      steamStatusEl.textContent = 'âŒ æœªè¿æ¥';
      steamStatusEl.style.color = '#ff5555';
    }
  }
  
  // åŠ è½½ Steam æ¸¸æˆ
  function loadSteamGames() {
    steamGames = [];
    
    if (userData?.steam?.linked && userData.steam.games) {
      console.log('ğŸ“¦ åŸå§‹ Steam æ¸¸æˆæ•°æ®:', userData.steam.games.slice(0, 2));
      
      steamGames = userData.steam.games.map(game => {
        // ç¡®ä¿è·å–æ­£ç¡®çš„ AppID (å¿…é¡»æ˜¯æ•°å­—)
        const appId = game.appId || game.appid || game.id;
        const validAppId = appId && /^\d+$/.test(String(appId)) ? appId : null;
        
        return {
          id: validAppId,
          appId: validAppId,
          name: game.name,
          playtimeForever: game.playtimeForever || game.playtime_forever || 0,
          playtime2Weeks: game.playtime2Weeks || game.playtime_2weeks || 0,
          thumbnail: game.headerImage || (validAppId ? `https://cdn.cloudflare.steamstatic.com/steam/apps/${validAppId}/header.jpg` : ''),
          source: 'steam',
          lastPlayed: game.playtime2Weeks > 0 ? Date.now() : null
        };
      });
      
      console.log(`âœ… åŠ è½½ Steam æ¸¸æˆ: ${steamGames.length} æ¬¾`, steamGames.slice(0, 2));
    }
    
    // ä¹Ÿæ£€æŸ¥ç”¨æˆ·ä¸“å±çš„ steam_bindingï¼ˆä½¿ç”¨å½“å‰ç”¨æˆ· IDï¼‰
    if (steamGames.length === 0 && currentUser?.id) {
      const userSteamBindingKey = 'steam_binding_' + currentUser.id;
      const steamBinding = localStorage.getItem(userSteamBindingKey);
      
      if (steamBinding) {
        try {
          const bindingData = JSON.parse(steamBinding);
          console.log('ğŸ“¦ ç”¨æˆ·ä¸“å± steam_binding æ•°æ®:', bindingData.games?.slice(0, 2));
          
          // éªŒè¯ç»‘å®šæ•°æ®çš„ç”¨æˆ· ID
          if (bindingData.userId && bindingData.userId !== currentUser.id) {
            console.warn('[Library] Steam ç»‘å®šæ•°æ®çš„ç”¨æˆ· ID ä¸åŒ¹é…ï¼Œå¿½ç•¥');
          } else if (bindingData.games && bindingData.games.length > 0) {
            steamGames = bindingData.games.map(game => {
              const appId = game.appid || game.appId || game.id;
              const validAppId = appId && /^\d+$/.test(String(appId)) ? appId : null;
              
              return {
                id: validAppId,
                appId: validAppId,
                name: game.name,
                playtimeForever: game.playtimeForever || game.playtime_forever || 0,
                playtime2Weeks: game.playtime2Weeks || game.playtime_2weeks || 0,
                thumbnail: validAppId ? `https://cdn.cloudflare.steamstatic.com/steam/apps/${validAppId}/header.jpg` : '',
                source: 'steam',
                lastPlayed: game.playtime2Weeks > 0 ? Date.now() : null
              };
            });
            console.log(`âœ… ä» steam_binding_${currentUser.id} åŠ è½½æ¸¸æˆ: ${steamGames.length} æ¬¾`);
          }
        } catch (e) {
          console.error('è§£æ steam_binding å¤±è´¥:', e);
        }
      }
    }
  }
  
  // åŠ è½½æœ¬åœ°æ ‡è®°çš„æ¸¸æˆ
  function loadLocalGames() {
    // å·²æ‹¥æœ‰
    const ownedIds = getLocalList('ownedGames');
    ownedGames = ownedIds.map(id => {
      const game = findGameById(id);
      return game ? { ...game, source: 'local' } : {
        id: id,
        name: id,
        source: 'local',
        thumbnail: ''
      };
    });
    
    // æƒ³ç©
    const wishlistIds = getLocalList('wishlistGames');
    wishlistGames = wishlistIds.map(id => {
      const game = findGameById(id);
      return game ? { ...game, source: 'local' } : {
        id: id,
        name: id,
        source: 'local',
        thumbnail: ''
      };
    });
  }
  
  // è·å–æœ¬åœ°åˆ—è¡¨
  function getLocalList(key) {
    try {
      return JSON.parse(localStorage.getItem(key) || '[]');
    } catch {
      return [];
    }
  }
  
  // æ ¹æ®IDæŸ¥æ‰¾æ¸¸æˆ
  function findGameById(id) {
    return allGamesData.find(g => 
      g.id === id || 
      g.name?.toLowerCase() === id?.toLowerCase()
    );
  }
  
  // æ›´æ–°ç»Ÿè®¡
  function updateStats() {
    const totalPlaytime = steamGames.reduce((sum, g) => sum + (g.playtimeForever || 0), 0);
    const recentGames = steamGames.filter(g => g.playtime2Weeks > 0);
    
    document.getElementById('statSteamGames').textContent = steamGames.length;
    document.getElementById('statOwnedGames').textContent = ownedGames.length;
    document.getElementById('statWishlistGames').textContent = wishlistGames.length;
    document.getElementById('statTotalPlaytime').textContent = formatPlaytimeShort(totalPlaytime);
    
    // æ›´æ–°é€‰é¡¹å¡è®¡æ•°
    document.getElementById('tabSteamCount').textContent = steamGames.length;
    document.getElementById('tabOwnedCount').textContent = ownedGames.length;
    document.getElementById('tabWishlistCount').textContent = wishlistGames.length;
    document.getElementById('tabRecentCount').textContent = recentGames.length;
  }
  
  // æ ¼å¼åŒ–æ—¶é•¿ï¼ˆçŸ­ï¼‰
  function formatPlaytimeShort(minutes) {
    if (!minutes) return '0h';
    const hours = Math.floor(minutes / 60);
    if (hours < 1) return `${minutes}m`;
    return `${hours}h`;
  }
  
  // æ ¼å¼åŒ–æ—¶é•¿ï¼ˆé•¿ï¼‰
  function formatPlaytime(minutes) {
    if (!minutes) return 'æœªæ¸¸ç©';
    if (minutes < 60) return `${minutes} åˆ†é’Ÿ`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    if (hours < 24) return mins > 0 ? `${hours} å°æ—¶ ${mins} åˆ†é’Ÿ` : `${hours} å°æ—¶`;
    const days = Math.floor(hours / 24);
    const remainHours = hours % 24;
    return `${days} å¤© ${remainHours} å°æ—¶`;
  }
  
  // æ— é™æ»šåŠ¨ç›¸å…³å˜é‡
  let currentPage = 0;
  const pageSize = 12; // æ¯æ¬¡åŠ è½½12ä¸ªæ¸¸æˆ
  let allFilteredGames = [];
  let isLoading = false;
  
  // æ¸²æŸ“æ¸¸æˆåˆ—è¡¨ - æ”¯æŒæ— é™æ»šåŠ¨
  function renderGames(reset = true) {
    const container = document.getElementById('gamesList');
    const searchText = document.getElementById('gameSearch').value.toLowerCase();
    const sortBy = document.getElementById('sortBy').value;
    
    let games = [];
    
    switch (currentTab) {
      case 'steam':
        games = [...steamGames];
        break;
      case 'owned':
        games = [...ownedGames];
        break;
      case 'wishlist':
        games = [...wishlistGames];
        break;
      case 'recent':
        games = steamGames.filter(g => g.playtime2Weeks > 0);
        break;
    }
    
    // æœç´¢è¿‡æ»¤
    if (searchText) {
      games = games.filter(g => 
        g.name?.toLowerCase().includes(searchText)
      );
    }
    
    // æ’åº
    switch (sortBy) {
      case 'playtime':
        games.sort((a, b) => (b.playtimeForever || 0) - (a.playtimeForever || 0));
        break;
      case 'recent':
        games.sort((a, b) => (b.playtime2Weeks || 0) - (a.playtime2Weeks || 0));
        break;
      case 'name':
        games.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
        break;
    }
    
    // é‡ç½®æ—¶æ¸…ç©ºå¹¶ä»å¤´å¼€å§‹
    if (reset) {
      currentPage = 0;
      allFilteredGames = games;
      container.innerHTML = '';
    }
    
    // æ¸²æŸ“ç©ºçŠ¶æ€
    if (allFilteredGames.length === 0) {
      renderEmptyState(container);
      document.getElementById('loadMoreTrigger').classList.add('hidden');
      return;
    }
    
    // åŠ è½½å½“å‰é¡µçš„æ¸¸æˆ
    loadMoreGames();
  }
  
  // åŠ è½½æ›´å¤šæ¸¸æˆ
  function loadMoreGames() {
    if (isLoading) return;
    
    const container = document.getElementById('gamesList');
    const trigger = document.getElementById('loadMoreTrigger');
    const start = currentPage * pageSize;
    const end = start + pageSize;
    const gamesToLoad = allFilteredGames.slice(start, end);
    
    if (gamesToLoad.length === 0) {
      trigger.classList.add('hidden');
      return;
    }
    
    isLoading = true;
    
    // æ·»åŠ æ¸¸æˆå¡ç‰‡
    const fragment = document.createDocumentFragment();
    gamesToLoad.forEach(game => {
      const div = document.createElement('div');
      div.innerHTML = renderGameCard(game);
      fragment.appendChild(div.firstElementChild);
    });
    container.appendChild(fragment);
    
    currentPage++;
    isLoading = false;
    
    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤š
    if (end >= allFilteredGames.length) {
      trigger.classList.add('hidden');
    } else {
      trigger.classList.remove('hidden');
    }
  }
  
  // çŸ¥åæ¸¸æˆ AppID æ˜ å°„è¡¨ (ç”¨äºæ²¡æœ‰ AppID æ—¶çš„é™çº§æ–¹æ¡ˆ)
  const KNOWN_GAMES = {
    'terraria': 105600,
    'counter-strike 2': 730,
    'cs2': 730,
    'counter strike 2': 730,
    'pubg: battlegrounds': 578080,
    'pubg battlegrounds': 578080,
    'playerunknown\'s battlegrounds': 578080,
    'dota 2': 570,
    'elden ring': 1245620,
    'cyberpunk 2077': 1091500,
    'black myth: wukong': 2358720,
    'black myth wukong': 2358720,
    'baldur\'s gate 3': 1086940,
    'baldurs gate 3': 1086940,
    'monster hunter: world': 582010,
    'monster hunter world': 582010,
    'hollow knight': 367520,
    'hollow knight: silksong': 1030300,
    'stardew valley': 413150,
    'hades': 1145360,
    'celeste': 504230,
    'dead cells': 588650,
    'the witcher 3': 292030,
    'witcher 3': 292030,
    'red dead redemption 2': 1174180,
    'gta v': 271590,
    'grand theft auto v': 271590,
    'rust': 252490,
    'ark': 346110,
    'valheim': 892970,
    'satisfactory': 526870,
    'factorio': 427520,
    'rimworld': 294100,
    'don\'t starve together': 322330,
    'dont starve together': 322330,
    'persona 5 royal': 1687950,
    'persona 4 golden': 1113000,
    'persona 3 reload': 2161700,
    'yu-gi-oh! master duel': 1449850,
    'yugioh master duel': 1449850,
    'wallpaper engine': 431960,
    '3dmark': 223850,
    'split fiction': 2001120,
    'the alters': 1578060,
    'battlefield 1': 1238840,
    'battlefield v': 1238810,
    'mydockfinder': 1454190,
    'tmodloader': 1281930,
    'forza horizon 5': 1551360,
    'forza horizon 4': 1293830,
    'hogwarts legacy': 1817070,
    'delta force': 2507950,
    'yakuza: like a dragon': 1235140,
    'yakuza like a dragon': 1235140,
  };
  
  // é€šè¿‡æ¸¸æˆåè·å– AppID
  function getAppIdByName(name) {
    if (!name) return null;
    const normalizedName = name.toLowerCase().trim();
    return KNOWN_GAMES[normalizedName] || null;
  }

  // æ¸²æŸ“å•ä¸ªæ¸¸æˆå¡ç‰‡ - å…¨å°é¢è®¾è®¡
  function renderGameCard(game) {
    const playtimeText = formatPlaytime(game.playtimeForever);
    const recentText = game.playtime2Weeks > 0 ? `è¿‘ä¸¤å‘¨: ${formatPlaytime(game.playtime2Weeks)}` : '';
    const isSteam = game.source === 'steam';
    
    // è·å– Steam AppID - å¿…é¡»æ˜¯çº¯æ•°å­—
    let gameId = game.appId || game.appid || game.id;
    
    // ç¡®ä¿ gameId æ˜¯æœ‰æ•ˆçš„ Steam AppID (çº¯æ•°å­—)
    if (gameId && !/^\d+$/.test(String(gameId))) {
      gameId = null;
    }
    
    // å¦‚æœæ²¡æœ‰æœ‰æ•ˆ AppIDï¼Œå°è¯•é€šè¿‡æ¸¸æˆååŒ¹é…
    if (!gameId && game.name) {
      gameId = getAppIdByName(game.name);
      if (gameId) {
        console.log(`ğŸ¯ é€šè¿‡æ¸¸æˆååŒ¹é… AppID: ${game.name} -> ${gameId}`);
      }
    }
    
    // Steam é«˜æ¸…å°é¢å›¾ URL
    const steamCoverUrl = gameId ? `https://cdn.cloudflare.steamstatic.com/steam/apps/${gameId}/header.jpg` : '';
    const steamCoverFallback = gameId ? `https://cdn.cloudflare.steamstatic.com/steam/apps/${gameId}/capsule_616x353.jpg` : '';
    
    // ç¡®å®šå°é¢ URL
    let coverUrl = '';
    if (game.thumbnail && game.thumbnail.startsWith('http')) {
      coverUrl = game.thumbnail;
    } else if (gameId) {
      coverUrl = steamCoverUrl;
    }
    
    // å®‰å…¨å¤„ç†æ¸¸æˆåç§°
    const safeName = (game.name || 'Unknown').replace(/['"<>&]/g, '').substring(0, 25);
    
    // å ä½ç¬¦ HTML
    const placeholderHTML = `<div class="cover-placeholder" data-name="${safeName}">ğŸ®</div>`;
    
    // å°é¢å›¾æ˜¾ç¤ºé€»è¾‘
    let coverImg;
    if (coverUrl) {
      coverImg = `<img 
        src="${coverUrl}" 
        alt="${safeName}" 
        loading="lazy"
        style="width:100%;height:100%;object-fit:cover;"
        onerror="this.onerror=null;this.src='${steamCoverFallback || coverUrl}';this.onerror=function(){this.parentElement.innerHTML='${placeholderHTML.replace(/'/g, "\\'")}';}" 
      />`;
    } else {
      coverImg = placeholderHTML;
    }
    
    // ç‚¹å‡»äº‹ä»¶å¤„ç†
    const clickHandler = isSteam 
      ? `onclick="window.open('https://store.steampowered.com/app/${gameId}', '_blank')"` 
      : `onclick="window.location.href='game-detail.html?id=${gameId}&name=${encodeURIComponent(game.name)}'" `;
    
    // Steam å¾½ç«  SVG
    const steamBadge = isSteam ? `
      <div class="steam-badge">
        <svg viewBox="0 0 24 24" fill="currentColor" style="width:12px;height:12px;">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/>
        </svg>
        Steam
      </div>` : '';
    
    // æ¸¸æˆæ—¶é•¿å¾½ç« 
    const playtimeBadge = game.playtimeForever > 0 
      ? `<div class="playtime-badge">ğŸ® ${formatPlaytimeShort(game.playtimeForever)}</div>` 
      : '';
    
    return `
      <div class="game-card-enhanced" data-id="${gameId}" data-name="${game.name}" ${clickHandler}>
        <div class="game-cover">
          ${coverImg}
        </div>
        ${steamBadge}
        ${playtimeBadge}
        <div class="game-overlay">
          <div class="game-title">${game.name}</div>
          <div class="game-meta">
            <span>æ€»è®¡ ${playtimeText}</span>
          </div>
          ${recentText ? `<div class="recent-play">ğŸ”¥ ${recentText}</div>` : ''}
        </div>
        <div class="view-btn">${isSteam ? 'ğŸ”— Steam å•†åº—' : 'ğŸ“– è¯¦æƒ…'}</div>
      </div>
    `;
  }
  
  // æ¸²æŸ“ç©ºçŠ¶æ€
  function renderEmptyState(container) {
    let message = '';
    let action = '';
    
    switch (currentTab) {
      case 'steam':
        if (userData?.steam?.linked) {
          message = 'æ‚¨çš„ Steam æ¸¸æˆåº“ä¸ºç©º';
          action = '<button class="btn btn-primary" onclick="syncSteamData()">ğŸ”„ åŒæ­¥ Steam æ•°æ®</button>';
        } else {
          message = 'å°šæœªè¿æ¥ Steam è´¦å·';
          action = '<a href="steam-binding.html" class="btn btn-primary">ğŸ® è¿æ¥ Steam</a>';
        }
        break;
      case 'owned':
        message = 'è¿˜æ²¡æœ‰æ ‡è®°å·²æ‹¥æœ‰çš„æ¸¸æˆ';
        action = '<a href="game-library.html" class="btn btn-primary">ğŸ® æµè§ˆæ¸¸æˆåº“</a>';
        break;
      case 'wishlist':
        message = 'æƒ³ç©åˆ—è¡¨ä¸ºç©º';
        action = '<a href="game-library.html" class="btn btn-primary">ğŸ® å‘ç°æ–°æ¸¸æˆ</a>';
        break;
      case 'recent':
        message = 'æœ€è¿‘ä¸¤å‘¨æ²¡æœ‰æ¸¸ç©è®°å½•';
        action = '';
        break;
    }
    
    container.innerHTML = `
      <div class="empty-state" style="grid-column: 1/-1;">
        <div class="icon">ğŸ“¦</div>
        <h3>${message}</h3>
        <p>å¼€å§‹æ¢ç´¢å¹¶æ·»åŠ æ‚¨å–œæ¬¢çš„æ¸¸æˆå§ï¼</p>
        ${action}
      </div>
    `;
  }
  
  // æ›´æ–°ä¾§è¾¹æ ä¿¡æ¯
  function updateSidebarInfo() {
    const lastSync = userData?.steam?.lastSync;
    if (lastSync) {
      const date = new Date(lastSync);
      document.getElementById('lastSync').textContent = date.toLocaleDateString('zh-CN');
    }
  }
  
  // åŒæ­¥ Steam æ•°æ®
  async function syncSteamData() {
    if (!currentUser) {
      alert('è¯·å…ˆç™»å½•');
      window.location.href = 'login.html';
      return;
    }
    
    if (!userData?.steam?.linked) {
      if (confirm('æ‚¨è¿˜æœªç»‘å®š Steam è´¦å·ï¼Œæ˜¯å¦å‰å¾€ç»‘å®šï¼Ÿ')) {
        window.location.href = 'steam-binding.html';
      }
      return;
    }
    
    try {
      const result = await UserDataManager.syncSteam(currentUser.id);
      if (result.success) {
        userData = UserDataManager.getData(currentUser.id);
        loadSteamGames();
        updateStats();
        renderGames();
        updateSidebarInfo();
        alert('âœ… Steam æ•°æ®åŒæ­¥æˆåŠŸï¼');
      } else {
        alert('âŒ åŒæ­¥å¤±è´¥: ' + result.error);
      }
    } catch (error) {
      alert('âŒ åŒæ­¥å¤±è´¥: ' + error.message);
    }
  }
  
  // æ— é™æ»šåŠ¨ç›‘å¬
  function setupInfiniteScroll() {
    const container = document.getElementById('gamesContainer');
    const trigger = document.getElementById('loadMoreTrigger');
    
    // ä½¿ç”¨Intersection Observerå®ç°æ— é™æ»šåŠ¨
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !isLoading) {
          loadMoreGames();
        }
      });
    }, {
      root: container,
      rootMargin: '100px',
      threshold: 0.1
    });
    
    observer.observe(trigger);
    
    // åŒæ—¶æ”¯æŒæ»šåŠ¨äº‹ä»¶ä½œä¸ºåå¤‡
    container.addEventListener('scroll', () => {
      const { scrollTop, scrollHeight, clientHeight } = container;
      if (scrollTop + clientHeight >= scrollHeight - 200 && !isLoading) {
        loadMoreGames();
      }
    });
  }
  
  // é€‰é¡¹å¡åˆ‡æ¢
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentTab = btn.dataset.tab;
      renderGames(true); // é‡ç½®å¹¶é‡æ–°åŠ è½½
    });
  });
  
  // æœç´¢å’Œæ’åº
  document.getElementById('gameSearch').addEventListener('input', () => renderGames(true));
  document.getElementById('sortBy').addEventListener('change', () => renderGames(true));
  
  // åˆå§‹åŒ–
  init();
  
  // è®¾ç½®æ— é™æ»šåŠ¨
  setupInfiniteScroll();
</script>
</body>
</html>
