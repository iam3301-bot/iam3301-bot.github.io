<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>GameBox æ¸¸ç›’ - æˆ‘çš„æ¸¸æˆ</title>
  <!-- Cyberpunk Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="index.css" />
</head>
<body data-current-page="my" class="cyberpunk-theme">
<div class="page">
  <header class="header">
    <div class="header-inner">
      <a href="index.html" class="logo">
        <div class="logo-mark">G</div>
        <div>
          <div>GameBox æ¸¸ç›’</div>
          <div class="logo-sub">LIGHTWEIGHT GAME HUB</div>
        </div>
      </a>
      <nav class="nav-main">
        <a href="index.html" data-page="home" class="nav-link">é¦–é¡µ</a>
        <a href="news-list.html" data-page="news" class="nav-link">èµ„è®¯</a>
        <a href="game-library.html" data-page="library" class="nav-link">æ¸¸æˆåº“</a>
        <a href="ranking.html" data-page="ranking" class="nav-link">
          æ’è¡Œæ¦œ <span class="badge">HOT</span>
        </a>
        <a href="discount.html" data-page="discount" class="nav-link">æŠ˜æ‰£ / å²ä½</a>
        <a href="community.html" data-page="community" class="nav-link">ç¤¾åŒº</a>
        <a href="my-library.html" data-page="my" class="nav-link">æˆ‘çš„æ¸¸æˆ</a>
        <a href="tools.html" data-page="tools" class="nav-link">å·¥å…·ä¸­å¿ƒ</a>
        <a href="profile.html" data-page="profile" class="nav-link">ç”¨æˆ·ä¸­å¿ƒ</a>
      </nav>
      <div class="header-right">
        <div class="header-search">
          <input type="text" placeholder="æœç´¢æ¸¸æˆ / èµ„è®¯ / å¸–å­" />
          <span class="header-search-icon">ğŸ”</span>
        </div>
        <button class="header-user">æœªç™»å½• Â· æ¸¸å®¢</button>
      </div>
    </div>
  </header>
  
  <!-- Cyberpunk Effects -->
  <canvas id="matrix-canvas" class="matrix-bg"></canvas>
  <div id="particles-container" class="particles-container"></div>
  <div id="scroll-progress" class="scroll-progress"></div>
  <div id="loading-overlay" class="loading-overlay">
    <div class="cyberpunk-loader">
      <div class="loader-hexagon"></div>
      <div class="loader-text">LOADING...</div>
    </div>
  </div>

  <main class="main">
    <section>
      <div class="card">
        <div class="page-title">æˆ‘çš„æ¸¸æˆ</div>
        <div class="page-intro">
          è¿™é‡Œä»æµè§ˆå™¨ localStorage ä¸­è¯»å–â€œå·²æ‹¥æœ‰â€å’Œâ€œæƒ³ç©â€çš„æ¸¸æˆ IDï¼Œå¹¶è½¬æˆå¯é˜…è¯»åˆ—è¡¨ã€‚
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title"><span class="dot"></span><span>åˆ—è¡¨ç±»å‹</span></div>
        </header>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
          <button class="btn btn-primary btn-inline" id="tabOwned">å·²æ‹¥æœ‰</button>
          <button class="btn btn-inline" id="tabWish">æƒ³ç©</button>
        </div>
        <div class="form">
          <div class="form-row">
            <label for="mySearch">æŒ‰åç§°æœç´¢</label>
            <input id="mySearch" type="text" placeholder="ä¾‹å¦‚ï¼šè‰¾å°”ç™»æ³•ç¯" />
          </div>
        </div>
      </div>

      <div class="card">
        <header class="card-header">
          <div class="card-title"><span class="dot"></span><span>æˆ‘çš„åˆ—è¡¨</span></div>
          <div class="chip" id="myCount">å…± 0 æ¬¾</div>
        </header>
        <div id="myList" class="game-list"></div>
      </div>
    </section>

    <aside>
      <div class="sidebar-card">
        <div class="sidebar-title">è¯´æ˜</div>
        <div class="sidebar-item">
          <span class="label">æ•°æ®æ¥æº</span><span class="value">game-detail æ ‡è®°ç»“æœ</span>
        </div>
        <div class="sidebar-item">
          <span class="label">å­˜å‚¨</span><span class="value">localStorage</span>
        </div>
      </div>
    </aside>
  </main>
</div>


<script src="common.js"></script>
<script src="cyber-effects.js"></script>
<script src="enhanced-game-api.js"></script>
<script>
  initCommon();

  const myListEl = document.getElementById("myList");
  const myCountEl = document.getElementById("myCount");
  const mySearchEl = document.getElementById("mySearch");
  const tabOwned = document.getElementById("tabOwned");
  const tabWish = document.getElementById("tabWish");

  let currentType = "owned"; // owned / wish
  let allGamesData = [];
  let isDataLoaded = false;

  // åŠ è½½æ¸¸æˆæ•°æ®
  async function loadGamesData() {
    try {
      allGamesData = await window.enhancedGameAPI.getAllGames();
      isDataLoaded = true;
      console.log(`âœ… æ¸¸æˆæ•°æ®åŠ è½½å®Œæˆï¼š${allGamesData.length} æ¬¾`);
      renderMyList();
    } catch (error) {
      console.error("âŒ åŠ è½½æ¸¸æˆæ•°æ®å¤±è´¥:", error);
      myListEl.innerHTML = '<div style="padding:20px;text-align:center;color:var(--danger);">âŒ æ•°æ®åŠ è½½å¤±è´¥</div>';
    }
  }

  // è·å–åˆ—è¡¨
  function getList(key) {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return [];
      return JSON.parse(raw);
    } catch {
      return [];
    }
  }

  // ä¿å­˜åˆ—è¡¨
  function saveList(key, list) {
    try {
      localStorage.setItem(key, JSON.stringify(list));
    } catch (error) {
      console.error("ä¿å­˜å¤±è´¥:", error);
    }
  }

  // æ ¹æ®IDæŸ¥æ‰¾æ¸¸æˆ
  function findGameById(id) {
    return allGamesData.find(g => g.id === id || g.name.toLowerCase() === id.toLowerCase());
  }

  // ç§»é™¤æ¸¸æˆ
  function removeGame(id, type) {
    const key = type === "owned" ? "ownedGames" : "wishlistGames";
    const list = getList(key);
    const newList = list.filter(gid => gid !== id);
    saveList(key, newList);
    renderMyList();
  }

  // æ¸²æŸ“æˆ‘çš„æ¸¸æˆåˆ—è¡¨
  function renderMyList() {
    if (!isDataLoaded) {
      myListEl.innerHTML = '<div style="grid-column: 1/-1; padding:20px;text-align:center;color:var(--text-muted);">ğŸ® æ­£åœ¨åŠ è½½æ¸¸æˆæ•°æ®...</div>';
      return;
    }

    const kw = mySearchEl.value.trim().toLowerCase();
    const ids = currentType === "owned" ? getList("ownedGames") : getList("wishlistGames");

    // æ ¹æ®IDæŸ¥æ‰¾å®Œæ•´æ¸¸æˆä¿¡æ¯
    let games = ids.map(id => {
      const game = findGameById(id);
      return game || {
        id: id,
        name: `æœªçŸ¥æ¸¸æˆ (${id})`,
        genre: "Unknown",
        platform: "PC",
        rating: 0,
        price: 0,
        thumbnail: ""
      };
    });

    // æœç´¢è¿‡æ»¤
    if (kw) {
      games = games.filter(g => 
        g.name.toLowerCase().includes(kw) || 
        g.genre.toLowerCase().includes(kw)
      );
    }

    myListEl.innerHTML = "";
    myCountEl.textContent = `å…± ${games.length} æ¬¾`;

    if (!games.length) {
      const emptyIcon = currentType === "owned" ? "ğŸ“¦" : "â­";
      const emptyText = currentType === "owned" 
        ? "å½“å‰åˆ—è¡¨ä¸ºç©ºï¼Œå»æ¸¸æˆè¯¦æƒ…é¡µæ ‡è®°\"å·²æ‹¥æœ‰\"å§ï¼" 
        : "å½“å‰æƒ³ç©åˆ—è¡¨ä¸ºç©ºï¼Œå»æ¸¸æˆè¯¦æƒ…é¡µæ ‡è®°\"æƒ³ç©\"å§ï¼";
      myListEl.innerHTML =
        `<div style="grid-column: 1/-1; font-size:12px;color:var(--text-muted);padding:40px;text-align:center;">${emptyIcon}<br><br>${emptyText}</div>`;
      return;
    }

    games.forEach(game => {
      const div = document.createElement("div");
      div.className = "game-card";
      div.style.cursor = "pointer";
      
      const statusIcon = currentType === "owned" ? "âœ…" : "â­";
      const statusText = currentType === "owned" ? "å·²æ‹¥æœ‰" : "æƒ³ç©";
      
      // å°é¢å›¾
      const coverHtml = game.thumbnail
        ? `<img src="${game.thumbnail}" alt="${game.name}" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:40px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);\\'>ğŸ®</div>'" />`
        : '<div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; font-size: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸ®</div>';
      
      div.innerHTML = `
        <div class="game-cover">${coverHtml}</div>
        <div class="game-title">${statusIcon} ${game.name}</div>
        <div class="game-meta">${game.genre} Â· ${game.platform.split(',')[0].trim()}</div>
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 8px;">
          <div style="color: var(--accent); font-weight: 600;">
            â­ ${game.rating.toFixed(1)}
          </div>
          <button class="btn-remove" data-id="${game.id}" style="padding: 4px 12px; font-size: 11px; background: var(--danger); color: white; border: none; border-radius: 4px; cursor: pointer;">
            ç§»é™¤
          </button>
        </div>
      `;
      
      // æ‚¬åœæ•ˆæœ
      div.addEventListener("mouseenter", () => {
        div.style.transform = "translateY(-4px)";
        div.style.boxShadow = "0 8px 24px rgba(56, 189, 248, 0.3)";
        div.style.transition = "all 0.3s ease";
      });
      
      div.addEventListener("mouseleave", () => {
        div.style.transform = "translateY(0)";
        div.style.boxShadow = "";
      });
      
      // ç‚¹å‡»è·³è½¬
      div.addEventListener("click", (e) => {
        // å¦‚æœç‚¹å‡»çš„æ˜¯ç§»é™¤æŒ‰é’®ï¼Œä¸è·³è½¬
        if (e.target.classList.contains("btn-remove")) {
          e.stopPropagation();
          const gameId = e.target.getAttribute("data-id");
          if (confirm(`ç¡®å®šè¦ä»${statusText}åˆ—è¡¨ä¸­ç§»é™¤ã€Š${game.name}ã€‹å—ï¼Ÿ`)) {
            removeGame(gameId, currentType);
          }
          return;
        }
        
        const url = new URL("game-detail.html", window.location.href);
        url.searchParams.set("id", game.id);
        url.searchParams.set("name", game.name);
        window.location.href = url.toString();
      });
      
      myListEl.appendChild(div);
    });
  }

  // Tab åˆ‡æ¢
  tabOwned.addEventListener("click", () => {
    currentType = "owned";
    tabOwned.classList.add("active");
    tabWish.classList.remove("active");
    renderMyList();
  });

  tabWish.addEventListener("click", () => {
    currentType = "wish";
    tabWish.classList.add("active");
    tabOwned.classList.remove("active");
    renderMyList();
  });

  // æœç´¢
  mySearchEl.addEventListener("input", renderMyList);

  // åˆå§‹åŒ–
  loadGamesData();
</script>
</body>
</html>
