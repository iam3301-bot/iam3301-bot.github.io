<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®€å•æµ‹è¯•</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase-config.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .box {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #45a049;
    }
    #result {
      background: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 20px;
      margin-top: 20px;
      min-height: 100px;
      white-space: pre-wrap;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.8;
    }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .warning { color: #ff9800; }
    .info { color: #2196F3; }
  </style>
</head>
<body>
  <div class="box">
    <h1>ğŸ” è¶…ç®€å• Supabase æµ‹è¯•</h1>
    <p>ç‚¹å‡»ä¸‹é¢çš„æŒ‰é’®æµ‹è¯• Supabase è¿æ¥</p>
    
    <button onclick="test1()">æµ‹è¯• 1: æ£€æŸ¥åŠ è½½</button>
    <button onclick="test2()">æµ‹è¯• 2: è¿æ¥æ•°æ®åº“</button>
    <button onclick="test3()">æµ‹è¯• 3: æŸ¥è¯¢æ•°æ®</button>
    <button onclick="clearResult()">æ¸…é™¤ç»“æœ</button>
    
    <div id="result">ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•...</div>
  </div>

  <script>
    function print(msg, type = 'info') {
      const result = document.getElementById('result');
      const span = document.createElement('span');
      span.className = type;
      span.textContent = msg + '\n';
      result.appendChild(span);
    }
    
    function clearResult() {
      document.getElementById('result').innerHTML = '';
    }
    
    function test1() {
      clearResult();
      print('=== æµ‹è¯• 1: æ£€æŸ¥åŠ è½½ ===', 'info');
      print('');
      
      // æ£€æŸ¥ Supabase SDK
      if (typeof supabase === 'undefined') {
        print('âŒ Supabase SDK æœªåŠ è½½', 'error');
        print('é—®é¢˜ï¼šæ— æ³•æ‰¾åˆ° supabase å¯¹è±¡', 'error');
        return;
      }
      print('âœ… Supabase SDK å·²åŠ è½½', 'success');
      
      // æ£€æŸ¥é…ç½®
      if (typeof SUPABASE_CONFIG === 'undefined') {
        print('âŒ SUPABASE_CONFIG æœªå®šä¹‰', 'error');
        print('é—®é¢˜ï¼šsupabase-config.js å¯èƒ½æœªåŠ è½½', 'error');
        return;
      }
      print('âœ… SUPABASE_CONFIG å·²åŠ è½½', 'success');
      
      // æ˜¾ç¤ºé…ç½®
      print('');
      print('ğŸ“‹ é…ç½®ä¿¡æ¯:', 'info');
      print(`URL: ${SUPABASE_CONFIG.url}`, 'info');
      print(`Key: ${SUPABASE_CONFIG.anonKey ? SUPABASE_CONFIG.anonKey.substring(0, 30) + '...' : 'æœªè®¾ç½®'}`, 'info');
      print(`å¯ç”¨: ${SUPABASE_CONFIG.enabled}`, 'info');
      
      if (!SUPABASE_CONFIG.enabled) {
        print('');
        print('âš ï¸ Supabase æœªå¯ç”¨ï¼', 'warning');
        print('éœ€è¦åœ¨ supabase-config.js ä¸­è®¾ç½® enabled: true', 'warning');
      } else {
        print('');
        print('âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¯ä»¥ç»§ç»­æµ‹è¯• 2', 'success');
      }
    }
    
    async function test2() {
      clearResult();
      print('=== æµ‹è¯• 2: è¿æ¥æ•°æ®åº“ ===', 'info');
      print('');
      
      if (typeof supabase === 'undefined' || typeof SUPABASE_CONFIG === 'undefined') {
        print('âŒ è¯·å…ˆè¿è¡Œæµ‹è¯• 1', 'error');
        return;
      }
      
      try {
        print('æ­£åœ¨åˆ›å»º Supabase å®¢æˆ·ç«¯...', 'info');
        
        const client = supabase.createClient(
          SUPABASE_CONFIG.url,
          SUPABASE_CONFIG.anonKey
        );
        
        print('âœ… Supabase å®¢æˆ·ç«¯å·²åˆ›å»º', 'success');
        print('');
        print('æ­£åœ¨æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
        
        // ç®€å•çš„è¿æ¥æµ‹è¯•
        const { data, error } = await client
          .from('community_posts')
          .select('id')
          .limit(1);
        
        if (error) {
          print('');
          print('âŒ è¿æ¥å¤±è´¥', 'error');
          print(`é”™è¯¯ä»£ç : ${error.code}`, 'error');
          print(`é”™è¯¯ä¿¡æ¯: ${error.message}`, 'error');
          print('');
          
          if (error.code === '42P01') {
            print('ğŸ’¡ é—®é¢˜åˆ†æ:', 'warning');
            print('æ•°æ®åº“è¡¨ community_posts ä¸å­˜åœ¨', 'warning');
            print('');
            print('ğŸ”§ è§£å†³æ–¹æ¡ˆ:', 'info');
            print('1. è®¿é—® Supabase SQL Editor:', 'info');
            print('   https://supabase.com/dashboard/project/gybgiqyyltckgxbdtzwu/sql', 'info');
            print('2. å¤åˆ¶å¹¶æ‰§è¡Œ supabase-init.sql æ–‡ä»¶å†…å®¹', 'info');
            print('3. ç­‰å¾…æ‰§è¡ŒæˆåŠŸåï¼Œé‡æ–°è¿è¡Œæ­¤æµ‹è¯•', 'info');
          } else if (error.code === 'PGRST301') {
            print('ğŸ’¡ é—®é¢˜åˆ†æ:', 'warning');
            print('æ•°æ®åº“æƒé™é”™è¯¯ (RLS ç­–ç•¥)', 'warning');
            print('');
            print('ğŸ”§ è§£å†³æ–¹æ¡ˆ:', 'info');
            print('åœ¨ Supabase SQL Editor æ‰§è¡Œ:', 'info');
            print('ALTER TABLE community_posts DISABLE ROW LEVEL SECURITY;', 'info');
          } else {
            print('ğŸ’¡ æœªçŸ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Supabase çŠ¶æ€', 'warning');
          }
        } else {
          print('âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
          print(`æŸ¥è¯¢ç»“æœ: ${JSON.stringify(data)}`, 'info');
          print('');
          print('âœ… å¯ä»¥ç»§ç»­æµ‹è¯• 3', 'success');
          
          // ä¿å­˜å®¢æˆ·ç«¯ä¾›æµ‹è¯•3ä½¿ç”¨
          window.testClient = client;
        }
      } catch (e) {
        print('âŒ æµ‹è¯•å¼‚å¸¸', 'error');
        print(`å¼‚å¸¸ä¿¡æ¯: ${e.message}`, 'error');
        print(`å †æ ˆ: ${e.stack}`, 'error');
      }
    }
    
    async function test3() {
      clearResult();
      print('=== æµ‹è¯• 3: æŸ¥è¯¢æ•°æ® ===', 'info');
      print('');
      
      if (!window.testClient) {
        print('âŒ è¯·å…ˆè¿è¡Œæµ‹è¯• 2', 'error');
        return;
      }
      
      try {
        print('æ­£åœ¨æ£€æŸ¥æ‰€æœ‰æ•°æ®åº“è¡¨...', 'info');
        print('');
        
        const tables = [
          'user_profiles',
          'community_posts',
          'community_comments',
          'community_likes',
          'community_stats',
          'online_users',
          'activity_logs',
          'user_platform_bindings'
        ];
        
        let successCount = 0;
        let failCount = 0;
        
        for (const table of tables) {
          const { data, error } = await window.testClient
            .from(table)
            .select('*')
            .limit(1);
          
          if (error) {
            print(`âŒ ${table}: ${error.code === '42P01' ? 'ä¸å­˜åœ¨' : error.message}`, 'error');
            failCount++;
          } else {
            const count = data ? data.length : 0;
            print(`âœ… ${table}: æ­£å¸¸ (${count} è¡Œ)`, 'success');
            successCount++;
          }
        }
        
        print('');
        print(`æ€»è®¡: ${successCount} ä¸ªè¡¨æ­£å¸¸, ${failCount} ä¸ªè¡¨å¤±è´¥`, failCount === 0 ? 'success' : 'error');
        
        if (failCount === 0) {
          print('');
          print('ğŸ‰ğŸ‰ğŸ‰ å®Œç¾ï¼æ‰€æœ‰æ•°æ®åº“è¡¨éƒ½æ­£å¸¸ï¼', 'success');
          print('');
          print('ğŸ“ ä¸‹ä¸€æ­¥:', 'info');
          print('1. å¦‚æœ community.html è¿˜æ˜¾ç¤º"æœ¬åœ°å­˜å‚¨"', 'info');
          print('2. è¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ (Ctrl+Shift+Delete)', 'info');
          print('3. æˆ–è€…è®¿é—®: https://iam3301-bot.github.io/force-refresh.html', 'info');
        } else {
          print('');
          print('ğŸ”§ ä¿®å¤æ­¥éª¤:', 'warning');
          print('1. è®¿é—® Supabase SQL Editor', 'info');
          print('2. æ‰§è¡Œ supabase-init.sql å®Œæ•´è„šæœ¬', 'info');
          print('3. é‡æ–°è¿è¡Œæ­¤æµ‹è¯•', 'info');
        }
      } catch (e) {
        print('âŒ æµ‹è¯•å¼‚å¸¸', 'error');
        print(`å¼‚å¸¸: ${e.message}`, 'error');
      }
    }
  </script>
</body>
</html>
