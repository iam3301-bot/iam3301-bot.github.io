<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç»ˆæè¯Šæ–­å·¥å…·</title>
  
  <!-- åŠ è½½ Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- åŠ è½½ Supabase é…ç½® -->
  <script src="supabase-config.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      color: #4ec9b0;
      margin-bottom: 20px;
      border-bottom: 2px solid #4ec9b0;
      padding-bottom: 10px;
    }
    
    .section {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .section h2 {
      color: #569cd6;
      margin-bottom: 15px;
    }
    
    .log {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 15px;
      margin: 10px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .success {
      color: #4ec9b0;
    }
    
    .error {
      color: #f48771;
    }
    
    .warning {
      color: #dcdcaa;
    }
    
    .info {
      color: #9cdcfe;
    }
    
    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
      font-family: 'Courier New', monospace;
    }
    
    button:hover {
      background: #1177bb;
    }
    
    button:disabled {
      background: #3e3e42;
      cursor: not-allowed;
    }
    
    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .status-badge.ok {
      background: #4ec9b0;
      color: #1e1e1e;
    }
    
    .status-badge.fail {
      background: #f48771;
      color: #1e1e1e;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 10px 0;
    }
    
    th, td {
      border: 1px solid #3e3e42;
      padding: 10px;
      text-align: left;
    }
    
    th {
      background: #2d2d30;
      color: #569cd6;
    }
    
    .code {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 10px;
      margin: 10px 0;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”¬ ç»ˆæ Supabase è¯Šæ–­å·¥å…·</h1>
    
    <!-- æ­¥éª¤ 1: åŸºç¡€æ£€æŸ¥ -->
    <div class="section">
      <h2>ğŸ“‹ æ­¥éª¤ 1: åŸºç¡€ç¯å¢ƒæ£€æŸ¥</h2>
      <button onclick="runBasicCheck()">è¿è¡ŒåŸºç¡€æ£€æŸ¥</button>
      <div id="basic-result" class="log"></div>
    </div>
    
    <!-- æ­¥éª¤ 2: è¿æ¥æµ‹è¯• -->
    <div class="section">
      <h2>ğŸ”Œ æ­¥éª¤ 2: Supabase è¿æ¥æµ‹è¯•</h2>
      <button onclick="runConnectionTest()">æµ‹è¯•è¿æ¥</button>
      <div id="connection-result" class="log"></div>
    </div>
    
    <!-- æ­¥éª¤ 3: æ•°æ®åº“è¡¨æ£€æŸ¥ -->
    <div class="section">
      <h2>ğŸ—„ï¸ æ­¥éª¤ 3: æ•°æ®åº“è¡¨æ£€æŸ¥</h2>
      <button onclick="runTableCheck()">æ£€æŸ¥æ•°æ®åº“è¡¨</button>
      <div id="table-result" class="log"></div>
    </div>
    
    <!-- æ­¥éª¤ 4: å®Œæ•´æµ‹è¯• -->
    <div class="section">
      <h2>ğŸ§ª æ­¥éª¤ 4: å®Œæ•´åŠŸèƒ½æµ‹è¯•</h2>
      <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
      <div id="full-result" class="log"></div>
    </div>
    
    <!-- æ­¥éª¤ 5: ä¿®å¤å»ºè®® -->
    <div class="section">
      <h2>ğŸ”§ æ­¥éª¤ 5: é—®é¢˜ä¿®å¤</h2>
      <div id="fix-suggestions"></div>
    </div>
  </div>

  <script>
    let supabaseClient = null;
    let issues = [];
    
    function log(element, message, type = 'info') {
      const colors = {
        success: '#4ec9b0',
        error: '#f48771',
        warning: '#dcdcaa',
        info: '#9cdcfe'
      };
      
      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };
      
      const div = document.getElementById(element);
      div.innerHTML += `<div style="color: ${colors[type]}">${icons[type]} ${message}</div>`;
    }
    
    function clear(element) {
      document.getElementById(element).innerHTML = '';
    }
    
    async function runBasicCheck() {
      clear('basic-result');
      issues = [];
      
      log('basic-result', 'å¼€å§‹åŸºç¡€ç¯å¢ƒæ£€æŸ¥...', 'info');
      log('basic-result', '');
      
      // æ£€æŸ¥ Supabase SDK
      if (typeof supabase === 'undefined') {
        log('basic-result', 'Supabase SDK æœªåŠ è½½', 'error');
        issues.push('Supabase SDK æœªåŠ è½½');
      } else {
        log('basic-result', 'Supabase SDK å·²åŠ è½½', 'success');
        log('basic-result', `ç‰ˆæœ¬: ${supabase.createClient ? '2.x' : 'æœªçŸ¥'}`, 'info');
      }
      
      // æ£€æŸ¥é…ç½®æ–‡ä»¶
      if (typeof SUPABASE_CONFIG === 'undefined') {
        log('basic-result', 'SUPABASE_CONFIG æœªå®šä¹‰', 'error');
        issues.push('é…ç½®æ–‡ä»¶æœªåŠ è½½');
      } else {
        log('basic-result', 'SUPABASE_CONFIG å·²åŠ è½½', 'success');
        log('basic-result', '');
        log('basic-result', 'é…ç½®è¯¦æƒ…:', 'info');
        log('basic-result', `  URL: ${SUPABASE_CONFIG.url}`, 'info');
        log('basic-result', `  anonKey: ${SUPABASE_CONFIG.anonKey ? SUPABASE_CONFIG.anonKey.substring(0, 20) + '...' : 'æœªè®¾ç½®'}`, 'info');
        log('basic-result', `  enabled: ${SUPABASE_CONFIG.enabled}`, 'info');
        
        if (!SUPABASE_CONFIG.enabled) {
          log('basic-result', '', 'warning');
          log('basic-result', 'Supabase æœªå¯ç”¨ï¼è¯·åœ¨ supabase-config.js ä¸­è®¾ç½® enabled: true', 'error');
          issues.push('Supabase æœªå¯ç”¨');
        }
        
        if (!SUPABASE_CONFIG.url || !SUPABASE_CONFIG.anonKey) {
          log('basic-result', 'URL æˆ– anonKey æœªé…ç½®', 'error');
          issues.push('URL æˆ– Key æœªé…ç½®');
        }
      }
      
      log('basic-result', '');
      if (issues.length === 0) {
        log('basic-result', 'ğŸ‰ åŸºç¡€æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼', 'success');
      } else {
        log('basic-result', `âŒ å‘ç° ${issues.length} ä¸ªé—®é¢˜`, 'error');
      }
    }
    
    async function runConnectionTest() {
      clear('connection-result');
      
      if (typeof supabase === 'undefined' || typeof SUPABASE_CONFIG === 'undefined') {
        log('connection-result', 'è¯·å…ˆè¿è¡Œæ­¥éª¤1çš„åŸºç¡€æ£€æŸ¥', 'error');
        return;
      }
      
      log('connection-result', 'å¼€å§‹è¿æ¥æµ‹è¯•...', 'info');
      log('connection-result', '');
      
      try {
        log('connection-result', `æ­£åœ¨è¿æ¥åˆ°: ${SUPABASE_CONFIG.url}`, 'info');
        
        supabaseClient = supabase.createClient(
          SUPABASE_CONFIG.url,
          SUPABASE_CONFIG.anonKey
        );
        
        log('connection-result', 'Supabase å®¢æˆ·ç«¯å·²åˆ›å»º', 'success');
        log('connection-result', '');
        
        // æµ‹è¯•ç®€å•æŸ¥è¯¢
        log('connection-result', 'æµ‹è¯•æ•°æ®åº“è¿æ¥...', 'info');
        
        const { data, error } = await supabaseClient
          .from('community_posts')
          .select('count')
          .limit(1);
        
        if (error) {
          log('connection-result', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
          log('connection-result', `é”™è¯¯ä»£ç : ${error.code}`, 'error');
          
          if (error.code === '42P01') {
            log('connection-result', '', 'warning');
            log('connection-result', 'è¡¨ community_posts ä¸å­˜åœ¨ï¼', 'error');
            log('connection-result', 'è¯·åœ¨ Supabase SQL Editor æ‰§è¡Œ supabase-init.sql', 'warning');
            issues.push('æ•°æ®åº“è¡¨ä¸å­˜åœ¨');
          } else if (error.code === 'PGRST301') {
            log('connection-result', '', 'warning');
            log('connection-result', 'RLS æƒé™é”™è¯¯ï¼', 'error');
            issues.push('RLS ç­–ç•¥é—®é¢˜');
          } else {
            issues.push(`æ•°æ®åº“é”™è¯¯: ${error.code}`);
          }
        } else {
          log('connection-result', 'âœ… æ•°æ®åº“è¿æ¥æˆåŠŸï¼', 'success');
          log('connection-result', `æŸ¥è¯¢ç»“æœ: ${JSON.stringify(data)}`, 'info');
        }
      } catch (e) {
        log('connection-result', `è¿æ¥å¼‚å¸¸: ${e.message}`, 'error');
        issues.push(`è¿æ¥å¼‚å¸¸: ${e.message}`);
      }
    }
    
    async function runTableCheck() {
      clear('table-result');
      
      if (!supabaseClient) {
        log('table-result', 'è¯·å…ˆè¿è¡Œæ­¥éª¤2çš„è¿æ¥æµ‹è¯•', 'error');
        return;
      }
      
      log('table-result', 'å¼€å§‹æ£€æŸ¥æ•°æ®åº“è¡¨...', 'info');
      log('table-result', '');
      
      const tables = [
        'user_profiles',
        'community_posts',
        'community_comments',
        'community_likes',
        'community_stats',
        'online_users',
        'activity_logs',
        'user_platform_bindings'
      ];
      
      let allOk = true;
      
      for (const table of tables) {
        try {
          const { data, error } = await supabaseClient
            .from(table)
            .select('*')
            .limit(1);
          
          if (error) {
            log('table-result', `è¡¨ ${table}: âŒ ${error.code === '42P01' ? 'ä¸å­˜åœ¨' : error.message}`, 'error');
            allOk = false;
          } else {
            const count = data ? data.length : 0;
            log('table-result', `è¡¨ ${table}: âœ… æ­£å¸¸ (${count} è¡Œæ•°æ®)`, 'success');
          }
        } catch (e) {
          log('table-result', `è¡¨ ${table}: âŒ æ£€æŸ¥å¤±è´¥: ${e.message}`, 'error');
          allOk = false;
        }
      }
      
      log('table-result', '');
      if (allOk) {
        log('table-result', 'ğŸ‰ æ‰€æœ‰æ•°æ®åº“è¡¨æ£€æŸ¥é€šè¿‡ï¼', 'success');
      } else {
        log('table-result', 'âŒ éƒ¨åˆ†è¡¨ä¸å­˜åœ¨æˆ–æœ‰é—®é¢˜', 'error');
        log('table-result', 'è¯·åœ¨ Supabase æ‰§è¡Œ supabase-init.sql', 'warning');
        issues.push('æ•°æ®åº“è¡¨ç¼ºå¤±æˆ–æŸå');
      }
    }
    
    async function runFullTest() {
      clear('full-result');
      issues = [];
      
      log('full-result', 'ğŸš€ è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶...', 'info');
      log('full-result', '');
      
      // æµ‹è¯•1: åŸºç¡€æ£€æŸ¥
      log('full-result', 'ã€æµ‹è¯• 1/5ã€‘åŸºç¡€ç¯å¢ƒæ£€æŸ¥', 'info');
      await runBasicCheckSilent();
      
      // æµ‹è¯•2: è¿æ¥æµ‹è¯•
      log('full-result', 'ã€æµ‹è¯• 2/5ã€‘è¿æ¥æµ‹è¯•', 'info');
      await runConnectionTestSilent();
      
      // æµ‹è¯•3: è¡¨æ£€æŸ¥
      log('full-result', 'ã€æµ‹è¯• 3/5ã€‘æ•°æ®åº“è¡¨æ£€æŸ¥', 'info');
      await runTableCheckSilent();
      
      // æµ‹è¯•4: å†™å…¥æµ‹è¯•
      log('full-result', 'ã€æµ‹è¯• 4/5ã€‘å†™å…¥æƒé™æµ‹è¯•', 'info');
      await testWrite();
      
      // æµ‹è¯•5: å®æ—¶è®¢é˜…
      log('full-result', 'ã€æµ‹è¯• 5/5ã€‘å®æ—¶è®¢é˜…æµ‹è¯•', 'info');
      await testRealtime();
      
      log('full-result', '');
      log('full-result', '='.repeat(50), 'info');
      
      if (issues.length === 0) {
        log('full-result', 'ğŸ‰ğŸ‰ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Supabase å®Œå…¨å¯ç”¨ï¼', 'success');
        log('full-result', '', 'success');
        log('full-result', 'âœ… ä½ çš„ community.html åº”è¯¥å¯ä»¥æ­£å¸¸å·¥ä½œäº†', 'success');
        log('full-result', 'å¦‚æœè¿˜æ˜¾ç¤º"æœ¬åœ°å­˜å‚¨"ï¼Œè¯·æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+Deleteï¼‰', 'warning');
      } else {
        log('full-result', `âŒ å‘ç° ${issues.length} ä¸ªé—®é¢˜ï¼š`, 'error');
        issues.forEach((issue, i) => {
          log('full-result', `  ${i + 1}. ${issue}`, 'error');
        });
        
        generateFixSuggestions();
      }
    }
    
    async function runBasicCheckSilent() {
      if (typeof supabase === 'undefined') {
        log('full-result', '  âŒ Supabase SDK æœªåŠ è½½', 'error');
        issues.push('Supabase SDK æœªåŠ è½½');
        return;
      }
      log('full-result', '  âœ… Supabase SDK å·²åŠ è½½', 'success');
      
      if (typeof SUPABASE_CONFIG === 'undefined') {
        log('full-result', '  âŒ é…ç½®æ–‡ä»¶æœªåŠ è½½', 'error');
        issues.push('é…ç½®æ–‡ä»¶æœªåŠ è½½');
        return;
      }
      log('full-result', '  âœ… é…ç½®æ–‡ä»¶å·²åŠ è½½', 'success');
      
      if (!SUPABASE_CONFIG.enabled) {
        log('full-result', '  âŒ Supabase æœªå¯ç”¨', 'error');
        issues.push('Supabase æœªå¯ç”¨');
      } else {
        log('full-result', '  âœ… Supabase å·²å¯ç”¨', 'success');
      }
      
      log('full-result', '');
    }
    
    async function runConnectionTestSilent() {
      try {
        supabaseClient = supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
        log('full-result', '  âœ… å®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ', 'success');
        
        const { error } = await supabaseClient.from('community_posts').select('id').limit(1);
        
        if (error) {
          log('full-result', `  âŒ è¿æ¥å¤±è´¥: ${error.code}`, 'error');
          issues.push(`è¿æ¥å¤±è´¥: ${error.code}`);
        } else {
          log('full-result', '  âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ', 'success');
        }
      } catch (e) {
        log('full-result', `  âŒ è¿æ¥å¼‚å¸¸: ${e.message}`, 'error');
        issues.push('è¿æ¥å¼‚å¸¸');
      }
      log('full-result', '');
    }
    
    async function runTableCheckSilent() {
      const tables = ['user_profiles', 'community_posts', 'community_stats', 'online_users'];
      let ok = 0;
      
      for (const table of tables) {
        const { error } = await supabaseClient.from(table).select('id').limit(1);
        if (!error) ok++;
      }
      
      log('full-result', `  ${ok === tables.length ? 'âœ…' : 'âŒ'} æ•°æ®åº“è¡¨: ${ok}/${tables.length} å¯ç”¨`, ok === tables.length ? 'success' : 'error');
      
      if (ok < tables.length) {
        issues.push('æ•°æ®åº“è¡¨ç¼ºå¤±');
      }
      log('full-result', '');
    }
    
    async function testWrite() {
      try {
        const testId = 'test-' + Date.now();
        const { error } = await supabaseClient
          .from('activity_logs')
          .insert({
            id: testId,
            action: 'diagnostic_test',
            details: { test: true }
          });
        
        if (error) {
          log('full-result', `  âŒ å†™å…¥æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
          issues.push('å†™å…¥æƒé™é—®é¢˜');
        } else {
          log('full-result', '  âœ… å†™å…¥æƒé™æ­£å¸¸', 'success');
          
          // æ¸…ç†æµ‹è¯•æ•°æ®
          await supabaseClient.from('activity_logs').delete().eq('id', testId);
        }
      } catch (e) {
        log('full-result', `  âŒ å†™å…¥æµ‹è¯•å¼‚å¸¸: ${e.message}`, 'error');
        issues.push('å†™å…¥æµ‹è¯•å¤±è´¥');
      }
      log('full-result', '');
    }
    
    async function testRealtime() {
      log('full-result', '  â„¹ï¸ å®æ—¶è®¢é˜…æµ‹è¯•ï¼ˆè·³è¿‡ï¼Œéœ€è¦åœ¨ Dashboard é…ç½®ï¼‰', 'warning');
      log('full-result', '');
    }
    
    function generateFixSuggestions() {
      const fixes = document.getElementById('fix-suggestions');
      fixes.innerHTML = '<h3>ğŸ”§ ä¿®å¤å»ºè®®</h3>';
      
      if (issues.some(i => i.includes('SDK æœªåŠ è½½'))) {
        fixes.innerHTML += `
          <div class="code">
            <strong>é—®é¢˜ï¼šSupabase SDK æœªåŠ è½½</strong><br>
            <strong>è§£å†³ï¼š</strong>åœ¨ HTML ä¸­æ·»åŠ ï¼š<br>
            <code>&lt;script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"&gt;&lt;/script&gt;</code>
          </div>
        `;
      }
      
      if (issues.some(i => i.includes('é…ç½®æ–‡ä»¶'))) {
        fixes.innerHTML += `
          <div class="code">
            <strong>é—®é¢˜ï¼šé…ç½®æ–‡ä»¶æœªåŠ è½½</strong><br>
            <strong>è§£å†³ï¼š</strong>ç¡®ä¿ supabase-config.js å­˜åœ¨å¹¶å·²åŠ è½½<br>
            <code>&lt;script src="supabase-config.js"&gt;&lt;/script&gt;</code>
          </div>
        `;
      }
      
      if (issues.some(i => i.includes('æœªå¯ç”¨'))) {
        fixes.innerHTML += `
          <div class="code">
            <strong>é—®é¢˜ï¼šSupabase æœªå¯ç”¨</strong><br>
            <strong>è§£å†³ï¼š</strong>åœ¨ supabase-config.js ä¸­è®¾ç½®ï¼š<br>
            <code>enabled: true</code>
          </div>
        `;
      }
      
      if (issues.some(i => i.includes('è¡¨') || i.includes('42P01'))) {
        fixes.innerHTML += `
          <div class="code">
            <strong>é—®é¢˜ï¼šæ•°æ®åº“è¡¨ä¸å­˜åœ¨</strong><br>
            <strong>è§£å†³ï¼š</strong><br>
            1. è®¿é—® <a href="https://supabase.com/dashboard/project/gybgiqyyltckgxbdtzwu/sql" target="_blank" style="color: #4ec9b0;">Supabase SQL Editor</a><br>
            2. å¤åˆ¶ supabase-init.sql å†…å®¹<br>
            3. ç²˜è´´å¹¶æ‰§è¡Œ<br>
            <button onclick="window.open('https://supabase.com/dashboard/project/gybgiqyyltckgxbdtzwu/sql', '_blank')">æ‰“å¼€ SQL Editor</button>
          </div>
        `;
      }
      
      if (issues.length === 0) {
        fixes.innerHTML += `
          <div class="code" style="background: #4ec9b0; color: #1e1e1e;">
            <strong>âœ… æ²¡æœ‰å‘ç°é—®é¢˜ï¼</strong><br><br>
            å¦‚æœ community.html ä»æ˜¾ç¤º"æœ¬åœ°å­˜å‚¨"ï¼š<br>
            1. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼ˆCtrl+Shift+Deleteï¼‰<br>
            2. å¼ºåˆ¶åˆ·æ–°é¡µé¢ï¼ˆCtrl+Shift+Rï¼‰<br>
            3. æˆ–ä½¿ç”¨éšèº«æ¨¡å¼æµ‹è¯•<br><br>
            <button onclick="window.location.href='force-refresh.html'">ä½¿ç”¨å¼ºåˆ¶åˆ·æ–°å·¥å…·</button>
            <button onclick="window.location.href='community.html?t=' + Date.now()">æ‰“å¼€ç¤¾åŒºé¡µé¢</button>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
